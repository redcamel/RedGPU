var e=1e-6,t="undefined"!=typeof Float32Array?Float32Array:Array,r=Math.random;var n=Math.PI/180;Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});var i=Object.freeze({__proto__:null,get ARRAY_TYPE(){return t},EPSILON:e,RANDOM:r,equals:function(t,r){return Math.abs(t-r)<=e*Math.max(1,Math.abs(t),Math.abs(r))},setMatrixArrayType:function(e){t=e},toRadian:function(e){return e*n}});function multiply$8(e,t,r){var n=t[0],i=t[1],s=t[2],a=t[3],o=r[0],u=r[1],l=r[2],c=r[3];return e[0]=n*o+s*u,e[1]=i*o+a*u,e[2]=n*l+s*c,e[3]=i*l+a*c,e}function subtract$6(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e[3]=t[3]-r[3],e}var s=multiply$8,a=subtract$6,o=Object.freeze({__proto__:null,LDU:function(e,t,r,n){return e[2]=n[2]/n[0],r[0]=n[0],r[1]=n[1],r[3]=n[3]-e[2]*r[1],[e,t,r]},add:function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e},adjoint:function(e,t){var r=t[0];return e[0]=t[3],e[1]=-t[1],e[2]=-t[2],e[3]=r,e},clone:function(e){var r=new t(4);return r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r},copy:function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},create:function(){var e=new t(4);return t!=Float32Array&&(e[1]=0,e[2]=0),e[0]=1,e[3]=1,e},determinant:function(e){return e[0]*e[3]-e[2]*e[1]},equals:function(t,r){var n=t[0],i=t[1],s=t[2],a=t[3],o=r[0],u=r[1],l=r[2],c=r[3];return Math.abs(n-o)<=e*Math.max(1,Math.abs(n),Math.abs(o))&&Math.abs(i-u)<=e*Math.max(1,Math.abs(i),Math.abs(u))&&Math.abs(s-l)<=e*Math.max(1,Math.abs(s),Math.abs(l))&&Math.abs(a-c)<=e*Math.max(1,Math.abs(a),Math.abs(c))},exactEquals:function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]},frob:function(e){return Math.hypot(e[0],e[1],e[2],e[3])},fromRotation:function(e,t){var r=Math.sin(t),n=Math.cos(t);return e[0]=n,e[1]=r,e[2]=-r,e[3]=n,e},fromScaling:function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e},fromValues:function(e,r,n,i){var s=new t(4);return s[0]=e,s[1]=r,s[2]=n,s[3]=i,s},identity:function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e},invert:function(e,t){var r=t[0],n=t[1],i=t[2],s=t[3],a=r*s-i*n;return a?(a=1/a,e[0]=s*a,e[1]=-n*a,e[2]=-i*a,e[3]=r*a,e):null},mul:s,multiply:multiply$8,multiplyScalar:function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e},multiplyScalarAndAdd:function(e,t,r,n){return e[0]=t[0]+r[0]*n,e[1]=t[1]+r[1]*n,e[2]=t[2]+r[2]*n,e[3]=t[3]+r[3]*n,e},rotate:function(e,t,r){var n=t[0],i=t[1],s=t[2],a=t[3],o=Math.sin(r),u=Math.cos(r);return e[0]=n*u+s*o,e[1]=i*u+a*o,e[2]=n*-o+s*u,e[3]=i*-o+a*u,e},scale:function(e,t,r){var n=t[0],i=t[1],s=t[2],a=t[3],o=r[0],u=r[1];return e[0]=n*o,e[1]=i*o,e[2]=s*u,e[3]=a*u,e},set:function(e,t,r,n,i){return e[0]=t,e[1]=r,e[2]=n,e[3]=i,e},str:function(e){return"mat2("+e[0]+","+e[1]+","+e[2]+","+e[3]+")"},sub:a,subtract:subtract$6,transpose:function(e,t){if(e===t){var r=t[1];e[1]=t[2],e[2]=r}else e[0]=t[0],e[1]=t[2],e[2]=t[1],e[3]=t[3];return e}});function multiply$7(e,t,r){var n=t[0],i=t[1],s=t[2],a=t[3],o=t[4],u=t[5],l=r[0],c=r[1],h=r[2],m=r[3],d=r[4],p=r[5];return e[0]=n*l+s*c,e[1]=i*l+a*c,e[2]=n*h+s*m,e[3]=i*h+a*m,e[4]=n*d+s*p+o,e[5]=i*d+a*p+u,e}function subtract$5(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e[3]=t[3]-r[3],e[4]=t[4]-r[4],e[5]=t[5]-r[5],e}var u=multiply$7,l=subtract$5,c=Object.freeze({__proto__:null,add:function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e[4]=t[4]+r[4],e[5]=t[5]+r[5],e},clone:function(e){var r=new t(6);return r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[4]=e[4],r[5]=e[5],r},copy:function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e},create:function(){var e=new t(6);return t!=Float32Array&&(e[1]=0,e[2]=0,e[4]=0,e[5]=0),e[0]=1,e[3]=1,e},determinant:function(e){return e[0]*e[3]-e[1]*e[2]},equals:function(t,r){var n=t[0],i=t[1],s=t[2],a=t[3],o=t[4],u=t[5],l=r[0],c=r[1],h=r[2],m=r[3],d=r[4],p=r[5];return Math.abs(n-l)<=e*Math.max(1,Math.abs(n),Math.abs(l))&&Math.abs(i-c)<=e*Math.max(1,Math.abs(i),Math.abs(c))&&Math.abs(s-h)<=e*Math.max(1,Math.abs(s),Math.abs(h))&&Math.abs(a-m)<=e*Math.max(1,Math.abs(a),Math.abs(m))&&Math.abs(o-d)<=e*Math.max(1,Math.abs(o),Math.abs(d))&&Math.abs(u-p)<=e*Math.max(1,Math.abs(u),Math.abs(p))},exactEquals:function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]},frob:function(e){return Math.hypot(e[0],e[1],e[2],e[3],e[4],e[5],1)},fromRotation:function(e,t){var r=Math.sin(t),n=Math.cos(t);return e[0]=n,e[1]=r,e[2]=-r,e[3]=n,e[4]=0,e[5]=0,e},fromScaling:function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e[4]=0,e[5]=0,e},fromTranslation:function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=t[0],e[5]=t[1],e},fromValues:function(e,r,n,i,s,a){var o=new t(6);return o[0]=e,o[1]=r,o[2]=n,o[3]=i,o[4]=s,o[5]=a,o},identity:function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=0,e[5]=0,e},invert:function(e,t){var r=t[0],n=t[1],i=t[2],s=t[3],a=t[4],o=t[5],u=r*s-n*i;return u?(u=1/u,e[0]=s*u,e[1]=-n*u,e[2]=-i*u,e[3]=r*u,e[4]=(i*o-s*a)*u,e[5]=(n*a-r*o)*u,e):null},mul:u,multiply:multiply$7,multiplyScalar:function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*r,e[5]=t[5]*r,e},multiplyScalarAndAdd:function(e,t,r,n){return e[0]=t[0]+r[0]*n,e[1]=t[1]+r[1]*n,e[2]=t[2]+r[2]*n,e[3]=t[3]+r[3]*n,e[4]=t[4]+r[4]*n,e[5]=t[5]+r[5]*n,e},rotate:function(e,t,r){var n=t[0],i=t[1],s=t[2],a=t[3],o=t[4],u=t[5],l=Math.sin(r),c=Math.cos(r);return e[0]=n*c+s*l,e[1]=i*c+a*l,e[2]=n*-l+s*c,e[3]=i*-l+a*c,e[4]=o,e[5]=u,e},scale:function(e,t,r){var n=t[0],i=t[1],s=t[2],a=t[3],o=t[4],u=t[5],l=r[0],c=r[1];return e[0]=n*l,e[1]=i*l,e[2]=s*c,e[3]=a*c,e[4]=o,e[5]=u,e},set:function(e,t,r,n,i,s,a){return e[0]=t,e[1]=r,e[2]=n,e[3]=i,e[4]=s,e[5]=a,e},str:function(e){return"mat2d("+e[0]+","+e[1]+","+e[2]+","+e[3]+","+e[4]+","+e[5]+")"},sub:l,subtract:subtract$5,translate:function(e,t,r){var n=t[0],i=t[1],s=t[2],a=t[3],o=t[4],u=t[5],l=r[0],c=r[1];return e[0]=n,e[1]=i,e[2]=s,e[3]=a,e[4]=n*l+s*c+o,e[5]=i*l+a*c+u,e}});function create$6(){var e=new t(9);return t!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e}function multiply$6(e,t,r){var n=t[0],i=t[1],s=t[2],a=t[3],o=t[4],u=t[5],l=t[6],c=t[7],h=t[8],m=r[0],d=r[1],p=r[2],f=r[3],g=r[4],x=r[5],_=r[6],v=r[7],y=r[8];return e[0]=m*n+d*a+p*l,e[1]=m*i+d*o+p*c,e[2]=m*s+d*u+p*h,e[3]=f*n+g*a+x*l,e[4]=f*i+g*o+x*c,e[5]=f*s+g*u+x*h,e[6]=_*n+v*a+y*l,e[7]=_*i+v*o+y*c,e[8]=_*s+v*u+y*h,e}function subtract$4(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e[3]=t[3]-r[3],e[4]=t[4]-r[4],e[5]=t[5]-r[5],e[6]=t[6]-r[6],e[7]=t[7]-r[7],e[8]=t[8]-r[8],e}var h=multiply$6,m=subtract$4,d=Object.freeze({__proto__:null,add:function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e[4]=t[4]+r[4],e[5]=t[5]+r[5],e[6]=t[6]+r[6],e[7]=t[7]+r[7],e[8]=t[8]+r[8],e},adjoint:function(e,t){var r=t[0],n=t[1],i=t[2],s=t[3],a=t[4],o=t[5],u=t[6],l=t[7],c=t[8];return e[0]=a*c-o*l,e[1]=i*l-n*c,e[2]=n*o-i*a,e[3]=o*u-s*c,e[4]=r*c-i*u,e[5]=i*s-r*o,e[6]=s*l-a*u,e[7]=n*u-r*l,e[8]=r*a-n*s,e},clone:function(e){var r=new t(9);return r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[4]=e[4],r[5]=e[5],r[6]=e[6],r[7]=e[7],r[8]=e[8],r},copy:function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},create:create$6,determinant:function(e){var t=e[0],r=e[1],n=e[2],i=e[3],s=e[4],a=e[5],o=e[6],u=e[7],l=e[8];return t*(l*s-a*u)+r*(-l*i+a*o)+n*(u*i-s*o)},equals:function(t,r){var n=t[0],i=t[1],s=t[2],a=t[3],o=t[4],u=t[5],l=t[6],c=t[7],h=t[8],m=r[0],d=r[1],p=r[2],f=r[3],g=r[4],x=r[5],_=r[6],v=r[7],y=r[8];return Math.abs(n-m)<=e*Math.max(1,Math.abs(n),Math.abs(m))&&Math.abs(i-d)<=e*Math.max(1,Math.abs(i),Math.abs(d))&&Math.abs(s-p)<=e*Math.max(1,Math.abs(s),Math.abs(p))&&Math.abs(a-f)<=e*Math.max(1,Math.abs(a),Math.abs(f))&&Math.abs(o-g)<=e*Math.max(1,Math.abs(o),Math.abs(g))&&Math.abs(u-x)<=e*Math.max(1,Math.abs(u),Math.abs(x))&&Math.abs(l-_)<=e*Math.max(1,Math.abs(l),Math.abs(_))&&Math.abs(c-v)<=e*Math.max(1,Math.abs(c),Math.abs(v))&&Math.abs(h-y)<=e*Math.max(1,Math.abs(h),Math.abs(y))},exactEquals:function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]},frob:function(e){return Math.hypot(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8])},fromMat2d:function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=0,e[3]=t[2],e[4]=t[3],e[5]=0,e[6]=t[4],e[7]=t[5],e[8]=1,e},fromMat4:function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e},fromQuat:function(e,t){var r=t[0],n=t[1],i=t[2],s=t[3],a=r+r,o=n+n,u=i+i,l=r*a,c=n*a,h=n*o,m=i*a,d=i*o,p=i*u,f=s*a,g=s*o,x=s*u;return e[0]=1-h-p,e[3]=c-x,e[6]=m+g,e[1]=c+x,e[4]=1-l-p,e[7]=d-f,e[2]=m-g,e[5]=d+f,e[8]=1-l-h,e},fromRotation:function(e,t){var r=Math.sin(t),n=Math.cos(t);return e[0]=n,e[1]=r,e[2]=0,e[3]=-r,e[4]=n,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},fromScaling:function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=t[1],e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},fromTranslation:function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=t[0],e[7]=t[1],e[8]=1,e},fromValues:function(e,r,n,i,s,a,o,u,l){var c=new t(9);return c[0]=e,c[1]=r,c[2]=n,c[3]=i,c[4]=s,c[5]=a,c[6]=o,c[7]=u,c[8]=l,c},identity:function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},invert:function(e,t){var r=t[0],n=t[1],i=t[2],s=t[3],a=t[4],o=t[5],u=t[6],l=t[7],c=t[8],h=c*a-o*l,m=-c*s+o*u,d=l*s-a*u,p=r*h+n*m+i*d;return p?(p=1/p,e[0]=h*p,e[1]=(-c*n+i*l)*p,e[2]=(o*n-i*a)*p,e[3]=m*p,e[4]=(c*r-i*u)*p,e[5]=(-o*r+i*s)*p,e[6]=d*p,e[7]=(-l*r+n*u)*p,e[8]=(a*r-n*s)*p,e):null},mul:h,multiply:multiply$6,multiplyScalar:function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*r,e[5]=t[5]*r,e[6]=t[6]*r,e[7]=t[7]*r,e[8]=t[8]*r,e},multiplyScalarAndAdd:function(e,t,r,n){return e[0]=t[0]+r[0]*n,e[1]=t[1]+r[1]*n,e[2]=t[2]+r[2]*n,e[3]=t[3]+r[3]*n,e[4]=t[4]+r[4]*n,e[5]=t[5]+r[5]*n,e[6]=t[6]+r[6]*n,e[7]=t[7]+r[7]*n,e[8]=t[8]+r[8]*n,e},normalFromMat4:function(e,t){var r=t[0],n=t[1],i=t[2],s=t[3],a=t[4],o=t[5],u=t[6],l=t[7],c=t[8],h=t[9],m=t[10],d=t[11],p=t[12],f=t[13],g=t[14],x=t[15],_=r*o-n*a,v=r*u-i*a,y=r*l-s*a,T=n*u-i*o,b=n*l-s*o,S=i*l-s*u,M=c*f-h*p,R=c*g-m*p,w=c*x-d*p,E=h*g-m*f,P=h*x-d*f,C=m*x-d*g,k=_*C-v*P+y*E+T*w-b*R+S*M;return k?(k=1/k,e[0]=(o*C-u*P+l*E)*k,e[1]=(u*w-a*C-l*R)*k,e[2]=(a*P-o*w+l*M)*k,e[3]=(i*P-n*C-s*E)*k,e[4]=(r*C-i*w+s*R)*k,e[5]=(n*w-r*P-s*M)*k,e[6]=(f*S-g*b+x*T)*k,e[7]=(g*y-p*S-x*v)*k,e[8]=(p*b-f*y+x*_)*k,e):null},projection:function(e,t,r){return e[0]=2/t,e[1]=0,e[2]=0,e[3]=0,e[4]=-2/r,e[5]=0,e[6]=-1,e[7]=1,e[8]=1,e},rotate:function(e,t,r){var n=t[0],i=t[1],s=t[2],a=t[3],o=t[4],u=t[5],l=t[6],c=t[7],h=t[8],m=Math.sin(r),d=Math.cos(r);return e[0]=d*n+m*a,e[1]=d*i+m*o,e[2]=d*s+m*u,e[3]=d*a-m*n,e[4]=d*o-m*i,e[5]=d*u-m*s,e[6]=l,e[7]=c,e[8]=h,e},scale:function(e,t,r){var n=r[0],i=r[1];return e[0]=n*t[0],e[1]=n*t[1],e[2]=n*t[2],e[3]=i*t[3],e[4]=i*t[4],e[5]=i*t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},set:function(e,t,r,n,i,s,a,o,u,l){return e[0]=t,e[1]=r,e[2]=n,e[3]=i,e[4]=s,e[5]=a,e[6]=o,e[7]=u,e[8]=l,e},str:function(e){return"mat3("+e[0]+","+e[1]+","+e[2]+","+e[3]+","+e[4]+","+e[5]+","+e[6]+","+e[7]+","+e[8]+")"},sub:m,subtract:subtract$4,translate:function(e,t,r){var n=t[0],i=t[1],s=t[2],a=t[3],o=t[4],u=t[5],l=t[6],c=t[7],h=t[8],m=r[0],d=r[1];return e[0]=n,e[1]=i,e[2]=s,e[3]=a,e[4]=o,e[5]=u,e[6]=m*n+d*a+l,e[7]=m*i+d*o+c,e[8]=m*s+d*u+h,e},transpose:function(e,t){if(e===t){var r=t[1],n=t[2],i=t[5];e[1]=t[3],e[2]=t[6],e[3]=r,e[5]=t[7],e[6]=n,e[7]=i}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8];return e}});function create$5(){var e=new t(16);return t!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function clone$5(e){var r=new t(16);return r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[4]=e[4],r[5]=e[5],r[6]=e[6],r[7]=e[7],r[8]=e[8],r[9]=e[9],r[10]=e[10],r[11]=e[11],r[12]=e[12],r[13]=e[13],r[14]=e[14],r[15]=e[15],r}function copy$5(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function fromValues$5(e,r,n,i,s,a,o,u,l,c,h,m,d,p,f,g){var x=new t(16);return x[0]=e,x[1]=r,x[2]=n,x[3]=i,x[4]=s,x[5]=a,x[6]=o,x[7]=u,x[8]=l,x[9]=c,x[10]=h,x[11]=m,x[12]=d,x[13]=p,x[14]=f,x[15]=g,x}function identity$2(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function invert$2(e,t){var r=t[0],n=t[1],i=t[2],s=t[3],a=t[4],o=t[5],u=t[6],l=t[7],c=t[8],h=t[9],m=t[10],d=t[11],p=t[12],f=t[13],g=t[14],x=t[15],_=r*o-n*a,v=r*u-i*a,y=r*l-s*a,T=n*u-i*o,b=n*l-s*o,S=i*l-s*u,M=c*f-h*p,R=c*g-m*p,w=c*x-d*p,E=h*g-m*f,P=h*x-d*f,C=m*x-d*g,k=_*C-v*P+y*E+T*w-b*R+S*M;return k?(k=1/k,e[0]=(o*C-u*P+l*E)*k,e[1]=(i*P-n*C-s*E)*k,e[2]=(f*S-g*b+x*T)*k,e[3]=(m*b-h*S-d*T)*k,e[4]=(u*w-a*C-l*R)*k,e[5]=(r*C-i*w+s*R)*k,e[6]=(g*y-p*S-x*v)*k,e[7]=(c*S-m*y+d*v)*k,e[8]=(a*P-o*w+l*M)*k,e[9]=(n*w-r*P-s*M)*k,e[10]=(p*b-f*y+x*_)*k,e[11]=(h*y-c*b-d*_)*k,e[12]=(o*R-a*E-u*M)*k,e[13]=(r*E-n*R+i*M)*k,e[14]=(f*v-p*T-g*_)*k,e[15]=(c*T-h*v+m*_)*k,e):null}function multiply$5(e,t,r){var n=t[0],i=t[1],s=t[2],a=t[3],o=t[4],u=t[5],l=t[6],c=t[7],h=t[8],m=t[9],d=t[10],p=t[11],f=t[12],g=t[13],x=t[14],_=t[15],v=r[0],y=r[1],T=r[2],b=r[3];return e[0]=v*n+y*o+T*h+b*f,e[1]=v*i+y*u+T*m+b*g,e[2]=v*s+y*l+T*d+b*x,e[3]=v*a+y*c+T*p+b*_,v=r[4],y=r[5],T=r[6],b=r[7],e[4]=v*n+y*o+T*h+b*f,e[5]=v*i+y*u+T*m+b*g,e[6]=v*s+y*l+T*d+b*x,e[7]=v*a+y*c+T*p+b*_,v=r[8],y=r[9],T=r[10],b=r[11],e[8]=v*n+y*o+T*h+b*f,e[9]=v*i+y*u+T*m+b*g,e[10]=v*s+y*l+T*d+b*x,e[11]=v*a+y*c+T*p+b*_,v=r[12],y=r[13],T=r[14],b=r[15],e[12]=v*n+y*o+T*h+b*f,e[13]=v*i+y*u+T*m+b*g,e[14]=v*s+y*l+T*d+b*x,e[15]=v*a+y*c+T*p+b*_,e}function translate$1(e,t,r){var n,i,s,a,o,u,l,c,h,m,d,p,f=r[0],g=r[1],x=r[2];return t===e?(e[12]=t[0]*f+t[4]*g+t[8]*x+t[12],e[13]=t[1]*f+t[5]*g+t[9]*x+t[13],e[14]=t[2]*f+t[6]*g+t[10]*x+t[14],e[15]=t[3]*f+t[7]*g+t[11]*x+t[15]):(n=t[0],i=t[1],s=t[2],a=t[3],o=t[4],u=t[5],l=t[6],c=t[7],h=t[8],m=t[9],d=t[10],p=t[11],e[0]=n,e[1]=i,e[2]=s,e[3]=a,e[4]=o,e[5]=u,e[6]=l,e[7]=c,e[8]=h,e[9]=m,e[10]=d,e[11]=p,e[12]=n*f+o*g+h*x+t[12],e[13]=i*f+u*g+m*x+t[13],e[14]=s*f+l*g+d*x+t[14],e[15]=a*f+c*g+p*x+t[15]),e}function scale$5(e,t,r){var n=r[0],i=r[1],s=r[2];return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e[4]=t[4]*i,e[5]=t[5]*i,e[6]=t[6]*i,e[7]=t[7]*i,e[8]=t[8]*s,e[9]=t[9]*s,e[10]=t[10]*s,e[11]=t[11]*s,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function rotateX$3(e,t,r){var n=Math.sin(r),i=Math.cos(r),s=t[4],a=t[5],o=t[6],u=t[7],l=t[8],c=t[9],h=t[10],m=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=s*i+l*n,e[5]=a*i+c*n,e[6]=o*i+h*n,e[7]=u*i+m*n,e[8]=l*i-s*n,e[9]=c*i-a*n,e[10]=h*i-o*n,e[11]=m*i-u*n,e}function rotateY$3(e,t,r){var n=Math.sin(r),i=Math.cos(r),s=t[0],a=t[1],o=t[2],u=t[3],l=t[8],c=t[9],h=t[10],m=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=s*i-l*n,e[1]=a*i-c*n,e[2]=o*i-h*n,e[3]=u*i-m*n,e[8]=s*n+l*i,e[9]=a*n+c*i,e[10]=o*n+h*i,e[11]=u*n+m*i,e}function rotateZ$3(e,t,r){var n=Math.sin(r),i=Math.cos(r),s=t[0],a=t[1],o=t[2],u=t[3],l=t[4],c=t[5],h=t[6],m=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=s*i+l*n,e[1]=a*i+c*n,e[2]=o*i+h*n,e[3]=u*i+m*n,e[4]=l*i-s*n,e[5]=c*i-a*n,e[6]=h*i-o*n,e[7]=m*i-u*n,e}function fromRotationTranslation$1(e,t,r){var n=t[0],i=t[1],s=t[2],a=t[3],o=n+n,u=i+i,l=s+s,c=n*o,h=n*u,m=n*l,d=i*u,p=i*l,f=s*l,g=a*o,x=a*u,_=a*l;return e[0]=1-(d+f),e[1]=h+_,e[2]=m-x,e[3]=0,e[4]=h-_,e[5]=1-(c+f),e[6]=p+g,e[7]=0,e[8]=m+x,e[9]=p-g,e[10]=1-(c+d),e[11]=0,e[12]=r[0],e[13]=r[1],e[14]=r[2],e[15]=1,e}function getTranslation$1(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e}function getScaling(e,t){var r=t[0],n=t[1],i=t[2],s=t[4],a=t[5],o=t[6],u=t[8],l=t[9],c=t[10];return e[0]=Math.hypot(r,n,i),e[1]=Math.hypot(s,a,o),e[2]=Math.hypot(u,l,c),e}function getRotation(e,r){var n=new t(3);getScaling(n,r);var i=1/n[0],s=1/n[1],a=1/n[2],o=r[0]*i,u=r[1]*s,l=r[2]*a,c=r[4]*i,h=r[5]*s,m=r[6]*a,d=r[8]*i,p=r[9]*s,f=r[10]*a,g=o+h+f,x=0;return g>0?(x=2*Math.sqrt(g+1),e[3]=.25*x,e[0]=(m-p)/x,e[1]=(d-l)/x,e[2]=(u-c)/x):o>h&&o>f?(x=2*Math.sqrt(1+o-h-f),e[3]=(m-p)/x,e[0]=.25*x,e[1]=(u+c)/x,e[2]=(d+l)/x):h>f?(x=2*Math.sqrt(1+h-o-f),e[3]=(d-l)/x,e[0]=(u+c)/x,e[1]=.25*x,e[2]=(m+p)/x):(x=2*Math.sqrt(1+f-o-h),e[3]=(u-c)/x,e[0]=(d+l)/x,e[1]=(m+p)/x,e[2]=.25*x),e}function perspectiveNO(e,t,r,n,i){var s,a=1/Math.tan(t/2);return e[0]=a/r,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=a,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=i&&i!==1/0?(s=1/(n-i),e[10]=(i+n)*s,e[14]=2*i*n*s):(e[10]=-1,e[14]=-2*n),e}var p=perspectiveNO;function orthoNO(e,t,r,n,i,s,a){var o=1/(t-r),u=1/(n-i),l=1/(s-a);return e[0]=-2*o,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*u,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*l,e[11]=0,e[12]=(t+r)*o,e[13]=(i+n)*u,e[14]=(a+s)*l,e[15]=1,e}var f=orthoNO;function orthoZO(e,t,r,n,i,s,a){var o=1/(t-r),u=1/(n-i),l=1/(s-a);return e[0]=-2*o,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*u,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=l,e[11]=0,e[12]=(t+r)*o,e[13]=(i+n)*u,e[14]=s*l,e[15]=1,e}function lookAt(t,r,n,i){var s,a,o,u,l,c,h,m,d,p,f=r[0],g=r[1],x=r[2],_=i[0],v=i[1],y=i[2],T=n[0],b=n[1],S=n[2];return Math.abs(f-T)<e&&Math.abs(g-b)<e&&Math.abs(x-S)<e?identity$2(t):(h=f-T,m=g-b,d=x-S,s=v*(d*=p=1/Math.hypot(h,m,d))-y*(m*=p),a=y*(h*=p)-_*d,o=_*m-v*h,(p=Math.hypot(s,a,o))?(s*=p=1/p,a*=p,o*=p):(s=0,a=0,o=0),u=m*o-d*a,l=d*s-h*o,c=h*a-m*s,(p=Math.hypot(u,l,c))?(u*=p=1/p,l*=p,c*=p):(u=0,l=0,c=0),t[0]=s,t[1]=u,t[2]=h,t[3]=0,t[4]=a,t[5]=l,t[6]=m,t[7]=0,t[8]=o,t[9]=c,t[10]=d,t[11]=0,t[12]=-(s*f+a*g+o*x),t[13]=-(u*f+l*g+c*x),t[14]=-(h*f+m*g+d*x),t[15]=1,t)}function subtract$3(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e[3]=t[3]-r[3],e[4]=t[4]-r[4],e[5]=t[5]-r[5],e[6]=t[6]-r[6],e[7]=t[7]-r[7],e[8]=t[8]-r[8],e[9]=t[9]-r[9],e[10]=t[10]-r[10],e[11]=t[11]-r[11],e[12]=t[12]-r[12],e[13]=t[13]-r[13],e[14]=t[14]-r[14],e[15]=t[15]-r[15],e}var g=multiply$5,x=subtract$3,_=Object.freeze({__proto__:null,add:function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e[4]=t[4]+r[4],e[5]=t[5]+r[5],e[6]=t[6]+r[6],e[7]=t[7]+r[7],e[8]=t[8]+r[8],e[9]=t[9]+r[9],e[10]=t[10]+r[10],e[11]=t[11]+r[11],e[12]=t[12]+r[12],e[13]=t[13]+r[13],e[14]=t[14]+r[14],e[15]=t[15]+r[15],e},adjoint:function(e,t){var r=t[0],n=t[1],i=t[2],s=t[3],a=t[4],o=t[5],u=t[6],l=t[7],c=t[8],h=t[9],m=t[10],d=t[11],p=t[12],f=t[13],g=t[14],x=t[15];return e[0]=o*(m*x-d*g)-h*(u*x-l*g)+f*(u*d-l*m),e[1]=-(n*(m*x-d*g)-h*(i*x-s*g)+f*(i*d-s*m)),e[2]=n*(u*x-l*g)-o*(i*x-s*g)+f*(i*l-s*u),e[3]=-(n*(u*d-l*m)-o*(i*d-s*m)+h*(i*l-s*u)),e[4]=-(a*(m*x-d*g)-c*(u*x-l*g)+p*(u*d-l*m)),e[5]=r*(m*x-d*g)-c*(i*x-s*g)+p*(i*d-s*m),e[6]=-(r*(u*x-l*g)-a*(i*x-s*g)+p*(i*l-s*u)),e[7]=r*(u*d-l*m)-a*(i*d-s*m)+c*(i*l-s*u),e[8]=a*(h*x-d*f)-c*(o*x-l*f)+p*(o*d-l*h),e[9]=-(r*(h*x-d*f)-c*(n*x-s*f)+p*(n*d-s*h)),e[10]=r*(o*x-l*f)-a*(n*x-s*f)+p*(n*l-s*o),e[11]=-(r*(o*d-l*h)-a*(n*d-s*h)+c*(n*l-s*o)),e[12]=-(a*(h*g-m*f)-c*(o*g-u*f)+p*(o*m-u*h)),e[13]=r*(h*g-m*f)-c*(n*g-i*f)+p*(n*m-i*h),e[14]=-(r*(o*g-u*f)-a*(n*g-i*f)+p*(n*u-i*o)),e[15]=r*(o*m-u*h)-a*(n*m-i*h)+c*(n*u-i*o),e},clone:clone$5,copy:copy$5,create:create$5,determinant:function(e){var t=e[0],r=e[1],n=e[2],i=e[3],s=e[4],a=e[5],o=e[6],u=e[7],l=e[8],c=e[9],h=e[10],m=e[11],d=e[12],p=e[13],f=e[14],g=e[15];return(t*a-r*s)*(h*g-m*f)-(t*o-n*s)*(c*g-m*p)+(t*u-i*s)*(c*f-h*p)+(r*o-n*a)*(l*g-m*d)-(r*u-i*a)*(l*f-h*d)+(n*u-i*o)*(l*p-c*d)},equals:function(t,r){var n=t[0],i=t[1],s=t[2],a=t[3],o=t[4],u=t[5],l=t[6],c=t[7],h=t[8],m=t[9],d=t[10],p=t[11],f=t[12],g=t[13],x=t[14],_=t[15],v=r[0],y=r[1],T=r[2],b=r[3],S=r[4],M=r[5],R=r[6],w=r[7],E=r[8],P=r[9],C=r[10],k=r[11],I=r[12],U=r[13],B=r[14],L=r[15];return Math.abs(n-v)<=e*Math.max(1,Math.abs(n),Math.abs(v))&&Math.abs(i-y)<=e*Math.max(1,Math.abs(i),Math.abs(y))&&Math.abs(s-T)<=e*Math.max(1,Math.abs(s),Math.abs(T))&&Math.abs(a-b)<=e*Math.max(1,Math.abs(a),Math.abs(b))&&Math.abs(o-S)<=e*Math.max(1,Math.abs(o),Math.abs(S))&&Math.abs(u-M)<=e*Math.max(1,Math.abs(u),Math.abs(M))&&Math.abs(l-R)<=e*Math.max(1,Math.abs(l),Math.abs(R))&&Math.abs(c-w)<=e*Math.max(1,Math.abs(c),Math.abs(w))&&Math.abs(h-E)<=e*Math.max(1,Math.abs(h),Math.abs(E))&&Math.abs(m-P)<=e*Math.max(1,Math.abs(m),Math.abs(P))&&Math.abs(d-C)<=e*Math.max(1,Math.abs(d),Math.abs(C))&&Math.abs(p-k)<=e*Math.max(1,Math.abs(p),Math.abs(k))&&Math.abs(f-I)<=e*Math.max(1,Math.abs(f),Math.abs(I))&&Math.abs(g-U)<=e*Math.max(1,Math.abs(g),Math.abs(U))&&Math.abs(x-B)<=e*Math.max(1,Math.abs(x),Math.abs(B))&&Math.abs(_-L)<=e*Math.max(1,Math.abs(_),Math.abs(L))},exactEquals:function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]&&e[9]===t[9]&&e[10]===t[10]&&e[11]===t[11]&&e[12]===t[12]&&e[13]===t[13]&&e[14]===t[14]&&e[15]===t[15]},frob:function(e){return Math.hypot(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])},fromQuat:function(e,t){var r=t[0],n=t[1],i=t[2],s=t[3],a=r+r,o=n+n,u=i+i,l=r*a,c=n*a,h=n*o,m=i*a,d=i*o,p=i*u,f=s*a,g=s*o,x=s*u;return e[0]=1-h-p,e[1]=c+x,e[2]=m-g,e[3]=0,e[4]=c-x,e[5]=1-l-p,e[6]=d+f,e[7]=0,e[8]=m+g,e[9]=d-f,e[10]=1-l-h,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},fromQuat2:function(e,r){var n=new t(3),i=-r[0],s=-r[1],a=-r[2],o=r[3],u=r[4],l=r[5],c=r[6],h=r[7],m=i*i+s*s+a*a+o*o;return m>0?(n[0]=2*(u*o+h*i+l*a-c*s)/m,n[1]=2*(l*o+h*s+c*i-u*a)/m,n[2]=2*(c*o+h*a+u*s-l*i)/m):(n[0]=2*(u*o+h*i+l*a-c*s),n[1]=2*(l*o+h*s+c*i-u*a),n[2]=2*(c*o+h*a+u*s-l*i)),fromRotationTranslation$1(e,r,n),e},fromRotation:function(t,r,n){var i,s,a,o=n[0],u=n[1],l=n[2],c=Math.hypot(o,u,l);return c<e?null:(o*=c=1/c,u*=c,l*=c,i=Math.sin(r),a=1-(s=Math.cos(r)),t[0]=o*o*a+s,t[1]=u*o*a+l*i,t[2]=l*o*a-u*i,t[3]=0,t[4]=o*u*a-l*i,t[5]=u*u*a+s,t[6]=l*u*a+o*i,t[7]=0,t[8]=o*l*a+u*i,t[9]=u*l*a-o*i,t[10]=l*l*a+s,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t)},fromRotationTranslation:fromRotationTranslation$1,fromRotationTranslationScale:function(e,t,r,n){var i=t[0],s=t[1],a=t[2],o=t[3],u=i+i,l=s+s,c=a+a,h=i*u,m=i*l,d=i*c,p=s*l,f=s*c,g=a*c,x=o*u,_=o*l,v=o*c,y=n[0],T=n[1],b=n[2];return e[0]=(1-(p+g))*y,e[1]=(m+v)*y,e[2]=(d-_)*y,e[3]=0,e[4]=(m-v)*T,e[5]=(1-(h+g))*T,e[6]=(f+x)*T,e[7]=0,e[8]=(d+_)*b,e[9]=(f-x)*b,e[10]=(1-(h+p))*b,e[11]=0,e[12]=r[0],e[13]=r[1],e[14]=r[2],e[15]=1,e},fromRotationTranslationScaleOrigin:function(e,t,r,n,i){var s=t[0],a=t[1],o=t[2],u=t[3],l=s+s,c=a+a,h=o+o,m=s*l,d=s*c,p=s*h,f=a*c,g=a*h,x=o*h,_=u*l,v=u*c,y=u*h,T=n[0],b=n[1],S=n[2],M=i[0],R=i[1],w=i[2],E=(1-(f+x))*T,P=(d+y)*T,C=(p-v)*T,k=(d-y)*b,I=(1-(m+x))*b,U=(g+_)*b,B=(p+v)*S,L=(g-_)*S,A=(1-(m+f))*S;return e[0]=E,e[1]=P,e[2]=C,e[3]=0,e[4]=k,e[5]=I,e[6]=U,e[7]=0,e[8]=B,e[9]=L,e[10]=A,e[11]=0,e[12]=r[0]+M-(E*M+k*R+B*w),e[13]=r[1]+R-(P*M+I*R+L*w),e[14]=r[2]+w-(C*M+U*R+A*w),e[15]=1,e},fromScaling:function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},fromTranslation:function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e},fromValues:fromValues$5,fromXRotation:function(e,t){var r=Math.sin(t),n=Math.cos(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=n,e[6]=r,e[7]=0,e[8]=0,e[9]=-r,e[10]=n,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},fromYRotation:function(e,t){var r=Math.sin(t),n=Math.cos(t);return e[0]=n,e[1]=0,e[2]=-r,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=r,e[9]=0,e[10]=n,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},fromZRotation:function(e,t){var r=Math.sin(t),n=Math.cos(t);return e[0]=n,e[1]=r,e[2]=0,e[3]=0,e[4]=-r,e[5]=n,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},frustum:function(e,t,r,n,i,s,a){var o=1/(r-t),u=1/(i-n),l=1/(s-a);return e[0]=2*s*o,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=2*s*u,e[6]=0,e[7]=0,e[8]=(r+t)*o,e[9]=(i+n)*u,e[10]=(a+s)*l,e[11]=-1,e[12]=0,e[13]=0,e[14]=a*s*2*l,e[15]=0,e},getRotation:getRotation,getScaling:getScaling,getTranslation:getTranslation$1,identity:identity$2,invert:invert$2,lookAt:lookAt,mul:g,multiply:multiply$5,multiplyScalar:function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*r,e[5]=t[5]*r,e[6]=t[6]*r,e[7]=t[7]*r,e[8]=t[8]*r,e[9]=t[9]*r,e[10]=t[10]*r,e[11]=t[11]*r,e[12]=t[12]*r,e[13]=t[13]*r,e[14]=t[14]*r,e[15]=t[15]*r,e},multiplyScalarAndAdd:function(e,t,r,n){return e[0]=t[0]+r[0]*n,e[1]=t[1]+r[1]*n,e[2]=t[2]+r[2]*n,e[3]=t[3]+r[3]*n,e[4]=t[4]+r[4]*n,e[5]=t[5]+r[5]*n,e[6]=t[6]+r[6]*n,e[7]=t[7]+r[7]*n,e[8]=t[8]+r[8]*n,e[9]=t[9]+r[9]*n,e[10]=t[10]+r[10]*n,e[11]=t[11]+r[11]*n,e[12]=t[12]+r[12]*n,e[13]=t[13]+r[13]*n,e[14]=t[14]+r[14]*n,e[15]=t[15]+r[15]*n,e},ortho:f,orthoNO:orthoNO,orthoZO:orthoZO,perspective:p,perspectiveFromFieldOfView:function(e,t,r,n){var i=Math.tan(t.upDegrees*Math.PI/180),s=Math.tan(t.downDegrees*Math.PI/180),a=Math.tan(t.leftDegrees*Math.PI/180),o=Math.tan(t.rightDegrees*Math.PI/180),u=2/(a+o),l=2/(i+s);return e[0]=u,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=l,e[6]=0,e[7]=0,e[8]=-(a-o)*u*.5,e[9]=(i-s)*l*.5,e[10]=n/(r-n),e[11]=-1,e[12]=0,e[13]=0,e[14]=n*r/(r-n),e[15]=0,e},perspectiveNO:perspectiveNO,perspectiveZO:function(e,t,r,n,i){var s,a=1/Math.tan(t/2);return e[0]=a/r,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=a,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=i&&i!==1/0?(s=1/(n-i),e[10]=i*s,e[14]=i*n*s):(e[10]=-1,e[14]=-n),e},rotate:function(t,r,n,i){var s,a,o,u,l,c,h,m,d,p,f,g,x,_,v,y,T,b,S,M,R,w,E,P,C=i[0],k=i[1],I=i[2],U=Math.hypot(C,k,I);return U<e?null:(C*=U=1/U,k*=U,I*=U,s=Math.sin(n),o=1-(a=Math.cos(n)),u=r[0],l=r[1],c=r[2],h=r[3],m=r[4],d=r[5],p=r[6],f=r[7],g=r[8],x=r[9],_=r[10],v=r[11],y=C*C*o+a,T=k*C*o+I*s,b=I*C*o-k*s,S=C*k*o-I*s,M=k*k*o+a,R=I*k*o+C*s,w=C*I*o+k*s,E=k*I*o-C*s,P=I*I*o+a,t[0]=u*y+m*T+g*b,t[1]=l*y+d*T+x*b,t[2]=c*y+p*T+_*b,t[3]=h*y+f*T+v*b,t[4]=u*S+m*M+g*R,t[5]=l*S+d*M+x*R,t[6]=c*S+p*M+_*R,t[7]=h*S+f*M+v*R,t[8]=u*w+m*E+g*P,t[9]=l*w+d*E+x*P,t[10]=c*w+p*E+_*P,t[11]=h*w+f*E+v*P,r!==t&&(t[12]=r[12],t[13]=r[13],t[14]=r[14],t[15]=r[15]),t)},rotateX:rotateX$3,rotateY:rotateY$3,rotateZ:rotateZ$3,scale:scale$5,set:function(e,t,r,n,i,s,a,o,u,l,c,h,m,d,p,f,g){return e[0]=t,e[1]=r,e[2]=n,e[3]=i,e[4]=s,e[5]=a,e[6]=o,e[7]=u,e[8]=l,e[9]=c,e[10]=h,e[11]=m,e[12]=d,e[13]=p,e[14]=f,e[15]=g,e},str:function(e){return"mat4("+e[0]+","+e[1]+","+e[2]+","+e[3]+","+e[4]+","+e[5]+","+e[6]+","+e[7]+","+e[8]+","+e[9]+","+e[10]+","+e[11]+","+e[12]+","+e[13]+","+e[14]+","+e[15]+")"},sub:x,subtract:subtract$3,targetTo:function(e,t,r,n){var i=t[0],s=t[1],a=t[2],o=n[0],u=n[1],l=n[2],c=i-r[0],h=s-r[1],m=a-r[2],d=c*c+h*h+m*m;d>0&&(c*=d=1/Math.sqrt(d),h*=d,m*=d);var p=u*m-l*h,f=l*c-o*m,g=o*h-u*c;return(d=p*p+f*f+g*g)>0&&(p*=d=1/Math.sqrt(d),f*=d,g*=d),e[0]=p,e[1]=f,e[2]=g,e[3]=0,e[4]=h*g-m*f,e[5]=m*p-c*g,e[6]=c*f-h*p,e[7]=0,e[8]=c,e[9]=h,e[10]=m,e[11]=0,e[12]=i,e[13]=s,e[14]=a,e[15]=1,e},translate:translate$1,transpose:function(e,t){if(e===t){var r=t[1],n=t[2],i=t[3],s=t[6],a=t[7],o=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=r,e[6]=t[9],e[7]=t[13],e[8]=n,e[9]=s,e[11]=t[14],e[12]=i,e[13]=a,e[14]=o}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15];return e}});function create$4(){var e=new t(3);return t!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function length$4(e){var t=e[0],r=e[1],n=e[2];return Math.hypot(t,r,n)}function fromValues$4(e,r,n){var i=new t(3);return i[0]=e,i[1]=r,i[2]=n,i}function set$4(e,t,r,n){return e[0]=t,e[1]=r,e[2]=n,e}function subtract$2(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e}function multiply$4(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e[2]=t[2]*r[2],e}function divide$2(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e[2]=t[2]/r[2],e}function distance$2(e,t){var r=t[0]-e[0],n=t[1]-e[1],i=t[2]-e[2];return Math.hypot(r,n,i)}function squaredDistance$2(e,t){var r=t[0]-e[0],n=t[1]-e[1],i=t[2]-e[2];return r*r+n*n+i*i}function squaredLength$4(e){var t=e[0],r=e[1],n=e[2];return t*t+r*r+n*n}function normalize$4(e,t){var r=t[0],n=t[1],i=t[2],s=r*r+n*n+i*i;return s>0&&(s=1/Math.sqrt(s)),e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s,e}function dot$4(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function cross$2(e,t,r){var n=t[0],i=t[1],s=t[2],a=r[0],o=r[1],u=r[2];return e[0]=i*u-s*o,e[1]=s*a-n*u,e[2]=n*o-i*a,e}function lerp$4(e,t,r,n){var i=t[0],s=t[1],a=t[2];return e[0]=i+n*(r[0]-i),e[1]=s+n*(r[1]-s),e[2]=a+n*(r[2]-a),e}var v,y=subtract$2,T=multiply$4,b=divide$2,S=distance$2,M=squaredDistance$2,R=length$4,w=squaredLength$4,E=(v=create$4(),function(e,t,r,n,i,s){var a,o;for(t||(t=3),r||(r=0),o=n?Math.min(n*t+r,e.length):e.length,a=r;a<o;a+=t)v[0]=e[a],v[1]=e[a+1],v[2]=e[a+2],i(v,v,s),e[a]=v[0],e[a+1]=v[1],e[a+2]=v[2];return e}),P=Object.freeze({__proto__:null,add:function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e},angle:function(e,t){var r=e[0],n=e[1],i=e[2],s=t[0],a=t[1],o=t[2],u=Math.sqrt(r*r+n*n+i*i)*Math.sqrt(s*s+a*a+o*o),l=u&&dot$4(e,t)/u;return Math.acos(Math.min(Math.max(l,-1),1))},bezier:function(e,t,r,n,i,s){var a=1-s,o=a*a,u=s*s,l=o*a,c=3*s*o,h=3*u*a,m=u*s;return e[0]=t[0]*l+r[0]*c+n[0]*h+i[0]*m,e[1]=t[1]*l+r[1]*c+n[1]*h+i[1]*m,e[2]=t[2]*l+r[2]*c+n[2]*h+i[2]*m,e},ceil:function(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e},clone:function(e){var r=new t(3);return r[0]=e[0],r[1]=e[1],r[2]=e[2],r},copy:function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},create:create$4,cross:cross$2,dist:S,distance:distance$2,div:b,divide:divide$2,dot:dot$4,equals:function(t,r){var n=t[0],i=t[1],s=t[2],a=r[0],o=r[1],u=r[2];return Math.abs(n-a)<=e*Math.max(1,Math.abs(n),Math.abs(a))&&Math.abs(i-o)<=e*Math.max(1,Math.abs(i),Math.abs(o))&&Math.abs(s-u)<=e*Math.max(1,Math.abs(s),Math.abs(u))},exactEquals:function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]},floor:function(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e},forEach:E,fromValues:fromValues$4,hermite:function(e,t,r,n,i,s){var a=s*s,o=a*(2*s-3)+1,u=a*(s-2)+s,l=a*(s-1),c=a*(3-2*s);return e[0]=t[0]*o+r[0]*u+n[0]*l+i[0]*c,e[1]=t[1]*o+r[1]*u+n[1]*l+i[1]*c,e[2]=t[2]*o+r[2]*u+n[2]*l+i[2]*c,e},inverse:function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e},len:R,length:length$4,lerp:lerp$4,max:function(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e[2]=Math.max(t[2],r[2]),e},min:function(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e[2]=Math.min(t[2],r[2]),e},mul:T,multiply:multiply$4,negate:function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e},normalize:normalize$4,random:function(e,t){t=t||1;var n=2*r()*Math.PI,i=2*r()-1,s=Math.sqrt(1-i*i)*t;return e[0]=Math.cos(n)*s,e[1]=Math.sin(n)*s,e[2]=i*t,e},rotateX:function(e,t,r,n){var i=[],s=[];return i[0]=t[0]-r[0],i[1]=t[1]-r[1],i[2]=t[2]-r[2],s[0]=i[0],s[1]=i[1]*Math.cos(n)-i[2]*Math.sin(n),s[2]=i[1]*Math.sin(n)+i[2]*Math.cos(n),e[0]=s[0]+r[0],e[1]=s[1]+r[1],e[2]=s[2]+r[2],e},rotateY:function(e,t,r,n){var i=[],s=[];return i[0]=t[0]-r[0],i[1]=t[1]-r[1],i[2]=t[2]-r[2],s[0]=i[2]*Math.sin(n)+i[0]*Math.cos(n),s[1]=i[1],s[2]=i[2]*Math.cos(n)-i[0]*Math.sin(n),e[0]=s[0]+r[0],e[1]=s[1]+r[1],e[2]=s[2]+r[2],e},rotateZ:function(e,t,r,n){var i=[],s=[];return i[0]=t[0]-r[0],i[1]=t[1]-r[1],i[2]=t[2]-r[2],s[0]=i[0]*Math.cos(n)-i[1]*Math.sin(n),s[1]=i[0]*Math.sin(n)+i[1]*Math.cos(n),s[2]=i[2],e[0]=s[0]+r[0],e[1]=s[1]+r[1],e[2]=s[2]+r[2],e},round:function(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e},scale:function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e},scaleAndAdd:function(e,t,r,n){return e[0]=t[0]+r[0]*n,e[1]=t[1]+r[1]*n,e[2]=t[2]+r[2]*n,e},set:set$4,sqrDist:M,sqrLen:w,squaredDistance:squaredDistance$2,squaredLength:squaredLength$4,str:function(e){return"vec3("+e[0]+","+e[1]+","+e[2]+")"},sub:y,subtract:subtract$2,transformMat3:function(e,t,r){var n=t[0],i=t[1],s=t[2];return e[0]=n*r[0]+i*r[3]+s*r[6],e[1]=n*r[1]+i*r[4]+s*r[7],e[2]=n*r[2]+i*r[5]+s*r[8],e},transformMat4:function(e,t,r){var n=t[0],i=t[1],s=t[2],a=r[3]*n+r[7]*i+r[11]*s+r[15];return a=a||1,e[0]=(r[0]*n+r[4]*i+r[8]*s+r[12])/a,e[1]=(r[1]*n+r[5]*i+r[9]*s+r[13])/a,e[2]=(r[2]*n+r[6]*i+r[10]*s+r[14])/a,e},transformQuat:function(e,t,r){var n=r[0],i=r[1],s=r[2],a=r[3],o=t[0],u=t[1],l=t[2],c=i*l-s*u,h=s*o-n*l,m=n*u-i*o,d=i*m-s*h,p=s*c-n*m,f=n*h-i*c,g=2*a;return c*=g,h*=g,m*=g,d*=2,p*=2,f*=2,e[0]=o+c+d,e[1]=u+h+p,e[2]=l+m+f,e},zero:function(e){return e[0]=0,e[1]=0,e[2]=0,e}});function create$3(){var e=new t(4);return t!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function clone$3(e){var r=new t(4);return r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r}function fromValues$3(e,r,n,i){var s=new t(4);return s[0]=e,s[1]=r,s[2]=n,s[3]=i,s}function copy$3(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function set$3(e,t,r,n,i){return e[0]=t,e[1]=r,e[2]=n,e[3]=i,e}function add$3(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e}function subtract$1(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e[3]=t[3]-r[3],e}function multiply$3(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e[2]=t[2]*r[2],e[3]=t[3]*r[3],e}function divide$1(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e[2]=t[2]/r[2],e[3]=t[3]/r[3],e}function scale$3(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e}function distance$1(e,t){var r=t[0]-e[0],n=t[1]-e[1],i=t[2]-e[2],s=t[3]-e[3];return Math.hypot(r,n,i,s)}function squaredDistance$1(e,t){var r=t[0]-e[0],n=t[1]-e[1],i=t[2]-e[2],s=t[3]-e[3];return r*r+n*n+i*i+s*s}function length$3(e){var t=e[0],r=e[1],n=e[2],i=e[3];return Math.hypot(t,r,n,i)}function squaredLength$3(e){var t=e[0],r=e[1],n=e[2],i=e[3];return t*t+r*r+n*n+i*i}function normalize$3(e,t){var r=t[0],n=t[1],i=t[2],s=t[3],a=r*r+n*n+i*i+s*s;return a>0&&(a=1/Math.sqrt(a)),e[0]=r*a,e[1]=n*a,e[2]=i*a,e[3]=s*a,e}function dot$3(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]}function lerp$3(e,t,r,n){var i=t[0],s=t[1],a=t[2],o=t[3];return e[0]=i+n*(r[0]-i),e[1]=s+n*(r[1]-s),e[2]=a+n*(r[2]-a),e[3]=o+n*(r[3]-o),e}function exactEquals$3(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]}function equals$3(t,r){var n=t[0],i=t[1],s=t[2],a=t[3],o=r[0],u=r[1],l=r[2],c=r[3];return Math.abs(n-o)<=e*Math.max(1,Math.abs(n),Math.abs(o))&&Math.abs(i-u)<=e*Math.max(1,Math.abs(i),Math.abs(u))&&Math.abs(s-l)<=e*Math.max(1,Math.abs(s),Math.abs(l))&&Math.abs(a-c)<=e*Math.max(1,Math.abs(a),Math.abs(c))}var C=subtract$1,k=multiply$3,I=divide$1,U=distance$1,B=squaredDistance$1,L=length$3,A=squaredLength$3,D=function(){var e=create$3();return function(t,r,n,i,s,a){var o,u;for(r||(r=4),n||(n=0),u=i?Math.min(i*r+n,t.length):t.length,o=n;o<u;o+=r)e[0]=t[o],e[1]=t[o+1],e[2]=t[o+2],e[3]=t[o+3],s(e,e,a),t[o]=e[0],t[o+1]=e[1],t[o+2]=e[2],t[o+3]=e[3];return t}}(),O=Object.freeze({__proto__:null,add:add$3,ceil:function(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e[3]=Math.ceil(t[3]),e},clone:clone$3,copy:copy$3,create:create$3,cross:function(e,t,r,n){var i=r[0]*n[1]-r[1]*n[0],s=r[0]*n[2]-r[2]*n[0],a=r[0]*n[3]-r[3]*n[0],o=r[1]*n[2]-r[2]*n[1],u=r[1]*n[3]-r[3]*n[1],l=r[2]*n[3]-r[3]*n[2],c=t[0],h=t[1],m=t[2],d=t[3];return e[0]=h*l-m*u+d*o,e[1]=-c*l+m*a-d*s,e[2]=c*u-h*a+d*i,e[3]=-c*o+h*s-m*i,e},dist:U,distance:distance$1,div:I,divide:divide$1,dot:dot$3,equals:equals$3,exactEquals:exactEquals$3,floor:function(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e[3]=Math.floor(t[3]),e},forEach:D,fromValues:fromValues$3,inverse:function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e[3]=1/t[3],e},len:L,length:length$3,lerp:lerp$3,max:function(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e[2]=Math.max(t[2],r[2]),e[3]=Math.max(t[3],r[3]),e},min:function(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e[2]=Math.min(t[2],r[2]),e[3]=Math.min(t[3],r[3]),e},mul:k,multiply:multiply$3,negate:function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e},normalize:normalize$3,random:function(e,t){var n,i,s,a,o,u;t=t||1;do{o=(n=2*r()-1)*n+(i=2*r()-1)*i}while(o>=1);do{u=(s=2*r()-1)*s+(a=2*r()-1)*a}while(u>=1);var l=Math.sqrt((1-o)/u);return e[0]=t*n,e[1]=t*i,e[2]=t*s*l,e[3]=t*a*l,e},round:function(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e[3]=Math.round(t[3]),e},scale:scale$3,scaleAndAdd:function(e,t,r,n){return e[0]=t[0]+r[0]*n,e[1]=t[1]+r[1]*n,e[2]=t[2]+r[2]*n,e[3]=t[3]+r[3]*n,e},set:set$3,sqrDist:B,sqrLen:A,squaredDistance:squaredDistance$1,squaredLength:squaredLength$3,str:function(e){return"vec4("+e[0]+","+e[1]+","+e[2]+","+e[3]+")"},sub:C,subtract:subtract$1,transformMat4:function(e,t,r){var n=t[0],i=t[1],s=t[2],a=t[3];return e[0]=r[0]*n+r[4]*i+r[8]*s+r[12]*a,e[1]=r[1]*n+r[5]*i+r[9]*s+r[13]*a,e[2]=r[2]*n+r[6]*i+r[10]*s+r[14]*a,e[3]=r[3]*n+r[7]*i+r[11]*s+r[15]*a,e},transformQuat:function(e,t,r){var n=t[0],i=t[1],s=t[2],a=r[0],o=r[1],u=r[2],l=r[3],c=l*n+o*s-u*i,h=l*i+u*n-a*s,m=l*s+a*i-o*n,d=-a*n-o*i-u*s;return e[0]=c*l+d*-a+h*-u-m*-o,e[1]=h*l+d*-o+m*-a-c*-u,e[2]=m*l+d*-u+c*-o-h*-a,e[3]=t[3],e},zero:function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=0,e}});function create$2(){var e=new t(4);return t!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function setAxisAngle(e,t,r){r*=.5;var n=Math.sin(r);return e[0]=n*t[0],e[1]=n*t[1],e[2]=n*t[2],e[3]=Math.cos(r),e}function multiply$2(e,t,r){var n=t[0],i=t[1],s=t[2],a=t[3],o=r[0],u=r[1],l=r[2],c=r[3];return e[0]=n*c+a*o+i*l-s*u,e[1]=i*c+a*u+s*o-n*l,e[2]=s*c+a*l+n*u-i*o,e[3]=a*c-n*o-i*u-s*l,e}function rotateX$1(e,t,r){r*=.5;var n=t[0],i=t[1],s=t[2],a=t[3],o=Math.sin(r),u=Math.cos(r);return e[0]=n*u+a*o,e[1]=i*u+s*o,e[2]=s*u-i*o,e[3]=a*u-n*o,e}function rotateY$1(e,t,r){r*=.5;var n=t[0],i=t[1],s=t[2],a=t[3],o=Math.sin(r),u=Math.cos(r);return e[0]=n*u-s*o,e[1]=i*u+a*o,e[2]=s*u+n*o,e[3]=a*u-i*o,e}function rotateZ$1(e,t,r){r*=.5;var n=t[0],i=t[1],s=t[2],a=t[3],o=Math.sin(r),u=Math.cos(r);return e[0]=n*u+i*o,e[1]=i*u-n*o,e[2]=s*u+a*o,e[3]=a*u-s*o,e}function exp(e,t){var r=t[0],n=t[1],i=t[2],s=t[3],a=Math.sqrt(r*r+n*n+i*i),o=Math.exp(s),u=a>0?o*Math.sin(a)/a:0;return e[0]=r*u,e[1]=n*u,e[2]=i*u,e[3]=o*Math.cos(a),e}function ln(e,t){var r=t[0],n=t[1],i=t[2],s=t[3],a=Math.sqrt(r*r+n*n+i*i),o=a>0?Math.atan2(a,s)/a:0;return e[0]=r*o,e[1]=n*o,e[2]=i*o,e[3]=.5*Math.log(r*r+n*n+i*i+s*s),e}function slerp(t,r,n,i){var s,a,o,u,l,c=r[0],h=r[1],m=r[2],d=r[3],p=n[0],f=n[1],g=n[2],x=n[3];return(a=c*p+h*f+m*g+d*x)<0&&(a=-a,p=-p,f=-f,g=-g,x=-x),1-a>e?(s=Math.acos(a),o=Math.sin(s),u=Math.sin((1-i)*s)/o,l=Math.sin(i*s)/o):(u=1-i,l=i),t[0]=u*c+l*p,t[1]=u*h+l*f,t[2]=u*m+l*g,t[3]=u*d+l*x,t}function fromMat3(e,t){var r,n=t[0]+t[4]+t[8];if(n>0)r=Math.sqrt(n+1),e[3]=.5*r,r=.5/r,e[0]=(t[5]-t[7])*r,e[1]=(t[6]-t[2])*r,e[2]=(t[1]-t[3])*r;else{var i=0;t[4]>t[0]&&(i=1),t[8]>t[3*i+i]&&(i=2);var s=(i+1)%3,a=(i+2)%3;r=Math.sqrt(t[3*i+i]-t[3*s+s]-t[3*a+a]+1),e[i]=.5*r,r=.5/r,e[3]=(t[3*s+a]-t[3*a+s])*r,e[s]=(t[3*s+i]+t[3*i+s])*r,e[a]=(t[3*a+i]+t[3*i+a])*r}return e}var G,N,V,F,z=clone$3,$=fromValues$3,H=copy$3,K=set$3,X=add$3,j=multiply$2,Y=scale$3,Z=dot$3,q=lerp$3,W=length$3,J=W,Q=squaredLength$3,ee=Q,te=normalize$3,re=exactEquals$3,ne=equals$3,ie=(G=create$4(),N=fromValues$4(1,0,0),V=fromValues$4(0,1,0),function(e,t,r){var n=dot$4(t,r);return n<-.999999?(cross$2(G,N,t),R(G)<1e-6&&cross$2(G,V,t),normalize$4(G,G),setAxisAngle(e,G,Math.PI),e):n>.999999?(e[0]=0,e[1]=0,e[2]=0,e[3]=1,e):(cross$2(G,t,r),e[0]=G[0],e[1]=G[1],e[2]=G[2],e[3]=1+n,te(e,e))}),se=function(){var e=create$2(),t=create$2();return function(r,n,i,s,a,o){return slerp(e,n,a,o),slerp(t,i,s,o),slerp(r,e,t,2*o*(1-o)),r}}(),ae=(F=create$6(),function(e,t,r,n){return F[0]=r[0],F[3]=r[1],F[6]=r[2],F[1]=n[0],F[4]=n[1],F[7]=n[2],F[2]=-t[0],F[5]=-t[1],F[8]=-t[2],te(e,fromMat3(e,F))}),oe=Object.freeze({__proto__:null,add:X,calculateW:function(e,t){var r=t[0],n=t[1],i=t[2];return e[0]=r,e[1]=n,e[2]=i,e[3]=Math.sqrt(Math.abs(1-r*r-n*n-i*i)),e},clone:z,conjugate:function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e},copy:H,create:create$2,dot:Z,equals:ne,exactEquals:re,exp:exp,fromEuler:function(e,t,r,n){var i=.5*Math.PI/180;t*=i,r*=i,n*=i;var s=Math.sin(t),a=Math.cos(t),o=Math.sin(r),u=Math.cos(r),l=Math.sin(n),c=Math.cos(n);return e[0]=s*u*c-a*o*l,e[1]=a*o*c+s*u*l,e[2]=a*u*l-s*o*c,e[3]=a*u*c+s*o*l,e},fromMat3:fromMat3,fromValues:$,getAngle:function(e,t){var r=Z(e,t);return Math.acos(2*r*r-1)},getAxisAngle:function(t,r){var n=2*Math.acos(r[3]),i=Math.sin(n/2);return i>e?(t[0]=r[0]/i,t[1]=r[1]/i,t[2]=r[2]/i):(t[0]=1,t[1]=0,t[2]=0),n},identity:function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e},invert:function(e,t){var r=t[0],n=t[1],i=t[2],s=t[3],a=r*r+n*n+i*i+s*s,o=a?1/a:0;return e[0]=-r*o,e[1]=-n*o,e[2]=-i*o,e[3]=s*o,e},len:J,length:W,lerp:q,ln:ln,mul:j,multiply:multiply$2,normalize:te,pow:function(e,t,r){return ln(e,t),Y(e,e,r),exp(e,e),e},random:function(e){var t=r(),n=r(),i=r(),s=Math.sqrt(1-t),a=Math.sqrt(t);return e[0]=s*Math.sin(2*Math.PI*n),e[1]=s*Math.cos(2*Math.PI*n),e[2]=a*Math.sin(2*Math.PI*i),e[3]=a*Math.cos(2*Math.PI*i),e},rotateX:rotateX$1,rotateY:rotateY$1,rotateZ:rotateZ$1,rotationTo:ie,scale:Y,set:K,setAxes:ae,setAxisAngle:setAxisAngle,slerp:slerp,sqlerp:se,sqrLen:ee,squaredLength:Q,str:function(e){return"quat("+e[0]+","+e[1]+","+e[2]+","+e[3]+")"}});function fromRotationTranslation(e,t,r){var n=.5*r[0],i=.5*r[1],s=.5*r[2],a=t[0],o=t[1],u=t[2],l=t[3];return e[0]=a,e[1]=o,e[2]=u,e[3]=l,e[4]=n*l+i*u-s*o,e[5]=i*l+s*a-n*u,e[6]=s*l+n*o-i*a,e[7]=-n*a-i*o-s*u,e}function copy$1(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e}var ue=H;var le=H;function multiply$1(e,t,r){var n=t[0],i=t[1],s=t[2],a=t[3],o=r[4],u=r[5],l=r[6],c=r[7],h=t[4],m=t[5],d=t[6],p=t[7],f=r[0],g=r[1],x=r[2],_=r[3];return e[0]=n*_+a*f+i*x-s*g,e[1]=i*_+a*g+s*f-n*x,e[2]=s*_+a*x+n*g-i*f,e[3]=a*_-n*f-i*g-s*x,e[4]=n*c+a*o+i*l-s*u+h*_+p*f+m*x-d*g,e[5]=i*c+a*u+s*o-n*l+m*_+p*g+d*f-h*x,e[6]=s*c+a*l+n*u-i*o+d*_+p*x+h*g-m*f,e[7]=a*c-n*o-i*u-s*l+p*_-h*f-m*g-d*x,e}var ce=multiply$1;var he=Z;var me=W,de=me,pe=Q,fe=pe;var ge=Object.freeze({__proto__:null,add:function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e[3]=t[3]+r[3],e[4]=t[4]+r[4],e[5]=t[5]+r[5],e[6]=t[6]+r[6],e[7]=t[7]+r[7],e},clone:function(e){var r=new t(8);return r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[4]=e[4],r[5]=e[5],r[6]=e[6],r[7]=e[7],r},conjugate:function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e[4]=-t[4],e[5]=-t[5],e[6]=-t[6],e[7]=t[7],e},copy:copy$1,create:function(){var e=new t(8);return t!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[4]=0,e[5]=0,e[6]=0,e[7]=0),e[3]=1,e},dot:he,equals:function(t,r){var n=t[0],i=t[1],s=t[2],a=t[3],o=t[4],u=t[5],l=t[6],c=t[7],h=r[0],m=r[1],d=r[2],p=r[3],f=r[4],g=r[5],x=r[6],_=r[7];return Math.abs(n-h)<=e*Math.max(1,Math.abs(n),Math.abs(h))&&Math.abs(i-m)<=e*Math.max(1,Math.abs(i),Math.abs(m))&&Math.abs(s-d)<=e*Math.max(1,Math.abs(s),Math.abs(d))&&Math.abs(a-p)<=e*Math.max(1,Math.abs(a),Math.abs(p))&&Math.abs(o-f)<=e*Math.max(1,Math.abs(o),Math.abs(f))&&Math.abs(u-g)<=e*Math.max(1,Math.abs(u),Math.abs(g))&&Math.abs(l-x)<=e*Math.max(1,Math.abs(l),Math.abs(x))&&Math.abs(c-_)<=e*Math.max(1,Math.abs(c),Math.abs(_))},exactEquals:function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]},fromMat4:function(e,r){var n=create$2();getRotation(n,r);var i=new t(3);return getTranslation$1(i,r),fromRotationTranslation(e,n,i),e},fromRotation:function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=0,e[5]=0,e[6]=0,e[7]=0,e},fromRotationTranslation:fromRotationTranslation,fromRotationTranslationValues:function(e,r,n,i,s,a,o){var u=new t(8);u[0]=e,u[1]=r,u[2]=n,u[3]=i;var l=.5*s,c=.5*a,h=.5*o;return u[4]=l*i+c*n-h*r,u[5]=c*i+h*e-l*n,u[6]=h*i+l*r-c*e,u[7]=-l*e-c*r-h*n,u},fromTranslation:function(e,t){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e[4]=.5*t[0],e[5]=.5*t[1],e[6]=.5*t[2],e[7]=0,e},fromValues:function(e,r,n,i,s,a,o,u){var l=new t(8);return l[0]=e,l[1]=r,l[2]=n,l[3]=i,l[4]=s,l[5]=a,l[6]=o,l[7]=u,l},getDual:function(e,t){return e[0]=t[4],e[1]=t[5],e[2]=t[6],e[3]=t[7],e},getReal:ue,getTranslation:function(e,t){var r=t[4],n=t[5],i=t[6],s=t[7],a=-t[0],o=-t[1],u=-t[2],l=t[3];return e[0]=2*(r*l+s*a+n*u-i*o),e[1]=2*(n*l+s*o+i*a-r*u),e[2]=2*(i*l+s*u+r*o-n*a),e},identity:function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e[4]=0,e[5]=0,e[6]=0,e[7]=0,e},invert:function(e,t){var r=pe(t);return e[0]=-t[0]/r,e[1]=-t[1]/r,e[2]=-t[2]/r,e[3]=t[3]/r,e[4]=-t[4]/r,e[5]=-t[5]/r,e[6]=-t[6]/r,e[7]=t[7]/r,e},len:de,length:me,lerp:function(e,t,r,n){var i=1-n;return he(t,r)<0&&(n=-n),e[0]=t[0]*i+r[0]*n,e[1]=t[1]*i+r[1]*n,e[2]=t[2]*i+r[2]*n,e[3]=t[3]*i+r[3]*n,e[4]=t[4]*i+r[4]*n,e[5]=t[5]*i+r[5]*n,e[6]=t[6]*i+r[6]*n,e[7]=t[7]*i+r[7]*n,e},mul:ce,multiply:multiply$1,normalize:function(e,t){var r=pe(t);if(r>0){r=Math.sqrt(r);var n=t[0]/r,i=t[1]/r,s=t[2]/r,a=t[3]/r,o=t[4],u=t[5],l=t[6],c=t[7],h=n*o+i*u+s*l+a*c;e[0]=n,e[1]=i,e[2]=s,e[3]=a,e[4]=(o-n*h)/r,e[5]=(u-i*h)/r,e[6]=(l-s*h)/r,e[7]=(c-a*h)/r}return e},rotateAroundAxis:function(t,r,n,i){if(Math.abs(i)<e)return copy$1(t,r);var s=Math.hypot(n[0],n[1],n[2]);i*=.5;var a=Math.sin(i),o=a*n[0]/s,u=a*n[1]/s,l=a*n[2]/s,c=Math.cos(i),h=r[0],m=r[1],d=r[2],p=r[3];t[0]=h*c+p*o+m*l-d*u,t[1]=m*c+p*u+d*o-h*l,t[2]=d*c+p*l+h*u-m*o,t[3]=p*c-h*o-m*u-d*l;var f=r[4],g=r[5],x=r[6],_=r[7];return t[4]=f*c+_*o+g*l-x*u,t[5]=g*c+_*u+x*o-f*l,t[6]=x*c+_*l+f*u-g*o,t[7]=_*c-f*o-g*u-x*l,t},rotateByQuatAppend:function(e,t,r){var n=r[0],i=r[1],s=r[2],a=r[3],o=t[0],u=t[1],l=t[2],c=t[3];return e[0]=o*a+c*n+u*s-l*i,e[1]=u*a+c*i+l*n-o*s,e[2]=l*a+c*s+o*i-u*n,e[3]=c*a-o*n-u*i-l*s,o=t[4],u=t[5],l=t[6],c=t[7],e[4]=o*a+c*n+u*s-l*i,e[5]=u*a+c*i+l*n-o*s,e[6]=l*a+c*s+o*i-u*n,e[7]=c*a-o*n-u*i-l*s,e},rotateByQuatPrepend:function(e,t,r){var n=t[0],i=t[1],s=t[2],a=t[3],o=r[0],u=r[1],l=r[2],c=r[3];return e[0]=n*c+a*o+i*l-s*u,e[1]=i*c+a*u+s*o-n*l,e[2]=s*c+a*l+n*u-i*o,e[3]=a*c-n*o-i*u-s*l,o=r[4],u=r[5],l=r[6],c=r[7],e[4]=n*c+a*o+i*l-s*u,e[5]=i*c+a*u+s*o-n*l,e[6]=s*c+a*l+n*u-i*o,e[7]=a*c-n*o-i*u-s*l,e},rotateX:function(e,t,r){var n=-t[0],i=-t[1],s=-t[2],a=t[3],o=t[4],u=t[5],l=t[6],c=t[7],h=o*a+c*n+u*s-l*i,m=u*a+c*i+l*n-o*s,d=l*a+c*s+o*i-u*n,p=c*a-o*n-u*i-l*s;return rotateX$1(e,t,r),n=e[0],i=e[1],s=e[2],a=e[3],e[4]=h*a+p*n+m*s-d*i,e[5]=m*a+p*i+d*n-h*s,e[6]=d*a+p*s+h*i-m*n,e[7]=p*a-h*n-m*i-d*s,e},rotateY:function(e,t,r){var n=-t[0],i=-t[1],s=-t[2],a=t[3],o=t[4],u=t[5],l=t[6],c=t[7],h=o*a+c*n+u*s-l*i,m=u*a+c*i+l*n-o*s,d=l*a+c*s+o*i-u*n,p=c*a-o*n-u*i-l*s;return rotateY$1(e,t,r),n=e[0],i=e[1],s=e[2],a=e[3],e[4]=h*a+p*n+m*s-d*i,e[5]=m*a+p*i+d*n-h*s,e[6]=d*a+p*s+h*i-m*n,e[7]=p*a-h*n-m*i-d*s,e},rotateZ:function(e,t,r){var n=-t[0],i=-t[1],s=-t[2],a=t[3],o=t[4],u=t[5],l=t[6],c=t[7],h=o*a+c*n+u*s-l*i,m=u*a+c*i+l*n-o*s,d=l*a+c*s+o*i-u*n,p=c*a-o*n-u*i-l*s;return rotateZ$1(e,t,r),n=e[0],i=e[1],s=e[2],a=e[3],e[4]=h*a+p*n+m*s-d*i,e[5]=m*a+p*i+d*n-h*s,e[6]=d*a+p*s+h*i-m*n,e[7]=p*a-h*n-m*i-d*s,e},scale:function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*r,e[5]=t[5]*r,e[6]=t[6]*r,e[7]=t[7]*r,e},set:function(e,t,r,n,i,s,a,o,u){return e[0]=t,e[1]=r,e[2]=n,e[3]=i,e[4]=s,e[5]=a,e[6]=o,e[7]=u,e},setDual:function(e,t){return e[4]=t[0],e[5]=t[1],e[6]=t[2],e[7]=t[3],e},setReal:le,sqrLen:fe,squaredLength:pe,str:function(e){return"quat2("+e[0]+","+e[1]+","+e[2]+","+e[3]+","+e[4]+","+e[5]+","+e[6]+","+e[7]+")"},translate:function(e,t,r){var n=t[0],i=t[1],s=t[2],a=t[3],o=.5*r[0],u=.5*r[1],l=.5*r[2],c=t[4],h=t[5],m=t[6],d=t[7];return e[0]=n,e[1]=i,e[2]=s,e[3]=a,e[4]=a*o+i*l-s*u+c,e[5]=a*u+s*o-n*l+h,e[6]=a*l+n*u-i*o+m,e[7]=-n*o-i*u-s*l+d,e}});function create(){var e=new t(2);return t!=Float32Array&&(e[0]=0,e[1]=0),e}function subtract(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e}function multiply(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e}function divide(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e}function distance(e,t){var r=t[0]-e[0],n=t[1]-e[1];return Math.hypot(r,n)}function squaredDistance(e,t){var r=t[0]-e[0],n=t[1]-e[1];return r*r+n*n}function length(e){var t=e[0],r=e[1];return Math.hypot(t,r)}function squaredLength(e){var t=e[0],r=e[1];return t*t+r*r}function lerp(e,t,r,n){var i=t[0],s=t[1];return e[0]=i+n*(r[0]-i),e[1]=s+n*(r[1]-s),e}var xe=length,_e=subtract,ve=multiply,ye=divide,Te=distance,be=squaredDistance,Se=squaredLength,Me=function(){var e=create();return function(t,r,n,i,s,a){var o,u;for(r||(r=2),n||(n=0),u=i?Math.min(i*r+n,t.length):t.length,o=n;o<u;o+=r)e[0]=t[o],e[1]=t[o+1],s(e,e,a),t[o]=e[0],t[o+1]=e[1];return t}}(),Re=Object.freeze({__proto__:null,add:function(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e},angle:function(e,t){var r=e[0],n=e[1],i=t[0],s=t[1],a=Math.sqrt(r*r+n*n)*Math.sqrt(i*i+s*s),o=a&&(r*i+n*s)/a;return Math.acos(Math.min(Math.max(o,-1),1))},ceil:function(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e},clone:function(e){var r=new t(2);return r[0]=e[0],r[1]=e[1],r},copy:function(e,t){return e[0]=t[0],e[1]=t[1],e},create:create,cross:function(e,t,r){var n=t[0]*r[1]-t[1]*r[0];return e[0]=e[1]=0,e[2]=n,e},dist:Te,distance:distance,div:ye,divide:divide,dot:function(e,t){return e[0]*t[0]+e[1]*t[1]},equals:function(t,r){var n=t[0],i=t[1],s=r[0],a=r[1];return Math.abs(n-s)<=e*Math.max(1,Math.abs(n),Math.abs(s))&&Math.abs(i-a)<=e*Math.max(1,Math.abs(i),Math.abs(a))},exactEquals:function(e,t){return e[0]===t[0]&&e[1]===t[1]},floor:function(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e},forEach:Me,fromValues:function(e,r){var n=new t(2);return n[0]=e,n[1]=r,n},inverse:function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e},len:xe,length:length,lerp:lerp,max:function(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e},min:function(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e},mul:ve,multiply:multiply,negate:function(e,t){return e[0]=-t[0],e[1]=-t[1],e},normalize:function(e,t){var r=t[0],n=t[1],i=r*r+n*n;return i>0&&(i=1/Math.sqrt(i)),e[0]=t[0]*i,e[1]=t[1]*i,e},random:function(e,t){t=t||1;var n=2*r()*Math.PI;return e[0]=Math.cos(n)*t,e[1]=Math.sin(n)*t,e},rotate:function(e,t,r,n){var i=t[0]-r[0],s=t[1]-r[1],a=Math.sin(n),o=Math.cos(n);return e[0]=i*o-s*a+r[0],e[1]=i*a+s*o+r[1],e},round:function(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e},scale:function(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e},scaleAndAdd:function(e,t,r,n){return e[0]=t[0]+r[0]*n,e[1]=t[1]+r[1]*n,e},set:function(e,t,r){return e[0]=t,e[1]=r,e},sqrDist:be,sqrLen:Se,squaredDistance:squaredDistance,squaredLength:squaredLength,str:function(e){return"vec2("+e[0]+","+e[1]+")"},sub:_e,subtract:subtract,transformMat2:function(e,t,r){var n=t[0],i=t[1];return e[0]=r[0]*n+r[2]*i,e[1]=r[1]*n+r[3]*i,e},transformMat2d:function(e,t,r){var n=t[0],i=t[1];return e[0]=r[0]*n+r[2]*i+r[4],e[1]=r[1]*n+r[3]*i+r[5],e},transformMat3:function(e,t,r){var n=t[0],i=t[1];return e[0]=r[0]*n+r[3]*i+r[6],e[1]=r[1]*n+r[4]*i+r[7],e},transformMat4:function(e,t,r){var n=t[0],i=t[1];return e[0]=r[0]*n+r[4]*i+r[12],e[1]=r[1]*n+r[5]*i+r[13],e},zero:function(e){return e[0]=0,e[1]=0,e}}),we=Object.freeze({__proto__:null,glMatrix:i,mat2:o,mat2d:c,mat3:d,mat4:_,quat:oe,quat2:ge,vec2:Re,vec3:P,vec4:O});class InstanceIdGenerator{static idMaps=new Map;static getNextId(e){let t=this.idMaps.get(e)||0;return this.idMaps.set(e,t+1),t}}Object.freeze(InstanceIdGenerator);class Camera2D{#e;#t=create$5();#r=0;#n=0;#i=0;#s;constructor(){}get name(){return this.#e||(this.#e=InstanceIdGenerator.getNextId(this.constructor)),this.#s||`${this.constructor.name} Instance ${this.#e}`}set name(e){this.#s=e}get modelMatrix(){return this.#t}get z(){return this.#i}get x(){return this.#r}set x(e){this.#r=e,this.#t[12]=e}get y(){return this.#n}set y(e){this.#n=e,this.#t[13]=e}get position(){return[this.#r,this.#n]}setPosition(e,t){Array.isArray(e)?[this.#r,this.#n]=e:(this.#r=e,this.#n=t),[this.#t[12],this.#t[13],this.#t[14]]=[this.#r,this.#n,0]}}const consoleAndThrowError=(...e)=>{const t=Array.prototype.slice.call(e).join(" ");throw new Error(t)},validateNumber=e=>"number"==typeof e||(consoleAndThrowError("Only numbers allowed."),!1);class PerspectiveCamera{#e;#a=new Float32Array([0,1,0]);#t=create$5();#r=0;#i=0;#n=0;#o=0;#u=0;#l=0;#c=60;#h=.01;#m=1e4;#s;constructor(){}get rotationX(){return this.#o}set rotationX(e){this.#o=e}get rotationY(){return this.#u}set rotationY(e){this.#u=e}get rotationZ(){return this.#l}set rotationZ(e){this.#l=e}get fieldOfView(){return this.#c}set fieldOfView(e){validateNumber(e),this.#c=e}get nearClipping(){return this.#h}set nearClipping(e){validateNumber(e),this.#h=e}get farClipping(){return this.#m}set farClipping(e){validateNumber(e),this.#m=e}get name(){return this.#e||(this.#e=InstanceIdGenerator.getNextId(this.constructor)),this.#s||`${this.constructor.name} Instance ${this.#e}`}set name(e){this.#s=e}get modelMatrix(){return this.#t}get x(){return this.#r}set x(e){this.#r=e,this.#t[12]=e}get y(){return this.#n}set y(e){this.#n=e,this.#t[13]=e}get z(){return this.#i}set z(e){this.#i=e,this.#t[14]=e}get position(){return[this.#r,this.#n,this.#i]}setPosition(e,t,r){Array.isArray(e)?[this.#r,this.#n,this.#i]=e:(this.#r=e,this.#n=t,this.#i=r),[this.#t[12],this.#t[13],this.#t[14]]=[this.#r,this.#n,this.#i]}lookAt(e,t,r){lookAt(this.#t,[this.#r,this.#n,this.#i],[e,t,r],this.#a)}}class OrthographicCamera extends PerspectiveCamera{#e;#s;#d=1;#p=-1;#f=-1;#g=1;constructor(){super(),this.nearClipping=.01,this.farClipping=2e3}get top(){return this.#d}set top(e){validateNumber(e),this.#d=e}get bottom(){return this.#p}set bottom(e){validateNumber(e),this.#p=e}get left(){return this.#f}set left(e){validateNumber(e),this.#f=e}get right(){return this.#g}set right(e){validateNumber(e),this.#g=e}get name(){return this.#e||(this.#e=InstanceIdGenerator.getNextId(this.constructor)),this.#s||`${this.constructor.name} Instance ${this.#e}`}set name(e){this.#s=e}}const gltfAnimationLooper_rotation=(t,r,n,i,s,a,o,u,l,c,h)=>{let m,d,p,f,g,x,_,v,y,T,b,S,M,R,w,E,P,C,k,I,U,B,L,A,D,O,G=!0;if("CUBICSPLINE"==t)a!=i-1?(O=12*a,U=n[O+4],B=n[O+5],L=n[O+6],A=n[O+7],D=U*U+B*B+L*L+A*A,D>0&&(D=1/Math.sqrt(D)),y=U*D,T=B*D,b=L*D,S=A*D,U=n[O+8],B=n[O+9],L=n[O+10],A=n[O+11],D=U*U+B*B+L*L+A*A,D>0&&(D=1/Math.sqrt(D)),M=U*D,R=B*D,w=L*D,E=A*D,U=n[O],B=n[O+1],L=n[O+2],A=n[O+3],D=U*U+B*B+L*L+A*A,D>0&&(D=1/Math.sqrt(D)),g=U*D,x=B*D,_=L*D,v=A*D,O=12*o,U=n[O+4],B=n[O+5],L=n[O+6],A=n[O+7],D=U*U+B*B+L*L+A*A,D>0&&(D=1/Math.sqrt(D)),m=U*D,d=B*D,p=L*D,f=A*D,P=y,C=M*s,k=m,I=g*s,U=u*P+l*C+c*k+h*I,P=T,C=R*s,k=d,I=x*s,B=u*P+l*C+c*k+h*I,P=b,C=w*s,k=p,I=_*s,L=u*P+l*C+c*k+h*I,P=S,C=E*s,k=f,I=v*s,A=u*P+l*C+c*k+h*I):G=!1;else{let t,r,i,u,l;O=4*a,U=n[O],B=n[O+1],L=n[O+2],A=n[O+3],D=U*U+B*B+L*L+A*A,D>0&&(D=1/Math.sqrt(D)),y=U*D,T=B*D,b=L*D,S=A*D,O=4*o,U=n[O],B=n[O+1],L=n[O+2],A=n[O+3],D=U*U+B*B+L*L+A*A,D>0&&(D=1/Math.sqrt(D)),m=U*D,d=B*D,p=L*D,f=A*D,r=y*m+T*d+b*p+S*f,r<0&&(r=-r,m=-m,d=-d,p=-p,f=-f),1-r>e?(t=Math.acos(r),i=Math.sin(t),u=Math.sin((1-s)*t)/i,l=Math.sin(s*t)/i):(u=1-s,l=s),U=u*y+l*m,B=u*T+l*d,L=u*b+l*p,A=u*S+l*f}if(G){let e=[],t=[0,0,0],n=U+U,i=B+B,s=L+L,a=U*n,o=U*i,u=U*s,l=B*i,c=B*s,h=L*s,m=A*n,d=A*i,p=A*s;e[0]=1-(l+h),e[4]=o-p,e[8]=u+d,e[1]=o+p,e[5]=1-(a+h),e[9]=c-m,e[2]=u-d,e[6]=c+m,e[10]=1-(a+l),e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1;let f=e[0],g=e[4],x=e[8],_=e[5],v=e[9],y=e[6],T=e[10];t[1]=Math.asin(Math.max(-1,Math.min(1,x))),Math.abs(x)<.99999?(t[0]=Math.atan2(-v,T),t[2]=Math.atan2(-g,f)):(t[0]=Math.atan2(y,_),t[2]=0),t[0]=-180*t[0]/Math.PI,t[1]=-180*t[1]/Math.PI,t[2]=-180*t[2]/Math.PI,r.rotationX=t[0],r.rotationY=t[1],r.rotationZ=t[2]}},gltfAnimationLooper_scale=(e,t,r,n,i,s,a,o,u,l,c)=>{let h,m,d,p,f,g,x,_,v,y,T,b,S,M,R,w,E;"CUBICSPLINE"==e?s!=n-1&&(E=9*s,h=r[E+3],m=r[E+4],d=r[E+5],y=r[E+6],T=r[E+7],b=r[E+8],E=9*a,p=r[E+0],f=r[E+1],g=r[E+2],x=r[E+3],_=r[E+4],v=r[E+5],S=x,M=y*i,R=h,w=p*i,t.scaleX=o*S+u*M+l*R+c*w,S=_,M=T*i,R=m,w=f*i,t.scaleY=o*S+u*M+l*R+c*w,S=v,M=b*i,R=d,w=g*i,t.scaleZ=o*S+u*M+l*R+c*w):(E=3*a,h=r[E],m=r[E+1],d=r[E+2],E=3*s,x=r[E],_=r[E+1],v=r[E+2],t.scaleX=x+i*(h-x),t.scaleY=_+i*(m-_),t.scaleZ=v+i*(d-v))},gltfAnimationLooper_transition=(e,t,r,n,i,s,a,o,u,l,c)=>{let h,m,d,p,f,g,x,_,v,y,T,b,S,M,R,w,E;"CUBICSPLINE"==e?s!=n-1&&(E=9*s,h=r[E+3],m=r[E+4],d=r[E+5],y=r[E+6],T=r[E+7],b=r[E+8],E=9*a,p=r[E+0],f=r[E+1],g=r[E+2],x=r[E+3],_=r[E+4],v=r[E+5],S=x,M=y*i,R=h,w=p*i,t.x=o*S+u*M+l*R+c*w,S=_,M=T*i,R=m,w=f*i,t.y=o*S+u*M+l*R+c*w,S=v,M=b*i,R=d,w=g*i,t.z=o*S+u*M+l*R+c*w):(E=3*a,h=r[E],m=r[E+1],d=r[E+2],E=3*s,x=r[E],_=r[E+1],v=r[E+2],t.x=x+i*(h-x),t.y=_+i*(m-_),t.z=v+i*(d-v))},gltfAnimationLooper_weight=(e,t,r,n,i)=>{let s,a,o,u,l,c,h,m,d,p,f,g,x,_,v,y,T,b,S,M,R,w;const E=9999991;for(s=e.length;s--;){let P;for(a=e[s],o=a.geometry.vertexBuffer.data,l=a.geometry.vertexBuffer.stride,h=o.length/l,y=a.animationInfo.morphInfo,u=y.origin,T=y.morphInfoDataList,v=T.length,c=0;c<h;c++){_=c*l;let e=_*E+n*E+i;if(w=y.cacheData[e],w)[m,d,p,f,g,x]=w;else{for(m=u[_],d=u[_],p=u[_+1],f=u[_+1],g=u[_+2],x=u[_+2],b=v;b--;)S=t[n*v+b],M=t[i*v+b],R=T[b].interleaveData,P=R[_],m+=S*P,d+=M*P,P=R[_+1],p+=S*P,f+=M*P,P=R[_+2],g+=S*P,x+=M*P;y.cacheData[e]=[m,d,p,f,g,x]}o[_]=m+r*(d-m),o[_+1]=p+r*(f-p),o[_+2]=g+r*(x-g)}a.geometry.vertexBuffer.updateAllData(o)}};class VertexGPURenderInfo{vertexShaderModule;vertexStructInfo;vertexUniformInfo;vertexBindGroupLayout;vertexUniformBindGroup;vertexUniformBuffer;pipeline;shadowPipeline;pickingPipeline;constructor(e,t,r,n,i,s,a,o){this.vertexShaderModule=e,this.vertexUniformInfo=t,this.vertexBindGroupLayout=r,this.vertexUniformBindGroup=i,this.vertexUniformBuffer=n,this.pipeline=s,this.shadowPipeline=a,this.pickingPipeline=o}}Object.freeze(VertexGPURenderInfo);const defineProperty=(e,t,r,n,...i)=>{Object.defineProperty(e.prototype,t,r(t,n,...i))},defineProperties=e=>(t,r)=>{r.forEach((r=>{if(Array.isArray(r)){const[n,i,...s]=r;defineProperty(t,n,e,i,...s)}else defineProperty(t,r,e)}))},createDefineByPreset=e=>{const t={};return Object.keys(e).forEach((r=>{const[n,i]=e[r];Object.assign(t,(e=>t=>t.reduce(((t,r)=>({...t,[r]:e})),{}))(n)(Object.values(i)))})),{defineByPreset:(e,r)=>((e,t,r)=>{t.forEach((t=>{if(Array.isArray(t)){const[n,i,...s]=t,a=r[n];a||consoleAndThrowError(n,"is a key not defined in Define Preset."),defineProperty(e,n,a,i,...s)}else{const n=r[t];n||consoleAndThrowError(t,"is a key not defined in Define Preset."),defineProperty(e,t,n)}}))})(e,r,t)}},Ee={enumerable:!0,configurable:!1};function createSetter$5(e,t,r){return function(n){this[t]=n;const{gpuRenderInfo:i}=this;if(r){const{fragmentUniformInfo:t,fragmentUniformBuffer:r}=i;r.writeBuffer(t.members[e],n?1:0)}else if(i){const{vertexUniformInfo:t,vertexUniformBuffer:r}=i;r.writeBuffer(t.members[e],n?1:0)}}}function defineBoolean(e,t=!1,r=!0){const n=Symbol(e);return{get:function(){return void 0===this[n]&&(this[n]=t),this[n]},set:createSetter$5(e,n,r),...Ee}}Object.freeze(Ee),Object.freeze(defineBoolean);const validatePositiveNumberRange=(e,t=0,r=Number.MAX_VALUE)=>("number"!=typeof e&&consoleAndThrowError("Only numbers allowed."),"number"!=typeof t&&consoleAndThrowError("Only numbers allowed."),"number"!=typeof r&&consoleAndThrowError("Only numbers allowed."),(t<0||e<0||e<t||e>r)&&consoleAndThrowError(`Only numbers within the range of [${t},${r}] are allowed.`),!0);function createSetter$4(e,t,r,n=0,i){return function(s){void 0!==n&&s<n&&(console.warn(`Value for ${e} is below the minimum (${n}). Received:${s}. Adjusted to ${n}.`),s=n),void 0!==i&&s>i&&(console.warn(`Value for ${e} exceeds the maximum (${i}). Received:${s}. Adjusted to ${i}.`),s=i),validatePositiveNumberRange(s),this[t]=s;const{gpuRenderInfo:a}=this;if(r){const{fragmentUniformInfo:r,fragmentUniformBuffer:n}=a;n.writeBuffer(r.members[e],this[t])}else if(a){const{vertexUniformInfo:r,vertexUniformBuffer:n}=a;n.writeBuffer(r.members[e],this[t])}}}function definePositiveNumberRange(e,t=1,r=!0,n=0,i){const s=Symbol(e);return{get:function(){return void 0===this[s]&&(this[s]=t),this[s]},set:createSetter$4(e,s,r,n,i),...Ee}}Object.freeze(definePositiveNumberRange);const isUint=e=>Number.isInteger(e)&&e>=0,validateUintRange=(e,t=0,r=4503599627370496)=>{const n=isUint(e),i=isUint(t),s=isUint(r),a="is not Uint!/value:",o=`(check range:${t}u ~ ${r}u)`;return n||consoleAndThrowError(`value ${a}${e}/${o}`),i||consoleAndThrowError(`min ${a}${t}/${o}`),s||consoleAndThrowError(`max ${a}${r}/${o}`),t>=r&&consoleAndThrowError(`maximum value is bigger than minimum value./${o}`),t>e&&consoleAndThrowError(`value is smaller than minimum value./value:${e}/${o}`),r<e&&consoleAndThrowError(`value is bigger than maximum value./value:${e}/${o}`),!0};function createSetter$3(e,t,r,n=0,i){return function(s){validateUintRange(s),void 0!==n&&s<n&&(console.warn(`Value for ${e} is below the minimum (${n}). Received:${s}. Adjusted to ${n}.`),s=n),void 0!==i&&s>i&&(console.warn(`Value for ${e} exceeds the maximum (${i}). Received:${s}. Adjusted to ${i}.`),s=i),this[t]=s;const{gpuRenderInfo:a}=this;if(r){const{fragmentUniformInfo:r,fragmentUniformBuffer:n}=a;n.writeBuffer(r.members[e],this[t])}else if(a){const{vertexUniformInfo:r,vertexUniformBuffer:n}=a;n.writeBuffer(r.members[e],this[t])}}}function defineUintRange(e,t=0,r=!0,n=0,i){const s=Symbol(e);return{get:function(){return void 0===this[s]&&(this[s]=t),this[s]},set:createSetter$3(e,s,r,n,i),...Ee}}function defineProperty_boolean(e,t=!1){return defineBoolean(e,t,!1)}function defineProperty_uintRange(e,t=0,r,n){return defineUintRange(e,t,!1,r,n)}function defineProperty_PositiveNumberRange(e,t=0,r,n){return definePositiveNumberRange(e,t,!1,r,n)}Object.freeze(defineUintRange);const Pe={USE_BILLBOARD_PERSPECTIVE:"useBillboardPerspective",USE_BILLBOARD:"useBillboard",RECEIVE_SHADOW:"receiveShadow"},Ce={BILLBOARD_FIXED_SCALE:"billboardFixedScale"},ke={},Ie={...createDefineByPreset({defineBoolean:[defineProperty_boolean,Pe],defineUint:[defineProperty_uintRange,ke],definePositiveNumber:[defineProperty_PositiveNumberRange,Ce]}),defineBoolean:defineProperties(defineProperty_boolean),defineUint:defineProperties(defineProperty_uintRange),definePositiveNumber:defineProperties(defineProperty_PositiveNumberRange),PRESET_BOOLEAN:Pe,PRESET_POSITIVE_NUMBER:Ce,PRESET_UINT:ke,PRESET_SAMPLER:{},PRESET_TEXTURE:{},PRESET_CUBE_TEXTURE:{},PRESET_VEC2:{},PRESET_VEC3:{},PRESET_VEC4:{},PRESET_COLOR_RGB:{}};Object.freeze(Ie);const uuidToUint=e=>{const t=e.replace(/-/g,"").substring(0,8);return parseInt(t,16)};class ResourceStateBitmapTexture{texture;src;cacheKey;useNum=0;uuid;constructor(e){this.texture=e,this.src=e.src,this.cacheKey=e.cacheKey,this.useNum=0,this.uuid=e.uuid}}class ResourceStateCubeTexture{texture;srcList;cacheKey;useNum=0;uuid;constructor(e){this.texture=e,this.srcList=e.srcList,this.cacheKey=e.cacheKey,this.useNum=0,this.uuid=e.uuid}}const basicRegisterResource=(e,t)=>{const{uuid:r,targetResourceManagedState:n}=e,i=t instanceof ResourceStateCubeTexture||t instanceof ResourceStateBitmapTexture;try{n.table[r]&&consoleAndThrowError(`Buffer with UUID ${r} is already registered.`),n.table[r]=t,n.length++,i||(n.videoMemory+=e.size)}catch(e){consoleAndThrowError(e.message)}};class ResourceStateUniformBuffer{static dirtyList=[];buffer;uuid;#x=0;constructor(e){this.buffer=e,this.uuid=e.uuid}get useNum(){return this.#x}set useNum(e){this.#x=e,ResourceStateUniformBuffer.dirtyList.push(this)}}const basicUnregisterResource=e=>{const{uuid:t,targetResourceManagedState:r}=e,{table:n}=r;n[t]&&(r.videoMemory-=e.size,delete n[t],r.length--)},validateRedGPUContext=e=>{if("RedGPUContext"!==e?.constructor?.name){return consoleAndThrowError(`from ${e?.constructor?.name}:requires a RedGPUContext instance,but received:${e}`),!1}return!0},createUUID=()=>{const e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");let t,r=0,n=["","","","","-","","","","-","4","","","-","","","","-","","","","","","-","","","","","","","","","","","",""];for(;r<36;)""===n[r]&&(t=16*Math.random()|0,n[r]=e[19===r?3&t|8:15&t]),r++;return n.join("")};class ResourceBase{#_=createUUID();#v;#y;#s="";#e;#T=[];constructor(e){validateRedGPUContext(e),this.#v=e,this.#y=e.gpuDevice}get name(){return this.#e||(this.#e=InstanceIdGenerator.getNextId(this.constructor)),this.#s||`${this.constructor.name} Instance ${this.#e}`}set name(e){this.#s=e}get uuid(){return this.#_}get gpuDevice(){return this.#y}get redGPUContext(){return this.#v}__addDirtyPipelineListener(e){this.#b(!0),this.#T.push(e)}__removeDirtyPipelineListener(e){const t=this.#T.indexOf(e);t>-1&&(this.#T.splice(t,1),this.#b(!1))}__fireListenerList(e=!1){for(const e of this.#T)e(this);e&&(this.#T.length=0)}#b(e){const{resourceManager:t}=this.#v;if(t){const r=t[`managed${this.constructor.name}State`]?.table?.[this.#_];r&&(e?r.useNum++:r.useNum--)}}}class ManagedResourceBase extends ResourceBase{#S;constructor(e,t){super(e),this.#S=e.resourceManager[t]}get targetResourceManagedState(){return this.#S}}class ABaseBuffer extends ManagedResourceBase{#M;constructor(e,t,r){super(e,t),this.#M=r}get usage(){return this.#M}}class AUniformBaseBuffer extends ABaseBuffer{#R;#w;#E;#P;constructor(e,t,r,n,i=""){super(e,t,r),this.#w=n.byteLength,this.#R={size:this.#w,usage:this.usage,label:i};try{this.#P=e.gpuDevice.createBuffer(this.#R)}catch(e){console.error("GPU   :",e)}e.gpuDevice.queue.writeBuffer(this.#P,0,n)}get gpuBuffer(){return this.#P}get data(){return this.#E}get size(){return this.#w}get uniformBufferDescriptor(){return this.#R}destroy(){const e=this.#P;e&&(this.#P=null,this.__fireListenerList(!0),basicUnregisterResource(this),e&&e.destroy())}writeBuffers(e){const{gpuDevice:t}=this.redGPUContext;let r=e.length;for(;r--;){const[n,i]=e[r];t.queue.writeBuffer(this.gpuBuffer,n.uniformOffset,new n.View("number"==typeof i?[i]:i))}}writeBuffer(e,t){this.redGPUContext.gpuDevice.queue.writeBuffer(this.gpuBuffer,e.uniformOffset,new e.View("number"==typeof t?[t]:t))}}const getCacheBufferFromResourceState=(e,t)=>{const{targetResourceManagedState:r}=e,n=((e,t)=>{if(!t)return;let r;const n=e.table;for(const e in n)if(n[e].label===t){r=n[e];break}return r})(r,t);return n?r.table[e.uuid].buffer:null};class UniformBuffer extends AUniformBaseBuffer{constructor(e,t,r="",n=""){super(e,"managedUniformBufferState",GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST,t,r);const i=getCacheBufferFromResourceState(this,n);if(i)return i;n&&(this.name=n),basicRegisterResource(this,new ResourceStateUniformBuffer(this))}}Object.freeze(UniformBuffer);const Ue={CLAMP_TO_EDGE:"clamp-to-edge",REPEAT:"repeat",MIRRORED_REPEAT:"mirror-repeat"};Object.freeze(Ue);const Be={NEAREST:"nearest",LINEAR:"linear"};Object.freeze(Be);const Le={NEAREST:"nearest",LINEAR:"linear"};Object.freeze(Le);const Ae=new Map,De=Object.values(Be),Oe=Object.values(Ue),Ge=Object.values(Le);class Sampler extends ResourceBase{#C;#k=Be.LINEAR;#I=Be.LINEAR;#U=Le.LINEAR;#B=Ue.REPEAT;#L=Ue.REPEAT;#A=Ue.REPEAT;#D;#O;#G;#N=1;constructor(e,t){super(e),this.#V(t)}get addressModeU(){return this.#B}set addressModeU(e){this.#F(e,"addressModeU")}get addressModeV(){return this.#L}set addressModeV(e){this.#F(e,"addressModeV")}get addressModeW(){return this.#A}set addressModeW(e){this.#F(e,"addressModeW")}get mipmapFilter(){return this.#U}set mipmapFilter(e){this.#z(e,Ge,"mipmapFilter")}get gpuSampler(){return this.#C}get magFilter(){return this.#k}set magFilter(e){this.#z(e,De,"magFilter")}get minFilter(){return this.#I}set minFilter(e){this.#z(e,De,"minFilter")}get maxAnisotropy(){return this.#N}set maxAnisotropy(e){validateUintRange(e,1,16),this.#N=e,this.#V()}get isAnisotropyValid(){return!this.#N||"linear"===this.#k&&"linear"===this.#I&&"linear"===this.#U}#$(){this.__fireListenerList()}#F(e,t){if(Oe.includes(e)){switch(t){case"addressModeU":this.#B=e;break;case"addressModeV":this.#L=e;break;case"addressModeW":this.#A=e}this.#V()}else consoleAndThrowError(`Invalid ${t} value. Must be one of ${Oe.join(",")},but received:${e}.`)}#z(e,t,r){if(t.includes(e)||null===e){switch(r){case"mipmapFilter":this.#U=e;break;case"magFilter":this.#k=e;break;case"minFilter":this.#I=e}this.#V()}else consoleAndThrowError(`Invalid ${r} value. Must be one of ${t.join(",")},but received:${e}.`)}#H(){return`${this.#k}:${this.#I}:${this.#U}:${this.#B}:${this.#L}:${this.#A}:${this.#D}:${this.#O}:${this.#G}:${this.#N}`}#V(e){e&&(e.magFilter&&(this.#k=e.magFilter),e.minFilter&&(this.#I=e.minFilter),e.mipmapFilter&&(this.#U=e.mipmapFilter),e.addressModeU&&(this.#B=e.addressModeU),e.addressModeV&&(this.#L=e.addressModeV),e.addressModeW&&(this.#A=e.addressModeW),void 0!==e.lodMinClamp&&(this.#D=e.lodMinClamp),void 0!==e.lodMaxClamp&&(this.#O=e.lodMaxClamp),e.compare&&(this.#G=e.compare),e.maxAnisotropy&&(this.#N=e.maxAnisotropy)),this.isAnisotropyValid||1===this.#N||(console.warn(`Invalid maxAnisotropy setting (${this.#N}) detected:magFilter(${this.#k}),minFilter(${this.#I}),mipmapFilter(${this.#U}) must all be set to 'linear' for anisotropic filtering to work. Falling back to default (1).`),this.#N=1);const t=this.#H();if(!Ae.has(t)){let e={};this.#k&&(e.magFilter=this.#k),this.#I&&(e.minFilter=this.#I),this.#U&&(e.mipmapFilter=this.#U),this.#B&&(e.addressModeU=this.#B),this.#L&&(e.addressModeV=this.#L),this.#A&&(e.addressModeW=this.#A),void 0!==this.#D&&(e.lodMinClamp=this.#D),void 0!==this.#O&&(e.lodMaxClamp=this.#O),this.#G&&(e.compare=this.#G),this.#N&&(e.maxAnisotropy=this.#N),Ae.set(t,this.redGPUContext.gpuDevice.createSampler(e))}this.#C=Ae.get(t),this.#$()}}function calculateTextureByteSize(e){return function(e){switch(e){case"r8unorm":case"r8snorm":case"r8uint":case"r8sint":return 1;case"r16uint":case"r16sint":case"r16float":case"rg8unorm":case"rg8snorm":case"rg8uint":case"rg8sint":case"depth16unorm":return 2;case"r32uint":case"r32sint":case"r32float":case"rg16uint":case"rg16sint":case"rg16float":case"rgba8unorm":case"rgba8unorm-srgb":case"rgba8snorm":case"rgba8uint":case"rgba8sint":case"bgra8unorm":case"bgra8unorm-srgb":case"depth24plus":case"depth32float":return 4;case"rg32uint":case"rg32sint":case"rg32float":case"rgba16uint":case"rgba16sint":case"rgba16float":return 8;case"rgba32uint":case"rgba32sint":case"rgba32float":return 16;default:throw new Error(`Unrecognized texture format:${e}`)}}(e.format)*(e.size[0]*e.size[1]*(e.size[2]||1))*(e.sampleCount?e.sampleCount:1)}Object.freeze(Sampler);const getMipLevelCount=(e,t)=>Math.floor(Math.log2(Math.max(e,t)))+1,imageBitmapToGPUTexture=(e,t,r,n=!0)=>{const i=e.createTexture(r);for(let s=0;s<t.length;s++){const a=t[s],o={source:a},u={texture:i,origin:[0,0,s],premultipliedAlpha:n};r.format.includes("srgb")&&(u.colorSpace="srgb");const l=[a.width,a.height];e.queue.copyExternalImageToTexture(o,u,l)}return i};async function loadAndCreateBitmapImage(e,t="none",r="premultiply"){const n=await fetch(e),i=await n.blob();return createImageBitmap(i,{colorSpaceConversion:t,premultiplyAlpha:r})}class BitmapTexture extends ManagedResourceBase{#K;#X;#j;#Y;#Z;#q;#W=0;#J=!0;#Q;#ee;#te;constructor(e,t,r=!0,n,i,s,a=!0){if(super(e,"managedBitmapTextureState"),this.#ee=n,this.#te=i,this.#J=a,this.#Z=r,this.#Q=s||navigator.gpu.getPreferredCanvasFormat(),t){this.#X=t?.src||t,this.#j=t?.cacheKey||t||this.uuid;const{table:e}=this.targetResourceManagedState;let r;for(const t in e)if(e[t].cacheKey===this.#j){r=e[t];break}if(r)return this.#ee?.(this),e[r.uuid].texture;this.src=t,this.#re()}}get usePremultiplyAlpha(){return this.#J}get cacheKey(){return this.#j}get videoMemorySize(){return this.#W}get gpuTexture(){return this.#K}get mipLevelCount(){return this.#Y}get src(){return this.#X}set src(e){this.#X=e?.src||e,this.#j=e?.cacheKey||e||this.uuid,this.#X&&this.#ne(this.#X)}get useMipmap(){return this.#Z}set useMipmap(e){this.#Z=e,this.#ie()}destroy(){const e=this.#K;this.#se(null),this.__fireListenerList(!0),this.#X=null,this.#j=null,this.#ae(),e&&e.destroy()}#se(e){this.#K=e,e||(this.#q=null),this.__fireListenerList()}#re(){basicRegisterResource(this,new ResourceStateBitmapTexture(this))}#ae(){basicUnregisterResource(this)}#ie(){const{gpuDevice:e,resourceManager:t}=this.redGPUContext,{mipmapGenerator:r}=t;this.#K&&(this.#K.destroy(),this.#K=null),this.targetResourceManagedState.videoMemory-=this.#W,this.#W=0;const{width:n,height:i}=this.#q;this.#Y=1;const s={size:[n,i],format:this.#Q,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST};this.#Z&&(this.#Y=getMipLevelCount(n,i),s.mipLevelCount=this.#Y,s.usage|=GPUTextureUsage.RENDER_ATTACHMENT);const a=imageBitmapToGPUTexture(e,[this.#q],s,this.#J);this.#W=calculateTextureByteSize(s),this.targetResourceManagedState.videoMemory+=this.#W,this.#Z&&r.generateMipmap(a,s),this.#se(a)}async#oe(e){return new Promise(((t,r)=>{const n=new Image;n.src=e,n.onload=()=>{const e=document.createElement("canvas");e.width=n.width||512,e.height=n.height||512;const i=e.getContext("2d");i?(i.fillStyle="rgba(0,0,0,0)",i.fillRect(0,0,e.width,e.height),i.drawImage(n,0,0,e.width,e.height),createImageBitmap(e,{colorSpaceConversion:"none",premultiplyAlpha:this.#J?"premultiply":"none"}).then(t).catch(r)):r(new Error("Canvas context could not be created."))},n.onerror=e=>{r(new Error(`Failed to load SVG:${e}`))}}))}async#ne(e){try{e.endsWith(".svg")?this.#q=await this.#oe(e):this.#q=await loadAndCreateBitmapImage(e,"none",this.#J?"premultiply":"none"),this.#ie(),this.#ee?.(this)}catch(e){console.error(e),this.#te?.(e)}}}Object.freeze(BitmapTexture);const Ne={LOAD:"load",CLEAR:"clear"};Object.freeze(Ne);const Ve={STORE:"store",DISCARD:"discard"};Object.freeze(Ve);class MipmapGenerator{#v;#ue;#le;#ce;#he;#me;constructor(e){this.#v=e,this.#ue=new Sampler(e,{minFilter:"linear"}).gpuSampler,this.#ce={}}getMipmapPipeline(e){const{gpuDevice:t,resourceManager:r}=this.#v;let n=this.#ce[e];return n||(this.#me||(this.#me=r.createGPUShaderModule("MODULE_MIP_MAP",{code:"\r\nvar<private> pos:array<vec2<f32>,3>=array<vec2<f32>,3>(\rvec2<f32>(-1.0,-1.0),\rvec2<f32>(-1.0,3.0),\rvec2<f32>(3.0,-1.0)\r\n);\r\n\r\n\r\nstruct VertexOutput {\r@builtin(position)\rposition:vec4<f32>,\r\n\r@location(0)\rtexCoord:vec2<f32>,\r\n};\r\n\r\n\r\n@vertex\r\nfn vertexMain(@builtin(vertex_index) vertexIndex:u32) -> VertexOutput {\rvar output:VertexOutput;\routput.texCoord=pos[vertexIndex] * vec2<f32>(0.5,-0.5) + vec2<f32>(0.5);\routput.position=vec4<f32>(pos[vertexIndex],0.0,1.0);\rreturn output;\r\n}\r\n\r\n\r\n@group(0) @binding(0)\r\nvar imgSampler:sampler;\r\n\r\n@group(0) @binding(1)\r\nvar img:texture_2d<f32>;\r\n\r\n\r\n@fragment\r\nfn fragmentMain(@location(0) texCoord:vec2<f32>) -> @location(0) vec4<f32> {\rreturn textureSample(img,imgSampler,texCoord);\r\n}\r\n"}),this.#he=r.createBindGroupLayout("FRAGMENT_BIND_GROUP_LAYOUT_NAME_MIP_MAP",{entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,sampler:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}}]}),this.#le=r.createGPUPipelineLayout("PIPELINE_DESCRIPTOR_FINAL_MIP_MAP",{bindGroupLayouts:[this.#he]})),n=t.createRenderPipeline({layout:this.#le,vertex:{module:this.#me,entryPoint:"vertexMain"},fragment:{module:this.#me,entryPoint:"fragmentMain",targets:[{format:e}]}}),this.#ce[e]=n),n}generateMipmap(e,t){const{gpuDevice:r}=this.#v,n=this.getMipmapPipeline(t.format);if("3d"==t.dimension||"1d"==t.dimension)throw new Error("Generating mipmaps for non-2d textures is currently unsupported!");let i=e;const s=t.size[0],a=t.size[1],o=t.size[2]||1,u=t.usage&GPUTextureUsage.RENDER_ATTACHMENT;if(!u){const e={size:{width:Math.max(1,s>>>1),height:Math.max(1,a>>>1),depthOrArrayLayers:o},format:t.format,usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_SRC|GPUTextureUsage.RENDER_ATTACHMENT,mipLevelCount:t.mipLevelCount-1};i=r.createTexture(e)}const l=r.createCommandEncoder({});for(let s=0;s<o;++s){let a=e.createView({baseMipLevel:0,mipLevelCount:1,dimension:"2d",baseArrayLayer:s,arrayLayerCount:1}),o=u?1:0;for(let e=1;e<t.mipLevelCount;++e){const e=i.createView({baseMipLevel:o++,mipLevelCount:1,dimension:"2d",baseArrayLayer:s,arrayLayerCount:1}),t=l.beginRenderPass({colorAttachments:[{view:e,clearValue:{r:0,g:0,b:0,a:0},loadOp:Ne.CLEAR,storeOp:Ve.STORE}]}),u=r.createBindGroup({layout:this.#he,entries:[{binding:0,resource:this.#ue},{binding:1,resource:a}]});t.setPipeline(n),t.setBindGroup(0,u),t.draw(3,1,0,0),t.end(),a=e}}if(!u){const r={width:Math.max(1,s>>>1),height:Math.max(1,a>>>1),depthOrArrayLayers:o};for(let n=1;n<t.mipLevelCount;++n)l.copyTextureToTexture({texture:i,mipLevel:n-1},{texture:e,mipLevel:n},r),r.width=Math.max(1,r.width>>>1),r.height=Math.max(1,r.height>>>1)}return r.queue.submit([l.finish()]),u||i.destroy(),e}}Object.freeze(MipmapGenerator);class CubeTexture extends ManagedResourceBase{static defaultViewDescriptor={dimension:"cube",aspect:"all",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:0,arrayLayerCount:6};#K;#de;#j;#Y;#Z;#pe;#W=0;#Q;#ee;#te;constructor(e,t,r=!0,n,i,s){super(e,"managedCubeTextureState"),this.#ee=n,this.#te=i,this.#Z=r,this.#Q=s||navigator.gpu.getPreferredCanvasFormat(),this.#de=t,this.#j=t?.toString();const{table:a}=this.targetResourceManagedState;let o;for(const e in a)if(a[e].cacheKey===this.#j){o=a[e];break}if(o)return this.#ee?.(this),a[o.uuid].texture;this.srcList=t,this.#re()}get cacheKey(){return this.#j}get videoMemorySize(){return this.#W}get gpuTexture(){return this.#K}get mipLevelCount(){return this.#Y}get srcList(){return this.#de}set srcList(e){this.#de=e,this.#j=e?.toString(),this.#de&&this.#ne(this.#de)}get useMipmap(){return this.#Z}set useMipmap(e){this.#Z=e,this.#ie()}destroy(){const e=this.#K;this.#se(null),this.__fireListenerList(!0),this.#de=null,this.#j=null,this.#ae(),e&&e.destroy()}#se(e){this.#K=e,e||(this.#pe=null),this.__fireListenerList()}#re(){basicRegisterResource(this,new ResourceStateCubeTexture(this))}#ae(){basicUnregisterResource(this)}#ie(){const{gpuDevice:e,resourceManager:t}=this.redGPUContext,{mipmapGenerator:r}=t;this.#K&&(this.#K.destroy(),this.#K=null),this.#Y=1;{const t=this.#pe,n=t[0],{width:i,height:s}=n,a={size:[i,s,6],format:this.#Q,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST};this.#Z&&(this.#Y=getMipLevelCount(i,s),a.mipLevelCount=this.#Y,a.usage|=GPUTextureUsage.RENDER_ATTACHMENT);const o=imageBitmapToGPUTexture(e,t,a);this.targetResourceManagedState.videoMemory-=this.#W,this.#W=calculateTextureByteSize(a),this.targetResourceManagedState.videoMemory+=this.#W,this.#Z&&r.generateMipmap(o,a),this.#se(o)}}async#ne(e){this.#pe=await async function(e){const t=e.map((e=>loadAndCreateBitmapImage(e)));return await Promise.all(t)}(e);try{this.#ie(),this.#ee?.(this)}catch(e){console.error(e),this.#te?.(e)}}}Object.freeze(CubeTexture);const Fe={TILE_COUNT_X:32,TILE_COUNT_Y:32,TILE_COUNT_Z:48,WORKGROUP_SIZE_X:8,WORKGROUP_SIZE_Y:4,WORKGROUP_SIZE_Z:8,MAX_POINT_LIGHTS_PER_CLUSTER:100,MAX_POINT_LIGHTS:1024,getTotalTileSize:()=>Fe.TILE_COUNT_X*Fe.TILE_COUNT_Y*Fe.TILE_COUNT_Z,getPointLight_ClusterLightsBufferSize:()=>{const e=Fe.getTotalTileSize();return 8*e+8*Fe.MAX_POINT_LIGHTS_PER_CLUSTER*e+4},getDispatchSize:()=>[Math.ceil(Fe.TILE_COUNT_X/Fe.WORKGROUP_SIZE_X),Math.ceil(Fe.TILE_COUNT_Y/Fe.WORKGROUP_SIZE_Y),Math.ceil(Fe.TILE_COUNT_Z/Fe.WORKGROUP_SIZE_Z)]};Object.freeze(Fe);const ze=Object.freeze({SYSTEM_UNIFORM:"struct DirectionalLight {\r\n\t direction:vec3<f32>,\r\n\t color:vec3<f32>,\r\n\t intensity:f32,\r\n};\r\nstruct AmbientLight {\r\n\t color:vec3<f32>,\r\n\t intensity:f32\r\n};\r\n\r\nstruct Camera {\r\n\t cameraMatrix:mat4x4<f32>,\r\n\t cameraPosition:vec3<f32>,\r\n\t nearClipping:f32,\rfarClipping:f32\r\n};\r\n\r\nstruct SystemUniform {\r\n\t projectionMatrix:mat4x4<f32>,\r\n\t inverseProjectionMatrix:mat4x4<f32>,\r\n\t projectionCameraMatrix:mat4x4<f32>,\r\n\t camera:Camera,\r\n\t resolution:vec2<f32>,\r\n\t viewPosition:vec2<f32>,\r\n\t \r\n\t directionalLightCount:u32,\r\n\t directionalLights:array<DirectionalLight,3>,\r\n\t \r\n\t directionalLightProjectionViewMatrix:mat4x4<f32>,\r\n\t directionalLightProjectionMatrix:mat4x4<f32>,\r\n\t directionalLightViewMatrix:mat4x4<f32>,\r\n\t \r\n\t directionalLightShadowDepthTextureSize:u32,\r\n\t directionalLightShadowBias:f32,\r\n\t \r\n\t ambientLight:AmbientLight,\r\n\r\n\t time:f32,\r\n\t \r\n\t useIblTexture:u32,\r\n\t isView3D:u32\r\n};\r\n\r\n@group(0) @binding(0) var<uniform> systemUniforms:SystemUniform;\r\n@group(0) @binding(1) var directionalShadowMapSampler:sampler_comparison;\r\n@group(0) @binding(2) var directionalShadowMap:texture_depth_2d;\r\n@group(0) @binding(3) var iblTextureSampler:sampler;\r\n@group(0) @binding(4) var iblTexture:texture_cube<f32>;\r\n\r\nconst pointLight_indicesLength:u32=REDGPU_DEFINE_MAX_LIGHTS_PER_CLUSTER * REDGPU_DEFINE_TOTAL_TILES;\r\nconst pointLight_tileCount=vec3<u32>(REDGPU_DEFINE_TILE_COUNT_Xu,REDGPU_DEFINE_TILE_COUNT_Yu,REDGPU_DEFINE_TILE_COUNT_Zu);\r\n\r\nstruct PointLight_ClusterLights {\roffset:u32,\rcount:u32\r\n};\r\nstruct PointLight_ClusterLightsGroup {\roffset:atomic<u32>,\rlights:array<PointLight_ClusterLights,REDGPU_DEFINE_TOTAL_TILES>,\rindices:array<u32,pointLight_indicesLength>\r\n};\r\nstruct PointLight_ClusterCube {\rminAABB:vec4<f32>,\rmaxAABB:vec4<f32>\r};\r\nstruct PointLight_Clusters {\rcubeList:array<PointLight_ClusterCube,REDGPU_DEFINE_TOTAL_TILES>\r\n};\r\n\r\nfn linearDepth(depthSample:f32) -> f32 {\rreturn systemUniforms.camera.farClipping*systemUniforms.camera.nearClipping/fma(depthSample,systemUniforms.camera.nearClipping-systemUniforms.camera.farClipping,systemUniforms.camera.farClipping);\r\n}\r\nfn getPointLightClusterIndex(fragCoord:vec4<f32>) -> u32 {\rlet tile=getPointLightTile(fragCoord);\rreturn tile.x +\rtile.y * pointLight_tileCount.x +\rtile.z * pointLight_tileCount.x * pointLight_tileCount.y;\r\n\r\n}\r\nfn getPointLightTile(fragCoord:vec4<f32>) -> vec3<u32> {\r\rlet sliceScale=f32(pointLight_tileCount.z)/log2(systemUniforms.camera.farClipping/systemUniforms.camera.nearClipping);\rlet sliceBias=-(f32(pointLight_tileCount.z) * log2(systemUniforms.camera.nearClipping)/log2(systemUniforms.camera.farClipping/systemUniforms.camera.nearClipping));\rlet zTile=u32(max(log2(linearDepth(fragCoord.z)) * sliceScale + sliceBias,0.0));\rreturn vec3<u32>(u32(fragCoord.x/(systemUniforms.resolution.x/f32(pointLight_tileCount.x))),\ru32(fragCoord.y/(systemUniforms.resolution.y/f32(pointLight_tileCount.y))),\rzTile);\r\n}\r\n\r\nstruct PointLight {\rposition:vec3<f32>,\rradius:f32,\rcolor:vec3<f32>,\rintensity:f32\r\n};\r\nstruct PointLightList {\rcount:vec4<f32>,\rlights:array<PointLight>\r\n};\r\n@group(0) @binding(5) var<storage> pointLightList:PointLightList;\r\n@group(0) @binding(6) var<storage,read_write> pointLight_clusterLightGroup:PointLight_ClusterLightsGroup;\r\n",calcTintBlendMode:"fn calcTintBlendMode(baseColor:vec4<f32>,tintBlendMode:u32,tint:vec4<f32>) -> vec4<f32> {\rvar tintedColor:vec3<f32>;\rswitch (tintBlendMode) {\rcase 0u:{ \rreturn vec4<f32>(mix(baseColor.rgb,tint.rgb,tint.a),baseColor.a);\r}\rcase 1u:{ \rtintedColor=baseColor.rgb * tint.rgb;\r}\rcase 2u:{ \rtintedColor=max(baseColor.rgb,tint.rgb);\r}\rcase 3u:{ \rtintedColor=1.0 - (1.0 - baseColor.rgb) * (1.0 - tint.rgb);\r}\rcase 4u:{ \rtintedColor=clamp(baseColor.rgb + tint.rgb,vec3<f32>(0.0),vec3<f32>(1.0));\r}\rcase 5u:{ \rtintedColor=clamp(baseColor.rgb - tint.rgb,vec3<f32>(0.0),vec3<f32>(1.0));\r}\rcase 6u:{ \rtintedColor=min(baseColor.rgb,tint.rgb);\r}\rcase 7u:{ \rtintedColor=mix(\r2.0 * baseColor.rgb * tint.rgb,\r1.0 - 2.0 * (1.0 - baseColor.rgb) * (1.0 - tint.rgb),\rstep(vec3<f32>(0.5),baseColor.rgb)\r);\r}\rcase 8u:{ \rtintedColor=clamp(baseColor.rgb/(1.0 - tint.rgb),vec3<f32>(0.0),vec3<f32>(1.0));\r}\rcase 9u:{ \rtintedColor=1.0 - clamp((1.0 - baseColor.rgb)/tint.rgb,vec3<f32>(0.0),vec3<f32>(1.0));\r}\rcase 10u:{ \rtintedColor=mix(\r2.0 * baseColor.rgb * tint.rgb,\r1.0 - 2.0 * (1.0 - baseColor.rgb) * (1.0 - tint.rgb),\rstep(vec3<f32>(0.5),tint.rgb)\r);\r}\rcase 11u:{ \rtintedColor=mix(\rbaseColor.rgb * (tint.rgb + tint.rgb - vec3<f32>(1.0)),\rbaseColor.rgb + tint.rgb - baseColor.rgb * tint.rgb,\rstep(vec3<f32>(0.5),tint.rgb)\r);\r}\rcase 12u:{ \rtintedColor=abs(baseColor.rgb - tint.rgb);\r}\rcase 13u:{ \rtintedColor=baseColor.rgb + tint.rgb - 2.0 * baseColor.rgb * tint.rgb;\r}\rcase 14u:{ \rtintedColor=clamp(baseColor.rgb/tint.rgb,vec3<f32>(0.0),vec3<f32>(1.0));\r}\rcase 15u:{ \rtintedColor=mix(\rclamp(baseColor.rgb/(1.0 - (tint.rgb - vec3<f32>(0.5)) * 2.0),vec3<f32>(0.0),vec3<f32>(1.0)),\r1.0 - clamp((1.0 - baseColor.rgb)/(tint.rgb * 2.0),vec3<f32>(0.0),vec3<f32>(1.0)),\rstep(vec3<f32>(0.5),tint.rgb)\r);\r}\rcase 16u:{ \rtintedColor=clamp(baseColor.rgb + tint.rgb - vec3<f32>(1.0),vec3<f32>(0.0),vec3<f32>(1.0));\r}\rcase 17u:{ \rtintedColor=mix(\rmin(baseColor.rgb,2.0 * tint.rgb),\rmax(baseColor.rgb,2.0 * tint.rgb - vec3<f32>(1.0)),\rstep(vec3<f32>(0.5),tint.rgb)\r);\r}\rcase 18u:{ \rlet baseHsl=rgbToHsl(baseColor.rgb);\rlet tintHsl=rgbToHsl(tint.rgb);\rtintedColor=hslToRgb(vec3<f32>(baseHsl.x,tintHsl.y,baseHsl.z));\r}\rcase 19u:{ \rlet baseHsl=rgbToHsl(baseColor.rgb);\rlet tintHsl=rgbToHsl(tint.rgb);\rtintedColor=hslToRgb(vec3<f32>(tintHsl.x,baseHsl.y,baseHsl.z));\r}\rcase 20u:{ \rlet baseHsl=rgbToHsl(baseColor.rgb);\rlet tintHsl=rgbToHsl(tint.rgb);\rtintedColor=hslToRgb(vec3<f32>(baseHsl.x,baseHsl.y,tintHsl.z));\r}\rcase 21u:{ \rlet baseHsl=rgbToHsl(baseColor.rgb);\rlet tintHsl=rgbToHsl(tint.rgb);\rtintedColor=hslToRgb(vec3<f32>(tintHsl.x,tintHsl.y,baseHsl.z));\r}\rcase 22u:{ \rtintedColor=1.0 - abs(1.0 - baseColor.rgb - tint.rgb);\r}\rdefault:{\rtintedColor=baseColor.rgb;\r}\r}\r\n\rreturn vec4<f32>(tintedColor,baseColor.a * tint.a);\r\n}\r\n\r\n\r\nfn rgbToHsl(rgb:vec3<f32>) -> vec3<f32> {\rlet maxVal:f32=max(max(rgb.r,rgb.g),rgb.b);\rlet minVal:f32=min(min(rgb.r,rgb.g),rgb.b);\rlet delta:f32=maxVal - minVal;\r\n\rlet lightness:f32=(maxVal + minVal) * 0.5;\r\n\rif (delta==0.0) {\rreturn vec3<f32>(0.0,0.0,lightness);\r}\r\n\r\rvar saturation:f32;\rif (lightness < 0.5) {\rsaturation=delta/(maxVal + minVal);\r} else {\rsaturation=delta/(2.0 - maxVal - minVal);\r}\r\n\r\rvar hue:f32=0.0;\rif (rgb.r==maxVal) {\rhue=(rgb.g - rgb.b)/delta;\rif (rgb.g < rgb.b) {\rhue +=6.0;\r}\r} else if (rgb.g==maxVal) {\rhue=(rgb.b - rgb.r)/delta + 2.0;\r} else { \rhue=(rgb.r - rgb.g)/delta + 4.0;\r}\r\n\rhue=hue/6.0;\r\n\rreturn vec3<f32>(hue,saturation,lightness);\r\n}\r\n\r\nfn hslToRgb(hsl:vec3<f32>) -> vec3<f32> {\rlet h=hsl.x;\rlet s=hsl.y;\rlet l=hsl.z;\r\n\rif (s==0.0) {\r\rreturn vec3<f32>(l,l,l);\r}\r\n\r\rvar q:f32;\rif (l < 0.5) {\rq=l * (1.0 + s);\r} else {\rq=l + s - l * s;\r}\r\n\rlet p=2.0 * l - q;\r\n\r\rvar r:f32;\rvar g:f32;\rvar b:f32;\r\n\rfor (var i:i32=0;i < 3;i=i + 1) {\rvar t:f32;\rif (i==0) {\rt=h + 1.0/3.0;\r} else if (i==1) {\rt=h;\r} else {\rt=h - 1.0/3.0;\r}\r\n\rif (t < 0.0) {\rt=t + 1.0;\r}\rif (t > 1.0) {\rt=t - 1.0;\r}\r\n\rvar color:f32;\rif (t < 1.0/6.0) {\rcolor=p + (q - p) * 6.0 * t;\r} else if (t < 1.0/2.0) {\rcolor=q;\r} else if (t < 2.0/3.0) {\rcolor=p + (q - p) * (2.0/3.0 - t) * 6.0;\r} else {\rcolor=p;\r}\r\n\rif (i==0) {\rr=color;\r} else if (i==1) {\rg=color;\r} else {\rb=color;\r}\r}\r\n\rreturn vec3<f32>(r,g,b);\r\n}",drawDirectionalShadowDepth:"struct OutputShadowData {\r@builtin(position) position:vec4<f32>,\r\n};\r\n\r\n@vertex\r\nfn drawDirectionalShadowDepth( inputData:InputData ) -> OutputShadowData {\rvar output:OutputShadowData;\rlet u_useDisplacementTexture=vertexUniforms.useDisplacementTexture==1u;\r\rlet u_directionalLightProjectionViewMatrix=systemUniforms.directionalLightProjectionViewMatrix;\rlet u_camera=systemUniforms.camera;\rlet u_cameraMatrix=u_camera.cameraMatrix;\rlet u_cameraPosition=u_camera.cameraPosition;\r\rlet u_modelMatrix=vertexUniforms.modelMatrix;\rlet u_displacementScale=vertexUniforms.displacementScale;\r\rlet input_position=inputData.position;\rlet input_vertexNormal=inputData.vertexNormal;\rlet input_uv=inputData.uv;\r\rvar position:vec4<f32>;\rposition=u_modelMatrix * vec4<f32>(input_position,1.0);\r\n\rif (u_useDisplacementTexture) {\rlet distance=distance(position.xyz,u_cameraPosition);\rlet mipLevel=(distance/maxDistance) * maxMipLevel;\rlet displacementSample=textureSampleLevel(displacementTexture,displacementTextureSampler,input_uv,mipLevel).r;\rlet scaledDisplacement=displacementSample * u_displacementScale;\rlet displacedPosition=input_position + input_vertexNormal * scaledDisplacement;\rposition=u_modelMatrix * vec4<f32>(displacedPosition,1.0);\r}\routput.position=u_directionalLightProjectionViewMatrix * position;\rreturn output;\r\n}\r\n",getBillboardMatrix:"fn getBillboardMatrix(cameraMatrix:mat4x4<f32>,modelMatrix:mat4x4<f32>) -> mat4x4<f32> {\r\rlet scaleX=length(vec3<f32>(modelMatrix[0].xyz));\rlet scaleY=length(vec3<f32>(modelMatrix[1].xyz));\rlet scaleZ=length(vec3<f32>(modelMatrix[2].xyz));\r\n\r\rlet scaleMatrix=mat4x4<f32>(\rvec4<f32>(scaleX,0.0,0.0,0.0),\rvec4<f32>(0.0,scaleY,0.0,0.0),\rvec4<f32>(0.0,0.0,scaleZ,0.0),\rvec4<f32>(0.0,0.0,0.0,1.0)\r);\r\n\r\rvar resultMatrix=cameraMatrix * modelMatrix;\rresultMatrix[0][0]=1.0;resultMatrix[0][1]=0.0;resultMatrix[0][2]=0.0;\rresultMatrix[1][0]=0.0;resultMatrix[1][1]=1.0;resultMatrix[1][2]=0.0;\rresultMatrix[2][0]=0.0;resultMatrix[2][1]=0.0;resultMatrix[2][2]=1.0;\r\n\r\rreturn resultMatrix * scaleMatrix;\r\n}\r\nfn getBillboardMatrixNoScaleRatio( cameraMatrix:mat4x4<f32>, modelMatrix:mat4x4<f32>)-> mat4x4<f32>{\rvar resultMatrix=cameraMatrix * modelMatrix;\rresultMatrix[0][0]=modelMatrix[0][0];resultMatrix[0][1]=0.0;resultMatrix[0][2]=0.0;\rresultMatrix[1][0]=0.0;resultMatrix[1][1]=modelMatrix[1][1];resultMatrix[1][2]=0.0;\rresultMatrix[2][0]=0.0;resultMatrix[2][1]=0.0;resultMatrix[2][2]=modelMatrix[2][2];\r\n\rreturn resultMatrix;\r\n}\r\n",extractScaleAndTranslation:"fn extractScaleAndTranslation(modelMatrix:mat4x4<f32>) -> mat4x4<f32> {\r\rlet scaleX=length(vec3<f32>(modelMatrix[0].xyz));\rlet scaleY=length(vec3<f32>(modelMatrix[1].xyz));\rlet scaleZ=length(vec3<f32>(modelMatrix[2].xyz));\r\n\r\rlet scaleMatrix=mat4x4<f32>(\rvec4<f32>(scaleX,0.0,0.0,0.0),\rvec4<f32>(0.0,scaleY,0.0,0.0),\rvec4<f32>(0.0,0.0,scaleZ,0.0),\rvec4<f32>(0.0,0.0,0.0,1.0)\r);\r\n\r\rreturn mat4x4<f32>(\rscaleMatrix[0],\rscaleMatrix[1],\rscaleMatrix[2],\rmodelMatrix[3] \r);\r\n}",calcDirectionalShadowVisibility:"fn calcDirectionalShadowVisibility(\rdirectionalShadowMap:texture_depth_2d,\rdirectionalShadowMapSampler:sampler_comparison,\rdirectionalLightShadowDepthTextureSize:u32,\rdirectionalLightShadowBias:f32,\rshadowPos:vec3<f32>\r\n) -> f32 {\rlet oneOverShadowDepthTextureSize=1.0/f32(directionalLightShadowDepthTextureSize);\rlet shadowDepth=clamp(shadowPos.z,0.0,1.0);\rvar visibility:f32=0.0;\rfor (var y=-1;y <=1;y++) {\rfor (var x=-1;x <=1;x++) {\rlet offset=vec2f(vec2(x,y)) * oneOverShadowDepthTextureSize;\rvar tUV:vec2<f32>=shadowPos.xy + offset;\rvar sampleVisibility=textureSampleCompare(\rdirectionalShadowMap,\rdirectionalShadowMapSampler,\rtUV,\rshadowDepth - directionalLightShadowBias\r);\r\n\rif (tUV.x < 0.0 || tUV.x > 1.0 || tUV.y < 0.0 || tUV.y > 1.0) {\rvisibility +=1.0;\r} else {\rvisibility +=sampleVisibility;\r}\r}\r}\rvisibility/=9.0;\rreturn visibility;\r\n}\r\n",drawPicking:"\r\n@fragment\r\nfn picking(inputData:InputData) -> @location(0) vec4<f32> {\rvar finalColor:vec4<f32>=inputData.pickingId;\rreturn finalColor;\r\n}\r\n",normalFunctions:"\r\nfn cotangent_frame( N:vec3<f32>, p:vec3<f32>, uv:vec2<f32>) -> mat3x3<f32>{\rlet dp1:vec3<f32>=dpdx( p );\rlet dp2:vec3<f32>=dpdy( p );\rlet duv1:vec2<f32>=dpdx( uv );\rlet duv2:vec2<f32>=dpdy( uv );\r\n\rlet dp2perp:vec3<f32>=cross( dp2,N );\rlet dp1perp:vec3<f32>=cross( N,dp1 );\rlet T:vec3<f32>=dp2perp * duv1.x + dp1perp * duv2.x;\rlet B:vec3<f32>=dp2perp * duv1.y + dp1perp * duv2.y;\rlet invmax:f32=inverseSqrt( max( dot(T,T),dot(B,B) ) );\rreturn mat3x3<f32>( T * invmax,B * invmax,N );\r\n}\r\nfn perturb_normal( N:vec3<f32>, V:vec3<f32>, texcoord:vec2<f32>, normalColor:vec3<f32>,normalPower:f32 ) -> vec3<f32> {\rvar map:vec3<f32>=normalColor;\rmap= map * 255./127. - 128./127.;\rmap=vec3<f32>(map.xy * -normalPower,map.z);\rlet TBN:mat3x3<f32>=cotangent_frame(N,V,texcoord);\rreturn normalize(TBN * map);\r\n}\r\n"});Object.freeze(ze);const $e=Object.keys(ze).join("|"),He=new RegExp(`#redgpu_include (${$e})`,"g"),parseIncludeWGSL=e=>e.replace(He,((e,t)=>ze[t]||e)).replace(/REDGPU_DEFINE_TILE_COUNT_X/g,Fe.TILE_COUNT_X.toString()).replace(/REDGPU_DEFINE_TILE_COUNT_Y/g,Fe.TILE_COUNT_Y.toString()).replace(/REDGPU_DEFINE_TILE_COUNT_Z/g,Fe.TILE_COUNT_Z.toString()).replace(/REDGPU_DEFINE_TOTAL_TILES/g,Fe.getTotalTileSize().toString()).replace(/REDGPU_DEFINE_WORKGROUP_SIZE_X/g,Fe.WORKGROUP_SIZE_X.toString()).replace(/REDGPU_DEFINE_WORKGROUP_SIZE_Y/g,Fe.WORKGROUP_SIZE_Y.toString()).replace(/REDGPU_DEFINE_WORKGROUP_SIZE_Z/g,Fe.WORKGROUP_SIZE_Z.toString()).replace(/REDGPU_DEFINE_WORKGROUP_SIZE_Z/g,Fe.WORKGROUP_SIZE_Z.toString()).replace(/REDGPU_DEFINE_MAX_LIGHTS_PER_CLUSTER/g,Fe.MAX_POINT_LIGHTS_PER_CLUSTER.toString());class ResourceState{table={};videoMemory=0;length=0;constructor(){}}var Ke;Object.freeze(ResourceState),function(e){e.GPUShaderModule="GPUShaderModule",e.GPUBindGroupLayout="GPUBindGroupLayout",e.GPUPipelineLayout="GPUPipelineLayout"}(Ke||(Ke={}));class ResourceManager extends ResourceBase{static PRESET_GPUBindGroupLayout_System="PRESET_GPUBindGroupLayout_System";static PRESET_VERTEX_GPUBindGroupLayout_Instancing="PRESET_VERTEX_GPUBindGroupLayout_Instancing";static PRESET_VERTEX_GPUBindGroupLayout="PRESET_VERTEX_GPUBindGroupLayout";static PRESET_VERTEX_GPUBindGroupLayout_SKIN="PRESET_VERTEX_GPUBindGroupLayout_SKIN";#fe=new ImmutableKeyMap([[Ke.GPUShaderModule,new Map],[Ke.GPUBindGroupLayout,new Map],[Ke.GPUPipelineLayout,new Map]]);#ge=new ResourceState;#xe=new ResourceState;#_e=new ResourceState;#ve=new ResourceState;#ye=new ResourceState;#Te=new ResourceState;#be=new ResourceState;#Se={};#Me;#Re;#we;#Ee;constructor(e){super(e),this.#we=new MipmapGenerator(e),this.#Pe()}get basicSampler(){return this.#Ee}get mipmapGenerator(){return this.#we}get cachedBufferState(){return this.#Se}get emptyBitmapTextureView(){return this.#Me}get emptyCubeTextureView(){return this.#Re}get managedBitmapTextureState(){return this.#ge}get managedCubeTextureState(){return this.#xe}get managedUniformBufferState(){return this.#ve}get managedVertexBufferState(){return this.#ye}get managedIndexBufferState(){return this.#Te}get managedStorageBufferState(){return this.#be}get resources(){return this.#fe}createGPUShaderModule(e,t){return this.#Ce(e,t,(t=>this.#ke(e,t)),Ke.GPUShaderModule)}getGPUShaderModule(e){return this.#Ie(e,Ke.GPUShaderModule)}deleteGPUShaderModule(e){this.#Ue(e,Ke.GPUShaderModule)}createBindGroupLayout(e,t){return this.#Ce(e,t,(t=>(t.label||(t.label=e),this.redGPUContext.gpuDevice.createBindGroupLayout(t))),Ke.GPUBindGroupLayout)}getGPUBindGroupLayout(e){return this.#Ie(e,Ke.GPUBindGroupLayout)}deleteGPUBindGroupLayout(e){this.#Ue(e,Ke.GPUBindGroupLayout)}createGPUPipelineLayout(e,t){return this.#Ce(e,t,(t=>(t.label||(t.label=e),this.redGPUContext.gpuDevice.createPipelineLayout(t))),Ke.GPUPipelineLayout)}getGPUPipelineLayout(e){return this.#Ie(e,Ke.GPUPipelineLayout)}deleteGPUPipelineLayout(e){this.#Ue(e,Ke.GPUPipelineLayout)}#Pe(){const{gpuDevice:e}=this.redGPUContext;{const t=e.createTexture({size:{width:1,height:1,depthOrArrayLayers:1},format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST,label:"emptyBitmapTexture"});this.#Me=t.createView();const r=new Uint8Array([0,0,0,0]);e.queue.writeTexture({texture:t},r,{bytesPerRow:4,rowsPerImage:1},{width:1,height:1,depthOrArrayLayers:1});const n=e.createTexture({size:{width:1,height:1,depthOrArrayLayers:6},format:"rgba8unorm",usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST,label:"emptyCubeTexture"});this.#Re=n.createView(CubeTexture.defaultViewDescriptor);const i=new Uint8Array([0,0,0,0]);for(let t=0;t<6;t++)e.queue.writeTexture({texture:n,origin:{x:0,y:0,z:t}},i,{bytesPerRow:4,rowsPerImage:1},{width:1,height:1,depthOrArrayLayers:1});this.#Ee=new Sampler(this.redGPUContext)}this.createBindGroupLayout(ResourceManager.PRESET_GPUBindGroupLayout_System,{entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},{binding:1,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,sampler:{type:"comparison"}},{binding:2,visibility:GPUShaderStage.FRAGMENT,texture:{sampleType:"depth"}},{binding:3,visibility:GPUShaderStage.FRAGMENT,sampler:{type:"filtering"}},{binding:4,visibility:GPUShaderStage.FRAGMENT,texture:{viewDimension:"cube"}},{binding:5,visibility:GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:6,visibility:GPUShaderStage.FRAGMENT|GPUShaderStage.COMPUTE,buffer:{type:"storage"}}]}),this.createBindGroupLayout(ResourceManager.PRESET_VERTEX_GPUBindGroupLayout,{entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{type:"uniform"}},{binding:1,visibility:GPUShaderStage.VERTEX,sampler:{type:"filtering"}},{binding:2,visibility:GPUShaderStage.VERTEX,texture:{}}]}),this.createBindGroupLayout(ResourceManager.PRESET_VERTEX_GPUBindGroupLayout_SKIN,{entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{type:"uniform"}},{binding:1,visibility:GPUShaderStage.VERTEX,sampler:{type:"filtering"}},{binding:2,visibility:GPUShaderStage.VERTEX,texture:{}},{binding:3,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}}]}),this.createBindGroupLayout(ResourceManager.PRESET_VERTEX_GPUBindGroupLayout_Instancing,{entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}},{binding:1,visibility:GPUShaderStage.VERTEX,sampler:{type:"filtering"}},{binding:2,visibility:GPUShaderStage.VERTEX,texture:{}}]})}#Be(e){return this.#fe.get(e)}#ke(e,t){const{code:r}=t,n=parseIncludeWGSL(r),i=this.redGPUContext.gpuDevice.createShaderModule({...t,code:n});return this.#Be(Ke.GPUShaderModule).set(e,i),i}#Le(e,t){if(!e)throw new Error("Name is required");return this.#Be(t)}#Ce(e,t,r,n){const i=this.#Le(e,n);if(i.has(e))return i.get(e);t.label||(t.label=e);const s=r(t);return i.set(e,s),s}#Ie(e,t){return this.#Le(e,t).get(e)}#Ue(e,t){const r=this.#Le(e,t);if(!r.has(e))throw new Error(`${t} with name ${e} doesn't exist.`);r.delete(e)}}Object.freeze(BitmapTexture);class ImmutableKeyMap extends Map{constructor(e=[]){super(),e?.forEach((([e,t])=>super.set(e,t)))}set(e,t){if(this.has(e))throw new Error("Cannot change the value of an existing key");return super.set(e,t)}}const createMeshVertexUniformBuffers=(e,t=!1)=>{const{gpuRenderInfo:r,redGPUContext:n}=e,{resourceManager:i}=n,s=i.getGPUBindGroupLayout(t?ResourceManager.PRESET_VERTEX_GPUBindGroupLayout_SKIN:ResourceManager.PRESET_VERTEX_GPUBindGroupLayout),a=new ArrayBuffer(r.vertexUniformInfo.arrayBufferByteLength),o=new UniformBuffer(n,a,e.name);r.vertexBindGroupLayout=s,r.vertexUniformBuffer=o},isHexColor=e=>{const t=/^([A-Fa-f0-9]{3}){1,2}$/;return e.startsWith("#")?t.test(e.substring(1)):!!e.startsWith("0x")&&t.test(e.substring(2))},convertHexToRgb=(e,t=!1)=>{if("number"==typeof e&&(e=`#${e.toString(16)}`),isHexColor(e)){"#"===e.charAt(0)&&(e=e.substring(1)),3===e.length&&(e=e.charAt(0)+e.charAt(0)+e.charAt(1)+e.charAt(1)+e.charAt(2)+e.charAt(2));const r=parseInt("0x"+e),n=r>>16&255,i=r>>8&255,s=255&r;return t?[n,i,s]:{r:n,g:i,b:s}}throw Error(`from ${convertHexToRgb.constructor.name}:input value - ${e}/Only hex string allowed`)},convertRgbToHex=(e,t,r)=>{validateUintRange(e,0,255),validateUintRange(t,0,255),validateUintRange(r,0,255);return`#${e.toString(16).padStart(2,"0").toUpperCase()}${t.toString(16).padStart(2,"0").toUpperCase()}${r.toString(16).padStart(2,"0").toUpperCase()}`};class ColorRGB{#Ae;#De;#Oe;#Ge;constructor(e=255,t=255,r=255,n=void 0){this.#Ne(e,t,r),this.#Ve(e,t,r),n&&(this.#Ge=n)}get r(){return this.#Ae}set r(e){validateUintRange(e,0,255),this.#Ae=e,this.#Ge?.()}get g(){return this.#De}set g(e){validateUintRange(e,0,255),this.#De=e,this.#Ge?.()}get b(){return this.#Oe}set b(e){validateUintRange(e,0,255),this.#Oe=e,this.#Ge?.()}get rgb(){return[this.#Ae,this.#De,this.#Oe]}get rgbNormal(){return[this.#Ae/255,this.#De/255,this.#Oe/255]}get hex(){return convertRgbToHex(this.#Ae,this.#De,this.#Oe)}setColorByRGB(e,t,r){this.#Ne(e,t,r),this.#Ve(e,t,r)}setColorByHEX(e){const{r:t,g:r,b:n}=convertHexToRgb(e);this.#Ve(t,r,n)}setColorByRGBString(e){const t=/rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/.exec(e);t||consoleAndThrowError(`Invalid rgb color value:${e}`);const[,r,n,i]=t.map(Number);this.#Ne(r,n,i),this.#Ve(r,n,i)}#Ve(e,t,r){this.#Ae=e,this.#De=t,this.#Oe=r,this.#Ge?.()}#Ne(e,t,r){validateUintRange(e,0,255),validateUintRange(t,0,255),validateUintRange(r,0,255)}}function defineColorRGB(e,t="#fff",r=!0){const n=Symbol(e);return{get:function(){if(void 0===this[n]){let i=255,s=255,a=255;if(isHexColor(t)){const e=convertHexToRgb(t);i=e.r,s=e.g,a=e.b}this[n]=new ColorRGB(i,s,a,(()=>{const{gpuRenderInfo:t}=this;if(t)if(r){const{fragmentUniformInfo:r,fragmentUniformBuffer:i}=t;i.writeBuffer(r.members[e],this[n].rgbNormal)}else{const{vertexUniformInfo:r,vertexUniformBuffer:i}=t;i.writeBuffer(r.members[e],this[n].rgbNormal)}}))}return this[n]},...Ee}}Object.freeze(defineColorRGB);class ColorRGBA extends ColorRGB{#Fe;#Ge;constructor(e=255,t=255,r=255,n=1,i=void 0){super(e,t,r,i),validatePositiveNumberRange(n,0,1),this.#Fe=n,i&&(this.#Ge=i)}get a(){return this.#Fe}set a(e){validatePositiveNumberRange(e,0,1),this.#Fe=e,this.#Ge?.()}get rgba(){return[this.r,this.g,this.b,this.#Fe]}get rgbaNormal(){return[this.r/255,this.g/255,this.b/255,this.#Fe]}setColorByRGBA(e,t,r,n){this.#ze(e,t,r,n),this.r=e,this.g=t,this.b=r,this.#Fe=n,this.#Ge?.()}setColorByRGBAString(e){const t=/rgba\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d*(?:\.\d+)?)\s*\)/.exec(e);if(!t)throw new Error(`Invalid rgba color value:${e}`);const[,r,n,i,s]=t.map(Number);this.#ze(r,n,i,s),this.r=r,this.g=n,this.b=i,this.#Fe=s,this.#Ge?.()}#ze(e,t,r,n){validateUintRange(e,0,255),validateUintRange(t,0,255),validateUintRange(r,0,255),validatePositiveNumberRange(n,0,1)}}function defineColorRGBA(e,t="#fff",r=!0){const n=Symbol(e);return{get:function(){if(void 0===this[n]){let i=255,s=255,a=255,o=1;if(isHexColor(t)){const e=convertHexToRgb(t);i=e.r,s=e.g,a=e.b}this[n]=new ColorRGBA(i,s,a,o,(()=>{const{gpuRenderInfo:t}=this;if(t)if(r){const{fragmentUniformInfo:r,fragmentUniformBuffer:i}=t;i.writeBuffer(r.members[e],this[n].rgbaNormal)}else{const{vertexUniformInfo:r,vertexUniformBuffer:i}=t;i.writeBuffer(r.members[e],this[n].rgbaNormal)}}))}return this[n]},...Ee}}function createSetter$2(e,t,r){const n=`use${e.charAt(0).toUpperCase()}${e.substring(1)}`;return function(e){const i=this[t];this[t]=e,this.updateTexture(i,e);const{gpuRenderInfo:s}=this;if(r){const{fragmentUniformInfo:t,fragmentUniformBuffer:r}=s;t.members[n]?r.writeBuffer(t.members[n],e?1:0):console.warn(this.material,n," fragment shader   .      ")}else if(s){const{vertexUniformInfo:t,vertexUniformBuffer:r}=s;t.members[n]?r.writeBuffer(r.members[n],e?1:0):console.warn(this.material,n," vertex shader   .      ")}}}function defineCubeTexture(e,t=!0){const r=Symbol(e);return{get:function(){return this[r]},set:createSetter$2(e,r,t),...Ee}}function defineSampler(e){const t=Symbol(e);return{get:function(){return this[t]},set:function(e){const r=this[t];this[t]=e,this.updateSampler(r,e)},...Ee}}function createSetter$1(e,t,r){const n=`use${e.charAt(0).toUpperCase()}${e.substring(1)}`,i=`premultiply${e.charAt(0).toUpperCase()}${e.substring(1)}`;return function(e){const s=this[t];this[t]=e,this.updateTexture(s,e);const{gpuRenderInfo:a}=this;if(r){const{fragmentUniformInfo:t,fragmentUniformBuffer:r}=a;t.members[n]?r.writeBuffer(t.members[n],e?1:0):console.warn(this.material,n," fragment shader   .      "),t.members[i]?r.writeBuffer(t.members[i],e?.usePremultiplyAlpha?1:0):console.warn(this.material,i," fragment shader   .      ")}else if(a){const{vertexUniformInfo:t,vertexUniformBuffer:r}=a;t.members[n]?r.writeBuffer(r.members[n],e?1:0):console.warn(this.material,n," vertex shader   .      ")}}}function defineTexture(e,t=!0){const r=Symbol(e);return{get:function(){return this[r]},set:createSetter$1(e,r,t),...Ee}}function createSetter(e,t,r){return function(n){this[t]=n;const{gpuRenderInfo:i}=this;if(r){const{fragmentUniformInfo:t,fragmentUniformBuffer:r}=i;r.writeBuffer(t.members[e],n)}else if(i){const{vertexUniformInfo:t,vertexUniformBuffer:r}=i;r.writeBuffer(t.members[e],n)}}}function defineVector(e,t,r=!0){const n=Symbol(e);return{get:function(){return void 0===this[n]&&(this[n]=t),this[n]},set:createSetter(e,n,r),...Ee}}function defineProperty_vec4(e,t=[0,0,0,0]){return defineVector(e,t)}function defineProperty_vec3(e,t=[0,0,0]){return defineVector(e,t)}function defineProperty_vec2(e,t=[0,0]){return defineVector(e,t)}Object.freeze(defineColorRGBA),Object.freeze(defineCubeTexture),Object.freeze(defineSampler),Object.freeze(defineTexture),Object.freeze(defineVector);const Xe={},je={AO_STRENGTH:"aoStrength",SPECULAR_STRENGTH:"specularStrength",EMISSIVE_STRENGTH:"emissiveStrength",OPACITY:"opacity",SHININESS:"shininess",NORMAL_SCALE:"normalScale"},Ye={},Ze={ALPHA_TEXTURE_SAMPLER:"alphaTextureSampler",AO_TEXTURE_SAMPLER:"aoTextureSampler",DIFFUSE_TEXTURE_SAMPLER:"diffuseTextureSampler",EMISSIVE_TEXTURE_SAMPLER:"emissiveTextureSampler",ENVIRONMENT_TEXTURE_SAMPLER:"environmentTextureSampler",NORMAL_TEXTURE_SAMPLER:"normalTextureSampler",SPECULAR_TEXTURE_SAMPLER:"specularTextureSampler"},qe={ENVIRONMENT_TEXTURE:"environmentTexture"},We={},Je={},Qe={},et={ALPHA_TEXTURE:"alphaTexture",AO_TEXTURE:"aoTexture",DIFFUSE_TEXTURE:"diffuseTexture",EMISSIVE_TEXTURE:"emissiveTexture",NORMAL_TEXTURE:"normalTexture",SPECULAR_TEXTURE:"specularTexture"},tt={COLOR:"color",EMISSIVE_COLOR:"emissiveColor",SPECULAR_COLOR:"specularColor"},rt={...createDefineByPreset({defineBoolean:[defineBoolean,Xe],definePositiveNumber:[definePositiveNumberRange,je],defineUint:[defineUintRange,Ye],defineVec2:[defineProperty_vec2,We],defineVec3:[defineProperty_vec3,Je],defineVec4:[defineProperty_vec4,Qe],defineColorRGB:[defineColorRGB,tt],defineSampler:[defineSampler,Ze],defineTexture:[defineTexture,et],defineCubeTexture:[defineCubeTexture,qe]}),defineBoolean:defineProperties(defineBoolean),definePositiveNumber:defineProperties(definePositiveNumberRange),defineUint:defineProperties(defineUintRange),defineVec2:defineProperties(defineProperty_vec2),defineVec3:defineProperties(defineProperty_vec3),defineVec4:defineProperties(defineProperty_vec4),defineColorRGB:defineProperties(defineColorRGB),defineColorRGBA:defineProperties(defineColorRGBA),defineSampler:defineProperties(defineSampler),defineTexture:defineProperties(defineTexture),defineCubeTexture:defineProperties(defineCubeTexture),PRESET_BOOLEAN:Xe,PRESET_POSITIVE_NUMBER:je,PRESET_UINT:Ye,PRESET_SAMPLER:Ze,PRESET_TEXTURE:et,PRESET_CUBE_TEXTURE:qe,PRESET_VEC2:We,PRESET_VEC3:Je,PRESET_VEC4:Qe,PRESET_COLOR_RGB:tt};Object.freeze(rt);class ParseContext{constructor(){this.constants=new Map,this.aliases=new Map,this.structs=new Map}}class Node{constructor(){}get isAstNode(){return!0}get astNodeType(){return""}evaluate(e){throw new Error("Cannot evaluate node")}evaluateString(e){return this.evaluate(e).toString()}search(e){}searchBlock(e,t){if(e){t(_BlockStart.instance);for(const r of e)r instanceof Array?this.searchBlock(r,t):r.search(t);t(_BlockEnd.instance)}}}class _BlockStart extends Node{}_BlockStart.instance=new _BlockStart;class _BlockEnd extends Node{}_BlockEnd.instance=new _BlockEnd;class Statement extends Node{constructor(){super()}}let nt=class extends Statement{constructor(e,t,r,n,i,s){super(),this.calls=new Set,this.name=e,this.args=t,this.returnType=r,this.body=n,this.startLine=i,this.endLine=s}get astNodeType(){return"function"}search(e){this.searchBlock(this.body,e)}};class StaticAssert extends Statement{constructor(e){super(),this.expression=e}get astNodeType(){return"staticAssert"}search(e){this.expression.search(e)}}class While extends Statement{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return"while"}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class Continuing extends Statement{constructor(e){super(),this.body=e}get astNodeType(){return"continuing"}search(e){this.searchBlock(this.body,e)}}class For extends Statement{constructor(e,t,r,n){super(),this.init=e,this.condition=t,this.increment=r,this.body=n}get astNodeType(){return"for"}search(e){var t,r,n;null===(t=this.init)||void 0===t||t.search(e),null===(r=this.condition)||void 0===r||r.search(e),null===(n=this.increment)||void 0===n||n.search(e),this.searchBlock(this.body,e)}}class Var extends Statement{constructor(e,t,r,n,i){super(),this.name=e,this.type=t,this.storage=r,this.access=n,this.value=i}get astNodeType(){return"var"}search(e){var t;e(this),null===(t=this.value)||void 0===t||t.search(e)}}class Override extends Statement{constructor(e,t,r){super(),this.name=e,this.type=t,this.value=r}get astNodeType(){return"override"}search(e){var t;null===(t=this.value)||void 0===t||t.search(e)}}class Let extends Statement{constructor(e,t,r,n,i){super(),this.name=e,this.type=t,this.storage=r,this.access=n,this.value=i}get astNodeType(){return"let"}search(e){var t;e(this),null===(t=this.value)||void 0===t||t.search(e)}}class Const extends Statement{constructor(e,t,r,n,i){super(),this.name=e,this.type=t,this.storage=r,this.access=n,this.value=i}get astNodeType(){return"const"}evaluate(e){return this.value.evaluate(e)}search(e){var t;e(this),null===(t=this.value)||void 0===t||t.search(e)}}var it,st,at,ot,ut;!function(e){e.increment="++",e.decrement="--"}(it||(it={})),function(e){e.parse=function(t){const r=t;if("parse"==r)throw new Error("Invalid value for IncrementOperator");return e[r]}}(it||(it={}));class Increment extends Statement{constructor(e,t){super(),this.operator=e,this.variable=t}get astNodeType(){return"increment"}search(e){this.variable.search(e)}}!function(e){e.assign="=",e.addAssign="+=",e.subtractAssin="-=",e.multiplyAssign="*=",e.divideAssign="/=",e.moduloAssign="%=",e.andAssign="&=",e.orAssign="|=",e.xorAssign="^=",e.shiftLeftAssign="<<=",e.shiftRightAssign=">>="}(st||(st={})),function(e){e.parse=function(e){const t=e;if("parse"==t)throw new Error("Invalid value for AssignOperator");return t}}(st||(st={}));class Assign extends Statement{constructor(e,t,r){super(),this.operator=e,this.variable=t,this.value=r}get astNodeType(){return"assign"}search(e){this.variable.search(e),this.value.search(e)}}class Call extends Statement{constructor(e,t){super(),this.name=e,this.args=t}get astNodeType(){return"call"}search(e){for(const t of this.args)t.search(e);e(this)}}class Loop extends Statement{constructor(e,t){super(),this.body=e,this.continuing=t}get astNodeType(){return"loop"}}class Switch extends Statement{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return"body"}}class If extends Statement{constructor(e,t,r,n){super(),this.condition=e,this.body=t,this.elseif=r,this.else=n}get astNodeType(){return"if"}search(e){this.condition.search(e),this.searchBlock(this.body,e),this.searchBlock(this.elseif,e),this.searchBlock(this.else,e)}}class Return extends Statement{constructor(e){super(),this.value=e}get astNodeType(){return"return"}search(e){var t;null===(t=this.value)||void 0===t||t.search(e)}}class Enable extends Statement{constructor(e){super(),this.name=e}get astNodeType(){return"enable"}}class Requires extends Statement{constructor(e){super(),this.extensions=e}get astNodeType(){return"requires"}}class Diagnostic extends Statement{constructor(e,t){super(),this.severity=e,this.rule=t}get astNodeType(){return"diagnostic"}}class Alias extends Statement{constructor(e,t){super(),this.name=e,this.type=t}get astNodeType(){return"alias"}}class Discard extends Statement{constructor(){super()}get astNodeType(){return"discard"}}class Break extends Statement{constructor(){super()}get astNodeType(){return"break"}}class Continue extends Statement{constructor(){super()}get astNodeType(){return"continue"}}class Type extends Statement{constructor(e){super(),this.name=e}get astNodeType(){return"type"}get isStruct(){return!1}get isArray(){return!1}}class Struct extends Type{constructor(e,t,r,n){super(e),this.members=t,this.startLine=r,this.endLine=n}get astNodeType(){return"struct"}get isStruct(){return!0}getMemberIndex(e){for(let t=0;t<this.members.length;t++)if(this.members[t].name==e)return t;return-1}}class TemplateType extends Type{constructor(e,t,r){super(e),this.format=t,this.access=r}get astNodeType(){return"template"}}class PointerType extends Type{constructor(e,t,r,n){super(e),this.storage=t,this.type=r,this.access=n}get astNodeType(){return"pointer"}}class ArrayType extends Type{constructor(e,t,r,n){super(e),this.attributes=t,this.format=r,this.count=n}get astNodeType(){return"array"}get isArray(){return!0}}class SamplerType extends Type{constructor(e,t,r){super(e),this.format=t,this.access=r}get astNodeType(){return"sampler"}}class Expression extends Node{constructor(){super()}}class StringExpr extends Expression{constructor(e){super(),this.value=e}get astNodeType(){return"stringExpr"}toString(){return this.value}evaluateString(){return this.value}}class CreateExpr extends Expression{constructor(e,t){super(),this.type=e,this.args=t}get astNodeType(){return"createExpr"}search(e){if(e(this),this.args)for(const t of this.args)t.search(e)}evaluate(e){return this.args[0].evaluate(e)}}class CallExpr extends Expression{constructor(e,t){super(),this.name=e,this.args=t}get astNodeType(){return"callExpr"}evaluate(e){switch(this.name){case"abs":return Math.abs(this.args[0].evaluate(e));case"acos":return Math.acos(this.args[0].evaluate(e));case"acosh":return Math.acosh(this.args[0].evaluate(e));case"asin":return Math.asin(this.args[0].evaluate(e));case"asinh":return Math.asinh(this.args[0].evaluate(e));case"atan":return Math.atan(this.args[0].evaluate(e));case"atan2":return Math.atan2(this.args[0].evaluate(e),this.args[1].evaluate(e));case"atanh":return Math.atanh(this.args[0].evaluate(e));case"ceil":return Math.ceil(this.args[0].evaluate(e));case"clamp":return Math.min(Math.max(this.args[0].evaluate(e),this.args[1].evaluate(e)),this.args[2].evaluate(e));case"cos":return Math.cos(this.args[0].evaluate(e));case"degrees":return 180*this.args[0].evaluate(e)/Math.PI;case"distance":return Math.sqrt(Math.pow(this.args[0].evaluate(e)-this.args[1].evaluate(e),2));case"dot":case"exp":return Math.exp(this.args[0].evaluate(e));case"exp2":return Math.pow(2,this.args[0].evaluate(e));case"floor":return Math.floor(this.args[0].evaluate(e));case"fma":return this.args[0].evaluate(e)*this.args[1].evaluate(e)+this.args[2].evaluate(e);case"fract":case"modf":return this.args[0].evaluate(e)-Math.floor(this.args[0].evaluate(e));case"inverseSqrt":return 1/Math.sqrt(this.args[0].evaluate(e));case"log":return Math.log(this.args[0].evaluate(e));case"log2":return Math.log2(this.args[0].evaluate(e));case"max":return Math.max(this.args[0].evaluate(e),this.args[1].evaluate(e));case"min":return Math.min(this.args[0].evaluate(e),this.args[1].evaluate(e));case"mix":return this.args[0].evaluate(e)*(1-this.args[2].evaluate(e))+this.args[1].evaluate(e)*this.args[2].evaluate(e);case"pow":return Math.pow(this.args[0].evaluate(e),this.args[1].evaluate(e));case"radians":return this.args[0].evaluate(e)*Math.PI/180;case"round":return Math.round(this.args[0].evaluate(e));case"sign":return Math.sign(this.args[0].evaluate(e));case"sin":return Math.sin(this.args[0].evaluate(e));case"sinh":return Math.sinh(this.args[0].evaluate(e));case"saturate":return Math.min(Math.max(this.args[0].evaluate(e),0),1);case"smoothstep":return this.args[0].evaluate(e)*this.args[0].evaluate(e)*(3-2*this.args[0].evaluate(e));case"sqrt":return Math.sqrt(this.args[0].evaluate(e));case"step":return this.args[0].evaluate(e)<this.args[1].evaluate(e)?0:1;case"tan":return Math.tan(this.args[0].evaluate(e));case"tanh":return Math.tanh(this.args[0].evaluate(e));case"trunc":return Math.trunc(this.args[0].evaluate(e));default:throw new Error("Non const function:"+this.name)}}search(e){for(const t of this.args)t.search(e);e(this)}}class VariableExpr extends Expression{constructor(e){super(),this.name=e}get astNodeType(){return"varExpr"}search(e){e(this),this.postfix&&this.postfix.search(e)}evaluate(e){const t=e.constants.get(this.name);if(!t)throw new Error("Cannot evaluate node");return t.evaluate(e)}}class ConstExpr extends Expression{constructor(e,t){super(),this.name=e,this.initializer=t}get astNodeType(){return"constExpr"}evaluate(e){var t,r;if(this.initializer instanceof CreateExpr){const n=null===(t=this.postfix)||void 0===t?void 0:t.evaluateString(e),i=null===(r=this.initializer.type)||void 0===r?void 0:r.name,s=e.structs.get(i),a=null==s?void 0:s.getMemberIndex(n);if(void 0!==a&&-1!=a){return this.initializer.args[a].evaluate(e)}return this.initializer.evaluate(e)}return this.initializer.evaluate(e)}search(e){this.initializer.search(e)}}class LiteralExpr extends Expression{constructor(e){super(),this.value=e}get astNodeType(){return"literalExpr"}evaluate(){return this.value}}class BitcastExpr extends Expression{constructor(e,t){super(),this.type=e,this.value=t}get astNodeType(){return"bitcastExpr"}search(e){this.value.search(e)}}class GroupingExpr extends Expression{constructor(e){super(),this.contents=e}get astNodeType(){return"groupExpr"}evaluate(e){return this.contents[0].evaluate(e)}search(e){this.searchBlock(this.contents,e)}}class ArrayIndex extends Expression{constructor(e){super(),this.index=e}search(e){this.index.search(e)}}class Operator extends Expression{constructor(){super()}}class UnaryOperator extends Operator{constructor(e,t){super(),this.operator=e,this.right=t}get astNodeType(){return"unaryOp"}evaluate(e){switch(this.operator){case"+":return this.right.evaluate(e);case"-":return-this.right.evaluate(e);case"!":return this.right.evaluate(e)?0:1;case"~":return~this.right.evaluate(e);default:throw new Error("Unknown unary operator:"+this.operator)}}search(e){this.right.search(e)}}class BinaryOperator extends Operator{constructor(e,t,r){super(),this.operator=e,this.left=t,this.right=r}get astNodeType(){return"binaryOp"}evaluate(e){switch(this.operator){case"+":return this.left.evaluate(e)+this.right.evaluate(e);case"-":return this.left.evaluate(e)-this.right.evaluate(e);case"*":return this.left.evaluate(e)*this.right.evaluate(e);case"/":return this.left.evaluate(e)/this.right.evaluate(e);case"%":return this.left.evaluate(e)%this.right.evaluate(e);case"==":return this.left.evaluate(e)==this.right.evaluate(e)?1:0;case"!=":return this.left.evaluate(e)!=this.right.evaluate(e)?1:0;case"<":return this.left.evaluate(e)<this.right.evaluate(e)?1:0;case">":return this.left.evaluate(e)>this.right.evaluate(e)?1:0;case"<=":return this.left.evaluate(e)<=this.right.evaluate(e)?1:0;case">=":return this.left.evaluate(e)>=this.right.evaluate(e)?1:0;case"&&":return this.left.evaluate(e)&&this.right.evaluate(e)?1:0;case"||":return this.left.evaluate(e)||this.right.evaluate(e)?1:0;default:throw new Error(`Unknown operator ${this.operator}`)}}search(e){this.left.search(e),this.right.search(e)}}class SwitchCase extends Node{constructor(){super()}}class Case extends SwitchCase{constructor(e,t){super(),this.selector=e,this.body=t}get astNodeType(){return"case"}search(e){this.searchBlock(this.body,e)}}class Default extends SwitchCase{constructor(e){super(),this.body=e}get astNodeType(){return"default"}search(e){this.searchBlock(this.body,e)}}class Argument extends Node{constructor(e,t,r){super(),this.name=e,this.type=t,this.attributes=r}get astNodeType(){return"argument"}}class ElseIf extends Node{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return"elseif"}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class Member extends Node{constructor(e,t,r){super(),this.name=e,this.type=t,this.attributes=r}get astNodeType(){return"member"}}class Attribute extends Node{constructor(e,t){super(),this.name=e,this.value=t}get astNodeType(){return"attribute"}}!function(e){e[e.token=0]="token",e[e.keyword=1]="keyword",e[e.reserved=2]="reserved"}(ot||(ot={}));class TokenType{constructor(e,t,r){this.name=e,this.type=t,this.rule=r}toString(){return this.name}}class TokenTypes{}at=TokenTypes,TokenTypes.none=new TokenType("",ot.reserved,""),TokenTypes.eof=new TokenType("EOF",ot.token,""),TokenTypes.reserved={asm:new TokenType("asm",ot.reserved,"asm"),bf16:new TokenType("bf16",ot.reserved,"bf16"),do:new TokenType("do",ot.reserved,"do"),enum:new TokenType("enum",ot.reserved,"enum"),f16:new TokenType("f16",ot.reserved,"f16"),f64:new TokenType("f64",ot.reserved,"f64"),handle:new TokenType("handle",ot.reserved,"handle"),i8:new TokenType("i8",ot.reserved,"i8"),i16:new TokenType("i16",ot.reserved,"i16"),i64:new TokenType("i64",ot.reserved,"i64"),mat:new TokenType("mat",ot.reserved,"mat"),premerge:new TokenType("premerge",ot.reserved,"premerge"),regardless:new TokenType("regardless",ot.reserved,"regardless"),typedef:new TokenType("typedef",ot.reserved,"typedef"),u8:new TokenType("u8",ot.reserved,"u8"),u16:new TokenType("u16",ot.reserved,"u16"),u64:new TokenType("u64",ot.reserved,"u64"),unless:new TokenType("unless",ot.reserved,"unless"),using:new TokenType("using",ot.reserved,"using"),vec:new TokenType("vec",ot.reserved,"vec"),void:new TokenType("void",ot.reserved,"void")},TokenTypes.keywords={array:new TokenType("array",ot.keyword,"array"),atomic:new TokenType("atomic",ot.keyword,"atomic"),bool:new TokenType("bool",ot.keyword,"bool"),f32:new TokenType("f32",ot.keyword,"f32"),i32:new TokenType("i32",ot.keyword,"i32"),mat2x2:new TokenType("mat2x2",ot.keyword,"mat2x2"),mat2x3:new TokenType("mat2x3",ot.keyword,"mat2x3"),mat2x4:new TokenType("mat2x4",ot.keyword,"mat2x4"),mat3x2:new TokenType("mat3x2",ot.keyword,"mat3x2"),mat3x3:new TokenType("mat3x3",ot.keyword,"mat3x3"),mat3x4:new TokenType("mat3x4",ot.keyword,"mat3x4"),mat4x2:new TokenType("mat4x2",ot.keyword,"mat4x2"),mat4x3:new TokenType("mat4x3",ot.keyword,"mat4x3"),mat4x4:new TokenType("mat4x4",ot.keyword,"mat4x4"),ptr:new TokenType("ptr",ot.keyword,"ptr"),sampler:new TokenType("sampler",ot.keyword,"sampler"),sampler_comparison:new TokenType("sampler_comparison",ot.keyword,"sampler_comparison"),struct:new TokenType("struct",ot.keyword,"struct"),texture_1d:new TokenType("texture_1d",ot.keyword,"texture_1d"),texture_2d:new TokenType("texture_2d",ot.keyword,"texture_2d"),texture_2d_array:new TokenType("texture_2d_array",ot.keyword,"texture_2d_array"),texture_3d:new TokenType("texture_3d",ot.keyword,"texture_3d"),texture_cube:new TokenType("texture_cube",ot.keyword,"texture_cube"),texture_cube_array:new TokenType("texture_cube_array",ot.keyword,"texture_cube_array"),texture_multisampled_2d:new TokenType("texture_multisampled_2d",ot.keyword,"texture_multisampled_2d"),texture_storage_1d:new TokenType("texture_storage_1d",ot.keyword,"texture_storage_1d"),texture_storage_2d:new TokenType("texture_storage_2d",ot.keyword,"texture_storage_2d"),texture_storage_2d_array:new TokenType("texture_storage_2d_array",ot.keyword,"texture_storage_2d_array"),texture_storage_3d:new TokenType("texture_storage_3d",ot.keyword,"texture_storage_3d"),texture_depth_2d:new TokenType("texture_depth_2d",ot.keyword,"texture_depth_2d"),texture_depth_2d_array:new TokenType("texture_depth_2d_array",ot.keyword,"texture_depth_2d_array"),texture_depth_cube:new TokenType("texture_depth_cube",ot.keyword,"texture_depth_cube"),texture_depth_cube_array:new TokenType("texture_depth_cube_array",ot.keyword,"texture_depth_cube_array"),texture_depth_multisampled_2d:new TokenType("texture_depth_multisampled_2d",ot.keyword,"texture_depth_multisampled_2d"),texture_external:new TokenType("texture_external",ot.keyword,"texture_external"),u32:new TokenType("u32",ot.keyword,"u32"),vec2:new TokenType("vec2",ot.keyword,"vec2"),vec3:new TokenType("vec3",ot.keyword,"vec3"),vec4:new TokenType("vec4",ot.keyword,"vec4"),bitcast:new TokenType("bitcast",ot.keyword,"bitcast"),block:new TokenType("block",ot.keyword,"block"),break:new TokenType("break",ot.keyword,"break"),case:new TokenType("case",ot.keyword,"case"),continue:new TokenType("continue",ot.keyword,"continue"),continuing:new TokenType("continuing",ot.keyword,"continuing"),default:new TokenType("default",ot.keyword,"default"),diagnostic:new TokenType("diagnostic",ot.keyword,"diagnostic"),discard:new TokenType("discard",ot.keyword,"discard"),else:new TokenType("else",ot.keyword,"else"),enable:new TokenType("enable",ot.keyword,"enable"),fallthrough:new TokenType("fallthrough",ot.keyword,"fallthrough"),false:new TokenType("false",ot.keyword,"false"),fn:new TokenType("fn",ot.keyword,"fn"),for:new TokenType("for",ot.keyword,"for"),function:new TokenType("function",ot.keyword,"function"),if:new TokenType("if",ot.keyword,"if"),let:new TokenType("let",ot.keyword,"let"),const:new TokenType("const",ot.keyword,"const"),loop:new TokenType("loop",ot.keyword,"loop"),while:new TokenType("while",ot.keyword,"while"),private:new TokenType("private",ot.keyword,"private"),read:new TokenType("read",ot.keyword,"read"),read_write:new TokenType("read_write",ot.keyword,"read_write"),return:new TokenType("return",ot.keyword,"return"),requires:new TokenType("requires",ot.keyword,"requires"),storage:new TokenType("storage",ot.keyword,"storage"),switch:new TokenType("switch",ot.keyword,"switch"),true:new TokenType("true",ot.keyword,"true"),alias:new TokenType("alias",ot.keyword,"alias"),type:new TokenType("type",ot.keyword,"type"),uniform:new TokenType("uniform",ot.keyword,"uniform"),var:new TokenType("var",ot.keyword,"var"),override:new TokenType("override",ot.keyword,"override"),workgroup:new TokenType("workgroup",ot.keyword,"workgroup"),write:new TokenType("write",ot.keyword,"write"),r8unorm:new TokenType("r8unorm",ot.keyword,"r8unorm"),r8snorm:new TokenType("r8snorm",ot.keyword,"r8snorm"),r8uint:new TokenType("r8uint",ot.keyword,"r8uint"),r8sint:new TokenType("r8sint",ot.keyword,"r8sint"),r16uint:new TokenType("r16uint",ot.keyword,"r16uint"),r16sint:new TokenType("r16sint",ot.keyword,"r16sint"),r16float:new TokenType("r16float",ot.keyword,"r16float"),rg8unorm:new TokenType("rg8unorm",ot.keyword,"rg8unorm"),rg8snorm:new TokenType("rg8snorm",ot.keyword,"rg8snorm"),rg8uint:new TokenType("rg8uint",ot.keyword,"rg8uint"),rg8sint:new TokenType("rg8sint",ot.keyword,"rg8sint"),r32uint:new TokenType("r32uint",ot.keyword,"r32uint"),r32sint:new TokenType("r32sint",ot.keyword,"r32sint"),r32float:new TokenType("r32float",ot.keyword,"r32float"),rg16uint:new TokenType("rg16uint",ot.keyword,"rg16uint"),rg16sint:new TokenType("rg16sint",ot.keyword,"rg16sint"),rg16float:new TokenType("rg16float",ot.keyword,"rg16float"),rgba8unorm:new TokenType("rgba8unorm",ot.keyword,"rgba8unorm"),rgba8unorm_srgb:new TokenType("rgba8unorm_srgb",ot.keyword,"rgba8unorm_srgb"),rgba8snorm:new TokenType("rgba8snorm",ot.keyword,"rgba8snorm"),rgba8uint:new TokenType("rgba8uint",ot.keyword,"rgba8uint"),rgba8sint:new TokenType("rgba8sint",ot.keyword,"rgba8sint"),bgra8unorm:new TokenType("bgra8unorm",ot.keyword,"bgra8unorm"),bgra8unorm_srgb:new TokenType("bgra8unorm_srgb",ot.keyword,"bgra8unorm_srgb"),rgb10a2unorm:new TokenType("rgb10a2unorm",ot.keyword,"rgb10a2unorm"),rg11b10float:new TokenType("rg11b10float",ot.keyword,"rg11b10float"),rg32uint:new TokenType("rg32uint",ot.keyword,"rg32uint"),rg32sint:new TokenType("rg32sint",ot.keyword,"rg32sint"),rg32float:new TokenType("rg32float",ot.keyword,"rg32float"),rgba16uint:new TokenType("rgba16uint",ot.keyword,"rgba16uint"),rgba16sint:new TokenType("rgba16sint",ot.keyword,"rgba16sint"),rgba16float:new TokenType("rgba16float",ot.keyword,"rgba16float"),rgba32uint:new TokenType("rgba32uint",ot.keyword,"rgba32uint"),rgba32sint:new TokenType("rgba32sint",ot.keyword,"rgba32sint"),rgba32float:new TokenType("rgba32float",ot.keyword,"rgba32float"),static_assert:new TokenType("static_assert",ot.keyword,"static_assert")},TokenTypes.tokens={decimal_float_literal:new TokenType("decimal_float_literal",ot.token,/((-?[0-9]*\.[0-9]+|-?[0-9]+\.[0-9]*)((e|E)(\+|-)?[0-9]+)?f?)|(-?[0-9]+(e|E)(\+|-)?[0-9]+f?)|(-?[0-9]+f)/),hex_float_literal:new TokenType("hex_float_literal",ot.token,/-?0x((([0-9a-fA-F]*\.[0-9a-fA-F]+|[0-9a-fA-F]+\.[0-9a-fA-F]*)((p|P)(\+|-)?[0-9]+f?)?)|([0-9a-fA-F]+(p|P)(\+|-)?[0-9]+f?))/),int_literal:new TokenType("int_literal",ot.token,/-?0x[0-9a-fA-F]+|0i?|-?[1-9][0-9]*i?/),uint_literal:new TokenType("uint_literal",ot.token,/0x[0-9a-fA-F]+u|0u|[1-9][0-9]*u/),ident:new TokenType("ident",ot.token,/[_a-zA-Z][0-9a-zA-Z_]*/),and:new TokenType("and",ot.token,"&"),and_and:new TokenType("and_and",ot.token,"&&"),arrow:new TokenType("arrow ",ot.token,"->"),attr:new TokenType("attr",ot.token,"@"),forward_slash:new TokenType("forward_slash",ot.token,"/"),bang:new TokenType("bang",ot.token,"!"),bracket_left:new TokenType("bracket_left",ot.token,"["),bracket_right:new TokenType("bracket_right",ot.token,"]"),brace_left:new TokenType("brace_left",ot.token,"{"),brace_right:new TokenType("brace_right",ot.token,"}"),colon:new TokenType("colon",ot.token,":"),comma:new TokenType("comma",ot.token,","),equal:new TokenType("equal",ot.token,"="),equal_equal:new TokenType("equal_equal",ot.token,"=="),not_equal:new TokenType("not_equal",ot.token,"!="),greater_than:new TokenType("greater_than",ot.token,">"),greater_than_equal:new TokenType("greater_than_equal",ot.token,">="),shift_right:new TokenType("shift_right",ot.token,">>"),less_than:new TokenType("less_than",ot.token,"<"),less_than_equal:new TokenType("less_than_equal",ot.token,"<="),shift_left:new TokenType("shift_left",ot.token,"<<"),modulo:new TokenType("modulo",ot.token,"%"),minus:new TokenType("minus",ot.token,"-"),minus_minus:new TokenType("minus_minus",ot.token,"--"),period:new TokenType("period",ot.token,"."),plus:new TokenType("plus",ot.token,"+"),plus_plus:new TokenType("plus_plus",ot.token,"++"),or:new TokenType("or",ot.token,"|"),or_or:new TokenType("or_or",ot.token,"||"),paren_left:new TokenType("paren_left",ot.token,"("),paren_right:new TokenType("paren_right",ot.token,")"),semicolon:new TokenType("semicolon",ot.token,";"),star:new TokenType("star",ot.token,"*"),tilde:new TokenType("tilde",ot.token,"~"),underscore:new TokenType("underscore",ot.token,"_"),xor:new TokenType("xor",ot.token,"^"),plus_equal:new TokenType("plus_equal",ot.token,"+="),minus_equal:new TokenType("minus_equal",ot.token,"-="),times_equal:new TokenType("times_equal",ot.token,"*="),division_equal:new TokenType("division_equal",ot.token,"/="),modulo_equal:new TokenType("modulo_equal",ot.token,"%="),and_equal:new TokenType("and_equal",ot.token,"&="),or_equal:new TokenType("or_equal",ot.token,"|="),xor_equal:new TokenType("xor_equal",ot.token,"^="),shift_right_equal:new TokenType("shift_right_equal",ot.token,">>="),shift_left_equal:new TokenType("shift_left_equal",ot.token,"<<=")},TokenTypes.simpleTokens={"@":at.tokens.attr,"{":at.tokens.brace_left,"}":at.tokens.brace_right,":":at.tokens.colon,",":at.tokens.comma,"(":at.tokens.paren_left,")":at.tokens.paren_right,";":at.tokens.semicolon},TokenTypes.literalTokens={"&":at.tokens.and,"&&":at.tokens.and_and,"->":at.tokens.arrow,"/":at.tokens.forward_slash,"!":at.tokens.bang,"[":at.tokens.bracket_left,"]":at.tokens.bracket_right,"=":at.tokens.equal,"==":at.tokens.equal_equal,"!=":at.tokens.not_equal,">":at.tokens.greater_than,">=":at.tokens.greater_than_equal,">>":at.tokens.shift_right,"<":at.tokens.less_than,"<=":at.tokens.less_than_equal,"<<":at.tokens.shift_left,"%":at.tokens.modulo,"-":at.tokens.minus,"--":at.tokens.minus_minus,".":at.tokens.period,"+":at.tokens.plus,"++":at.tokens.plus_plus,"|":at.tokens.or,"||":at.tokens.or_or,"*":at.tokens.star,"~":at.tokens.tilde,_:at.tokens.underscore,"^":at.tokens.xor,"+=":at.tokens.plus_equal,"-=":at.tokens.minus_equal,"*=":at.tokens.times_equal,"/=":at.tokens.division_equal,"%=":at.tokens.modulo_equal,"&=":at.tokens.and_equal,"|=":at.tokens.or_equal,"^=":at.tokens.xor_equal,">>=":at.tokens.shift_right_equal,"<<=":at.tokens.shift_left_equal},TokenTypes.regexTokens={decimal_float_literal:at.tokens.decimal_float_literal,hex_float_literal:at.tokens.hex_float_literal,int_literal:at.tokens.int_literal,uint_literal:at.tokens.uint_literal,ident:at.tokens.ident},TokenTypes.storage_class=[at.keywords.function,at.keywords.private,at.keywords.workgroup,at.keywords.uniform,at.keywords.storage],TokenTypes.access_mode=[at.keywords.read,at.keywords.write,at.keywords.read_write],TokenTypes.sampler_type=[at.keywords.sampler,at.keywords.sampler_comparison],TokenTypes.sampled_texture_type=[at.keywords.texture_1d,at.keywords.texture_2d,at.keywords.texture_2d_array,at.keywords.texture_3d,at.keywords.texture_cube,at.keywords.texture_cube_array],TokenTypes.multisampled_texture_type=[at.keywords.texture_multisampled_2d],TokenTypes.storage_texture_type=[at.keywords.texture_storage_1d,at.keywords.texture_storage_2d,at.keywords.texture_storage_2d_array,at.keywords.texture_storage_3d],TokenTypes.depth_texture_type=[at.keywords.texture_depth_2d,at.keywords.texture_depth_2d_array,at.keywords.texture_depth_cube,at.keywords.texture_depth_cube_array,at.keywords.texture_depth_multisampled_2d],TokenTypes.texture_external_type=[at.keywords.texture_external],TokenTypes.any_texture_type=[...at.sampled_texture_type,...at.multisampled_texture_type,...at.storage_texture_type,...at.depth_texture_type,...at.texture_external_type],TokenTypes.texel_format=[at.keywords.r8unorm,at.keywords.r8snorm,at.keywords.r8uint,at.keywords.r8sint,at.keywords.r16uint,at.keywords.r16sint,at.keywords.r16float,at.keywords.rg8unorm,at.keywords.rg8snorm,at.keywords.rg8uint,at.keywords.rg8sint,at.keywords.r32uint,at.keywords.r32sint,at.keywords.r32float,at.keywords.rg16uint,at.keywords.rg16sint,at.keywords.rg16float,at.keywords.rgba8unorm,at.keywords.rgba8unorm_srgb,at.keywords.rgba8snorm,at.keywords.rgba8uint,at.keywords.rgba8sint,at.keywords.bgra8unorm,at.keywords.bgra8unorm_srgb,at.keywords.rgb10a2unorm,at.keywords.rg11b10float,at.keywords.rg32uint,at.keywords.rg32sint,at.keywords.rg32float,at.keywords.rgba16uint,at.keywords.rgba16sint,at.keywords.rgba16float,at.keywords.rgba32uint,at.keywords.rgba32sint,at.keywords.rgba32float],TokenTypes.const_literal=[at.tokens.int_literal,at.tokens.uint_literal,at.tokens.decimal_float_literal,at.tokens.hex_float_literal,at.keywords.true,at.keywords.false],TokenTypes.literal_or_ident=[at.tokens.ident,at.tokens.int_literal,at.tokens.uint_literal,at.tokens.decimal_float_literal,at.tokens.hex_float_literal],TokenTypes.element_count_expression=[at.tokens.int_literal,at.tokens.uint_literal,at.tokens.ident],TokenTypes.template_types=[at.keywords.vec2,at.keywords.vec3,at.keywords.vec4,at.keywords.mat2x2,at.keywords.mat2x3,at.keywords.mat2x4,at.keywords.mat3x2,at.keywords.mat3x3,at.keywords.mat3x4,at.keywords.mat4x2,at.keywords.mat4x3,at.keywords.mat4x4,at.keywords.atomic,at.keywords.bitcast,...at.any_texture_type],TokenTypes.attribute_name=[at.tokens.ident,at.keywords.block,at.keywords.diagnostic],TokenTypes.assignment_operators=[at.tokens.equal,at.tokens.plus_equal,at.tokens.minus_equal,at.tokens.times_equal,at.tokens.division_equal,at.tokens.modulo_equal,at.tokens.and_equal,at.tokens.or_equal,at.tokens.xor_equal,at.tokens.shift_right_equal,at.tokens.shift_left_equal],TokenTypes.increment_operators=[at.tokens.plus_plus,at.tokens.minus_minus];class Token{constructor(e,t,r){this.type=e,this.lexeme=t,this.line=r}toString(){return this.lexeme}isTemplateType(){return-1!=TokenTypes.template_types.indexOf(this.type)}isArrayType(){return this.type==TokenTypes.keywords.array}isArrayOrTemplateType(){return this.isArrayType()||this.isTemplateType()}}class WgslScanner{constructor(e){this._tokens=[],this._start=0,this._current=0,this._line=1,this._source=null!=e?e:""}scanTokens(){for(;!this._isAtEnd();)if(this._start=this._current,!this.scanToken())throw`Invalid syntax at line ${this._line}`;return this._tokens.push(new Token(TokenTypes.eof,"",this._line)),this._tokens}scanToken(){let e=this._advance();if("\n"==e)return this._line++,!0;if(this._isWhitespace(e))return!0;if("/"==e){if("/"==this._peekAhead()){for(;"\n"!=e;){if(this._isAtEnd())return!0;e=this._advance()}return this._line++,!0}if("*"==this._peekAhead()){this._advance();let t=1;for(;t>0;){if(this._isAtEnd())return!0;if(e=this._advance(),"\n"==e)this._line++;else if("*"==e){if("/"==this._peekAhead()&&(this._advance(),t--,0==t))return!0}else"/"==e&&"*"==this._peekAhead()&&(this._advance(),t++)}return!0}}const t=TokenTypes.simpleTokens[e];if(t)return this._addToken(t),!0;let r=TokenTypes.none;const n=this._isAlpha(e),i="_"===e;if(this._isAlphaNumeric(e)){let t=this._peekAhead();for(;this._isAlphaNumeric(t);)e+=this._advance(),t=this._peekAhead()}if(n){const t=TokenTypes.keywords[e];if(t)return this._addToken(t),!0}if(n||i)return this._addToken(TokenTypes.tokens.ident),!0;for(;;){let t=this._findType(e);const n=this._peekAhead();if("-"==e&&this._tokens.length>0){if("="==n)return this._current++,e+=n,this._addToken(TokenTypes.tokens.minus_equal),!0;if("-"==n)return this._current++,e+=n,this._addToken(TokenTypes.tokens.minus_minus),!0;const r=this._tokens.length-1;if((-1!=TokenTypes.literal_or_ident.indexOf(this._tokens[r].type)||this._tokens[r].type==TokenTypes.tokens.paren_right)&&">"!=n)return this._addToken(t),!0}if(">"==e&&(">"==n||"="==n)){let e=!1,r=this._tokens.length-1;for(let t=0;t<5&&r>=0&&-1===TokenTypes.assignment_operators.indexOf(this._tokens[r].type);++t,--r)if(this._tokens[r].type===TokenTypes.tokens.less_than){r>0&&this._tokens[r-1].isArrayOrTemplateType()&&(e=!0);break}if(e)return this._addToken(t),!0}if(t===TokenTypes.none){let n=e,i=0;const s=2;for(let e=0;e<s;++e)if(n+=this._peekAhead(e),t=this._findType(n),t!==TokenTypes.none){i=e;break}if(t===TokenTypes.none)return r!==TokenTypes.none&&(this._current--,this._addToken(r),!0);e=n,this._current+=i+1}if(r=t,this._isAtEnd())break;e+=this._advance()}return r!==TokenTypes.none&&(this._addToken(r),!0)}_findType(e){for(const t in TokenTypes.regexTokens){const r=TokenTypes.regexTokens[t];if(this._match(e,r.rule))return r}const t=TokenTypes.literalTokens[e];return t||TokenTypes.none}_match(e,t){const r=t.exec(e);return r&&0==r.index&&r[0]==e}_isAtEnd(){return this._current>=this._source.length}_isAlpha(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"}_isAlphaNumeric(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"||"_"==e||e>="0"&&e<="9"}_isWhitespace(e){return" "==e||"\t"==e||"\r"==e}_advance(e=0){let t=this._source[this._current];return e=e||0,e++,this._current+=e,t}_peekAhead(e=0){return e=e||0,this._current+e>=this._source.length?"\0":this._source[this._current+e]}_addToken(e){const t=this._source.substring(this._start,this._current);this._tokens.push(new Token(e,t,this._line))}}class WgslParser{constructor(){this._tokens=[],this._current=0,this._currentLine=0,this._context=new ParseContext,this._deferArrayCountEval=[]}parse(e){this._initialize(e),this._deferArrayCountEval.length=0;const t=[];for(;!this._isAtEnd();){const e=this._global_decl_or_directive();if(!e)break;t.push(e)}if(this._deferArrayCountEval.length>0){for(const e of this._deferArrayCountEval){const t=e.arrayType,r=e.countNode;if(r instanceof VariableExpr){const e=r.name,n=this._context.constants.get(e);if(n)try{const e=n.evaluate(this._context);t.count=e}catch(e){}}}this._deferArrayCountEval.length=0}return t}_initialize(e){if(e)if("string"==typeof e){const t=new WgslScanner(e);this._tokens=t.scanTokens()}else this._tokens=e;else this._tokens=[];this._current=0}_error(e,t){return{token:e,message:t,toString:function(){return`${t}`}}}_isAtEnd(){return this._current>=this._tokens.length||this._peek().type==TokenTypes.eof}_match(e){if(e instanceof TokenType)return!!this._check(e)&&(this._advance(),!0);for(let t=0,r=e.length;t<r;++t){const r=e[t];if(this._check(r))return this._advance(),!0}return!1}_consume(e,t){if(this._check(e))return this._advance();throw this._error(this._peek(),t)}_check(e){if(this._isAtEnd())return!1;const t=this._peek();if(e instanceof Array){const r=t.type;return-1!=e.indexOf(r)}return t.type==e}_advance(){var e,t;return this._currentLine=null!==(t=null===(e=this._peek())||void 0===e?void 0:e.line)&&void 0!==t?t:-1,this._isAtEnd()||this._current++,this._previous()}_peek(){return this._tokens[this._current]}_previous(){return this._tokens[this._current-1]}_global_decl_or_directive(){for(;this._match(TokenTypes.tokens.semicolon)&&!this._isAtEnd(););if(this._match(TokenTypes.keywords.alias)){const e=this._type_alias();return this._consume(TokenTypes.tokens.semicolon,"Expected ';'"),e}if(this._match(TokenTypes.keywords.diagnostic)){const e=this._diagnostic();return this._consume(TokenTypes.tokens.semicolon,"Expected ';'"),e}if(this._match(TokenTypes.keywords.requires)){const e=this._requires_directive();return this._consume(TokenTypes.tokens.semicolon,"Expected ';'"),e}if(this._match(TokenTypes.keywords.enable)){const e=this._enable_directive();return this._consume(TokenTypes.tokens.semicolon,"Expected ';'"),e}const e=this._attribute();if(this._check(TokenTypes.keywords.var)){const t=this._global_variable_decl();return null!=t&&(t.attributes=e),this._consume(TokenTypes.tokens.semicolon,"Expected ';'."),t}if(this._check(TokenTypes.keywords.override)){const t=this._override_variable_decl();return null!=t&&(t.attributes=e),this._consume(TokenTypes.tokens.semicolon,"Expected ';'."),t}if(this._check(TokenTypes.keywords.let)){const t=this._global_let_decl();return null!=t&&(t.attributes=e),this._consume(TokenTypes.tokens.semicolon,"Expected ';'."),t}if(this._check(TokenTypes.keywords.const)){const t=this._global_const_decl();return null!=t&&(t.attributes=e),this._consume(TokenTypes.tokens.semicolon,"Expected ';'."),t}if(this._check(TokenTypes.keywords.struct)){const t=this._struct_decl();return null!=t&&(t.attributes=e),t}if(this._check(TokenTypes.keywords.fn)){const t=this._function_decl();return null!=t&&(t.attributes=e),t}return null}_function_decl(){if(!this._match(TokenTypes.keywords.fn))return null;const e=this._currentLine,t=this._consume(TokenTypes.tokens.ident,"Expected function name.").toString();this._consume(TokenTypes.tokens.paren_left,"Expected '(' for function arguments.");const r=[];if(!this._check(TokenTypes.tokens.paren_right))do{if(this._check(TokenTypes.tokens.paren_right))break;const e=this._attribute(),t=this._consume(TokenTypes.tokens.ident,"Expected argument name.").toString();this._consume(TokenTypes.tokens.colon,"Expected ':' for argument type.");const n=this._attribute(),i=this._type_decl();null!=i&&(i.attributes=n,r.push(new Argument(t,i,e)))}while(this._match(TokenTypes.tokens.comma));this._consume(TokenTypes.tokens.paren_right,"Expected ')' after function arguments.");let n=null;if(this._match(TokenTypes.tokens.arrow)){const e=this._attribute();n=this._type_decl(),null!=n&&(n.attributes=e)}const i=this._compound_statement(),s=this._currentLine;return new nt(t,r,n,i,e,s)}_compound_statement(){const e=[];for(this._consume(TokenTypes.tokens.brace_left,"Expected '{' for block.");!this._check(TokenTypes.tokens.brace_right);){const t=this._statement();null!==t&&e.push(t)}return this._consume(TokenTypes.tokens.brace_right,"Expected '}' for block."),e}_statement(){for(;this._match(TokenTypes.tokens.semicolon)&&!this._isAtEnd(););if(this._check(TokenTypes.tokens.attr)&&this._attribute(),this._check(TokenTypes.keywords.if))return this._if_statement();if(this._check(TokenTypes.keywords.switch))return this._switch_statement();if(this._check(TokenTypes.keywords.loop))return this._loop_statement();if(this._check(TokenTypes.keywords.for))return this._for_statement();if(this._check(TokenTypes.keywords.while))return this._while_statement();if(this._check(TokenTypes.keywords.continuing))return this._continuing_statement();if(this._check(TokenTypes.keywords.static_assert))return this._static_assert_statement();if(this._check(TokenTypes.tokens.brace_left))return this._compound_statement();let e=null;return e=this._check(TokenTypes.keywords.return)?this._return_statement():this._check([TokenTypes.keywords.var,TokenTypes.keywords.let,TokenTypes.keywords.const])?this._variable_statement():this._match(TokenTypes.keywords.discard)?new Discard:this._match(TokenTypes.keywords.break)?new Break:this._match(TokenTypes.keywords.continue)?new Continue:this._increment_decrement_statement()||this._func_call_statement()||this._assignment_statement(),null!=e&&this._consume(TokenTypes.tokens.semicolon,"Expected ';' after statement."),e}_static_assert_statement(){if(!this._match(TokenTypes.keywords.static_assert))return null;const e=this._optional_paren_expression();return new StaticAssert(e)}_while_statement(){if(!this._match(TokenTypes.keywords.while))return null;const e=this._optional_paren_expression();this._check(TokenTypes.tokens.attr)&&this._attribute();const t=this._compound_statement();return new While(e,t)}_continuing_statement(){if(!this._match(TokenTypes.keywords.continuing))return null;const e=this._compound_statement();return new Continuing(e)}_for_statement(){if(!this._match(TokenTypes.keywords.for))return null;this._consume(TokenTypes.tokens.paren_left,"Expected '('.");const e=this._check(TokenTypes.tokens.semicolon)?null:this._for_init();this._consume(TokenTypes.tokens.semicolon,"Expected ';'.");const t=this._check(TokenTypes.tokens.semicolon)?null:this._short_circuit_or_expression();this._consume(TokenTypes.tokens.semicolon,"Expected ';'.");const r=this._check(TokenTypes.tokens.paren_right)?null:this._for_increment();this._consume(TokenTypes.tokens.paren_right,"Expected ')'."),this._check(TokenTypes.tokens.attr)&&this._attribute();const n=this._compound_statement();return new For(e,t,r,n)}_for_init(){return this._variable_statement()||this._func_call_statement()||this._assignment_statement()}_for_increment(){return this._func_call_statement()||this._increment_decrement_statement()||this._assignment_statement()}_variable_statement(){if(this._check(TokenTypes.keywords.var)){const e=this._variable_decl();if(null===e)throw this._error(this._peek(),"Variable declaration expected.");let t=null;return this._match(TokenTypes.tokens.equal)&&(t=this._short_circuit_or_expression()),new Var(e.name,e.type,e.storage,e.access,t)}if(this._match(TokenTypes.keywords.let)){const e=this._consume(TokenTypes.tokens.ident,"Expected name for let.").toString();let t=null;if(this._match(TokenTypes.tokens.colon)){const e=this._attribute();t=this._type_decl(),null!=t&&(t.attributes=e)}this._consume(TokenTypes.tokens.equal,"Expected '=' for let.");const r=this._short_circuit_or_expression();return new Let(e,t,null,null,r)}if(this._match(TokenTypes.keywords.const)){const e=this._consume(TokenTypes.tokens.ident,"Expected name for const.").toString();let t=null;if(this._match(TokenTypes.tokens.colon)){const e=this._attribute();t=this._type_decl(),null!=t&&(t.attributes=e)}this._consume(TokenTypes.tokens.equal,"Expected '=' for const.");const r=this._short_circuit_or_expression();return new Const(e,t,null,null,r)}return null}_increment_decrement_statement(){const e=this._current,t=this._unary_expression();if(null==t)return null;if(!this._check(TokenTypes.increment_operators))return this._current=e,null;const r=this._consume(TokenTypes.increment_operators,"Expected increment operator");return new Increment(r.type===TokenTypes.tokens.plus_plus?it.increment:it.decrement,t)}_assignment_statement(){let e=null;if(this._check(TokenTypes.tokens.brace_right))return null;let t=this._match(TokenTypes.tokens.underscore);if(t||(e=this._unary_expression()),!t&&null==e)return null;const r=this._consume(TokenTypes.assignment_operators,"Expected assignment operator."),n=this._short_circuit_or_expression();return new Assign(st.parse(r.lexeme),e,n)}_func_call_statement(){if(!this._check(TokenTypes.tokens.ident))return null;const e=this._current,t=this._consume(TokenTypes.tokens.ident,"Expected function name."),r=this._argument_expression_list();return null===r?(this._current=e,null):new Call(t.lexeme,r)}_loop_statement(){if(!this._match(TokenTypes.keywords.loop))return null;this._check(TokenTypes.tokens.attr)&&this._attribute(),this._consume(TokenTypes.tokens.brace_left,"Expected '{' for loop.");const e=[];let t=this._statement();for(;null!==t;){if(Array.isArray(t))for(let r of t)e.push(r);else e.push(t);t=this._statement()}let r=null;return this._match(TokenTypes.keywords.continuing)&&(r=this._compound_statement()),this._consume(TokenTypes.tokens.brace_right,"Expected '}' for loop."),new Loop(e,r)}_switch_statement(){if(!this._match(TokenTypes.keywords.switch))return null;const e=this._optional_paren_expression();this._check(TokenTypes.tokens.attr)&&this._attribute(),this._consume(TokenTypes.tokens.brace_left,"Expected '{' for switch.");const t=this._switch_body();if(null==t||0==t.length)throw this._error(this._previous(),"Expected 'case' or 'default'.");return this._consume(TokenTypes.tokens.brace_right,"Expected '}' for switch."),new Switch(e,t)}_switch_body(){const e=[];if(this._match(TokenTypes.keywords.case)){const t=this._case_selectors();this._match(TokenTypes.tokens.colon),this._check(TokenTypes.tokens.attr)&&this._attribute(),this._consume(TokenTypes.tokens.brace_left,"Exected '{' for switch case.");const r=this._case_body();this._consume(TokenTypes.tokens.brace_right,"Exected '}' for switch case."),e.push(new Case(t,r))}if(this._match(TokenTypes.keywords.default)){this._match(TokenTypes.tokens.colon),this._check(TokenTypes.tokens.attr)&&this._attribute(),this._consume(TokenTypes.tokens.brace_left,"Exected '{' for switch default.");const t=this._case_body();this._consume(TokenTypes.tokens.brace_right,"Exected '}' for switch default."),e.push(new Default(t))}if(this._check([TokenTypes.keywords.default,TokenTypes.keywords.case])){const t=this._switch_body();e.push(t[0])}return e}_case_selectors(){const e=[this._shift_expression()];for(;this._match(TokenTypes.tokens.comma);)e.push(this._shift_expression());return e}_case_body(){if(this._match(TokenTypes.keywords.fallthrough))return this._consume(TokenTypes.tokens.semicolon,"Expected ';'"),[];let e=this._statement();if(null==e)return[];e instanceof Array||(e=[e]);const t=this._case_body();return 0==t.length?e:[...e,t[0]]}_if_statement(){if(!this._match(TokenTypes.keywords.if))return null;const e=this._optional_paren_expression();this._check(TokenTypes.tokens.attr)&&this._attribute();const t=this._compound_statement();let r=[];this._match_elseif()&&(this._check(TokenTypes.tokens.attr)&&this._attribute(),r=this._elseif_statement(r));let n=null;return this._match(TokenTypes.keywords.else)&&(this._check(TokenTypes.tokens.attr)&&this._attribute(),n=this._compound_statement()),new If(e,t,r,n)}_match_elseif(){return this._tokens[this._current].type===TokenTypes.keywords.else&&this._tokens[this._current+1].type===TokenTypes.keywords.if&&(this._advance(),this._advance(),!0)}_elseif_statement(e=[]){const t=this._optional_paren_expression(),r=this._compound_statement();return e.push(new ElseIf(t,r)),this._match_elseif()&&(this._check(TokenTypes.tokens.attr)&&this._attribute(),this._elseif_statement(e)),e}_return_statement(){if(!this._match(TokenTypes.keywords.return))return null;const e=this._short_circuit_or_expression();return new Return(e)}_short_circuit_or_expression(){let e=this._short_circuit_and_expr();for(;this._match(TokenTypes.tokens.or_or);)e=new BinaryOperator(this._previous().toString(),e,this._short_circuit_and_expr());return e}_short_circuit_and_expr(){let e=this._inclusive_or_expression();for(;this._match(TokenTypes.tokens.and_and);)e=new BinaryOperator(this._previous().toString(),e,this._inclusive_or_expression());return e}_inclusive_or_expression(){let e=this._exclusive_or_expression();for(;this._match(TokenTypes.tokens.or);)e=new BinaryOperator(this._previous().toString(),e,this._exclusive_or_expression());return e}_exclusive_or_expression(){let e=this._and_expression();for(;this._match(TokenTypes.tokens.xor);)e=new BinaryOperator(this._previous().toString(),e,this._and_expression());return e}_and_expression(){let e=this._equality_expression();for(;this._match(TokenTypes.tokens.and);)e=new BinaryOperator(this._previous().toString(),e,this._equality_expression());return e}_equality_expression(){const e=this._relational_expression();return this._match([TokenTypes.tokens.equal_equal,TokenTypes.tokens.not_equal])?new BinaryOperator(this._previous().toString(),e,this._relational_expression()):e}_relational_expression(){let e=this._shift_expression();for(;this._match([TokenTypes.tokens.less_than,TokenTypes.tokens.greater_than,TokenTypes.tokens.less_than_equal,TokenTypes.tokens.greater_than_equal]);)e=new BinaryOperator(this._previous().toString(),e,this._shift_expression());return e}_shift_expression(){let e=this._additive_expression();for(;this._match([TokenTypes.tokens.shift_left,TokenTypes.tokens.shift_right]);)e=new BinaryOperator(this._previous().toString(),e,this._additive_expression());return e}_additive_expression(){let e=this._multiplicative_expression();for(;this._match([TokenTypes.tokens.plus,TokenTypes.tokens.minus]);)e=new BinaryOperator(this._previous().toString(),e,this._multiplicative_expression());return e}_multiplicative_expression(){let e=this._unary_expression();for(;this._match([TokenTypes.tokens.star,TokenTypes.tokens.forward_slash,TokenTypes.tokens.modulo]);)e=new BinaryOperator(this._previous().toString(),e,this._unary_expression());return e}_unary_expression(){return this._match([TokenTypes.tokens.minus,TokenTypes.tokens.bang,TokenTypes.tokens.tilde,TokenTypes.tokens.star,TokenTypes.tokens.and])?new UnaryOperator(this._previous().toString(),this._unary_expression()):this._singular_expression()}_singular_expression(){const e=this._primary_expression(),t=this._postfix_expression();return t&&(e.postfix=t),e}_postfix_expression(){if(this._match(TokenTypes.tokens.bracket_left)){const e=this._short_circuit_or_expression();this._consume(TokenTypes.tokens.bracket_right,"Expected ']'.");const t=new ArrayIndex(e),r=this._postfix_expression();return r&&(t.postfix=r),t}if(this._match(TokenTypes.tokens.period)){const e=this._consume(TokenTypes.tokens.ident,"Expected member name."),t=this._postfix_expression(),r=new StringExpr(e.lexeme);return t&&(r.postfix=t),r}return null}_getStruct(e){if(this._context.aliases.has(e)){return this._context.aliases.get(e).type}if(this._context.structs.has(e)){return this._context.structs.get(e)}return null}_primary_expression(){if(this._match(TokenTypes.tokens.ident)){const e=this._previous().toString();if(this._check(TokenTypes.tokens.paren_left)){const t=this._argument_expression_list(),r=this._getStruct(e);return null!=r?new CreateExpr(r,t):new CallExpr(e,t)}if(this._context.constants.has(e)){const t=this._context.constants.get(e);return new ConstExpr(e,t.value)}return new VariableExpr(e)}if(this._match(TokenTypes.const_literal))return new LiteralExpr(parseFloat(this._previous().toString()));if(this._check(TokenTypes.tokens.paren_left))return this._paren_expression();if(this._match(TokenTypes.keywords.bitcast)){this._consume(TokenTypes.tokens.less_than,"Expected '<'.");const e=this._type_decl();this._consume(TokenTypes.tokens.greater_than,"Expected '>'.");const t=this._paren_expression();return new BitcastExpr(e,t)}const e=this._type_decl(),t=this._argument_expression_list();return new CreateExpr(e,t)}_argument_expression_list(){if(!this._match(TokenTypes.tokens.paren_left))return null;const e=[];do{if(this._check(TokenTypes.tokens.paren_right))break;const t=this._short_circuit_or_expression();e.push(t)}while(this._match(TokenTypes.tokens.comma));return this._consume(TokenTypes.tokens.paren_right,"Expected ')' for agument list"),e}_optional_paren_expression(){this._match(TokenTypes.tokens.paren_left);const e=this._short_circuit_or_expression();return this._match(TokenTypes.tokens.paren_right),new GroupingExpr([e])}_paren_expression(){this._consume(TokenTypes.tokens.paren_left,"Expected '('.");const e=this._short_circuit_or_expression();return this._consume(TokenTypes.tokens.paren_right,"Expected ')'."),new GroupingExpr([e])}_struct_decl(){if(!this._match(TokenTypes.keywords.struct))return null;const e=this._currentLine,t=this._consume(TokenTypes.tokens.ident,"Expected name for struct.").toString();this._consume(TokenTypes.tokens.brace_left,"Expected '{' for struct body.");const r=[];for(;!this._check(TokenTypes.tokens.brace_right);){const e=this._attribute(),t=this._consume(TokenTypes.tokens.ident,"Expected variable name.").toString();this._consume(TokenTypes.tokens.colon,"Expected ':' for struct member type.");const n=this._attribute(),i=this._type_decl();null!=i&&(i.attributes=n),this._check(TokenTypes.tokens.brace_right)?this._match(TokenTypes.tokens.comma):this._consume(TokenTypes.tokens.comma,"Expected ',' for struct member."),r.push(new Member(t,i,e))}this._consume(TokenTypes.tokens.brace_right,"Expected '}' after struct body.");const n=this._currentLine,i=new Struct(t,r,e,n);return this._context.structs.set(t,i),i}_global_variable_decl(){const e=this._variable_decl();return e&&this._match(TokenTypes.tokens.equal)&&(e.value=this._const_expression()),e}_override_variable_decl(){const e=this._override_decl();return e&&this._match(TokenTypes.tokens.equal)&&(e.value=this._const_expression()),e}_global_const_decl(){if(!this._match(TokenTypes.keywords.const))return null;const e=this._consume(TokenTypes.tokens.ident,"Expected variable name");let t=null;if(this._match(TokenTypes.tokens.colon)){const e=this._attribute();t=this._type_decl(),null!=t&&(t.attributes=e)}let r=null;if(this._match(TokenTypes.tokens.equal)){const e=this._short_circuit_or_expression();if(e instanceof CreateExpr)r=e;else if(e instanceof ConstExpr&&e.initializer instanceof CreateExpr)r=e.initializer;else try{const t=e.evaluate(this._context);r=new LiteralExpr(t)}catch(t){r=e}}const n=new Const(e.toString(),t,"","",r);return this._context.constants.set(n.name,n),n}_global_let_decl(){if(!this._match(TokenTypes.keywords.let))return null;const e=this._consume(TokenTypes.tokens.ident,"Expected variable name");let t=null;if(this._match(TokenTypes.tokens.colon)){const e=this._attribute();t=this._type_decl(),null!=t&&(t.attributes=e)}let r=null;return this._match(TokenTypes.tokens.equal)&&(r=this._const_expression()),new Let(e.toString(),t,"","",r)}_const_expression(){return this._short_circuit_or_expression()}_variable_decl(){if(!this._match(TokenTypes.keywords.var))return null;let e="",t="";this._match(TokenTypes.tokens.less_than)&&(e=this._consume(TokenTypes.storage_class,"Expected storage_class.").toString(),this._match(TokenTypes.tokens.comma)&&(t=this._consume(TokenTypes.access_mode,"Expected access_mode.").toString()),this._consume(TokenTypes.tokens.greater_than,"Expected '>'."));const r=this._consume(TokenTypes.tokens.ident,"Expected variable name");let n=null;if(this._match(TokenTypes.tokens.colon)){const e=this._attribute();n=this._type_decl(),null!=n&&(n.attributes=e)}return new Var(r.toString(),n,e,t,null)}_override_decl(){if(!this._match(TokenTypes.keywords.override))return null;const e=this._consume(TokenTypes.tokens.ident,"Expected variable name");let t=null;if(this._match(TokenTypes.tokens.colon)){const e=this._attribute();t=this._type_decl(),null!=t&&(t.attributes=e)}return new Override(e.toString(),t,null)}_diagnostic(){this._consume(TokenTypes.tokens.paren_left,"Expected '('");const e=this._consume(TokenTypes.tokens.ident,"Expected severity control name.");this._consume(TokenTypes.tokens.comma,"Expected ','");const t=this._consume(TokenTypes.tokens.ident,"Expected diagnostic rule name.");return this._consume(TokenTypes.tokens.paren_right,"Expected ')'"),new Diagnostic(e.toString(),t.toString())}_enable_directive(){const e=this._consume(TokenTypes.tokens.ident,"identity expected.");return new Enable(e.toString())}_requires_directive(){const e=[this._consume(TokenTypes.tokens.ident,"identity expected.").toString()];for(;this._match(TokenTypes.tokens.comma);){const t=this._consume(TokenTypes.tokens.ident,"identity expected.");e.push(t.toString())}return new Requires(e)}_type_alias(){const e=this._consume(TokenTypes.tokens.ident,"identity expected.");this._consume(TokenTypes.tokens.equal,"Expected '=' for type alias.");let t=this._type_decl();if(null===t)throw this._error(this._peek(),"Expected Type for Alias.");this._context.aliases.has(t.name)&&(t=this._context.aliases.get(t.name).type);const r=new Alias(e.toString(),t);return this._context.aliases.set(r.name,r),r}_type_decl(){if(this._check([TokenTypes.tokens.ident,...TokenTypes.texel_format,TokenTypes.keywords.bool,TokenTypes.keywords.f32,TokenTypes.keywords.i32,TokenTypes.keywords.u32])){const e=this._advance(),t=e.toString();return this._context.structs.has(t)?this._context.structs.get(t):this._context.aliases.has(t)?this._context.aliases.get(t).type:new Type(e.toString())}let e=this._texture_sampler_types();if(e)return e;if(this._check(TokenTypes.template_types)){let e=this._advance().toString(),t=null,r=null;return this._match(TokenTypes.tokens.less_than)&&(t=this._type_decl(),r=null,this._match(TokenTypes.tokens.comma)&&(r=this._consume(TokenTypes.access_mode,"Expected access_mode for pointer").toString()),this._consume(TokenTypes.tokens.greater_than,"Expected '>' for type.")),new TemplateType(e,t,r)}if(this._match(TokenTypes.keywords.ptr)){let e=this._previous().toString();this._consume(TokenTypes.tokens.less_than,"Expected '<' for pointer.");const t=this._consume(TokenTypes.storage_class,"Expected storage_class for pointer");this._consume(TokenTypes.tokens.comma,"Expected ',' for pointer.");const r=this._type_decl();let n=null;return this._match(TokenTypes.tokens.comma)&&(n=this._consume(TokenTypes.access_mode,"Expected access_mode for pointer").toString()),this._consume(TokenTypes.tokens.greater_than,"Expected '>' for pointer."),new PointerType(e,t.toString(),r,n)}const t=this._attribute();if(this._match(TokenTypes.keywords.array)){let e=null,r=-1;const n=this._previous();let i=null;if(this._match(TokenTypes.tokens.less_than)){e=this._type_decl(),this._context.aliases.has(e.name)&&(e=this._context.aliases.get(e.name).type);let t="";if(this._match(TokenTypes.tokens.comma)){i=this._shift_expression();try{t=i.evaluate(this._context).toString(),i=null}catch(e){t="1"}}this._consume(TokenTypes.tokens.greater_than,"Expected '>' for array."),r=t?parseInt(t):0}const s=new ArrayType(n.toString(),t,e,r);return i&&this._deferArrayCountEval.push({arrayType:s,countNode:i}),s}return null}_texture_sampler_types(){if(this._match(TokenTypes.sampler_type))return new SamplerType(this._previous().toString(),null,null);if(this._match(TokenTypes.depth_texture_type))return new SamplerType(this._previous().toString(),null,null);if(this._match(TokenTypes.sampled_texture_type)||this._match(TokenTypes.multisampled_texture_type)){const e=this._previous();this._consume(TokenTypes.tokens.less_than,"Expected '<' for sampler type.");const t=this._type_decl();return this._consume(TokenTypes.tokens.greater_than,"Expected '>' for sampler type."),new SamplerType(e.toString(),t,null)}if(this._match(TokenTypes.storage_texture_type)){const e=this._previous();this._consume(TokenTypes.tokens.less_than,"Expected '<' for sampler type.");const t=this._consume(TokenTypes.texel_format,"Invalid texel format.").toString();this._consume(TokenTypes.tokens.comma,"Expected ',' after texel format.");const r=this._consume(TokenTypes.access_mode,"Expected access mode for storage texture type.").toString();return this._consume(TokenTypes.tokens.greater_than,"Expected '>' for sampler type."),new SamplerType(e.toString(),t,r)}return null}_attribute(){let e=[];for(;this._match(TokenTypes.tokens.attr);){const t=this._consume(TokenTypes.attribute_name,"Expected attribute name"),r=new Attribute(t.toString(),null);if(this._match(TokenTypes.tokens.paren_left)){if(r.value=this._consume(TokenTypes.literal_or_ident,"Expected attribute value").toString(),this._check(TokenTypes.tokens.comma)){this._advance();do{const e=this._consume(TokenTypes.literal_or_ident,"Expected attribute value").toString();r.value instanceof Array||(r.value=[r.value]),r.value.push(e)}while(this._match(TokenTypes.tokens.comma))}this._consume(TokenTypes.tokens.paren_right,"Expected ')'")}e.push(r)}return 0==e.length?null:e}}class TypeInfo{constructor(e,t){this.name=e,this.attributes=t,this.size=0}get isArray(){return!1}get isStruct(){return!1}get isTemplate(){return!1}}class MemberInfo{constructor(e,t,r){this.name=e,this.type=t,this.attributes=r,this.offset=0,this.size=0}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class StructInfo extends TypeInfo{constructor(e,t){super(e,t),this.members=[],this.align=0,this.startLine=-1,this.endLine=-1,this.inUse=!1}get isStruct(){return!0}}class ArrayInfo extends TypeInfo{constructor(e,t){super(e,t),this.count=0,this.stride=0}get isArray(){return!0}}class TemplateInfo extends TypeInfo{constructor(e,t,r,n){super(e,r),this.format=t,this.access=n}get isTemplate(){return!0}}!function(e){e[e.Uniform=0]="Uniform",e[e.Storage=1]="Storage",e[e.Texture=2]="Texture",e[e.Sampler=3]="Sampler",e[e.StorageTexture=4]="StorageTexture"}(ut||(ut={}));class VariableInfo{constructor(e,t,r,n,i,s,a){this.name=e,this.type=t,this.group=r,this.binding=n,this.attributes=i,this.resourceType=s,this.access=a}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get size(){return this.type.size}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class AliasInfo{constructor(e,t){this.name=e,this.type=t}}class _TypeSize{constructor(e,t){this.align=e,this.size=t}}class InputInfo{constructor(e,t,r,n){this.name=e,this.type=t,this.locationType=r,this.location=n,this.interpolation=null}}class OutputInfo{constructor(e,t,r,n){this.name=e,this.type=t,this.locationType=r,this.location=n}}class OverrideInfo{constructor(e,t,r,n){this.name=e,this.type=t,this.attributes=r,this.id=n}}class ArgumentInfo{constructor(e,t){this.name=e,this.type=t}}class FunctionInfo{constructor(e,t=null){this.stage=null,this.inputs=[],this.outputs=[],this.arguments=[],this.returnType=null,this.resources=[],this.overrides=[],this.startLine=-1,this.endLine=-1,this.inUse=!1,this.calls=new Set,this.name=e,this.stage=t}}class EntryFunctions{constructor(){this.vertex=[],this.fragment=[],this.compute=[]}}class _FunctionResources{constructor(e){this.resources=null,this.inUse=!1,this.info=null,this.node=e}}class WgslReflect{constructor(e){this.uniforms=[],this.storage=[],this.textures=[],this.samplers=[],this.aliases=[],this.overrides=[],this.structs=[],this.entry=new EntryFunctions,this.functions=[],this._types=new Map,this._functions=new Map,e&&this.update(e)}_isStorageTexture(e){return"texture_storage_1d"==e.name||"texture_storage_2d"==e.name||"texture_storage_2d_array"==e.name||"texture_storage_3d"==e.name}update(e){const t=(new WgslParser).parse(e);for(const e of t)e instanceof nt&&this._functions.set(e.name,new _FunctionResources(e));for(const e of t)if(e instanceof Struct){const t=this._getTypeInfo(e,null);t instanceof StructInfo&&this.structs.push(t)}for(const e of t)if(e instanceof Alias)this.aliases.push(this._getAliasInfo(e));else if(e instanceof Override){const t=e,r=this._getAttributeNum(t.attributes,"id",0),n=null!=t.type?this._getTypeInfo(t.type,t.attributes):null;this.overrides.push(new OverrideInfo(t.name,n,t.attributes,r))}else if(this._isUniformVar(e)){const t=e,r=this._getAttributeNum(t.attributes,"group",0),n=this._getAttributeNum(t.attributes,"binding",0),i=this._getTypeInfo(t.type,t.attributes),s=new VariableInfo(t.name,i,r,n,t.attributes,ut.Uniform,t.access);this.uniforms.push(s)}else if(this._isStorageVar(e)){const t=e,r=this._getAttributeNum(t.attributes,"group",0),n=this._getAttributeNum(t.attributes,"binding",0),i=this._getTypeInfo(t.type,t.attributes),s=this._isStorageTexture(i),a=new VariableInfo(t.name,i,r,n,t.attributes,s?ut.StorageTexture:ut.Storage,t.access);this.storage.push(a)}else if(this._isTextureVar(e)){const t=e,r=this._getAttributeNum(t.attributes,"group",0),n=this._getAttributeNum(t.attributes,"binding",0),i=this._getTypeInfo(t.type,t.attributes),s=this._isStorageTexture(i),a=new VariableInfo(t.name,i,r,n,t.attributes,s?ut.StorageTexture:ut.Texture,t.access);s?this.storage.push(a):this.textures.push(a)}else if(this._isSamplerVar(e)){const t=e,r=this._getAttributeNum(t.attributes,"group",0),n=this._getAttributeNum(t.attributes,"binding",0),i=this._getTypeInfo(t.type,t.attributes),s=new VariableInfo(t.name,i,r,n,t.attributes,ut.Sampler,t.access);this.samplers.push(s)}else if(e instanceof nt){const t=this._getAttribute(e,"vertex"),r=this._getAttribute(e,"fragment"),n=this._getAttribute(e,"compute"),i=t||r||n,s=new FunctionInfo(e.name,null==i?void 0:i.name);s.startLine=e.startLine,s.endLine=e.endLine,this.functions.push(s),this._functions.get(e.name).info=s,i&&(this._functions.get(e.name).inUse=!0,s.inUse=!0,s.resources=this._findResources(e,!!i),s.inputs=this._getInputs(e.args),s.outputs=this._getOutputs(e.returnType),this.entry[i.name].push(s)),s.arguments=e.args.map((e=>new ArgumentInfo(e.name,this._getTypeInfo(e.type,e.attributes)))),s.returnType=e.returnType?this._getTypeInfo(e.returnType,e.attributes):null}else;for(const e of this._functions.values())e.info&&(e.info.inUse=e.inUse,this._addCalls(e.node,e.info.calls));for(const e of this._functions.values())e.node.search((t=>{var r;if("varExpr"===t.astNodeType){const n=t;for(const t of this.overrides)n.name==t.name&&(null===(r=e.info)||void 0===r||r.overrides.push(t))}}));for(const e of this.uniforms)this._markStructsInUse(e.type);for(const e of this.storage)this._markStructsInUse(e.type)}_markStructsInUse(e){if(e)if(e.isStruct){if(e.inUse=!0,e.members)for(const t of e.members)this._markStructsInUse(t.type)}else if(e.isArray)this._markStructsInUse(e.format);else if(e.isTemplate)e.format&&this._markStructsInUse(e.format);else{const t=this._getAlias(e.name);t&&this._markStructsInUse(t)}}_addCalls(e,t){var r;for(const n of e.calls){const e=null===(r=this._functions.get(n.name))||void 0===r?void 0:r.info;e&&t.add(e)}}findResource(e,t){for(const r of this.uniforms)if(r.group==e&&r.binding==t)return r;for(const r of this.storage)if(r.group==e&&r.binding==t)return r;for(const r of this.textures)if(r.group==e&&r.binding==t)return r;for(const r of this.samplers)if(r.group==e&&r.binding==t)return r;return null}_findResource(e){for(const t of this.uniforms)if(t.name==e)return t;for(const t of this.storage)if(t.name==e)return t;for(const t of this.textures)if(t.name==e)return t;for(const t of this.samplers)if(t.name==e)return t;return null}_markStructsFromAST(e){const t=this._getTypeInfo(e,null);this._markStructsInUse(t)}_findResources(e,t){const r=[],n=this,i=[];return e.search((s=>{if(s instanceof _BlockStart)i.push({});else if(s instanceof _BlockEnd)i.pop();else if(s instanceof Var){const e=s;t&&null!==e.type&&this._markStructsFromAST(e.type),i.length>0&&(i[i.length-1][e.name]=e)}else if(s instanceof CreateExpr){const e=s;t&&null!==e.type&&this._markStructsFromAST(e.type)}else if(s instanceof Let){const e=s;t&&null!==e.type&&this._markStructsFromAST(e.type),i.length>0&&(i[i.length-1][e.name]=e)}else if(s instanceof VariableExpr){const e=s;if(i.length>0){if(i[i.length-1][e.name])return}const t=n._findResource(e.name);t&&r.push(t)}else if(s instanceof CallExpr){const i=s,a=n._functions.get(i.name);a&&(t&&(a.inUse=!0),e.calls.add(a.node),null===a.resources&&(a.resources=n._findResources(a.node,t)),r.push(...a.resources))}else if(s instanceof Call){const i=s,a=n._functions.get(i.name);a&&(t&&(a.inUse=!0),e.calls.add(a.node),null===a.resources&&(a.resources=n._findResources(a.node,t)),r.push(...a.resources))}})),[...new Map(r.map((e=>[e.name,e]))).values()]}getBindGroups(){const e=[];function _makeRoom(t,r){t>=e.length&&(e.length=t+1),void 0===e[t]&&(e[t]=[]),r>=e[t].length&&(e[t].length=r+1)}for(const t of this.uniforms){_makeRoom(t.group,t.binding);e[t.group][t.binding]=t}for(const t of this.storage){_makeRoom(t.group,t.binding);e[t.group][t.binding]=t}for(const t of this.textures){_makeRoom(t.group,t.binding);e[t.group][t.binding]=t}for(const t of this.samplers){_makeRoom(t.group,t.binding);e[t.group][t.binding]=t}return e}_getOutputs(e,t=void 0){if(void 0===t&&(t=[]),e instanceof Struct)this._getStructOutputs(e,t);else{const r=this._getOutputInfo(e);null!==r&&t.push(r)}return t}_getStructOutputs(e,t){for(const r of e.members)if(r.type instanceof Struct)this._getStructOutputs(r.type,t);else{const e=this._getAttribute(r,"location")||this._getAttribute(r,"builtin");if(null!==e){const n=this._getTypeInfo(r.type,r.type.attributes),i=this._parseInt(e.value),s=new OutputInfo(r.name,n,e.name,i);t.push(s)}}}_getOutputInfo(e){const t=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(null!==t){const r=this._getTypeInfo(e,e.attributes),n=this._parseInt(t.value);return new OutputInfo("",r,t.name,n)}return null}_getInputs(e,t=void 0){void 0===t&&(t=[]);for(const r of e)if(r.type instanceof Struct)this._getStructInputs(r.type,t);else{const e=this._getInputInfo(r);null!==e&&t.push(e)}return t}_getStructInputs(e,t){for(const r of e.members)if(r.type instanceof Struct)this._getStructInputs(r.type,t);else{const e=this._getInputInfo(r);null!==e&&t.push(e)}}_getInputInfo(e){const t=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(null!==t){const r=this._getAttribute(e,"interpolation"),n=this._getTypeInfo(e.type,e.attributes),i=this._parseInt(t.value),s=new InputInfo(e.name,n,t.name,i);return null!==r&&(s.interpolation=this._parseString(r.value)),s}return null}_parseString(e){return e instanceof Array&&(e=e[0]),e}_parseInt(e){e instanceof Array&&(e=e[0]);const t=parseInt(e);return isNaN(t)?e:t}_getAlias(e){for(const t of this.aliases)if(t.name==e)return t.type;return null}_getAliasInfo(e){return new AliasInfo(e.name,this._getTypeInfo(e.type,null))}_getTypeInfo(e,t){if(this._types.has(e))return this._types.get(e);if(e instanceof ArrayType){const r=e,n=r.format?this._getTypeInfo(r.format,r.attributes):null,i=new ArrayInfo(r.name,t);return i.format=n,i.count=r.count,this._types.set(e,i),this._updateTypeInfo(i),i}if(e instanceof Struct){const r=e,n=new StructInfo(r.name,t);n.startLine=r.startLine,n.endLine=r.endLine;for(const e of r.members){const t=this._getTypeInfo(e.type,e.attributes);n.members.push(new MemberInfo(e.name,t,e.attributes))}return this._types.set(e,n),this._updateTypeInfo(n),n}if(e instanceof SamplerType){const r=e,n=r.format instanceof Type,i=r.format?n?this._getTypeInfo(r.format,null):new TypeInfo(r.format,null):null,s=new TemplateInfo(r.name,i,t,r.access);return this._types.set(e,s),this._updateTypeInfo(s),s}if(e instanceof TemplateType){const r=e,n=r.format?this._getTypeInfo(r.format,null):null,i=new TemplateInfo(r.name,n,t,r.access);return this._types.set(e,i),this._updateTypeInfo(i),i}const r=new TypeInfo(e.name,t);return this._types.set(e,r),this._updateTypeInfo(r),r}_updateTypeInfo(e){var t,r;const n=this._getTypeSize(e);if(e.size=null!==(t=null==n?void 0:n.size)&&void 0!==t?t:0,e instanceof ArrayInfo&&e.format){const t=this._getTypeSize(e.format);e.stride=null!==(r=null==t?void 0:t.size)&&void 0!==r?r:0,this._updateTypeInfo(e.format)}e instanceof StructInfo&&this._updateStructInfo(e)}_updateStructInfo(e){var t;let r=0,n=0,i=0,s=0;for(let a=0,o=e.members.length;a<o;++a){const o=e.members[a],u=this._getTypeSize(o);if(!u)continue;null!==(t=this._getAlias(o.type.name))&&void 0!==t||o.type;const l=u.align,c=u.size;r=this._roundUp(l,r+n),n=c,i=r,s=Math.max(s,l),o.offset=r,o.size=c,this._updateTypeInfo(o.type)}e.size=this._roundUp(s,i+n),e.align=s}_getTypeSize(e){var t,r;if(null==e)return null;const n=this._getAttributeNum(e.attributes,"size",0),i=this._getAttributeNum(e.attributes,"align",0);if(e instanceof MemberInfo&&(e=e.type),e instanceof TypeInfo){const t=this._getAlias(e.name);null!==t&&(e=t)}{const r=WgslReflect._typeInfo[e.name];if(void 0!==r){const s="f16"===(null===(t=e.format)||void 0===t?void 0:t.name)?2:1;return new _TypeSize(Math.max(i,r.align/s),Math.max(n,r.size/s))}}{const t=WgslReflect._typeInfo[e.name.substring(0,e.name.length-1)];if(t){const r="h"===e.name[e.name.length-1]?2:1;return new _TypeSize(Math.max(i,t.align/r),Math.max(n,t.size/r))}}if(e instanceof ArrayInfo){let t=e,s=8,a=8;const o=this._getTypeSize(t.format);null!==o&&(a=o.size,s=o.align);return a=t.count*this._getAttributeNum(null!==(r=null==e?void 0:e.attributes)&&void 0!==r?r:null,"stride",this._roundUp(s,a)),n&&(a=n),new _TypeSize(Math.max(i,s),Math.max(n,a))}if(e instanceof StructInfo){let t=0,r=0,s=0,a=0,o=0;for(const r of e.members){const e=this._getTypeSize(r.type);null!==e&&(t=Math.max(e.align,t),s=this._roundUp(e.align,s+a),a=e.size,o=s)}return r=this._roundUp(t,o+a),new _TypeSize(Math.max(i,t),Math.max(n,r))}return null}_isUniformVar(e){return e instanceof Var&&"uniform"==e.storage}_isStorageVar(e){return e instanceof Var&&"storage"==e.storage}_isTextureVar(e){return e instanceof Var&&null!==e.type&&-1!=WgslReflect._textureTypes.indexOf(e.type.name)}_isSamplerVar(e){return e instanceof Var&&null!==e.type&&-1!=WgslReflect._samplerTypes.indexOf(e.type.name)}_getAttribute(e,t){const r=e;if(!r||!r.attributes)return null;const n=r.attributes;for(let e of n)if(e.name==t)return e;return null}_getAttributeNum(e,t,r){if(null===e)return r;for(let n of e)if(n.name==t){let e=null!==n&&null!==n.value?n.value:r;return e instanceof Array&&(e=e[0]),"number"==typeof e?e:"string"==typeof e?parseInt(e):r}return r}_roundUp(e,t){return Math.ceil(t/e)*e}}WgslReflect._typeInfo={f16:{align:2,size:2},i32:{align:4,size:4},u32:{align:4,size:4},f32:{align:4,size:4},atomic:{align:4,size:4},vec2:{align:8,size:8},vec3:{align:16,size:12},vec4:{align:16,size:16},mat2x2:{align:8,size:16},mat3x2:{align:8,size:24},mat4x2:{align:8,size:32},mat2x3:{align:16,size:32},mat3x3:{align:16,size:48},mat4x3:{align:16,size:64},mat2x4:{align:16,size:32},mat3x4:{align:16,size:48},mat4x4:{align:16,size:64}},WgslReflect._textureTypes=TokenTypes.any_texture_type.map((e=>e.name)),WgslReflect._samplerTypes=TokenTypes.sampler_type.map((e=>e.name));class UniformType{static get i32(){return{numElements:1,align:4,size:4,type:"i32",wgslType:"i32",View:Int32Array}}static get u32(){return{numElements:1,align:4,size:4,type:"u32",wgslType:"u32",View:Uint32Array}}static get f32(){return{numElements:1,align:4,size:4,type:"f32",wgslType:"f32",View:Float32Array}}static get f16(){return{numElements:1,align:2,size:2,type:"f16",wgslType:"f16",View:Uint16Array}}static get vec2f32(){return{numElements:2,align:8,size:8,type:"f32",wgslType:"vec2<f32>",View:Float32Array}}static get vec2i32(){return{numElements:2,align:8,size:8,type:"i32",wgslType:"vec2<i32>",View:Int32Array}}static get vec2u32(){return{numElements:2,align:8,size:8,type:"u32",wgslType:"vec2<u32>",View:Uint32Array}}static get vec2u16(){return{numElements:2,align:4,size:4,type:"u16",wgslType:"vec2<u16>",View:Uint16Array}}static get vec3i32(){return{numElements:3,align:16,size:12,type:"i32",wgslType:"vec3<i32>",View:Int32Array}}static get vec3u32(){return{numElements:3,align:16,size:12,type:"u32",wgslType:"vec3<u32>",View:Uint32Array}}static get vec3f32(){return{numElements:3,align:16,size:12,type:"f32",wgslType:"vec3<f32>",View:Float32Array}}static get vec3u16(){return{numElements:3,align:8,size:6,type:"u16",wgslType:"vec3<u16>",View:Uint16Array}}static get vec4i32(){return{numElements:4,align:16,size:16,type:"i32",wgslType:"vec4<i32>",View:Int32Array}}static get vec4u32(){return{numElements:4,align:16,size:16,type:"u32",wgslType:"vec4<u32>",View:Uint32Array}}static get vec4f32(){return{numElements:4,align:16,size:16,type:"f32",wgslType:"vec4<f32>",View:Float32Array}}static get vec4u16(){return{numElements:4,align:8,size:8,type:"u16",wgslType:"vec4<u16>",View:Uint16Array}}static get mat2x2f32(){return{numElements:4,align:8,size:16,type:"f32",wgslType:"mat2x2<f32>",View:Float32Array}}static get mat2x2u16(){return{numElements:4,align:4,size:8,type:"u16",wgslType:"mat2x2<u16>",View:Uint16Array}}static get mat3x2f32(){return{numElements:6,align:8,size:24,type:"f32",wgslType:"mat3x2<f32>",View:Float32Array}}static get mat3x2u16(){return{numElements:6,align:4,size:12,type:"u16",wgslType:"mat3x2<u16>",View:Uint16Array}}static get mat3x3f32(){return{numElements:16,align:16,size:64,type:"f32",wgslType:"mat3x3<f32>",View:Float32Array}}static get mat4x2f32(){return{numElements:8,align:8,size:32,type:"f32",wgslType:"mat4x2<f32>",View:Float32Array}}static get mat4x2u16(){return{numElements:8,align:4,size:16,type:"u16",wgslType:"mat4x2<u16>",View:Uint16Array}}static get mat2x3f32(){return{numElements:8,align:16,size:32,type:"f32",wgslType:"mat2x3<f32>",View:Float32Array}}static get mat2x3u16(){return{numElements:8,align:8,size:16,type:"u16",wgslType:"mat2x3<u16>",View:Uint16Array}}static get mat4x4f32(){return{numElements:16,align:16,size:64,type:"f32",wgslType:"mat4x4<f32>",View:Float32Array}}static get mat4x4u16(){return{numElements:16,align:8,size:32,type:"u16",wgslType:"mat4x4<u16>",View:Uint16Array}}}Object.freeze(UniformType);const processMembers=(e,t=0,r=0)=>{let n=0,i=r;const s=e?.reduce(((e,r,s)=>{const{type:a,offset:o,size:u,stride:l,count:c,isArray:h}=r,{format:m}=a,d="array"===a.name?`${m.name}${m.format?`${m.format.name}`:""}`:`${a.name}${m?`${m.name}`:""}`;if(0===s&&(n=o),i=o+u,e[r.name]=((e,t,r)=>{const n=UniformType[r];return{uniformOffset:e.offset+t,stride:e.stride,isArray:e.isArray,typeInfo:n,View:n?.View}})(r,t,d),h&&m.members){const t=processMembers(m.members).members;e[r.name].memberList=Array.from({length:c},((e,r)=>{const n={};for(const e in t){const i=n[e]={...t[e]};i.uniformOffset=i.uniformOffset+o+l*r}return n}))}else a.members&&(e[r.name]=processMembers(a.members,o+t,i));return e}),{});return{members:s,startOffset:n,endOffset:i}},parseWGSL=e=>{const t=parseIncludeWGSL(e),r=new WgslReflect(t);return{uniforms:{...(i=r.uniforms,i.reduce(((e,t)=>(e[t.name]={name:t.name,...processMembers(t.members),arrayBufferByteLength:t.size,stride:t.stride},t.attributes?.forEach((r=>e[t.name][r.name]=+r.value)),e)),{}))},storage:{...(n=r.storage,n.reduce(((e,t)=>(e[t.name]={name:t.name,...processMembers(t.members),arrayBufferByteLength:t.size,stride:t.stride,acccess:t.access,type:t.type},t.attributes?.forEach((r=>e[t.name][r.name]=+r.value)),e)),{}))},samplers:r.samplers,textures:r.textures,vertexEntries:r.entry.vertex.map((e=>e.name)),fragmentEntries:r.entry.fragment.map((e=>e.name)),computeEntries:r.entry.compute.map((e=>e.name)),shaderSource:t};var n,i},lt={ZERO:"zero",ONE:"one",SRC:"src",ONE_MINUS_SRC:"one-minus-src",SRC_ALPHA:"src-alpha",ONE_MINUS_SRC_ALPHA:"one-minus-src-alpha",DST:"dst",ONE_MINUS_DST:"one-minus-dst",DST_ALPHA:"dst-alpha",ONE_MINUS_DST_ALPHA:"one-minus-dst-alpha",SRC_ALPHA_SATURATED:"src-alpha-saturated",CONSTANT:"constant",ONE_MINUS_CONSTANT:"one-minus-constant",SRC1:"src1",ONE_MINUS_SRC1:"one-minus-src1",SRC1_ALPHA:"src1-alpha",ONE_MINUS_SRC1_ALPHA:"one-minus-src1-alpha"};Object.freeze(lt);const ct={ADD:"add",SUBTRACT:"subtract",REVERSE_SUBTRACT:"reverse-subtract",MIN:"min",MAX:"max"};Object.freeze(ct);class FragmentGPURenderInfo{fragmentShaderModule;fragmentUniformInfo;fragmentBindGroupLayout;fragmentUniformBuffer;fragmentUniformBindGroup;fragmentState;constructor(e,t,r,n,i,s){this.fragmentShaderModule=e,this.fragmentUniformInfo=t,this.fragmentBindGroupLayout=r,this.fragmentUniformBuffer=n,this.fragmentUniformBindGroup=i,this.fragmentState=s}}Object.freeze(FragmentGPURenderInfo);const ht=Object.values(lt),mt=Object.values(ct);class BlendState{state;#$e;#He;#Ke;#Xe;constructor(e,t,r,n){this.#Xe=e,this.srcFactor=t,this.dstFactor=r,this.operation=n}get operation(){return this.#Ke}set operation(e){mt.includes(e)||consoleAndThrowError(`Invalid GPUBlendOperation:${e}. Valid operations are ${mt.join(",")}`),this.#Ke=e,this.#je()}get srcFactor(){return this.#$e}set srcFactor(e){ht.includes(e)||consoleAndThrowError(`Invalid GPUBlendFactor:${e}. Valid srcFactor factors are ${ht.join(",")}`),this.#$e=e,this.#je()}get dstFactor(){return this.#He}set dstFactor(e){ht.includes(e)||consoleAndThrowError(`Invalid GPUBlendFactor:${e}. Valid dstFactor factors are ${ht.join(",")}`),this.#He=e,this.#je()}#je(){const e=this.#Ke?{operation:this.#Ke}:{},t=this.#$e?{srcFactor:this.#$e}:{},r=this.#He?{dstFactor:this.#He}:{};this.state={...e,...t,...r},this.#Xe.dirtyPipeline=!0}}const dt={NORMAL:0,MULTIPLY:1,LIGHTEN:2,SCREEN:3,LINEAR_DODGE:4,SUBTRACT:5,DARKEN:6,OVERLAY:7,COLOR_DODGE:8,COLOR_BURN:9,HARD_LIGHT:10,SOFT_LIGHT:11,DIFFERENCE:12,EXCLUSION:13,DIVIDE:14,VIVID_LIGHT:15,LINEAR_BURN:16,PIN_LIGHT:17,SATURATION:18,HUE:19,LUMINOSITY:20,COLOR:21,NEGATION:22},getBindGroupLayoutDescriptorFromShaderInfo=(e,t,r)=>{const{textures:n,samplers:i,uniforms:s,storage:a}=e,o=[];for(const e in a){const n=a[e],{binding:i,name:s,group:u,type:l}=n;if(n.access){const e={write:"write-only-storage",read:"read-only-storage",read_write:"read-write-storage"}[n.access];t===u&&o.push({binding:i,visibility:r,buffer:{type:e}})}else if(t===u){const{access:e,format:t}=l,n={write:"write-only",read:"read-only",read_write:"read-write"}[e],s=t.name;o.push({binding:i,visibility:r,storageTexture:{access:n,format:s}})}}for(const e in n){const i=n[e],{binding:s,name:a,group:u,type:l}=i,{name:c}=l;t===u&&o.push({binding:s,visibility:r,texture:"texture_cube"===c?{viewDimension:"cube"}:{}})}for(const e in i){const n=i[e],{binding:s,name:a,group:u}=n;t===u&&o.push({binding:s,visibility:r,sampler:{type:"filtering"}})}for(const e in s){const n=s[e],{binding:i,name:a,group:u}=n;t===u&&o.push({binding:i,visibility:r,buffer:{type:"uniform"}})}return{entries:o}},getFragmentBindGroupLayoutDescriptorFromShaderInfo=(e,t)=>getBindGroupLayoutDescriptorFromShaderInfo(e,t,GPUShaderStage.FRAGMENT),getVertexBindGroupLayoutDescriptorFromShaderInfo=(e,t)=>getBindGroupLayoutDescriptorFromShaderInfo(e,t,GPUShaderStage.VERTEX),getComputeBindGroupLayoutDescriptorFromShaderInfo=(e,t)=>getBindGroupLayoutDescriptorFromShaderInfo(e,t,GPUShaderStage.COMPUTE);class ABaseMaterial extends ResourceBase{gpuRenderInfo;dirtyPipeline=!1;transparent=!1;#Ye=GPUColorWrite.ALL;#Ze;#qe;#We;#Je;#Qe;#Re;#et;#tt;#rt;#nt;#it;#st;#at;#ot;#ut;#he;#lt=dt.MULTIPLY;constructor(e,t,r,n){super(e),this.#ut=t,this.#et=`FRAGMENT_MODULE_${this.#ut}`,this.#tt=`FRAGMENT_BIND_GROUP_DESCRIPTOR_${t}`,this.#rt=`FRAGMENT_BIND_GROUP_LAYOUT_${t}`,this.#nt=r,this.#it=r?.storage,this.#st=r?.uniforms.uniforms,this.#at=r?.textures,this.#ot=r?.samplers,this.#he=e.resourceManager.getGPUBindGroupLayout(this.#rt)||e.resourceManager.createBindGroupLayout(this.#rt,getFragmentBindGroupLayoutDescriptorFromShaderInfo(r,n)),this.#Ze=new BlendState(this,lt.ONE,lt.ONE_MINUS_SRC_ALPHA,ct.ADD),this.#qe=new BlendState(this,lt.ONE,lt.ONE_MINUS_SRC_ALPHA,ct.ADD),this.#We=e.resourceManager,this.#Je=this.#We.basicSampler.gpuSampler,this.#Qe=this.#We.emptyBitmapTextureView,this.#Re=this.#We.emptyCubeTextureView}get tintBlendMode(){const e=Object.entries(dt).find((([,e])=>e===this.#lt));if(!e)throw new Error(`Invalid tint mode value:${this.#lt}`);return e[0]}set tintBlendMode(e){const{fragmentUniformInfo:t,fragmentUniformBuffer:r}=this.gpuRenderInfo;let n;if("string"==typeof e){if(!(e in dt))throw new Error(`Invalid tint mode key:${e}`);n=dt[e]}else{if("number"!=typeof e||!Object.values(dt).includes(e))throw new Error(`Invalid tint mode:${e}`);n=e}r.writeBuffer(t.members.tintBlendMode,n),this.#lt=n}get MODULE_NAME(){return this.#ut}get FRAGMENT_SHADER_MODULE_NAME(){return this.#et}get FRAGMENT_BIND_GROUP_DESCRIPTOR_NAME(){return this.#tt}get STORAGE_STRUCT(){return this.#it}get UNIFORM_STRUCT(){return this.#st}get blendColorState(){return this.#Ze}get blendAlphaState(){return this.#qe}get writeMaskState(){return this.#Ye}set writeMaskState(e){this.#Ye=e}initGPURenderInfos(){const{redGPUContext:e}=this,{resourceManager:t}=e,r=t.createGPUShaderModule(this.#et,{code:this.#nt.shaderSource}),n=new ArrayBuffer(Math.max(this.#st.arrayBufferByteLength,16)),i=new UniformBuffer(e,n,`UniformBuffer_${this.#ut}_${this.uuid}`);this.gpuRenderInfo=new FragmentGPURenderInfo(r,this.#st,this.#he,i,null,null),this._updateBaseProperty(),this._updateFragmentState()}_updateFragmentState(){const{gpuDevice:e}=this.redGPUContext,t=[];for(const e in this.#at){const r=this.#at[e],{binding:n,name:i,group:s,type:a}=r,{name:o}=a;2===s&&t.push({binding:n,resource:"texture_cube"===o?this.getGPUResourceCubeTextureView(this[i]):this.getGPUResourceBitmapTextureView(this[i])})}for(const e in this.#ot){const r=this.#ot[e],{binding:n,name:i,group:s}=r;2===s&&t.push({binding:n,resource:this.getGPUResourceSampler(this[i])})}this.#st&&t.push({binding:this.#st.binding,resource:{buffer:this.gpuRenderInfo.fragmentUniformBuffer.gpuBuffer,offset:0,size:this.gpuRenderInfo.fragmentUniformBuffer.size}});const r={layout:this.gpuRenderInfo.fragmentBindGroupLayout,label:this.#tt,entries:t},n=e.createBindGroup(r);this.gpuRenderInfo.fragmentState=this.getFragmentRenderState(),this.gpuRenderInfo.fragmentUniformBindGroup=n}getFragmentRenderState(e="main"){return{module:this.gpuRenderInfo.fragmentShaderModule,entryPoint:e,targets:[{format:navigator.gpu.getPreferredCanvasFormat(),blend:{color:this.blendColorState.state,alpha:this.blendAlphaState.state},writeMask:this.writeMaskState}]}}_updateBaseProperty(){const{fragmentUniformInfo:e,fragmentUniformBuffer:t}=this.gpuRenderInfo,{members:r}=e;for(const n in r){const r=this[n];r instanceof ColorRGBA?t.writeBuffer(e.members[n],r.rgbaNormal):r instanceof ColorRGB?t.writeBuffer(e.members[n],r.rgbNormal):pt.test(n)||(this[n]=r)}}getGPUResourceBitmapTextureView(e){return e?.gpuTexture?.createView({label:e.src})||this.#Qe}getGPUResourceCubeTextureView(e,t){return e?.gpuTexture?.createView(t||CubeTexture.defaultViewDescriptor)||this.#Re}getGPUResourceSampler(e){return e?.gpuSampler||this.#Je}}const pt=/^use\w+Texture$/;rt.defineByPreset(ABaseMaterial,[rt.PRESET_POSITIVE_NUMBER.OPACITY]),rt.defineBoolean(ABaseMaterial,[["useTint",!1]]),rt.defineColorRGBA(ABaseMaterial,["tint","#ff0000"]),Object.freeze(ABaseMaterial);class ABitmapBaseMaterial extends ABaseMaterial{constructor(e,t,r,n){super(e,t,r,n)}updateTexture(e,t){e&&e.__removeDirtyPipelineListener(this.#ct),t&&t.__addDirtyPipelineListener(this.#ct),this.#ct()}updateSampler(e,t){e&&e.__removeDirtyPipelineListener(this.#ct),t&&t.__addDirtyPipelineListener(this.#ct),this.#ct()}#ct=()=>{this.dirtyPipeline=!0,this.gpuRenderInfo?.fragmentShaderModule?this._updateFragmentState():this.initGPURenderInfos()}}Object.freeze(ABitmapBaseMaterial);const ft=parseWGSL("#redgpu_include SYSTEM_UNIFORM;\r\n#redgpu_include calcDirectionalShadowVisibility;\r\n#redgpu_include calcTintBlendMode;\r\n#redgpu_include normalFunctions;\r\n#redgpu_include drawPicking;\r\nstruct Uniforms {\ruseVertexColor:u32,\ruseCutOff:u32,\rcutOff:f32,\ralphaBlend:u32,\r\ruseBaseColorTexture:u32,\rbaseColorTexture_texCoord_index:u32,\rbaseColorFactor:vec4<f32>,\r\ruseEmissiveTexture:u32,\remissiveTexture_texCoord_index:u32,\remissiveFactor:vec3<f32>,\remissiveStrength:f32,\r\ruseOcclusionTexture:u32,\rocclusionTexture_texCoord_index:u32,\rocclusionStrength:f32,\r\ruseMetallicRoughnessTexture:u32,\rmetallicRoughnessTexture_texCoord_index:u32,\rmetallicFactor:f32,\rroughnessFactor:f32,\r\rnormalScale:f32,\ruseNormalTexture:u32,\rnormalTexture_texCoord_index:u32,\r\ruseEnvironmentTexture:u32,\r\rdoubleSided:u32,\ruseVertexTangent:u32,\r\n\r\r\n\r\ruseKHR_materials_clearcoat:u32,\rKHR_clearcoatFactor:f32,\rKHR_clearcoatRoughnessFactor:f32,\rKHR_clearcoatNormalScale:f32,\ruseKHR_clearcoatTexture:u32,\ruseKHR_clearcoatNormalTexture:u32,\ruseKHR_clearcoatRoughnessTexture:u32,\rKHR_clearcoatTexture_texCoord_index:u32,\rKHR_clearcoatNormalTexture_texCoord_index:u32,\rKHR_clearcoatRoughnessTexture_texCoord_index:u32,\r\rtransmissionFactor:f32,\ruseTransmissionTexture:u32,\rtransmissionTexture_texCoord_index:u32,\r\ruseKHR_materials_specular:u32,\rKHR_specularFactor:f32,\rKHR_specularColorFactor:vec3<f32>,\ruseKHR_specularTexture:u32,\ruseKHR_specularColorTexture:u32,\rKHR_specularTexture_texCoord_index:u32,\rKHR_specularColorTexture_texCoord_index:u32,\r\ruseKHR_materials_sheen:u32,\rKHR_sheenColorFactor:vec3<f32>,\rKHR_sheenRoughnessFactor:f32,\ruseKHR_sheenColorTexture:u32,\ruseKHR_sheenRoughnessTexture:u32,\rKHR_sheenColorTexture_texCoord_index:u32,\rKHR_sheenRoughnessTexture_texCoord_index:u32,\r\n\r\r\rbaseColorTexture_KHR_texture_transform_offset:vec2<f32>,\rbaseColorTexture_KHR_texture_transform_scale:vec2<f32>,\rbaseColorTexture_KHR_texture_transform_rotation:f32,\ruse_baseColorTexture_KHR_texture_transform:u32,\r\rmetallicRoughnessTexture_KHR_texture_transform_offset:vec2<f32>,\rmetallicRoughnessTexture_KHR_texture_transform_scale:vec2<f32>,\rmetallicRoughnessTexture_KHR_texture_transform_rotation:f32,\ruse_metallicRoughnessTexture_KHR_texture_transform:u32,\r\rnormalTexture_KHR_texture_transform_offset:vec2<f32>,\rnormalTexture_KHR_texture_transform_scale:vec2<f32>,\rnormalTexture_KHR_texture_transform_rotation:f32,\ruse_normalTexture_KHR_texture_transform:u32,\r\remissiveTexture_KHR_texture_transform_offset:vec2<f32>,\remissiveTexture_KHR_texture_transform_scale:vec2<f32>,\remissiveTexture_KHR_texture_transform_rotation:f32,\ruse_emissiveTexture_KHR_texture_transform:u32,\r\rocclusionTexture_KHR_texture_transform_offset:vec2<f32>,\rocclusionTexture_KHR_texture_transform_scale:vec2<f32>,\rocclusionTexture_KHR_texture_transform_rotation:f32,\ruse_occlusionTexture_KHR_texture_transform:u32,\r\rKHR_clearcoatTexture_KHR_texture_transform_offset:vec2<f32>,\rKHR_clearcoatTexture_KHR_texture_transform_scale:vec2<f32>,\rKHR_clearcoatTexture_KHR_texture_transform_rotation:f32,\ruse_KHR_clearcoatTexture_KHR_texture_transform:u32,\r\rKHR_clearcoatNormalTexture_KHR_texture_transform_offset:vec2<f32>,\rKHR_clearcoatNormalTexture_KHR_texture_transform_scale:vec2<f32>,\rKHR_clearcoatNormalTexture_KHR_texture_transform_rotation:f32,\ruse_KHR_clearcoatNormalTexture_KHR_texture_transform:u32,\r\rKHR_clearcoatRoughnessTexture_KHR_texture_transform_offset:vec2<f32>,\rKHR_clearcoatRoughnessTexture_KHR_texture_transform_scale:vec2<f32>,\rKHR_clearcoatRoughnessTexture_KHR_texture_transform_rotation:f32,\ruse_KHR_clearcoatRoughnessTexture_KHR_texture_transform:u32,\r\rKHR_sheenColorTexture_KHR_texture_transform_offset:vec2<f32>,\rKHR_sheenColorTexture_KHR_texture_transform_scale:vec2<f32>,\rKHR_sheenColorTexture_KHR_texture_transform_rotation:f32,\ruse_KHR_sheenColorTexture_KHR_texture_transform:u32,\r\rKHR_sheenRoughnessTexture_KHR_texture_transform_offset:vec2<f32>,\rKHR_sheenRoughnessTexture_KHR_texture_transform_scale:vec2<f32>,\rKHR_sheenRoughnessTexture_KHR_texture_transform_rotation:f32,\ruse_KHR_sheenRoughnessTexture_KHR_texture_transform:u32,\r\rKHR_specularTexture_KHR_texture_transform_offset:vec2<f32>,\rKHR_specularTexture_KHR_texture_transform_scale:vec2<f32>,\rKHR_specularTexture_KHR_texture_transform_rotation:f32,\ruse_KHR_specularTexture_KHR_texture_transform:u32,\r\rKHR_specularColorTexture_KHR_texture_transform_offset:vec2<f32>,\rKHR_specularColorTexture_KHR_texture_transform_scale:vec2<f32>,\rKHR_specularColorTexture_KHR_texture_transform_rotation:f32,\ruse_KHR_specularColorTexture_KHR_texture_transform:u32,\r\ruseKHR_materials_unlit:u32,\r\rKHR_materials_ior:f32,\r\ropacity:f32,\ruseTint:u32,\rtint:vec4<f32>,\rtintBlendMode:u32,\r\n\r\n};\r\n\r\n@group(2) @binding(0) var<uniform> uniforms:Uniforms;\r\n\r\n\r\n@group(2) @binding(1) var baseColorTextureSampler:sampler;\r\n@group(2) @binding(2) var baseColorTexture:texture_2d<f32>;\r\n\r\n\r\n@group(2) @binding(3) var emissiveTextureSampler:sampler;\r\n@group(2) @binding(4) var emissiveTexture:texture_2d<f32>;\r\n\r\n\r\n@group(2) @binding(5) var occlusionTextureSampler:sampler;\r\n@group(2) @binding(6) var occlusionTexture:texture_2d<f32>;\r\n\r\n\r\n@group(2) @binding(7) var metallicRoughnessTextureSampler:sampler;\r\n@group(2) @binding(8) var metallicRoughnessTexture:texture_2d<f32>;\r\n\r\n\r\n@group(2) @binding(9) var normalTextureSampler:sampler;\r\n@group(2) @binding(10) var normalTexture:texture_2d<f32>;\r\n\r\n\r\n\r\n\r\n@group(2) @binding(11) var KHR_clearcoatTextureSampler:sampler;\r\n@group(2) @binding(12) var KHR_clearcoatTexture:texture_2d<f32>;\r\n\r\n\r\n@group(2) @binding(13) var KHR_clearcoatNormalTextureSampler:sampler;\r\n@group(2) @binding(14) var KHR_clearcoatNormalTexture:texture_2d<f32>;\r\n\r\n\r\n@group(2) @binding(15) var KHR_clearcoatRoughnessTextureSampler:sampler;\r\n@group(2) @binding(16) var KHR_clearcoatRoughnessTexture:texture_2d<f32>;\r\n\r\n\r\n@group(2) @binding(17) var transmissionTextureSampler:sampler;\r\n@group(2) @binding(18) var transmissionTexture:texture_2d<f32>;\r\n\r\n\r\n@group(2) @binding(19) var KHR_sheenColorTextureSampler:sampler;\r\n@group(2) @binding(20) var KHR_sheenColorTexture:texture_2d<f32>;\r\n@group(2) @binding(21) var KHR_sheenRoughnessTextureSampler:sampler;\r\n@group(2) @binding(22) var KHR_sheenRoughnessTexture:texture_2d<f32>;\r\n\r\n\r\n@group(2) @binding(23) var KHR_specularTextureSampler:sampler;\r\n@group(2) @binding(24) var KHR_specularTexture:texture_2d<f32>;\r\n@group(2) @binding(25) var KHR_specularColorTextureSampler:sampler;\r\n@group(2) @binding(26) var KHR_specularColorTexture:texture_2d<f32>;\r\n\r\n\r\nstruct InputData {\r\r@builtin(position) position:vec4<f32>,\r\r@location(0) vertexPosition:vec3<f32>,\r@location(1) vertexNormal:vec3<f32>,\r\r@location(2) uv:vec2<f32>,\r@location(3) uv1:vec2<f32>,\r\r@location(4) vertexColor_0:vec4<f32>,\r\r@location(5) vertexTangent:vec4<f32>,\r@location(6) shadowPos:vec3<f32>,\r@location(7) receiveShadow:f32,\r@location(8) pickingId:vec4<f32>,\r\n}\r\n\r\n\r\n@fragment\r\nfn main(inputData:InputData) -> @location(0) vec4<f32> {\r\rvar input_vertexNormal=(inputData.vertexNormal.xyz);\rvar input_vertexPosition=inputData.vertexPosition.xyz;\rvar input_vertexColor_0=inputData.vertexColor_0;\rvar input_vertexTangent=inputData.vertexTangent;\rvar input_uv=inputData.uv;\rvar input_uv1=inputData.uv1;\r\r\rlet u_ambientLight=systemUniforms.ambientLight;\rlet u_ambientLightColor=u_ambientLight.color;\rlet u_ambientLightIntensity=u_ambientLight.intensity;\r\n\r\rlet u_directionalLightCount=systemUniforms.directionalLightCount;\rlet u_directionalLights=systemUniforms.directionalLights;\rlet u_directionalLightShadowDepthTextureSize=systemUniforms.directionalLightShadowDepthTextureSize;\rlet u_directionalLightShadowBias=systemUniforms.directionalLightShadowBias;\r\n\rvar u_useIblTexture=systemUniforms.useIblTexture==1u;\r\rlet receiveShadowYn=inputData.receiveShadow !=.0;\r\n\r\rlet u_camera=systemUniforms.camera;\rlet u_cameraMatrix=u_camera.cameraMatrix;\rlet u_cameraPosition=u_camera.cameraPosition;\r\n\r\rvar u_opacity=uniforms.opacity;\rvar u_baseColorTexture_texCoord_index=uniforms.baseColorTexture_texCoord_index;\rvar u_emissiveTexture_texCoord_index=uniforms.emissiveTexture_texCoord_index;\rvar u_occlusionTexture_texCoord_index=uniforms.occlusionTexture_texCoord_index;\rvar u_KHR_clearcoatTexture_texCoord_index=uniforms.KHR_clearcoatTexture_texCoord_index;\rvar u_KHR_clearcoatNormalTexture_texCoord_index=uniforms.KHR_clearcoatNormalTexture_texCoord_index;\rvar u_KHR_clearcoatRoughnessTexture_texCoord_index =uniforms.KHR_clearcoatRoughnessTexture_texCoord_index;\rvar u_useMetallicRoughnessTexture =uniforms.useMetallicRoughnessTexture==1u;\rvar u_metallicRoughnessTexture_texCoord_index=uniforms.metallicRoughnessTexture_texCoord_index;\rvar u_normalTexture_texCoord_index=uniforms.normalTexture_texCoord_index;\rvar u_normalScale=uniforms.normalScale;\rvar u_baseColorFactor=uniforms.baseColorFactor;\rvar u_useVertexColor=uniforms.useVertexColor==1u;\rvar u_useBaseColorTexture=uniforms.useBaseColorTexture==1u;\rvar u_useNormalTexture=uniforms.useNormalTexture==1u;\rvar u_metallicFactor=uniforms.metallicFactor;\rvar u_roughnessFactor=uniforms.roughnessFactor;;\rvar u_useEmissiveTexture=uniforms.useEmissiveTexture==1u;\rvar u_emissiveFactor=uniforms.emissiveFactor;\rvar u_emissiveStrength=uniforms.emissiveStrength;\rvar u_useOcclusionTexture=uniforms.useOcclusionTexture==1u;\rvar u_occlusionStrength=uniforms.occlusionStrength;\rvar u_useCutOff=uniforms.useCutOff==1u;\rvar u_cutOff=uniforms.cutOff;\rvar u_doubleSided=uniforms.doubleSided==1u;\rvar u_useVertexTangent=uniforms.useVertexTangent==1u;\r\rvar u_KHR_clearcoatFactor=uniforms.KHR_clearcoatFactor;\rvar u_KHR_clearcoatRoughnessFactor=uniforms.KHR_clearcoatRoughnessFactor;\rvar u_KHR_clearcoatNormalScale=uniforms.KHR_clearcoatNormalScale;\rvar u_useKHR_materials_clearcoat=uniforms.useKHR_materials_clearcoat==1u;\rvar u_useKHR_clearcoatTexture=uniforms.useKHR_clearcoatTexture==1u;\rvar u_useKHR_clearcoatNormalTexture=uniforms.useKHR_clearcoatNormalTexture==1u;\rvar u_useKHR_clearcoatRoughnessTexture=uniforms.useKHR_clearcoatRoughnessTexture==1u;\r\rvar u_transmissionFactor=uniforms.transmissionFactor;\rvar u_transmissionTexture_texCoord_index=uniforms.transmissionTexture_texCoord_index;\rvar u_useTransmissionTexture=uniforms.useTransmissionTexture==1u;\r\rvar u_use_baseColorTexture_KHR_texture_transform=uniforms.use_baseColorTexture_KHR_texture_transform==1u;\rvar u_use_metallicRoughnessTexture_texture_transform=uniforms.use_metallicRoughnessTexture_KHR_texture_transform==1u;\rvar u_use_normalTexture_texture_transform=uniforms.use_normalTexture_KHR_texture_transform==1u;\rvar u_use_emissiveTexture_texture_transform=uniforms.use_emissiveTexture_KHR_texture_transform==1u;\rvar u_use_occlusionTexture_texture_transform=uniforms.use_occlusionTexture_KHR_texture_transform==1u;\rvar u_use_KHR_clearcoatTexture_texture_transform=uniforms.use_KHR_clearcoatTexture_KHR_texture_transform==1u;\rvar u_use_KHR_clearcoatNormalTexture_texture_transform=uniforms.use_KHR_clearcoatNormalTexture_KHR_texture_transform==1u;\rvar u_use_KHR_clearcoatRoughnessTexture_texture_transform=uniforms.use_KHR_clearcoatRoughnessTexture_KHR_texture_transform==1u;\rvar u_use_KHR_sheenColorTexture_KHR_texture_transform=uniforms.use_KHR_sheenColorTexture_KHR_texture_transform==1u;\rvar u_use_KHR_sheenRoughnessTexture_KHR_texture_transform=uniforms.use_KHR_sheenRoughnessTexture_KHR_texture_transform==1u;\rvar u_use_KHR_specularTexture_KHR_texture_transform=uniforms.use_KHR_specularTexture_KHR_texture_transform==1u;\rvar u_use_KHR_specularColorTexture_KHR_texture_transform=uniforms.use_KHR_specularColorTexture_KHR_texture_transform==1u;\r\rvar u_useKHR_materials_unlit=uniforms.useKHR_materials_unlit==1u;\rvar u_KHR_materials_ior=uniforms.KHR_materials_ior;\r\rvar u_useKHR_materials_sheen=uniforms.useKHR_materials_sheen==1u;\rvar u_useKHR_sheenColorTexture=uniforms.useKHR_sheenColorTexture==1u;\rvar u_useKHR_sheenRoughnessTexture=uniforms.useKHR_sheenRoughnessTexture==1u;\rvar u_KHR_sheenColorFactor=uniforms.KHR_sheenColorFactor;\rvar u_KHR_sheenRoughnessFactor=uniforms.KHR_sheenRoughnessFactor;\rvar u_KHR_sheenColorTexture_texCoord_index=uniforms.KHR_sheenColorTexture_texCoord_index;\rvar u_KHR_sheenRoughnessTexture_texCoord_index=uniforms.KHR_sheenRoughnessTexture_texCoord_index;\r\rvar u_useKHR_materials_specular=uniforms.useKHR_materials_specular==1u;\rvar u_KHR_specularFactor=uniforms.KHR_specularFactor;\rvar u_KHR_specularColorFactor=uniforms.KHR_specularColorFactor;\rvar u_useKHR_specularTexture=uniforms.useKHR_specularTexture==1u;\rvar u_useKHR_specularColorTexture=uniforms.useKHR_specularColorTexture==1u;\rvar u_KHR_specularTexture_texCoord_index=uniforms.KHR_specularTexture_texCoord_index;\rvar u_KHR_specularColorTexture_texCoord_index=uniforms.KHR_specularColorTexture_texCoord_index;\r\n\r\rvar diffuseUV=input_uv;\rvar emissiveUV=input_uv;\rvar occlusionUV=input_uv;\rvar metallicRoughnessUV=input_uv;\rvar normalUV=input_uv;\rvar clearcoatUV=input_uv;\rvar clearcoatNormalUV=input_uv;\rvar clearcoatRoughnessUV=input_uv;\rvar transmissionUV=input_uv;\rvar sheenColorUV=input_uv;\rvar sheenRoughnessUV=input_uv;\rvar khr_specularTextureUV=input_uv;\rvar khr_specularColorTextureUV=input_uv;\r\n\r\rif (u_baseColorTexture_texCoord_index==1) { diffuseUV=input_uv1;}\rif (u_emissiveTexture_texCoord_index==1) { emissiveUV=input_uv1;}\rif (u_occlusionTexture_texCoord_index==1) { occlusionUV=input_uv1;}\rif (u_metallicRoughnessTexture_texCoord_index==1) { metallicRoughnessUV=input_uv1;}\rif (u_normalTexture_texCoord_index==1) { normalUV=input_uv1;}\r\rif (u_KHR_clearcoatTexture_texCoord_index==1) { clearcoatUV=input_uv1;}\rif (u_KHR_clearcoatNormalTexture_texCoord_index==1) { clearcoatNormalUV=input_uv1;}\rif (u_KHR_clearcoatRoughnessTexture_texCoord_index==1) { clearcoatRoughnessUV=input_uv1;}\r\rif (u_transmissionTexture_texCoord_index==1) { transmissionUV=input_uv1;}\r\rif (u_KHR_sheenColorTexture_texCoord_index==1) { sheenColorUV=input_uv1;}\rif (u_KHR_sheenRoughnessTexture_texCoord_index==1) { sheenRoughnessUV=input_uv1;}\r\rif (u_KHR_specularTexture_texCoord_index==1) { khr_specularTextureUV=input_uv1;}\rif (u_KHR_specularColorTexture_texCoord_index==1) { khr_specularColorTextureUV=input_uv1;}\r\n\r\n\r\n\rif(u_use_baseColorTexture_KHR_texture_transform){\rdiffuseUV=transform_texture_coordinate( diffuseUV,uniforms.baseColorTexture_KHR_texture_transform_offset,uniforms.baseColorTexture_KHR_texture_transform_rotation,uniforms.baseColorTexture_KHR_texture_transform_scale );\r}\rif(u_use_metallicRoughnessTexture_texture_transform){\rmetallicRoughnessUV=transform_texture_coordinate( metallicRoughnessUV,uniforms.metallicRoughnessTexture_KHR_texture_transform_offset,uniforms.metallicRoughnessTexture_KHR_texture_transform_rotation,uniforms.metallicRoughnessTexture_KHR_texture_transform_scale );\r}\rif(u_use_normalTexture_texture_transform){\rnormalUV=transform_texture_coordinate( normalUV,uniforms.normalTexture_KHR_texture_transform_offset,uniforms.normalTexture_KHR_texture_transform_rotation,uniforms.normalTexture_KHR_texture_transform_scale );\r}\rif(u_use_emissiveTexture_texture_transform){\remissiveUV=transform_texture_coordinate( emissiveUV,uniforms.emissiveTexture_KHR_texture_transform_offset,uniforms.emissiveTexture_KHR_texture_transform_rotation,uniforms.emissiveTexture_KHR_texture_transform_scale );\r}\rif(u_use_occlusionTexture_texture_transform){\rocclusionUV=transform_texture_coordinate( occlusionUV,uniforms.occlusionTexture_KHR_texture_transform_offset,uniforms.occlusionTexture_KHR_texture_transform_rotation,uniforms.occlusionTexture_KHR_texture_transform_scale );\r}\rif(u_use_KHR_clearcoatTexture_texture_transform){\rclearcoatUV=transform_texture_coordinate( clearcoatUV,uniforms.KHR_clearcoatTexture_KHR_texture_transform_offset,uniforms.KHR_clearcoatTexture_KHR_texture_transform_rotation,uniforms.KHR_clearcoatTexture_KHR_texture_transform_scale );\r}\rif(u_use_KHR_clearcoatNormalTexture_texture_transform){\rclearcoatNormalUV=transform_texture_coordinate( clearcoatNormalUV,uniforms.KHR_clearcoatNormalTexture_KHR_texture_transform_offset,uniforms.KHR_clearcoatNormalTexture_KHR_texture_transform_rotation,uniforms.KHR_clearcoatNormalTexture_KHR_texture_transform_scale );\r}\rif(u_use_KHR_clearcoatRoughnessTexture_texture_transform){\rclearcoatRoughnessUV=transform_texture_coordinate( clearcoatRoughnessUV,uniforms.KHR_clearcoatRoughnessTexture_KHR_texture_transform_offset,uniforms.KHR_clearcoatRoughnessTexture_KHR_texture_transform_rotation,uniforms.KHR_clearcoatRoughnessTexture_KHR_texture_transform_scale );\r}\rif(u_use_KHR_sheenColorTexture_KHR_texture_transform){\rsheenColorUV=transform_texture_coordinate( sheenColorUV,uniforms.KHR_sheenColorTexture_KHR_texture_transform_offset,uniforms.KHR_sheenColorTexture_KHR_texture_transform_rotation,uniforms.KHR_sheenColorTexture_KHR_texture_transform_scale );\r}\rif(u_use_KHR_sheenRoughnessTexture_KHR_texture_transform){\rsheenRoughnessUV=transform_texture_coordinate( sheenRoughnessUV,uniforms.KHR_sheenRoughnessTexture_KHR_texture_transform_offset,uniforms.KHR_sheenRoughnessTexture_KHR_texture_transform_rotation,uniforms.KHR_sheenRoughnessTexture_KHR_texture_transform_scale );\r}\rif(u_use_KHR_specularColorTexture_KHR_texture_transform){\rkhr_specularColorTextureUV=transform_texture_coordinate( khr_specularColorTextureUV,uniforms.KHR_specularColorTexture_KHR_texture_transform_offset,uniforms.KHR_specularColorTexture_KHR_texture_transform_rotation,uniforms.KHR_specularColorTexture_KHR_texture_transform_scale );\r}\rif(u_use_KHR_specularTexture_KHR_texture_transform){\rkhr_specularTextureUV=transform_texture_coordinate( khr_specularColorTextureUV,uniforms.KHR_specularTexture_KHR_texture_transform_offset,uniforms.KHR_specularTexture_KHR_texture_transform_rotation,uniforms.KHR_specularTexture_KHR_texture_transform_scale );\r}\r\n\rif(u_use_baseColorTexture_KHR_texture_transform){\rtransmissionUV=transform_texture_coordinate( transmissionUV,uniforms.baseColorTexture_KHR_texture_transform_offset,uniforms.baseColorTexture_KHR_texture_transform_rotation,uniforms.baseColorTexture_KHR_texture_transform_scale );\r}\r\n\r\rvar V:vec3<f32>=normalize(u_cameraPosition - input_vertexPosition);\r\rvar N:vec3<f32>=normalize(input_vertexNormal.xyz);\r\n\r\n\r\n\rvar backFaceYn:bool=false;\rif(u_doubleSided) {\rvar fdx:vec3<f32>=dpdx(input_vertexPosition);\rvar fdy:vec3<f32>=dpdy(input_vertexPosition);\rvar faceNormal:vec3<f32>=normalize(cross(fdy,fdx));\rif (dot(N,faceNormal) < 0.0) {\rN=-N;\rbackFaceYn=true;\r};\r}\rlet N2=N;\rif(u_useNormalTexture){\rvar targetUv=normalUV;\rif(backFaceYn){\rtargetUv=1.0 - targetUv;\r}\rlet normalSamplerColor=textureSample(normalTexture,normalTextureSampler,normalUV).rgb;\rN=perturb_normal(\rN,\rinput_vertexPosition,\rtargetUv,\rvec3<f32>(normalSamplerColor.r,1.0 - normalSamplerColor.g,normalSamplerColor.b),\ru_normalScale\r);\rif(u_useVertexTangent){\rif(backFaceYn ){ N=-N;}\r}\r}else{\rN=N * u_normalScale;\r}\r\n\r\n\rvar visibility:f32=1.0;\rvisibility=calcDirectionalShadowVisibility(\rdirectionalShadowMap,\rdirectionalShadowMapSampler,\ru_directionalLightShadowDepthTextureSize,\ru_directionalLightShadowBias,\rinputData.shadowPos\r);\r\n\rif(!receiveShadowYn){\rvisibility=1.0;\r}\r\n\rlet directionalLightColor=u_directionalLights[0].color;\rlet directionalLightIntensity=u_directionalLights[0].intensity;\r\rvar L:vec3<f32>=-normalize(u_directionalLights[0].direction);\r\n\r\n\r\rvar finalColor:vec4<f32>;\rvar baseColor=u_baseColorFactor;\rvar resultAlpha:f32=u_opacity * baseColor.a;\r\n\r\rif (u_useVertexColor) {\rbaseColor *=input_vertexColor_0;\r}\r\n\r\rif (u_useBaseColorTexture) {\rlet diffuseSampleColor=(textureSample(baseColorTexture,baseColorTextureSampler,diffuseUV));\rbaseColor *=diffuseSampleColor;\rresultAlpha *=diffuseSampleColor.a;\r}\r\n\r\n\rif(u_useKHR_materials_unlit){\rreturn baseColor;\r}\r\n\r\rif (u_useOcclusionTexture) {\rlet occlusionSamplerColor:vec4<f32>=(textureSample(occlusionTexture,occlusionTextureSampler,occlusionUV));\rbaseColor=vec4<f32>( baseColor.rgb * occlusionSamplerColor.r * u_occlusionStrength,resultAlpha);\r}\r\n\r\n\rvar metallicParameter:f32=u_metallicFactor;\rvar roughnessParameter:f32=u_roughnessFactor;\rvar ior:f32=u_KHR_materials_ior;\r\n\r\n\rif (u_useMetallicRoughnessTexture) {\r\rlet metallicRoughnessSample=(textureSample(metallicRoughnessTexture,metallicRoughnessTextureSampler,metallicRoughnessUV));\rmetallicParameter=metallicRoughnessSample.b * u_metallicFactor;\rroughnessParameter=metallicRoughnessSample.g * u_roughnessFactor;\r}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\rlet albedo=baseColor.rgb;\r\n\r\n\rlet F0_dielectric:vec3<f32>=vec3<f32>(pow((1.0 - ior)/(1.0 + ior),2.0));\rlet F0_metal:vec3<f32>=albedo;\rvar F0:vec3<f32>=mix(F0_dielectric,F0_metal,metallicParameter );\r\n\r\n\rvar specularColor=vec3<f32>(1.0);\r\n\r\n\r\n\rvar specular_specularFactor=u_KHR_specularFactor;\rvar specular_specularColorFactor=u_KHR_specularColorFactor;\r\n\rif(u_useKHR_materials_specular){\rif(u_useKHR_specularTexture){\rlet specularTextureSample= textureSample(\rKHR_specularTexture,\rKHR_specularTextureSampler,\rkhr_specularTextureUV\r);\rspecular_specularFactor *=specularTextureSample.a;\r};\r\n\rif(u_useKHR_specularColorTexture){\rlet specularColorTextureSample= textureSample(\rKHR_specularColorTexture,\rKHR_specularColorTextureSampler,\rkhr_specularColorTextureUV\r);\rspecular_specularColorFactor *=specularColorTextureSample.rgb;\r};\rspecularColor=specular_specularColorFactor;\r}\r\n\r\n\r\n\r\n\rlet NdotV=(dot(N,V)) * 0.5 + 0.5;\r\n\rlet NdotL=(dot(N,L)) * 0.5 + 0.5;\rlet H=normalize(L + V);\rlet LdotH=(dot(L,H)) * 0.5 + 0.5;\rlet NdotH=(dot(N,H)) * 0.5 + 0.5;\rlet VdotH=(dot(V,H)) * 0.5 + 0.5;\r\n\r\n\rvar BRDF_diffuse=diffuse_brdf(N,L,albedo * directionalLightColor * directionalLightIntensity );\rvar BRDF_specular=specular_brdf(F0,N,V,L,roughnessParameter ) * directionalLightIntensity;\rvar BRDF_dielectric=fresnel_mix_KHR_materials_specular(specularColor,ior,specular_specularFactor,BRDF_diffuse,BRDF_specular,VdotH);\rlet BRDF_metal=conductor_fresnel(F0,BRDF_specular,VdotH);\rfinalColor=vec4<f32>(\rmix(BRDF_dielectric,BRDF_metal,metallicParameter),\rresultAlpha\r);\r\n\r\n{\rlet clusterIndex=getPointLightClusterIndex(inputData.position);\rlet lightOffset =pointLight_clusterLightGroup.lights[clusterIndex].offset;\rlet lightCount:u32 =pointLight_clusterLightGroup.lights[clusterIndex].count;\rvar mixColor:vec3<f32>=vec3<f32>(0.0);\rfor (var lightIndex=0u;lightIndex < lightCount;lightIndex=lightIndex + 1u) {\rlet i=pointLight_clusterLightGroup.indices[lightOffset + lightIndex];\rlet u_pointLightPosition=pointLightList.lights[i].position;\rlet u_pointLightRadius=pointLightList.lights[i].radius;\rlet lightDistance=length(u_pointLightPosition - inputData.vertexPosition);\r\n\rif(lightDistance<=u_pointLightRadius){\rlet u_pointLightColor=pointLightList.lights[i].color;\rlet u_pointLightIntensity=pointLightList.lights[i].intensity;\rlet lightDir=normalize(u_pointLightPosition - inputData.vertexPosition);\rlet attenuation=clamp(0.0,1.0,1.0 - (lightDistance * lightDistance)/(u_pointLightRadius * u_pointLightRadius));\rlet L=normalize(lightDir);\rlet R=reflect(-L,N);\r\n\rvar BRDF_diffuse=diffuse_brdf(N,L,albedo * u_pointLightColor * u_pointLightIntensity * attenuation);\rvar BRDF_specular=specular_brdf(F0,N,V,L,roughnessParameter ) * attenuation ;\rvar BRDF_dielectric=fresnel_mix_KHR_materials_specular(specularColor,ior,specular_specularFactor,BRDF_diffuse,BRDF_specular,VdotH);\rlet BRDF_metal=conductor_fresnel(F0,BRDF_specular,VdotH);\rmixColor +=mix(BRDF_dielectric,BRDF_metal,metallicParameter);\r}\r}\rfinalColor=vec4<f32>(finalColor.rgb + mixColor,resultAlpha);\r\n\r\n}\r\n{\r\n\r\n\r\n\r\n}\rvar transmission=u_transmissionFactor;\r{\r\n\rif(u_transmissionFactor > 0.0 ){\r\n\rvar transmissionSampleColor=vec4<f32>(1.0);\rif (u_useTransmissionTexture) {\rtransmissionSampleColor=(textureSample(transmissionTexture,transmissionTextureSampler,transmissionUV));\rtransmission *=transmissionSampleColor.r;\r\n\r}\rif(transmission > 0.0){\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r}\r\n\r}\r}\r\n\r\n\r\n\r\rif (u_useIblTexture) {\r\n\rvar reflectionDirection:vec3<f32>=reflect(-V,N);\rlet reflectionFromEnvironmentSample=(textureSample(iblTexture,iblTextureSampler,reflectionDirection));\rlet reflectance=(1.0 - roughnessParameter) * metallicParameter ;\r\n\rlet fresnel:vec3<f32>=fresnelSchlick(max(1.0 - VdotH,0.0),F0) * (1.0 - roughnessParameter) * (1.0 - roughnessParameter) * reflectionFromEnvironmentSample.rgb * VdotH;\rlet Metal_result=conductor_fresnel( F0,reflectionFromEnvironmentSample.rgb,VdotH );\rfinalColor=vec4<f32>(\r(mix(finalColor.rgb,Metal_result ,reflectance )\r+ specular_specularColorFactor * specular_specularFactor * fresnel * (1-(NdotV )) * (1.0 - roughnessParameter) * (1.0 - roughnessParameter)) * directionalLightColor * directionalLightIntensity,\rresultAlpha\r);\r}\r\n\r\n\rif(u_useKHR_materials_clearcoat){\rif(u_KHR_clearcoatFactor==0.0){\r}else{\rvar clearcoat=u_KHR_clearcoatFactor;\rvar clearcoatRoughness=u_KHR_clearcoatRoughnessFactor;\rvar clearcoatNormal:vec3<f32>=N;\rif(u_useKHR_clearcoatTexture){\rlet clearcoatSample= textureSample(KHR_clearcoatTexture,KHR_clearcoatTextureSampler,clearcoatUV);\rclearcoat *=clearcoatSample.r;\r}\r\n\rif(u_useKHR_clearcoatRoughnessTexture){\rlet clearcoatRoughnesstSample= textureSample(KHR_clearcoatRoughnessTexture,KHR_clearcoatRoughnessTextureSampler,clearcoatRoughnessUV);\rclearcoatRoughness *=clearcoatRoughnesstSample.g;\r}\r\n\rvar clearcoatNormalSampler= textureSample(KHR_clearcoatNormalTexture,KHR_clearcoatNormalTextureSampler,clearcoatNormalUV);\rif(u_useKHR_clearcoatNormalTexture){\rvar targetUv=clearcoatNormalUV;\rif(backFaceYn){\rtargetUv=1.0 - targetUv;\r}\rclearcoatNormal= vec3<f32>(clearcoatNormalSampler.r,clearcoatNormalSampler.g,clearcoatNormalSampler.b);\r\n\rclearcoatNormal=perturb_normal(\rN2,\rinput_vertexPosition,\rtargetUv,\rclearcoatNormal,\ru_normalScale\r);\rif(u_useVertexTangent){\rif(backFaceYn ){ clearcoatNormal=-clearcoatNormal;}\r}\r\n\r}\r\n\rlet reflectance= (1.0 - clearcoatRoughness);\rvar reflectionDirection:vec3<f32>=reflect(-V,clearcoatNormal);\rreflectionDirection=vec3<f32>(reflectionDirection.x,-reflectionDirection.y,reflectionDirection.z);\rlet reflectionFromEnvironmentSample2=(textureSample(iblTexture,iblTextureSampler,reflectionDirection));\r\n\rlet F0_dielectric:vec3<f32>=vec3<f32>(pow((1.0 - ior)/(1.0 + ior),2.0));\rlet BRDF_clearcoat=specular_brdf(F0_dielectric,clearcoatNormal,V,L,clearcoatRoughness * clearcoatRoughness );\rlet coated_material=\rfresnel_coat( dot(clearcoatNormal,V),ior,clearcoat,finalColor,vec4<f32>(BRDF_clearcoat,0) );\rfinalColor=coated_material;\r\n\rif (u_useIblTexture) {\r\n\rlet t0=fresnel_coat( dot(clearcoatNormal,V),ior,clearcoat,finalColor,reflectionFromEnvironmentSample2 );\rfinalColor=vec4<f32>(t0.rgb * directionalLightColor * directionalLightIntensity,t0.a);\r}\r}\r\n\r}\r\n\r\n{\r\n\r\rvar sheenColorFactor=u_KHR_sheenColorFactor;\rvar sheenRoughnessFactor=u_KHR_sheenRoughnessFactor;\rif(u_useKHR_materials_sheen){\rif(u_useKHR_sheenColorTexture){\rlet sheenColorSampler=textureSample(KHR_sheenColorTexture,KHR_sheenColorTextureSampler,sheenColorUV);\rsheenColorFactor *=sheenColorSampler.rgb;\r}\rif(u_useKHR_sheenRoughnessTexture){\rlet sheenRoughnessSampler=textureSample(KHR_sheenRoughnessTexture,KHR_sheenRoughnessTextureSampler,sheenRoughnessUV);\rsheenRoughnessFactor *=sheenRoughnessSampler.a;\r}\rif(sheenRoughnessFactor > 0.0) {\rlet alphaG=sheenRoughnessFactor * sheenRoughnessFactor;\rlet invR=1/alphaG;\rlet H=normalize(L + V);\rlet NdotH=max(dot(N,H),0.0) * 0.5 +0.5;\rlet NdotL=max(dot(N,L),0.0) * 0.5 +0.5;\rlet NdotV=max(dot(N,V),0.0) * 0.5 +0.5;\r\r\r\r\rlet sheenVisibility=1/(4 * (NdotL + NdotV - NdotL * NdotV));\r\n\rlet cos2h=NdotH * NdotH;\rlet sin2h=1 - cos2h;\rlet sheenDistribution=(2 + invR) * pow(sin2h,invR * 0.5)/(2 * pi);\rlet sheenBRDF=sheenColorFactor * sheenDistribution * sheenVisibility;\r\r\rfinalColor=finalColor + vec4<f32>(sheenBRDF,0);\r}\r}\r\n\r\n\r\n}\r\n\r\rif (u_useEmissiveTexture) {\rlet emissiveSamplerColor:vec4<f32>=(textureSample(emissiveTexture,emissiveTextureSampler,emissiveUV));\rfinalColor +=vec4<f32>( emissiveSamplerColor.rgb * u_emissiveFactor * u_emissiveStrength,0);\r} else {\rfinalColor +=(vec4<f32>(u_emissiveFactor * u_emissiveStrength,0));\r}\rif(uniforms.useTint==1u){\rfinalColor=calcTintBlendMode(finalColor,uniforms.tintBlendMode,uniforms.tint);\r}\rfinalColor=linear_to_srgb(finalColor);\r\n\r\n\r\n\r\n\r\n\r\rif (u_useCutOff) {\r\rif (resultAlpha <=u_cutOff) {\rdiscard; \r}\r}\r\n\rreturn finalColor;\r\n};\r\nfn specular_btdf(ior:vec3<f32>,n:vec3<f32>,wi:vec3<f32>,wo:vec3<f32>) -> vec3<f32> {\rlet eta=vec3<f32>(1.0,1.0,1.0)/ior;\r\n\rlet f0=((1.0 - eta)/(1.0 + eta)) * ((1.0 - eta)/(1.0 + eta));\r\n\rlet cosThetaI=dot(n,wi) * 0.5 + 0.5;\rlet sinThetaI=sqrt(max(vec3<f32>(1.0,1.0,1.0) - cosThetaI * cosThetaI,vec3<f32>(0.0,0.0,0.0)));\r\n\rlet sinThetaT=eta * sinThetaI;\r\n\rif(any(sinThetaT > vec3<f32>(1.0,1.0,1.0))) {\rreturn vec3<f32>(0.0,0.0,0.0);\r}\r\n\rlet cosThetaT=sqrt(max(vec3<f32>(1.0,1.0,1.0) - sinThetaT * sinThetaT,vec3<f32>(0.0,0.0,0.0)));\r\n\rlet Fparl=((eta * cosThetaI - cosThetaT)/(eta * cosThetaI + cosThetaT)) * ((eta * cosThetaI - cosThetaT)/(eta * cosThetaI + cosThetaT));\rlet Fperp=((cosThetaI - eta * cosThetaT)/(cosThetaI + eta * cosThetaT)) * ((cosThetaI - eta * cosThetaT)/(cosThetaI + eta * cosThetaT));\r\n\rlet Fr=0.5 * (Fparl + Fperp);\r\n\rreturn vec3<f32>(1.0,1.0,1.0) - Fr;\r\n}\r\nconst pi=3.14159;\r\nfn fresnel_coat(NdotV:f32,ior:f32,weight:f32,base:vec4<f32>,layer:vec4<f32>) -> vec4<f32> {\rlet f0:f32=pow((1.0 - ior)/(1.0 + ior),2.0);\rlet fr:f32=f0 + (1.0 - f0) * pow(1.0 - abs(NdotV),5.0);\rreturn mix(base,layer,weight * fr);\r\n}\r\nfn conductor_fresnel(F0:vec3<f32>,bsdf:vec3<f32>,VdotH:f32) -> vec3<f32> {\rreturn bsdf * (F0 + (1 - F0) * pow((1 - abs(VdotH)),5));\r\n}\r\nfn fresnel_mix(ior:f32,base:vec3<f32>,layer:vec3<f32>,VdotH:f32 ) -> vec3<f32> {\rvar f0:f32=pow((1.0 - ior)/(1.0 + ior),2.0);\rvar fr:f32=f0 + (1.0 - f0) * pow(1.0 - abs(VdotH),5.0);\rreturn mix(base,layer,fr);\r\n}\r\nfn max_value(v:vec3<f32>) -> f32{\rreturn max(max(v.x,v.y),v.z);\r\n}\r\nfn fresnel_mix_KHR_materials_specular(f0_color:vec3<f32>,ior:f32,weight:f32,base:vec3<f32>,layer:vec3<f32>,VdotH:f32) -> vec3<f32> {\rvar f0:vec3<f32>=pow((1.0 - ior)/(1.0 + ior),2.0) * f0_color;\rf0=min(f0,vec3<f32>(1.0,1.0,1.0));\rvar fr:vec3<f32>=f0 + (1.0 - f0) * pow(1.0 - abs(VdotH),5.0);\rreturn (1.0 - weight * max_value(fr)) * base + weight * fr * layer;\r\n}\r\nfn diffuse_brdf(N:vec3<f32>,L:vec3<f32>,Albedo:vec3<f32>) -> vec3<f32> {\rlet cos_theta=dot(N,L) * 0.5 + 0.5;\rreturn Albedo * cos_theta;\r\n\r\n}\r\n\r\nfn specular_brdf(F0:vec3<f32>,N:vec3<f32>,V:vec3<f32>,L:vec3<f32>,roughness:f32) -> vec3<f32> {\rlet H=normalize(V + L);\rlet NdotH=(dot(N,H)) * 0.5 + 0.5;\rlet NdotV=(dot(N,V)) * 0.5 + 0.5;\rlet NdotL=(dot(N,L)) * 0.5 + 0.5;\r\n\rlet D=ggx_distribution(N,H,roughness * roughness);\rlet G=min(1.0,min(2.0 * NdotH * NdotV/NdotH,2.0 * NdotH * NdotL/NdotH));\r\n\rlet F=fresnelSchlick(max(1.0 - NdotV,0.0),F0);\r\n\rreturn (D * G * F)/(4.0 * NdotV * NdotL);\r\n}\r\nfn fresnelSchlick(cosTheta:f32,F0:vec3<f32>) -> vec3<f32> {\rreturn F0 + (vec3<f32>(1.0,1.0,1.0) - F0) * pow(1.0 - cosTheta,5.0);\r\n}\r\n\r\nfn ggx_distribution(N:vec3<f32>,H:vec3<f32>,alpha:f32) -> f32 {\rlet a2=alpha * alpha;\rlet NdotH=max(dot(N,H),0.0);\rlet NdotH2=NdotH * NdotH;\r\n\rlet den=NdotH2 * (a2 - 1.0) + 1.0;\rlet D=a2/(3.14159 * den * den);\r\n\rreturn max(D,0.0);\r\n}\r\nfn sRGBToLinear(srgb:vec4<f32>) -> vec4<f32> {\rlet scale=vec3<f32>(12.92);\rlet offset=vec3<f32>(0.055);\rlet power=vec3<f32>(2.4);\rlet threshold=vec3<f32>(0.04045);\rreturn vec4<f32>(\rselect(\rsrgb.rgb/scale,\rpow((srgb.rgb + offset)/(1.0 + offset),power),\rsrgb.rgb > threshold\r),\rsrgb.a\r);\r\n}\r\n\r\nfn linear_to_srgb( color:vec4<f32>) -> vec4<f32> {\rlet scale=vec3<f32>(12.92);\rlet offset=vec3<f32>(0.055);\rlet power=vec3<f32>(1.0/2.4);\rlet threshold=vec3<f32>(0.0031308);\rreturn vec4<f32>(\rselect(\rcolor.rgb * scale,\r(1.0 + offset) * pow(color.rgb,power) - offset,\rcolor.rgb > threshold\r),\rcolor.a\r);\r\n}\r\nfn transform_texture_coordinate(\ruv:vec2<f32>,offset:vec2<f32>, rotation:f32,scale:vec2<f32>) -> vec2<f32> {\rlet translation:mat3x3<f32>=mat3x3<f32>(\r1.0,0.0,0.0,\r0.0,1.0,0.0,\roffset.x,offset.y,1.0\r);\r\n\rlet rotation_matrix:mat3x3<f32>=mat3x3<f32>(\rcos(rotation),-sin(rotation),0.0,\rsin(rotation),cos(rotation),0.0,\r0.0,0.0,1.0\r);\r\n\rlet scale_matrix:mat3x3<f32>=mat3x3<f32>(\rscale.x,0.0,0.0,\r0.0,scale.y,0.0,\r0.0,0.0,1.0\r);\r\n\rlet result_matrix=translation * rotation_matrix * scale_matrix;\rreturn (result_matrix * vec3<f32>(uv,1.0)).xy;\r\n}\r\n\r\n");class PBRMaterial extends ABitmapBaseMaterial{dirtyPipeline=!1;constructor(e){super(e,"PBR_MATERIAL",ft,2),this.initGPURenderInfos()}}rt.defineByPreset(PBRMaterial,[rt.PRESET_POSITIVE_NUMBER.EMISSIVE_STRENGTH,rt.PRESET_POSITIVE_NUMBER.NORMAL_SCALE]),["baseColorTexture","metallicRoughnessTexture","normalTexture","emissiveTexture","occlusionTexture","KHR_clearcoatTexture","KHR_clearcoatNormalTexture","KHR_clearcoatRoughnessTexture","KHR_sheenColorTexture","KHR_sheenRoughnessTexture","KHR_specularTexture","KHR_specularColorTexture"].forEach((e=>{rt.definePositiveNumber(PBRMaterial,[[`${e}_KHR_texture_transform_rotation`,0]]),rt.defineBoolean(PBRMaterial,[`use_${e}_KHR_texture_transform`]),rt.defineVec2(PBRMaterial,[`${e}_KHR_texture_transform_offset`,[`${e}_KHR_texture_transform_scale`,[1,1]]]),rt.defineUint(PBRMaterial,[`${e}_texCoord_index`]),rt.defineTexture(PBRMaterial,[e]),rt.defineSampler(PBRMaterial,[`${e}Sampler`])})),rt.definePositiveNumber(PBRMaterial,[["cutOff",0],"occlusionStrength","metallicFactor","roughnessFactor",["KHR_clearcoatFactor",0],["KHR_clearcoatRoughnessFactor",0],"KHR_clearcoatNormalScale",["transmissionFactor",0],["KHR_materials_ior",1.5],["KHR_sheenRoughnessFactor",0],"KHR_specularFactor"]),rt.defineUint(PBRMaterial,["alphaBlend","transmissionTexture_texCoord_index"]),rt.defineBoolean(PBRMaterial,["doubleSided","useCutOff","useVertexColor","useVertexTangent","useKHR_materials_clearcoat","useKHR_materials_unlit","useKHR_materials_sheen","useKHR_materials_specular"]),rt.defineVec2(PBRMaterial,[]),rt.defineVec3(PBRMaterial,["emissiveFactor","KHR_sheenColorFactor",["KHR_specularColorFactor",[1,1,1]]]),rt.defineVec4(PBRMaterial,[["baseColorFactor",[1,1,1,1]]]),rt.defineSampler(PBRMaterial,["transmissionTextureSampler"]),rt.defineTexture(PBRMaterial,["transmissionTexture"]),Object.freeze(PBRMaterial);var gt="#redgpu_include SYSTEM_UNIFORM;\r\n#redgpu_include drawDirectionalShadowDepth;\r\nstruct VertexUniforms {\rpickingId:u32,\r\n\t modelMatrix:mat4x4<f32>,\r\n\t normalModelMatrix:mat4x4<f32>,\r\n\t useDisplacementTexture:u32,\r\n\t displacementScale:f32,\r\n\t receiveShadow:f32,\rcombinedOpacity:f32,\r\n};\r\nconst maxDistance:f32=1000.0;\r\nconst maxMipLevel:f32=10.0;\r\n\r\n@group(1) @binding(0) var<uniform> vertexUniforms:VertexUniforms;\r\n@group(1) @binding(1) var displacementTextureSampler:sampler;\r\n@group(1) @binding(2) var displacementTexture:texture_2d<f32>;\r\n\r\nstruct InputData {\r@location(0) position:vec3<f32>,\r@location(1) vertexNormal:vec3<f32>,\r@location(2) uv:vec2<f32>,\r\n};\r\nstruct OutputData {\r@builtin(position) position:vec4<f32>,\r@location(0) vertexPosition:vec3<f32>,\r@location(1) vertexNormal:vec3<f32>,\r@location(2) uv:vec2<f32>,\r@location(12) combinedOpacity:f32,\r@location(13) shadowPos:vec3<f32>,\r@location(14) receiveShadow:f32,\r@location(15) pickingId:vec4<f32>,\r\n};\r\n\r\n@vertex\r\nfn main( inputData:InputData ) -> OutputData {\rvar output:OutputData;\r\n\r\rlet u_projectionMatrix=systemUniforms.projectionMatrix;\rlet u_resolution=systemUniforms.resolution;\rlet u_camera=systemUniforms.camera;\rlet u_cameraMatrix=u_camera.cameraMatrix;\rlet u_cameraPosition=u_camera.cameraPosition;\r\rlet u_modelMatrix=vertexUniforms.modelMatrix;\rlet u_normalModelMatrix=vertexUniforms.normalModelMatrix;\rlet u_displacementScale=vertexUniforms.displacementScale;\rlet u_useDisplacementTexture=vertexUniforms.useDisplacementTexture==1u;\rlet u_receiveShadow=vertexUniforms.receiveShadow;\r\rlet u_directionalLightCount=systemUniforms.directionalLightCount;\rlet u_directionalLights=systemUniforms.directionalLights;\rlet u_directionalLightProjectionViewMatrix=systemUniforms.directionalLightProjectionViewMatrix;\r\rlet input_position=inputData.position;\rlet input_vertexNormal=inputData.vertexNormal;\rlet input_uv=inputData.uv;\r\n\rvar position:vec4<f32>;\rvar normalPosition:vec4<f32>;\rposition=u_modelMatrix * vec4<f32>(input_position,1.0);\r\n\rif (u_useDisplacementTexture) {\rlet distance=distance(position.xyz,u_cameraPosition);\rlet mipLevel=(distance/maxDistance) * maxMipLevel;\rlet displacementSample=textureSampleLevel(displacementTexture,displacementTextureSampler,input_uv,mipLevel).r;\rlet scaledDisplacement=displacementSample * u_displacementScale;\rlet displacedPosition=input_position + input_vertexNormal * scaledDisplacement;\r\n\rposition=u_modelMatrix * vec4<f32>(displacedPosition,1.0);\rnormalPosition=u_normalModelMatrix * vec4<f32>(input_vertexNormal * scaledDisplacement,1.0);\r} else {\rnormalPosition=u_normalModelMatrix * vec4<f32>(input_vertexNormal,1.0);\r}\r\n\r\n\routput.position=u_projectionMatrix * u_cameraMatrix * position;\routput.vertexPosition=position.xyz;\routput.vertexNormal=normalPosition.xyz;\routput.uv=input_uv;\rvar posFromLight= u_directionalLightProjectionViewMatrix * vec4(position.xyz,1.0);\r\r\routput.shadowPos=vec3(\rposFromLight.xy * vec2(0.5,-0.5) + vec2(0.5),\rposFromLight.z\r);\routput.receiveShadow=u_receiveShadow;\routput.combinedOpacity=vertexUniforms.combinedOpacity;\r\n\r\n\rreturn output;\r\n}\r\n\r\n@vertex\r\nfn picking(inputData:InputData) -> OutputData {\rvar output:OutputData;\rlet input_position=inputData.position;\rlet u_modelMatrix=vertexUniforms.modelMatrix;\rlet u_projectionMatrix=systemUniforms.projectionMatrix;\rlet u_camera=systemUniforms.camera;\rlet u_cameraMatrix=u_camera.cameraMatrix;\rvar position:vec4<f32>=u_modelMatrix * vec4<f32>(input_position,1.0);\routput.position=u_projectionMatrix * u_cameraMatrix * position;\routput.pickingId=unpack4x8unorm(vertexUniforms.pickingId);\rreturn output;\r\n}\r\n",xt="#redgpu_include SYSTEM_UNIFORM;\r\n#redgpu_include drawDirectionalShadowDepth;\r\nstruct VertexUniforms {\rpickingId:u32,\rmodelMatrix:mat4x4<f32>,\rnormalModelMatrix:mat4x4<f32>,\ruseDisplacementTexture:u32,\rdisplacementScale:f32,\rreceiveShadow:f32\r\n};\r\nconst maxDistance:f32=1000.0;\r\nconst maxMipLevel:f32=10.0;\r\n@group(1) @binding(0) var<uniform> vertexUniforms:VertexUniforms;\r\n@group(1) @binding(1) var displacementTextureSampler:sampler;\r\n@group(1) @binding(2) var displacementTexture:texture_2d<f32>;\r\n\r\nstruct InputData {\r@location(0) position:vec3<f32>,\r@location(1) vertexNormal:vec3<f32>,\r@location(2) uv:vec2<f32>,\r@location(3) uv1:vec2<f32>,\r@location(4) vertexColor_0:vec4<f32>,\r@location(5) vertexWeight:vec4<f32>,\r@location(6) vertexJoint:vec4<f32>,\r@location(7) vertexTangent:vec4<f32>,\r\n};\r\n\r\nstruct OutputData {\r@builtin(position) position:vec4<f32>,\r@location(0) vertexPosition:vec3<f32>,\r@location(1) vertexNormal:vec3<f32>,\r@location(2) uv:vec2<f32>,\r@location(3) uv1:vec2<f32>,\r@location(4) vertexColor_0:vec4<f32>,\r@location(5) vertexTangent:vec4<f32>,\r@location(6) shadowPos:vec3<f32>,\r@location(7) receiveShadow:f32,\r@location(8) pickingId:vec4<f32>,\r\n};\r\n@vertex\r\nfn main(inputData:InputData) -> OutputData {\rvar output:OutputData;\r\n\rlet input_position=inputData.position;\rlet input_vertexNormal=inputData.vertexNormal;\r\n\r\rlet u_projectionMatrix=systemUniforms.projectionMatrix;\rlet u_camera=systemUniforms.camera;\rlet u_cameraMatrix=u_camera.cameraMatrix;\r\rlet u_modelMatrix=vertexUniforms.modelMatrix;\rlet u_normalModelMatrix=vertexUniforms.normalModelMatrix;\r\rlet u_directionalLightCount=systemUniforms.directionalLightCount;\rlet u_directionalLights=systemUniforms.directionalLights;\rlet u_directionalLightProjectionViewMatrix=systemUniforms.directionalLightProjectionViewMatrix;\rlet u_receiveShadow=vertexUniforms.receiveShadow;\r\n\rvar position:vec4<f32>;\rvar normalPosition:vec4<f32>;\r\n\rposition= u_modelMatrix * vec4<f32>(input_position,1.0);\rnormalPosition= u_normalModelMatrix * vec4<f32>(input_vertexNormal,1.0);\r\n\routput.position=u_projectionMatrix * u_cameraMatrix * position;\routput.vertexPosition=position.xyz;\routput.vertexNormal=normalPosition.xyz;\routput.uv=inputData.uv;\routput.uv1=inputData.uv1;\routput.vertexColor_0=inputData.vertexColor_0;\routput.vertexTangent=inputData.vertexTangent;\r\n\rvar posFromLight= u_directionalLightProjectionViewMatrix * vec4(position.xyz,1.0);\r\r\routput.shadowPos=vec3(\rposFromLight.xy * vec2(0.5,-0.5) + vec2(0.5),\rposFromLight.z\r);\routput.receiveShadow=u_receiveShadow;\r\n\rreturn output;\r\n}\r\n\r\n@vertex\r\nfn picking(inputData:InputData) -> OutputData {\rvar output:OutputData;\rlet input_position=inputData.position;\rlet u_modelMatrix=vertexUniforms.modelMatrix;\rlet u_projectionMatrix=systemUniforms.projectionMatrix;\rlet u_camera=systemUniforms.camera;\rlet u_cameraMatrix=u_camera.cameraMatrix;\rvar position:vec4<f32>=u_modelMatrix * vec4<f32>(input_position,1.0);\routput.position=u_projectionMatrix * u_cameraMatrix * position;\routput.pickingId=unpack4x8unorm(vertexUniforms.pickingId);\rreturn output;\r\n}\r\n";class ResourceStateStorageBuffer{static dirtyList=[];buffer;uuid;#x=0;constructor(e){this.buffer=e,this.uuid=e.uuid}get useNum(){return this.#x}set useNum(e){this.#x=e,ResourceStateStorageBuffer.dirtyList.push(this)}}class StorageBuffer extends AUniformBaseBuffer{constructor(e,t,r="",n=""){super(e,"managedStorageBufferState",GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC,t,r);const i=getCacheBufferFromResourceState(this,n);if(i)return i;n&&(this.name=n),basicRegisterResource(this,new ResourceStateStorageBuffer(this))}}Object.freeze(StorageBuffer);const getBasicMeshVertexBindGroupDescriptor=(e,t=!1)=>{const{redGPUContext:r,gpuRenderInfo:n,material:i}=e,{resourceManager:s}=r,{vertexUniformBuffer:a,vertexBindGroupLayout:o}=n,{basicSampler:u,emptyBitmapTextureView:l,emptyCubeTextureView:c}=s,{gpuSampler:h}=u;return{layout:o,label:t?"VERTEX_BIND_GROUP_DESCRIPTOR_MESH_SKIN":"VERTEX_BIND_GROUP_DESCRIPTOR_MESH",entries:t?[{binding:0,resource:{buffer:a.gpuBuffer,offset:0,size:a.size}},{binding:1,resource:getGPUResourceSampler(i?.displacementTextureSampler)||h},{binding:2,resource:getGPUResourceBitmapTextureView(i?.displacementTexture)||l},{binding:3,resource:{buffer:e.animationInfo.skinInfo.vertexStorageBuffer.gpuBuffer,offset:0,size:e.animationInfo.skinInfo.vertexStorageBuffer.size}}]:[{binding:0,resource:{buffer:a.gpuBuffer,offset:0,size:a.size}},{binding:1,resource:getGPUResourceSampler(i?.displacementTextureSampler)||h},{binding:2,resource:getGPUResourceBitmapTextureView(i?.displacementTexture)||l}]}},getGPUResourceBitmapTextureView=e=>e?.gpuTexture?.createView({label:e.src}),getGPUResourceSampler=e=>e?.gpuSampler,_t=parseWGSL(xt),vt=_t.uniforms.vertexUniforms,yt=parseWGSL(gt),Tt=yt.uniforms.vertexUniforms,createMeshVertexShaderModule=e=>{const{material:t}=e;let r;return r=t instanceof PBRMaterial?e.animationInfo.skinInfo?((e,t)=>{const{redGPUContext:r,currentShaderModuleName:n}=t,{resourceManager:i}=r,{gpuRenderInfo:s}=t,a=`${t.animationInfo.skinInfo.joints.length}`,o=`${e}_${a}`,u="#redgpu_include SYSTEM_UNIFORM;\r\nstruct VertexUniforms {\rpickingId:u32,\rmodelMatrix:mat4x4<f32>,\rnormalModelMatrix:mat4x4<f32>,\ruseDisplacementTexture:u32,\rdisplacementScale:f32,\rreceiveShadow:f32\r\n};\r\nstruct VertexStorages {\rjointMatrix:array<mat4x4<f32>,#JOINT_NUM>,\r\n};\r\nconst maxDistance:f32=1000.0;\r\nconst maxMipLevel:f32=10.0;\r\n@group(1) @binding(0) var<uniform> vertexUniforms:VertexUniforms;\r\n@group(1) @binding(1) var displacementTextureSampler:sampler;\r\n@group(1) @binding(2) var displacementTexture:texture_2d<f32>;\r\n@group(1) @binding(3) var<storage,read> vertexStorages:VertexStorages;\r\nstruct InputDataSkin {\r@location(0) position:vec3<f32>,\r@location(1) vertexNormal:vec3<f32>,\r@location(2) uv:vec2<f32>,\r@location(3) uv1:vec2<f32>,\r@location(4) vertexColor_0:vec4<f32>,\r@location(5) vertexWeight:vec4<f32>,\r@location(6) vertexJoint:vec4<f32>,\r@location(7) vertexTangent:vec4<f32>,\r\n};\r\nstruct OutputDataSkin {\r@builtin(position) position:vec4<f32>,\r@location(0) vertexPosition:vec3<f32>,\r@location(1) vertexNormal:vec3<f32>,\r@location(2) uv:vec2<f32>,\r@location(3) uv1:vec2<f32>,\r@location(4) vertexColor_0:vec4<f32>,\r@location(5) vertexTangent:vec4<f32>,\r@location(6) shadowPos:vec3<f32>,\r@location(7) receiveShadow:f32,\r@location(8) pickingId:vec4<f32>,\r\n};\r\n\r\nstruct OutputShadowData {\r@builtin(position) position:vec4<f32>,\r\n};\r\n\r\n\r\n@vertex\r\nfn main( inputData:InputDataSkin ) -> OutputDataSkin {\r\rlet u_projectionMatrix=systemUniforms.projectionMatrix;\rlet u_projectionCameraMatrix=systemUniforms.projectionCameraMatrix;\rlet u_camera=systemUniforms.camera;\rlet u_cameraMatrix=u_camera.cameraMatrix;\r\rlet u_modelMatrix=vertexUniforms.modelMatrix;\rlet u_normalModelMatrix=vertexUniforms.normalModelMatrix;\r\n\r\rlet u_directionalLightCount=systemUniforms.directionalLightCount;\rlet u_directionalLights=systemUniforms.directionalLights;\rlet u_directionalLightProjectionViewMatrix=systemUniforms.directionalLightProjectionViewMatrix;\rlet u_receiveShadow=vertexUniforms.receiveShadow;\r\n\rvar output:OutputDataSkin;\rvar skinMat:mat4x4<f32>;\rlet vertexJoint:vec4<f32>=inputData.vertexJoint;\rlet vertexWeight:vec4<f32>=inputData.vertexWeight;\rlet jointMatrix=vertexStorages.jointMatrix;\rskinMat=vertexWeight.x * jointMatrix[ u32(vertexJoint.x) ]+\rvertexWeight.y * jointMatrix[ u32(vertexJoint.y) ]+\rvertexWeight.z * jointMatrix[ u32(vertexJoint.z) ]+\rvertexWeight.w * jointMatrix[ u32(vertexJoint.w) ];\r\n\r\n\rlet position= u_modelMatrix * skinMat * vec4<f32>(inputData.position,1.0);\rlet normalPosition= u_normalModelMatrix * skinMat * vec4<f32>(inputData.vertexNormal,1.0);\r\n\routput.position=u_projectionCameraMatrix * position;\routput.vertexPosition=position.xyz;\routput.vertexNormal=normalPosition.xyz;\routput.uv=inputData.uv;\routput.uv1=inputData.uv1;\routput.vertexColor_0=inputData.vertexColor_0;\routput.vertexTangent=inputData.vertexTangent;\r\n\rvar posFromLight= u_directionalLightProjectionViewMatrix * position;\r\r\routput.shadowPos=vec3<f32>(\rposFromLight.xy * vec2<f32>(0.5,-0.5) + vec2<f32>(0.5),\rposFromLight.z\r);\routput.receiveShadow=u_receiveShadow;\rreturn output;\r\n}\r\n\r\n@vertex\r\nfn drawDirectionalShadowDepth( inputData:InputDataSkin ) -> OutputShadowData {\rvar output:OutputShadowData;\rlet u_directionalLightProjectionViewMatrix=systemUniforms.directionalLightProjectionViewMatrix;\rlet u_modelMatrix=vertexUniforms.modelMatrix;\rlet input_position=inputData.position;\rvar position:vec4<f32>;\r\n\rvar skinMat:mat4x4<f32>=mat4x4<f32>(1.0,0.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,0.0,1.0);\rvar vertexJoint:vec4<f32>=inputData.vertexJoint;\rvar vertexWeight:vec4<f32>=inputData.vertexWeight;\rvar jointMatrix=vertexStorages.jointMatrix;\rskinMat=\r\n\rvertexWeight.x * jointMatrix[ u32(vertexJoint.x) ]+\rvertexWeight.y * jointMatrix[ u32(vertexJoint.y) ]+\rvertexWeight.z * jointMatrix[ u32(vertexJoint.z) ]+\rvertexWeight.w * jointMatrix[ u32(vertexJoint.w) ];\r\n\rposition= u_modelMatrix * skinMat * vec4<f32>(input_position,1.0);\routput.position=u_directionalLightProjectionViewMatrix * position;\rreturn output;\r\n}\r\n@vertex\r\nfn picking(inputData:InputDataSkin) -> OutputDataSkin {\rlet u_projectionMatrix=systemUniforms.projectionMatrix;\rlet u_camera=systemUniforms.camera;\rlet u_cameraMatrix=u_camera.cameraMatrix;\rlet u_modelMatrix=vertexUniforms.modelMatrix;\r\rvar output:OutputDataSkin;\rvar skinMat:mat4x4<f32>=mat4x4<f32>(1.0,0.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0,0.0,1.0);\rvar vertexJoint:vec4<f32>=inputData.vertexJoint;\rvar vertexWeight:vec4<f32>=inputData.vertexWeight;\rvar jointMatrix=vertexStorages.jointMatrix;\rskinMat=\r\n\rvertexWeight.x * jointMatrix[ u32(vertexJoint.x) ]+\rvertexWeight.y * jointMatrix[ u32(vertexJoint.y) ]+\rvertexWeight.z * jointMatrix[ u32(vertexJoint.z) ]+\rvertexWeight.w * jointMatrix[ u32(vertexJoint.w) ];\r\n\r\n\rvar position:vec4<f32>;\rposition= u_modelMatrix * skinMat * vec4<f32>(inputData.position,1.0);\routput.position=u_projectionMatrix * u_cameraMatrix * position;\routput.pickingId=unpack4x8unorm(vertexUniforms.pickingId);\rreturn output;\r\n}\r\n",l={code:u};if(n===o)return i.getGPUShaderModule(o);if(l.code=u.replaceAll("#JOINT_NUM",a),s.vertexUniformInfo=parseWGSL(l.code).uniforms.vertexUniforms,t.animationInfo.skinInfo){createMeshVertexUniformBuffers(t,!0),t.animationInfo.skinInfo.vertexStorageInfo=parseWGSL(l.code).storage.vertexStorages;const e=new ArrayBuffer(t.animationInfo.skinInfo.vertexStorageInfo.arrayBufferByteLength);t.animationInfo.skinInfo.vertexStorageBuffer=new StorageBuffer(t.redGPUContext,e,t.name),s.vertexUniformBindGroup=r.gpuDevice.createBindGroup(getBasicMeshVertexBindGroupDescriptor(t,!0))}else createMeshVertexUniformBuffers(t),s.vertexUniformBindGroup=r.gpuDevice.createBindGroup(getBasicMeshVertexBindGroupDescriptor(t));return i.createGPUShaderModule(o,l)})("VERTEX_MODULE_MESH_PBR_SKIN",e):e.createMeshVertexShaderModuleBASIC("VERTEX_MODULE_MESH_PBR",_t,vt,xt):e.createCustomMeshVertexShaderModule?e.createCustomMeshVertexShaderModule():e.createMeshVertexShaderModuleBASIC("VERTEX_MODULE_MESH",yt,Tt,gt),e.currentShaderModuleName=r.label,r},bt={NEVER:"never",LESS:"less",EQUAL:"equal",LESS_EQUAL:"less-equal",GREATER:"greater",NOT_EQUAL:"not-equal",GREATER_EQUAL:"greater-equal",ALWAYS:"always"};Object.freeze(bt);const St="shadow",Mt="picking",createBasePipeline=(e,t,r,n)=>{const{redGPUContext:i}=e,{gpuDevice:s}=i,a=e.material.gpuRenderInfo;let o,u;switch(n){case St:o="drawDirectionalShadowDepth",u=`${t.label}_shadow_pipelineDescriptor`;break;case Mt:o="picking",u=`${t.label}_picking_pipelineDescriptor`;break;default:o="main",u=`${t.label}_pipelineDescriptor`}const l={module:t,entryPoint:o,buffers:e.vertexStateBuffers},c=[i.resourceManager.getGPUBindGroupLayout(ResourceManager.PRESET_GPUBindGroupLayout_System),r];n!==St&&c.push(a.fragmentBindGroupLayout);const h={bindGroupLayouts:c},m={label:u,layout:s.createPipelineLayout(h),vertex:l,primitive:e.primitiveState.state};switch(n){case St:m.depthStencil={depthWriteEnabled:!0,depthCompare:bt.LESS_EQUAL,format:"depth32float"};break;case Mt:e.material&&(m.fragment={module:e.material.gpuRenderInfo.fragmentShaderModule,entryPoint:"picking",targets:[{format:navigator.gpu.getPreferredCanvasFormat()}]},m.depthStencil=e.depthStencilState.state);break;default:m.fragment=a.fragmentState,m.depthStencil=e.depthStencilState.state,m.multisample={count:i.useMSAA?4:1}}return s.createRenderPipeline(m)},updateMeshDirtyPipeline=(e,t)=>{const{material:r,gpuRenderInfo:n,redGPUContext:i}=e,{resourceManager:s}=i;e.dirtyTransform=!0,r.dirtyPipeline&&r._updateFragmentState();const a=createMeshVertexShaderModule(e),o=s.getGPUBindGroupLayout(e.animationInfo.skinInfo?ResourceManager.PRESET_VERTEX_GPUBindGroupLayout_SKIN:ResourceManager.PRESET_VERTEX_GPUBindGroupLayout);n.vertexShaderModule=a,n.pipeline=createBasePipeline(e,a,o),n.shadowPipeline=e.gpuRenderInfo.vertexStructInfo.vertexEntries.includes("drawDirectionalShadowDepth")?createBasePipeline(e,a,o,St):null,n.pickingPipeline=e.gpuRenderInfo.vertexStructInfo.vertexEntries.includes("picking")?createBasePipeline(e,a,o,Mt):null;const{vertexUniformInfo:u}=e.gpuRenderInfo,{members:l}=u;for(const t in l)"pickingId"!==t&&(e[t]=e[t]);e.gpuRenderInfo.vertexUniformInfo.members.pickingId&&e.gpuRenderInfo.vertexUniformBuffer.writeBuffer(e.gpuRenderInfo.vertexUniformInfo.members.pickingId,e.pickingId),r.dirtyPipeline=!1,e.dirtyPipeline=!1,t&&t.numDirtyPipelines++},Rt=Object.values(bt);class DepthStencilState{state;#ht;#Q="depth24plus";#mt=["r8unorm","r8snorm","r8uint","r8sint","r16uint","r16sint","r16float","rg8unorm","rg8snorm","rg8uint","rg8sint","r32uint","r32sint","r32float","rg16uint","rg16sint","rg16float","rgba8unorm","rgba8unorm-srgb","rgba8snorm","rgba8uint","rgba8sint","bgra8unorm","bgra8unorm-srgb","rgb9e5ufloat","rgb10a2uint","rgb10a2unorm","rg11b10ufloat","rg32uint","rg32sint","rg32float","rgba16uint","rgba16sint","rgba16float","rgba32uint","rgba32sint","rgba32float","stencil8","depth16unorm","depth24plus","depth24plus-stencil8","depth32float","depth32float-stencil8","bc1-rgba-unorm","bc1-rgba-unorm-srgb","bc2-rgba-unorm","bc2-rgba-unorm-srgb","bc3-rgba-unorm","bc3-rgba-unorm-srgb","bc4-r-unorm","bc4-r-snorm","bc5-rg-unorm","bc5-rg-snorm","bc6h-rgb-ufloat","bc6h-rgb-float","bc7-rgba-unorm","bc7-rgba-unorm-srgb","etc2-rgb8unorm","etc2-rgb8unorm-srgb","etc2-rgb8a1unorm","etc2-rgb8a1unorm-srgb","etc2-rgba8unorm","etc2-rgba8unorm-srgb","eac-r11unorm","eac-r11snorm","eac-rg11unorm","eac-rg11snorm","astc-4x4-unorm","astc-4x4-unorm-srgb","astc-5x4-unorm","astc-5x4-unorm-srgb","astc-5x5-unorm","astc-5x5-unorm-srgb","astc-6x5-unorm","astc-6x5-unorm-srgb","astc-6x6-unorm","astc-6x6-unorm-srgb","astc-8x5-unorm","astc-8x5-unorm-srgb","astc-8x6-unorm","astc-8x6-unorm-srgb","astc-8x8-unorm","astc-8x8-unorm-srgb","astc-10x5-unorm","astc-10x5-unorm-srgb","astc-10x6-unorm","astc-10x6-unorm-srgb","astc-10x8-unorm","astc-10x8-unorm-srgb","astc-10x10-unorm","astc-10x10-unorm-srgb","astc-12x10-unorm","astc-12x10-unorm-srgb","astc-12x12-unorm","astc-12x12-unorm-srgb"];#dt=!0;#pt=bt.LESS_EQUAL;#ft;#gt;#xt;#_t;#vt;#yt;#Tt;constructor(e){this.#ht=e,this.#je()}get format(){return this.#Q}set format(e){this.#mt.includes(e)?(this.#Q=e,this.#je()):consoleAndThrowError(`Invalid value for format. Received ${e}. Expected one of:${this.#mt.join(",")}`)}get depthWriteEnabled(){return this.#dt}set depthWriteEnabled(e){this.#dt=e,this.#je()}get depthCompare(){return this.#pt}set depthCompare(e){Rt.includes(e)?(this.#pt=e,this.#je()):consoleAndThrowError(`Invalid value for depthCompare. Received ${e}. Expected one of:${Rt.join(",")}`)}get stencilFront(){return this.#ft}set stencilFront(e){this.#ft=e,this.#je()}get stencilBack(){return this.#gt}set stencilBack(e){this.#gt=e,this.#je()}get stencilReadMask(){return this.#xt}set stencilReadMask(e){this.#xt=e,this.#je()}get stencilWriteMask(){return this.#_t}set stencilWriteMask(e){this.#_t=e,this.#je()}get depthBias(){return this.#vt}set depthBias(e){this.#vt=e,this.#je()}get depthBiasSlopeScale(){return this.#yt}set depthBiasSlopeScale(e){this.#yt=e,this.#je()}get depthBiasClamp(){return this.#Tt}set depthBiasClamp(e){this.#Tt=e,this.#je()}#je(){this.state={format:this.#Q,depthWriteEnabled:this.#dt,depthCompare:this.#pt,stencilFront:this.#ft,stencilBack:this.#gt,stencilReadMask:this.#xt,stencilWriteMask:this.#_t,depthBias:this.#vt,depthBiasSlopeScale:this.#yt,depthBiasClamp:this.#Tt},this.#ht.dirtyPipeline=!0}}const wt={NONE:"none",FRONT:"front",BACK:"back"};Object.freeze(wt);const Et={CW:"cw",CCW:"ccw"};Object.freeze(Et);const Pt={UINT16:"uint16",UINT32:"uint32"};Object.freeze(Pt);const Ct={POINT_LIST:"point-list",LINE_LIST:"line-list",LINE_STRIP:"line-strip",TRIANGLE_LIST:"triangle-list",TRIANGLE_STRIP:"triangle-strip"};Object.freeze(Ct);const kt=Object.values(Pt),It=Object.values(Et),Ut=Object.values(wt),Bt=["point-list","line-list","line-strip","triangle-list","triangle-strip"];class PrimitiveState{dirtyPipeline=!1;state;#ht;#bt=Ct.TRIANGLE_LIST;#St;#Mt=Et.CCW;#Rt=wt.BACK;#wt=!1;constructor(e){this.#ht=e,this.#je()}get topology(){return this.#bt}set topology(e){Bt.includes(e)?(this.#bt=e,this.#je()):consoleAndThrowError(`Invalid value for topology. Received ${e}. Expected one of:${Bt.join(",")}`)}get stripIndexFormat(){return this.#St}set stripIndexFormat(e){kt.includes(e)?(this.#St=e,this.#je()):consoleAndThrowError(`Invalid value for stripIndexFormat. Received ${e}. Expected one of:${kt.join(",")}`)}get frontFace(){return this.#Mt}set frontFace(e){It.includes(e)?(this.#Mt=e,this.#je()):consoleAndThrowError(`Invalid value for frontFace. Received ${e}. Expected one of:${It.join(",")}`)}get cullMode(){return this.#Rt}set cullMode(e){Ut.includes(e)?(this.#Rt=e,this.#je()):consoleAndThrowError(`Invalid value for cullMode. Received ${e}. Expected one of:${Ut.join(",")}`)}get unclippedDepth(){return this.#wt}set unclippedDepth(e){"boolean"==typeof e?(this.#wt=e,this.#je()):consoleAndThrowError(`Invalid type for unclippedDepth. Received ${typeof e}. Expected type:boolean.`)}#je(){this.state={topology:this.#bt,stripIndexFormat:this.#St,frontFace:this.#Mt,cullMode:this.#Rt,unclippedDepth:this.#wt},this.#ht.dirtyPipeline=!0}}const Lt=create$5(),At={x:0,y:0,z:0,w:0},getScreenPoint=(e,t)=>{"View"!==e?.constructor?.name&&consoleAndThrowError("allow only View3D instance"),identity$2(Lt);const{projectionMatrix:r,rawCamera:n,pixelRectArray:i}=e;return multiply$5(Lt,r,n.modelMatrix),multiply$5(Lt,Lt,t),At.z=Lt[14],At.w=Lt[15],At.x=.5*Lt[12]/At.w+.5,At.y=.5*Lt[13]/At.w+.5,[(i[0]+At.x*i[2])/window.devicePixelRatio,(i[1]+(1-At.y)*i[3])/window.devicePixelRatio]},Dt=create$5(),localToWorld=(e,t,r,n)=>(validateNumber(t),validateNumber(r),validateNumber(n),identity$2(Dt),translate$1(Dt,Dt,[t,r,n]),multiply$5(Dt,e,Dt),[Dt[12],Dt[13],Dt[14]]),Ot=create$5(),Gt=create$5(),worldToLocal=(e,t,r,n)=>(validateNumber(t),validateNumber(r),validateNumber(n),identity$2(Ot),identity$2(Gt),translate$1(Ot,Ot,[t,r,n]),multiply$5(Gt,Ot,e),[Gt[0]*t+Gt[1]*r+Gt[2]*n+Gt[3],Gt[4]*t+Gt[5]*r+Gt[6]*n+Gt[7],Gt[8]*t+Gt[9]*r+Gt[10]*n+Gt[11]]);class Object3DContainer{modelMatrix=create$5();#Et=[];constructor(){}get children(){return this.#Et}get numChildren(){return this.#Et.length}contains(e){return this.#Pt(e),this.#Et.includes(e)}addChild(e){return this.#Pt(e),this.#Ct(e)?(this.#Et.push(e),e.dirtyTransform=!0,e):null}addChildAt(e,t){if(validateUintRange(t),this.#Et.length<t&&(t=this.#Et.length),!(t<0||t>this.#Et.length)&&this.#Ct(e))return this.#Et.splice(t,0,e),e.dirtyTransform=!0,this}getChildAt(e){if(validateUintRange(e),!(e>=this.#Et.length||e<0))return this.#Et[e]}getChildIndex(e){this.#Pt(e);const t=this.#Et.indexOf(e);return-1===t?-1:t}setChildIndex(e,t){this.#Pt(e),validateUintRange(t);const r=this.#Et.length,n=t>=r,i=this.#Et.indexOf(e);-1!==i?n?consoleAndThrowError(`Invalid index. Index ${t} is out of bounds. Index should be between 0 and ${r-1}.`):(this.#Et.splice(i,1),this.#Et.splice(t,0,e)):consoleAndThrowError(`The provided is not a child of the Object3DContainer.:${e}`)}swapChildren(e,t){if(this.#Pt(e),this.#Pt(t),e===t)return void consoleAndThrowError("Error:child1 and child2 are the same. Cannot swap a child with itself.");const r=this.#Et.indexOf(e),n=this.#Et.indexOf(t);-1!==r&&-1!==n||consoleAndThrowError(`Error:${-1===r?"child1":"child2"} is not a child of this Object3DContainer.`),this.swapChildrenAt(r,n)}swapChildrenAt(e,t){validateUintRange(e),validateUintRange(t),e===t&&consoleAndThrowError("Error:index1 and index2 are identical. Cannot swap a child with itself.");const r=this.#Et.length;(e>=r||t>=r)&&consoleAndThrowError(`Error:Both index1 and index2 should be less than the number of children. Provided index1:${e},index2:${t},number of children:${r}`);let n=this.#Et[e];this.#Et[e]=this.#Et[t],this.#Et[t]=n}removeChild(e){this.#Pt(e);const t=this.#Et.indexOf(e);if(t>-1)return e.parent=null,this.#Et.splice(t,1)[0];consoleAndThrowError("Error:Child not found within parent.")}removeChildAt(e){validateUintRange(e);const t=this.#Et[e];if(t)return t.parent=null,this.#Et.splice(e,1)[0];throw new Error(`Error:No child found at provided index:${e}.`)}removeAllChildren(){let e=this.#Et.length;for(;e--;)this.#Et[e].parent=null;return this.#Et.length=0,this}#Pt(e){e instanceof Object3DContainer||consoleAndThrowError("allow only Object3DContainer instance.")}#Ct=e=>(this.#Pt(e),e.parent?!!e.parent?.removeChild(e)&&(e.parent=this,!0):(e.parent=this,!0))}class MeshBase extends Object3DContainer{gpuRenderInfo;animationInfo={skinInfo:null,morphInfo:null,animationsList:null};gltfLoaderInfo;dirtyPipeline=!0;dirtyTransform=!0;dirtyOpacity=!0;modelMatrix=create$5();localMatrix=create$5();normalModelMatrix=create$5();castShadow=!1;#v;#y;#kt;#It;#Ut;#T=[];#_=createUUID();constructor(e){super(),validateRedGPUContext(e),this.#v=e,this.#y=e.gpuDevice,this.#kt=new PrimitiveState(this),this.#It=new DepthStencilState(this)}get uuid(){return this.#_}get currentShaderModuleName(){return this.#Ut}set currentShaderModuleName(e){this.#Ut=e}get primitiveState(){return this.#kt}get depthStencilState(){return this.#It}get gpuDevice(){return this.#y}get redGPUContext(){return this.#v}worldToLocal(e,t,r){return worldToLocal(this.modelMatrix,e,t,r)}localToWorld(e,t,r){return localToWorld(this.modelMatrix,e,t,r)}getScreenPoint(e){return getScreenPoint(e,this.modelMatrix)}__fireListenerList(e=!1){for(const e of this.#T)e(this);e&&(this.#T.length=0)}}const Nt="VERTEX_MODULE_MESH_PBR_SKIN",Vt=Math.PI/180,Ft=3.141592653589793,zt=6.283185307179586,$t=.225,Ht=1.27323954,Kt=.405284735,Xt=1.5707963267948966;class Mesh extends MeshBase{displacementTexture;#Bt=!0;#e;#s;#Lt;#r=0;#i=0;#n=0;#At=[0,0,0];#Dt=0;#Ot=0;#Gt=0;#Nt;#Vt=1;#Ft=1;#zt=1;#$t=[1,1,1];#o=0;#u=0;#l=0;#Ht=[0,0,0];#Kt={};#Xt=0;#jt=!1;#Yt=1;constructor(e,t,r,n){super(e),n&&(this.name=n),this._geometry=t,this._material=r,this.#Nt=uuidToUint(this.uuid)}_material;get material(){return this._material}set material(e){this._material=e,this.dirtyPipeline=!0,"blendMode"in this&&(this.blendMode=this.blendMode)}_geometry;get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.dirtyPipeline=!0,this.dirtyTransform=!0}get opacity(){return this.#Yt}set opacity(e){validatePositiveNumberRange(e,0,1),this.#Yt=e,this.dirtyOpacity=!0}get ignoreFrustumCulling(){return this.#jt}set ignoreFrustumCulling(e){this.#jt=e}get pickingId(){return this.#Nt}get events(){return this.#Kt}get name(){return this.#e||(this.#e=InstanceIdGenerator.getNextId(this.constructor)),this.#s||`${this.constructor.name} Instance ${this.#e}`}set name(e){this.#s=e}get vertexStateBuffers(){return this._geometry.gpuRenderInfo.buffers}get parent(){return this.#Lt}set parent(e){this.#Lt=e}get pivotX(){return this.#Dt}set pivotX(e){this.#Dt=e,this.dirtyTransform=!0}get pivotY(){return this.#Ot}set pivotY(e){this.#Ot=e,this.dirtyTransform=!0}get pivotZ(){return this.#Gt}set pivotZ(e){this.#Gt=e,this.dirtyTransform=!0}get x(){return this.#r}set x(e){this.#r=this.#At[0]=e,this.dirtyTransform=!0}get y(){return this.#n}set y(e){this.#n=this.#At[1]=e,this.dirtyTransform=!0}get z(){return this.#i}set z(e){this.#i=this.#At[2]=e,this.dirtyTransform=!0}get position(){return this.#At}get scaleX(){return this.#Vt}set scaleX(e){this.#Vt=this.#$t[0]=e,this.dirtyTransform=!0}get scaleY(){return this.#Ft}set scaleY(e){this.#Ft=this.#$t[1]=e,this.dirtyTransform=!0}get scaleZ(){return this.#zt}set scaleZ(e){this.#zt=this.#$t[2]=e,this.dirtyTransform=!0}get scale(){return this.#At}get rotationX(){return this.#o}set rotationX(e){this.#o=this.#Ht[0]=e,this.dirtyTransform=!0}get rotationY(){return this.#u}set rotationY(e){this.#u=this.#Ht[1]=e,this.dirtyTransform=!0}get rotationZ(){return this.#l}set rotationZ(e){this.#l=this.#Ht[2]=e,this.dirtyTransform=!0}get rotation(){return this.#Ht}getCombinedOpacity(){if(this.is2DMeshType){const e=this.parent;return this.#Yt*(e?.getCombinedOpacity?e.getCombinedOpacity():1)}return 1}addListener(e,t){this.#Kt[e]=t,this.#Xt=Object.keys(this.#Kt).length}setScale(e,t,r){t=t??e,r=r??e;const n=this.#$t;this.#Vt=n[0]=e,this.#Ft=n[1]=t,this.#zt=n[2]=r,this.dirtyTransform=!0}setPosition(e,t,r){t=t??e,r=r??e;const n=this.#At;this.#r=n[0]=e,this.#n=n[1]=t,this.#i=n[2]=r,this.dirtyTransform=!0}setRotation(e,t,r){t=t??e,r=r??e;const n=this.#Ht;this.#o=n[0]=e,this.#u=n[1]=t,this.#l=n[2]=r,this.dirtyTransform=!0}clone(){const e=new Mesh(this.redGPUContext,this._geometry,this._material);e.setPosition(this.#r,this.#n,this.#i),e.setRotation(this.#o,this.#u,this.#l),e.setScale(this.#Vt,this.#Ft,this.#zt);let t=this.children.length;for(;t--;)e.addChild(this.children[t].clone());return e}render(e){const{redGPUContext:t}=this,{view:r,isScene2DMode:n,currentRenderPassEncoder:i,timestamp:s,frustumPlanes:a,dirtyVertexUniformFromMaterial:o,useDistanceCulling:u,cullingDistanceSquared:l,distanceCulling:c}=e,{scene:h}=r,{shadowManager:m}=h,{pickingManager:d}=r,{castingList:p}=m,f=this._geometry,g=this._material,{uuid:x}=g||{};let _,v;if(n&&(this.#i=0,this.#Gt=0,this.depthStencilState.depthWriteEnabled&&(this.depthStencilState.depthWriteEnabled=!1)),this.dirtyTransform){_=!0;{const{pixelRectObject:e}=r,t=this.parent,i=this.localMatrix;let s,a,o,u,l,c,h,m,d,p,f,g,x,_,v,y,T,b,S,M,R,w,E,P,C,k,I,U,B,L,A,D,O,G,N,V,F,z,$;if(i[12]=this.#r,i[13]=this.#n,i[14]=this.#i,i[15]=1,s=this.#o*Vt,a=this.#u*Vt,o=this.#l*Vt,E=1,P=0,C=0,I=0,U=1,B=0,A=0,D=0,O=1,$=s%zt,$<-3.141592653589793?$+=zt:$>Ft&&($-=zt),$=$<0?Ht*$+Kt*$*$:Ht*$-Kt*$*$,u=$<0?$t*($*-$-$)+$:$t*($*$-$)+$,$=(s+Xt)%zt,$<-3.141592653589793?$+=zt:$>Ft&&($-=zt),$=$<0?Ht*$+Kt*$*$:Ht*$-Kt*$*$,h=$<0?$t*($*-$-$)+$:$t*($*$-$)+$,$=a%zt,$<-3.141592653589793?$+=zt:$>Ft&&($-=zt),$=$<0?Ht*$+Kt*$*$:Ht*$-Kt*$*$,l=$<0?$t*($*-$-$)+$:$t*($*$-$)+$,$=(a+Xt)%zt,$<-3.141592653589793?$+=zt:$>Ft&&($-=zt),$=$<0?Ht*$+Kt*$*$:Ht*$-Kt*$*$,m=$<0?$t*($*-$-$)+$:$t*($*$-$)+$,$=o%zt,$<-3.141592653589793?$+=zt:$>Ft&&($-=zt),$=$<0?Ht*$+Kt*$*$:Ht*$-Kt*$*$,c=$<0?$t*($*-$-$)+$:$t*($*$-$)+$,$=(o+Xt)%zt,$<-3.141592653589793?$+=zt:$>Ft&&($-=zt),$=$<0?Ht*$+Kt*$*$:Ht*$-Kt*$*$,d=$<0?$t*($*-$-$)+$:$t*($*$-$)+$,_=m*d,v=u*l*d-h*c,y=h*l*d+u*c,T=m*c,b=u*l*c+h*d,S=h*l*c-u*d,M=-l,R=u*m,w=h*m,s=this.#Vt,a=this.#Ft,o=this.#zt,this.renderTextureWidth&&(s*=this.renderTextureWidth,a*=this.renderTextureHeight),i[0]=(E*_+I*v+A*y)*s,i[1]=(P*_+U*v+D*y)*s,i[2]=(C*_+B*v+O*y)*s,i[3]=i[3]*s,i[4]=(E*T+I*b+A*S)*a,i[5]=(P*T+U*b+D*S)*a,i[6]=(C*T+B*b+O*S)*a,i[7]=i[7]*a,i[8]=(E*M+I*R+A*w)*o,i[9]=(P*M+U*R+D*w)*o,i[10]=(C*M+B*R+O*w)*o,i[11]=i[11]*o,(this.#Dt||this.#Ot||this.#Gt)&&(E=i[0],P=i[1],C=i[2],k=i[3],I=i[4],U=i[5],B=i[6],L=i[7],A=i[8],D=i[9],O=i[10],G=i[11],N=i[12],V=i[13],F=i[14],z=i[15],p=1,f=0,g=0,x=0,i[0]=p*E+f*I+g*A+x*N,i[1]=p*P+f*U+g*D+x*V,i[2]=p*C+f*B+g*O+x*F,i[3]=p*k+f*L+g*G+x*z,p=0,f=1,g=0,x=0,i[4]=p*E+f*I+g*A+x*N,i[5]=p*P+f*U+g*D+x*V,i[6]=p*C+f*B+g*O+x*F,i[7]=p*k+f*L+g*G+x*z,p=0,f=0,g=1,x=0,i[8]=p*E+f*I+g*A+x*N,i[9]=p*P+f*U+g*D+x*V,i[10]=p*C+f*B+g*O+x*F,i[11]=p*k+f*L+g*G+x*z,n?t?.modelMatrix?(p=-this.#Dt,f=-this.#Ot,g=-this.#Gt,x=1):(p=-this.#Dt/s,f=-this.#Ot/a,g=-this.#Gt,x=1):(p=-this.#Dt,f=-this.#Ot,g=-this.#Gt,x=1),i[12]=p*E+f*I+g*A+x*N,i[13]=p*P+f*U+g*D+x*V,i[14]=p*C+f*B+g*O+x*F,i[15]=p*k+f*L+g*G+x*z),t?.modelMatrix){let e=t.modelMatrix,r=this.localMatrix,n=this.modelMatrix,i=e[0],s=e[1],a=e[2],o=e[3],u=e[4],l=e[5],c=e[6],h=e[7],m=e[8],d=e[9],p=e[10],f=e[11],g=e[12],x=e[13],_=e[14],v=e[15],y=r[0],T=r[1],b=r[2],S=r[3];n[0]=y*i+T*u+b*m+S*g,n[1]=y*s+T*l+b*d+S*x,n[2]=y*a+T*c+b*p+S*_,n[3]=y*o+T*h+b*f+S*v,y=r[4],T=r[5],b=r[6],S=r[7],n[4]=y*i+T*u+b*m+S*g,n[5]=y*s+T*l+b*d+S*x,n[6]=y*a+T*c+b*p+S*_,n[7]=y*o+T*h+b*f+S*v,y=r[8],T=r[9],b=r[10],S=r[11],n[8]=y*i+T*u+b*m+S*g,n[9]=y*s+T*l+b*d+S*x,n[10]=y*a+T*c+b*p+S*_,n[11]=y*o+T*h+b*f+S*v,y=r[12],T=r[13],b=r[14],S=r[15],n[12]=y*i+T*u+b*m+S*g,n[13]=y*s+T*l+b*d+S*x,n[14]=y*a+T*c+b*p+S*_,n[15]=y*o+T*h+b*f+S*v}else{const{modelMatrix:e,localMatrix:t}=this;e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]}{let e=this.normalModelMatrix,t=this.modelMatrix,r=t[0],n=t[1],i=t[2],s=t[3],a=t[4],o=t[5],u=t[6],l=t[7],c=t[8],h=t[9],m=t[10],d=t[11],p=t[12],f=t[13],g=t[14],x=t[15],_=r*o-n*a,v=r*u-i*a,y=r*l-s*a,T=n*u-i*o,b=n*l-s*o,S=i*l-s*u,M=c*f-h*p,R=c*g-m*p,w=c*x-d*p,E=m*x-d*g,P=h*x-d*f,C=_*E-v*P+y*E+T*w-b*R+S*M;C=1/C,e[0]=(o*E-u*P+l*E)*C,e[4]=(-n*E+i*P-s*E)*C,e[8]=(f*S-g*b+x*T)*C,e[12]=(-h*S+m*b-d*T)*C,e[1]=(-a*E+u*w-l*R)*C,e[5]=(r*E-i*w+s*R)*C,e[9]=(-p*S+g*y-x*v)*C,e[13]=(c*S-m*y+d*v)*C,e[2]=(a*P-o*w+l*M)*C,e[6]=(-r*P+n*w-s*M)*C,e[10]=(p*b-f*y+x*_)*C,e[14]=(-c*b+h*y-d*_)*C,e[3]=(-a*E+o*R-u*M)*C,e[7]=(r*E-n*R+i*M)*C,e[11]=(-p*T+f*v-g*_)*C,e[15]=(c*T-h*v+m*_)*C}}}this.gltfLoaderInfo?.activeAnimations?.length&&((e,t)=>{let r,n,i,s,a,o,u,l,c,h,m,d,p,f,g=t.length;for(;g--;)for(u=t[g],o=u.targetAniTrackList,a=o.length;a--;){l=o[a];const{animationTargetMesh:t,timeAnimationInfo:g,aniDataAnimationInfo:x,weightMeshes:_}=l;for(r=(e-u.startTime)%(1e3*o.maxTime)/1e3,m=g.dataList,d=x.dataList,p=m.length,f=0,h=m.length-1,c=0,n=m[h],i=m[c];f<p;f++){const e=m[f];if(e<r&&(h=f,n=m[h],c=null==m[h+1]?0:h+1,i=m[c]),0==f&&r<e){h=p-1,n=m[h],c=f,i=m[c],r=e;break}if(f==p-1&&r>e){h=0,n=m[h],c=p-1,i=m[c],r=e;break}}let v,y,T,b,S,M,R;switch("CUBICSPLINE"==l.interpolation?(s=i-n,"NaN"==s.toString()&&(s=0),v=(r-n)/s,"NaN"==v.toString()&&(v=0),y=v*v,T=y*v,M=-2*T+3*y,R=T-y,b=1-M,S=R-y+v):(s="STEP"==l.interpolation?0:(r-n)/(i-n),"NaN"==s.toString()&&(s=0)),l.key){case"rotation":gltfAnimationLooper_rotation(l.interpolation,t,d,p,s,h,c,b,S,M,R);break;case"translation":gltfAnimationLooper_transition(l.interpolation,t,d,p,s,h,c,b,S,M,R);break;case"scale":gltfAnimationLooper_scale(l.interpolation,t,d,p,s,h,c,b,S,M,R);break;case"weights":gltfAnimationLooper_weight(_,d,s,h,c)}}})(s,this.gltfLoaderInfo.activeAnimations),this.animationInfo.skinInfo&&(this.currentShaderModuleName.includes(Nt)||(this.dirtyPipeline=!0),this.currentShaderModuleName===`${Nt}_${this.animationInfo.skinInfo.joints?.length}`&&(this.animationInfo.skinInfo.update(t,this),_=!1));let y=!0;if(u&&f){const{rawCamera:e}=r,t=e.x-this.#r,n=e.y-this.#n,i=e.z-this.#i,s=this.modelMatrix;f.volume.geometryRadius;s[0],s[5],s[10];const a=t*t;if(a>l)y=!1;else{const e=n*n;if(a+e>l)y=!1;else{a+e+i*i>l&&(y=!1)}}}if(a&&y)if(f){const e=this.modelMatrix,t=a[0],r=a[1],n=a[2],i=a[3],s=a[4],o=a[5],u=f.volume.geometryRadius,l=u*e[0],c=u*e[5],h=u*e[10],m=2*Math.max(u,l,c,h),d=e[12],p=e[13],g=e[14];(t[0]*d+t[1]*p+t[2]*g+t[3]<=-m||r[0]*d+r[1]*p+r[2]*g+r[3]<=-m||n[0]*d+n[1]*p+n[2]*g+n[3]<=-m||i[0]*d+i[1]*p+i[2]*g+i[3]<=-m||s[0]*d+s[1]*p+s[2]*g+s[3]<=-m||o[0]*d+o[1]*p+o[2]*g+o[3]<=-m)&&(y=!1)}else y=!1;this.#jt&&(y=!0),f?e.num3DObjects++:e.num3DGroups++;const{displacementTexture:T,displacementScale:b}=g||{};(this.dirtyPipeline||g?.dirtyPipeline||o[x])&&(o[x]=!0);const{useMSAA:S,gpuDevice:M}=t;if(f&&(S!==this.#Bt&&(this.#Bt=S,this.dirtyPipeline=!0),this.gpuRenderInfo||this.initGPURenderInfos(),(this.dirtyPipeline||o[x])&&updateMeshDirtyPipeline(this,e)),f&&y){{const{gpuRenderInfo:e}=this,{vertexUniformBuffer:t,vertexUniformInfo:r,pipeline:n}=e,{members:i}=r;void 0!==i.displacementScale&&i.displacementScale!==b&&M.queue.writeBuffer(t.gpuBuffer,i.displacementScale.uniformOffset,new i.displacementScale.View([b])),void 0!==i.useDisplacementTexture&&i.useDisplacementTexture!==T&&M.queue.writeBuffer(t.gpuBuffer,i.useDisplacementTexture.uniformOffset,new i.useDisplacementTexture.View([T?1:0]))}const{gpuRenderInfo:t}=this,{vertexUniformBuffer:r,vertexUniformBindGroup:n,vertexUniformInfo:s,pipeline:a}=t,{members:o}=s;if(this.dirtyTransform&&(M.queue.writeBuffer(r.gpuBuffer,o.modelMatrix.uniformOffset,new o.modelMatrix.View(this.is2DMeshType?multiply$5(create$5(),this.modelMatrix,fromValues$5(this.width,0,0,0,0,this.height,0,0,0,0,1,0,0,0,0,1)):this.modelMatrix)),M.queue.writeBuffer(r.gpuBuffer,o.normalModelMatrix.uniformOffset,new o.normalModelMatrix.View(this.normalModelMatrix)),_=!0,this.dirtyTransform=!1),this.dirtyOpacity&&(v=!0,o.combinedOpacity&&M.queue.writeBuffer(r.gpuBuffer,o.combinedOpacity.uniformOffset,new o.combinedOpacity.View([this.getCombinedOpacity()])),this.dirtyOpacity=!1),"particle"===this.meshType)e.particleLayer[e.particleLayer.length]=this;else if("instanceMesh"===this.meshType)e.instanceMeshLayer[e.instanceMeshLayer.length]=this;else if(g.transparent)e.transparentLayer[e.transparentLayer.length]=this;else if(2===g.alphaBlend||g.opacity<1||!this.depthStencilState.depthWriteEnabled)e.alphaLayer[e.alphaLayer.length]=this;else{i.setPipeline(a);const{gpuBuffer:t}=f.vertexBuffer,{fragmentUniformBindGroup:r}=g.gpuRenderInfo;if(e.prevVertexGpuBuffer!==t&&(i.setVertexBuffer(0,t),e.prevVertexGpuBuffer=t),i.setBindGroup(1,n),e.prevFragmentUniformBindGroup!==r&&(i.setBindGroup(2,r),e.prevFragmentUniformBindGroup=r),e.numDrawCalls++,f.indexBuffer){const{indexBuffer:t}=f,{indexNum:r,triangleCount:n,gpuBuffer:s}=t;i.setIndexBuffer(s,"uint32"),this.particleBuffers?i.drawIndexed(r,this.particleNum,0,0,0):i.drawIndexed(r,1,0,0,0),e.numTriangles+=n,e.numPoints+=r}else{const{vertexBuffer:t}=f,{vertexCount:r,triangleCount:n}=t;i.draw(r,1,0,0),e.numTriangles+=n,e.numPoints+=r}}this.#Xt&&(d.castingList[d.castingList.length]=this)}(this.castShadow||this.castShadow&&!f)&&(p[p.length]=this);const{children:R}=this;let w=0;const E=R.length;for(;w<E;w++)_&&(R[w].dirtyTransform=_),v&&(R[w].dirtyOpacity=v),R[w].render(e)}initGPURenderInfos(){this.gpuRenderInfo=new VertexGPURenderInfo(null,null,null,null,null,null),updateMeshDirtyPipeline(this)}createMeshVertexShaderModuleBASIC(e,t,r,n){const{redGPUContext:i}=this,{resourceManager:s}=i,{gpuRenderInfo:a}=this,o={code:n};return a.vertexUniformInfo!==r&&(a.vertexUniformInfo=r,a.vertexStructInfo=t,createMeshVertexUniformBuffers(this)),a.vertexUniformBindGroup=i.gpuDevice.createBindGroup(getBasicMeshVertexBindGroupDescriptor(this)),s.createGPUShaderModule(e,o)}}Object.defineProperty(Mesh.prototype,"meshType",{value:"mesh",writable:!1}),Ie.defineByPreset(Mesh,[Ie.PRESET_BOOLEAN.RECEIVE_SHADOW]),Object.freeze(Mesh);class AController{#Zt;constructor(){}get camera(){return this.#Zt}set camera(e){this.#Zt=e}update(e){}getCanvasEventPoint=(e,t)=>{const r=t.htmlCanvas,n=t.detector.isMobile,i=r.getBoundingClientRect(),s="clientX",a="clientY";let o,u;if(n){const t=e.changedTouches[0];o=t[s],u=t[a]}else{const t=e;o=t[s],u=t[a]}return{x:o-i.left,y:u-i.top}}}let jt,Yt=create$5();const Zt=create$5(),qt=create$4();const validateNumberRange=(e,t=0,r=Number.MAX_VALUE)=>("number"!=typeof e&&consoleAndThrowError("Only numbers allowed."),"number"!=typeof t&&consoleAndThrowError("Only numbers allowed."),"number"!=typeof r&&consoleAndThrowError("Only numbers allowed."),(e<t||e>r)&&consoleAndThrowError(`Only numbers within the range of [${t},${r}] are allowed. input:${e}`),!0);let Wt;var Jt=Object.freeze({__proto__:null,BasicController:class extends AController{#qt=!0;#Wt;#Jt={moveForward:"w",moveBack:"s",moveLeft:"a",moveRight:"d",moveUp:"t",moveDown:"g",turnLeft:"q",turnRight:"e",turnUp:"r",turnDown:"f"};#Qt=1;#er=.1;#tr=1;#rr=.1;#nr=3;#ir=0;#sr=[0,0,0];#ar=0;#or=0;#ur;constructor(e){super(),this.#ur=new Mesh(e),this.camera=new PerspectiveCamera;const t=e.detector.isMobile,r={move:t?"touchmove":"mousemove",up:t?"touchend":"mouseup",down:t?"touchstart":"mousedown"};let n,i;const checkArea=t=>{let r=this.#Wt;if(jt&&r===jt){let n,i,s=r.pixelRectObject;const{x:a,y:o}=this.getCanvasEventPoint(t,e);if(n=a*window.devicePixelRatio*e.renderScale,i=o*window.devicePixelRatio*e.renderScale,!(s.x<n&&n<s.x+s.width))return;if(!(s.y<i&&i<s.y+s.height))return}return!0};n=0,i=0;const HD_Move=t=>{const{x:r,y:s}=this.getCanvasEventPoint(t,e),a=r-n,o=s-i;n=r,i=s,this.#ar-=a*this.#tr*.1,this.#or-=o*this.#tr*.1},HD_up=()=>{jt=null,e.htmlCanvas.removeEventListener(r.move,HD_Move),window.removeEventListener(r.up,HD_up)};e.htmlCanvas.addEventListener(r.down,(t=>{if(jt=this.#Wt,!checkArea(t))return;const{x:s,y:a}=this.getCanvasEventPoint(t,e);n=s,i=a,e.htmlCanvas.addEventListener(r.move,HD_Move),window.addEventListener(r.up,HD_up)}))}get x(){return this.#ur.x}set x(e){validateNumber(e),this.#ur.x=e,this.#sr[0]=e}get y(){return this.#ur.y}set y(e){validateNumber(e),this.#ur.y=e,this.#sr[1]=e}get z(){return this.#ur.z}set z(e){validateNumber(e),this.#ur.z=e,this.#sr[2]=e}get tilt(){return this.#or}set tilt(e){validateNumber(e),this.#ur.rotationX=e,this.#or=e}get pan(){return this.#ar}set pan(e){validateNumber(e),this.#ur.rotationY=e,this.#ar=e}get keyNameMapper(){return{...this.#Jt}}setMoveForwardKey(e){this.#Jt.moveForward=e}setMoveBackKey(e){this.#Jt.moveBack=e}setMoveLeftKey(e){this.#Jt.moveLeft=e}setMoveRightKey(e){this.#Jt.moveRight=e}setMoveUpKey(e){this.#Jt.moveUp=e}setMoveDownKey(e){this.#Jt.moveDown=e}setTurnLeftKey(e){this.#Jt.turnLeft=e}setTurnRightKey(e){this.#Jt.turnRight=e}setTurnUpKey(e){this.#Jt.turnUp=e}setTurnDownKey(e){this.#Jt.turnDown=e}update(e){this.#Wt=e;const t=this.#er,r=this.#rr,n=this.#sr,i=this.#ur;i.rotationY+=(this.#ar-i.rotationY)*r,i.rotationX+=(this.#or-i.rotationX)*r,this.#lr(e)&&(Yt=i.modelMatrix,identity$2(Zt),rotateY$3(Zt,Zt,i.rotationY*Math.PI/180),rotateX$3(Zt,Zt,i.rotationX*Math.PI/180),translate$1(Zt,Zt,qt),identity$2(Yt),translate$1(Yt,Yt,i.position),multiply$5(Yt,Yt,Zt),n[0]=Yt[12],n[1]=Yt[13],n[2]=Yt[14]),i.x+=(n[0]-i.x)*t,i.y+=(n[1]-i.y)*t,i.z+=(n[2]-i.z)*t,i.rotationY+=(this.#ar-i.rotationY)*r,i.rotationX+=(this.#or-i.rotationX)*r,Yt=i.modelMatrix,identity$2(Yt),translate$1(Yt,Yt,i.position),rotateY$3(Yt,Yt,i.rotationY*Math.PI/180),rotateX$3(Yt,Yt,i.rotationX*Math.PI/180);const s=clone$5(Yt);translate$1(s,s,[0,0,.01]),this.camera.setPosition(s[12],s[13],s[14]),this.camera.lookAt(i.x,i.y,i.z)}#lr(e){if(!e.checkMouseInViewBounds())return;const t=this.#Qt,r=this.#tr,{keyboardKeyBuffer:n}=e.redGPUContext,i=this.#Jt;let s=!1,a=!1,o=0,u=0;qt[0]=0,qt[1]=0,qt[2]=0;const l=this.#ir*t;return n[i.turnLeft]&&(a=!0,o=r),n[i.turnRight]&&(a=!0,o=-r),n[i.turnUp]&&(a=!0,u=r),n[i.turnDown]&&(a=!0,u=-r),n[i.moveForward]&&(s=!0,qt[2]=-l),n[i.moveBack]&&(s=!0,qt[2]=l),n[i.moveLeft]&&(s=!0,qt[0]=-l),n[i.moveRight]&&(s=!0,qt[0]=l),n[i.moveUp]&&(s=!0,qt[1]=l),n[i.moveDown]&&(s=!0,qt[1]=-l),a||s?(this.#ir+=.1,this.#ir>this.#nr&&(this.#ir=this.#nr)):(this.#ir+=-.1,this.#ir<0&&(this.#ir=0)),a&&(this.#ar+=o,this.#or+=u),s||a}},Camera2D:Camera2D,ObitController:class extends AController{#e;#cr=0;#hr=0;#mr=0;#dr=15;#pr=2;#fr=.1;#tr=3;#rr=.1;#gr=-35;#xr=-90;#_r=90;#vr=0;#yr=0;#Tr=0;#br=0;#Wt;#s;constructor(e){super(),this.camera=new PerspectiveCamera;const t=e.detector.isMobile,r={move:t?"touchmove":"mousemove",up:t?"touchend":"mouseup",down:t?"touchstart":"mousedown"};let n,i;const checkArea=t=>{let r=this.#Wt;if(Wt&&r===Wt){let n,i,s=r.pixelRectObject;const{x:a,y:o}=this.getCanvasEventPoint(t,e);if(n=a*window.devicePixelRatio*e.renderScale,i=o*window.devicePixelRatio*e.renderScale,!(s.x<n&&n<s.x+s.width))return;if(!(s.y<i&&i<s.y+s.height))return}return!0};n=0,i=0;const HD_Move=t=>{const{x:r,y:s}=this.getCanvasEventPoint(t,e),a=r-n,o=s-i;n=r,i=s,this.#vr-=a*this.#tr*.1,this.#gr-=o*this.#tr*.1},HD_up=()=>{Wt=null,e.htmlCanvas.removeEventListener(r.move,HD_Move),window.removeEventListener(r.up,HD_up)};e.htmlCanvas.addEventListener(r.down,(t=>{if(Wt=this.#Wt,!checkArea(t))return;const{x:s,y:a}=this.getCanvasEventPoint(t,e);n=s,i=a,e.htmlCanvas.addEventListener(r.move,HD_Move),window.addEventListener(r.up,HD_up)})),e.htmlCanvas.addEventListener("wheel",(e=>{Wt=this.#Wt,checkArea(e)&&(this.#dr+=e.deltaY/100*this.#pr,Wt=null)}))}get name(){return this.#e||(this.#e=InstanceIdGenerator.getNextId(this.constructor)),this.#s||`${this.constructor.name} Instance ${this.#e}`}set name(e){this.#s=e}get centerX(){return this.#cr}set centerX(e){this.#cr=e}get centerY(){return this.#hr}set centerY(e){this.#hr=e}get centerZ(){return this.#mr}set centerZ(e){this.#mr=e}get distance(){return this.#dr}set distance(e){validateNumberRange(e,0),this.#dr=e}get speedDistance(){return this.#pr}set speedDistance(e){validateNumberRange(e,.01),this.#pr=e}get delayDistance(){return this.#fr}set delayDistance(e){validateNumberRange(e,.01,.99),this.#fr=e}get speedRotation(){return this.#tr}set speedRotation(e){validateNumberRange(e,.01),this.#tr=e}get delayRotation(){return this.#rr}set delayRotation(e){validateNumberRange(e,.01,.99),this.#rr=e}get minTilt(){return this.#xr}set minTilt(e){validateNumberRange(e,-90,90),this.#xr=e}get maxTilt(){return this.#_r}set maxTilt(e){validateNumberRange(e,-90,90),this.#_r=e}get pan(){return this.#vr}set pan(e){this.#vr=e}get tilt(){return this.#gr}set tilt(e){validateNumberRange(e,-90,90),this.#gr=e}update(e){let t,r,n;this.#Wt=e,n=Math.PI/180,this.#gr<this.#xr&&(this.#gr=this.#xr),this.#gr>this.#_r&&(this.#gr=this.#_r),t=this.#rr;const{camera:i}=this;r=i.modelMatrix,this.#yr+=(this.#vr-this.#yr)*t,this.#Tr+=(this.#gr-this.#Tr)*t,this.#dr<i.nearClipping&&(this.#dr=i.nearClipping),this.#br+=(this.#dr-this.#br)*this.#fr,this.#br<i.nearClipping&&(this.#br=i.nearClipping),identity$2(r),translate$1(r,r,[this.#cr,this.#hr,this.#mr]),rotateY$3(r,r,this.#yr*n),rotateX$3(r,r,this.#Tr*n),translate$1(r,r,[0,0,this.#br]),i.x=r[12],i.y=r[13],i.z=r[14],this.camera.lookAt(this.#cr,this.#hr,this.#mr)}},OrthographicCamera:OrthographicCamera,PerspectiveCamera:PerspectiveCamera});class RedGPUContextSizeManager{#Sr;#Mr;#v;#Rr=[0,0,0,0];#wr;#Er=1;constructor(e,t="100%",r="100%"){this.#v=e,this.#wr=e.htmlCanvas,this.#wr.style.boxSizing="border-box",this.#Sr=t,this.#Mr=r}get renderScale(){return this.#Er}set renderScale(e){validateNumber(e),e<=0&&(e=.01),this.#Er=e,this.setSize()}get width(){return this.#Sr}set width(e){this.setSize(e,this.#Mr)}get height(){return this.#Mr}set height(e){this.setSize(this.#Sr,e)}get pixelRectArray(){return this.#Rr}get pixelRectObject(){return{x:this.#Rr[0],y:this.#Rr[1],width:this.#Rr[2],height:this.#Rr[3]}}get parentDomRect(){return(this.#wr.parentNode||document.body).getBoundingClientRect()}get screenRectObject(){return{x:this.#Rr[0]/devicePixelRatio,y:this.#Rr[1]/devicePixelRatio,width:this.#Rr[2]/devicePixelRatio,height:this.#Rr[3]/devicePixelRatio}}static validateSizeValue=e=>{switch(typeof e){case"number":validatePositiveNumberRange(e);break;case"string":new RegExp(/^[+]?^[.]?(\d+)(\.\d+)?(?:px|%|$)/gm).test(e)||consoleAndThrowError(`allow positive number,%,px model/input:${e}`);break;default:consoleAndThrowError(`positive number,%,px model/input:${e}`)}};static validatePositionValue=e=>{switch(typeof e){case"number":validateNumber(e);break;case"string":new RegExp(/^-?\d+(\.\d+)?(px|%)?$/).test(e)||consoleAndThrowError(`allow number,%,px model /input:${e}`);break;default:consoleAndThrowError(`number,%,px model/input:${e}`)}};static getPixelDimension(e,t,r){return"number"==typeof r?r:RedGPUContextSizeManager.calculateSizeFromString(e,t,r)}static calculateSizeFromString(e,t,r){return r.includes("%")?Math.floor(e[t]*+r.replace("%","")/100):+r.replace("px","")}setSize(e=this.#Sr,t=this.#Mr){RedGPUContextSizeManager.validateSizeValue(e),RedGPUContextSizeManager.validateSizeValue(t),this.#Sr=e,this.#Mr=t;const r=Math.max(.01,RedGPUContextSizeManager.getPixelDimension(this.parentDomRect,"width",e)),n=Math.max(.01,RedGPUContextSizeManager.getPixelDimension(this.parentDomRect,"height",t));this.#Pr(r,n),this.#Cr(r,n),this.#kr()}#Cr(e,t){this.#Rr[2]=Math.floor(e*this.#Er*window.devicePixelRatio),this.#Rr[3]=Math.floor(t*this.#Er*window.devicePixelRatio)}#kr(){this.#v.onResize&&this.#v.onResize(this.screenRectObject.width,this.screenRectObject.height),this.#v.viewList.forEach((e=>{e.setSize(),e.setPosition()}))}#Pr(e,t){const r=this.#wr,{style:n}=r;r.width=e*this.#Er*window.devicePixelRatio,r.height=t*this.#Er*window.devicePixelRatio,n.width=`${e}px`,n.height=`${t}px`}}const Qt=new Uint32Array([0,0,0,0]);class PassPointLightClusters{#Ir;#Ur;#Br;#Lr;#v;constructor(e,t){validateRedGPUContext(e),this.#v=e,this.#Ir=t,this.#Ar()}get clusterLightsBuffer(){return this.#Lr}render(){const{gpuDevice:e}=this.#v,t=this.#Ir.systemUniform_Vertex_UniformBindGroup;if(t){const r=e.createCommandEncoder(),n=r.beginComputePass({label:"PointLight cluster"}),i=Fe.getDispatchSize();this.#v.gpuDevice.queue.writeBuffer(this.clusterLightsBuffer,0,Qt),n.setPipeline(this.#Br),n.setBindGroup(0,t),n.setBindGroup(1,this.#Ur),n.dispatchWorkgroups(i[0],i[1],i[2]),n.end(),e.queue.submit([r.finish()])}}#Ar(){const{gpuDevice:e,resourceManager:t}=this.#v,r=parseWGSL("#redgpu_include SYSTEM_UNIFORM;\r\n@group(1) @binding(0) var<storage> pointLight_Clusters:PointLight_Clusters;\r\n\r\nfn pointLight_testSphereAABB(light:u32, tile:u32) -> bool {\r\rlet targetLight=pointLightList.lights[light];\rlet targetTile=pointLight_Clusters.cubeList[tile];\r\n\r\rlet radius:f32=targetLight.radius;\rlet position:vec3<f32>=targetLight.position;\rlet center:vec3<f32>=(systemUniforms.camera.cameraMatrix * vec4<f32>(position,1.0)).xyz;\r\n\r\rlet squaredDistance:f32=pointLight_sqDistPointAABB(center,tile,targetTile.minAABB.xyz,targetTile.maxAABB.xyz);\r\n\rreturn squaredDistance <=(radius * radius);\r\n}\r\n\r\nfn pointLight_sqDistPointAABB(targetPoint:vec3<f32>,tile:u32,minAABB:vec3<f32>,maxAABB:vec3<f32>) -> f32 {\rvar sqDist=0.0;\rfor(var i=0u;i < 3u;i=i + 1u) {\r\rlet v=targetPoint[i];\rlet _minAABB=minAABB[i];\rlet _maxAABB=maxAABB[i];\r\n\rif(v < _minAABB){\rsqDist += (_minAABB - v) * (_minAABB - v);\r}\rif(v > _maxAABB){\rsqDist +=(v - _maxAABB) * (v - _maxAABB);\r}\r}\r\n\rreturn sqDist;\r\n}\r\nfn spotLight_testConeAABB(light:u32,tile:u32) -> bool {\rlet targetLight=pointLightList.lights[light];\rlet targetTile=pointLight_Clusters.cubeList[tile];\r\n\rlet position:vec3<f32>=(systemUniforms.camera.cameraMatrix * vec4<f32>(targetLight.position,1.0)).xyz;\r\nlet spotlightDirection:vec3<f32>=normalize(\r(systemUniforms.camera.cameraMatrix * vec4<f32>(targetLight.position + vec3<f32>(0,-1,0),1.0)).xyz - position\r\n);\rlet innerCutoffAngle:f32=radians(25.0);\rlet outerCutoffAngle:f32=radians(26.0);\r\n\rlet tileMin:vec3<f32>=targetTile.minAABB.xyz;\rlet tileMax:vec3<f32>=targetTile.maxAABB.xyz;\r\n\r\rlet corners:array<vec3<f32>,8>=array<vec3<f32>,8>(\rtileMin,\rvec3<f32>(tileMax.x,tileMin.y,tileMin.z),\rvec3<f32>(tileMin.x,tileMax.y,tileMin.z),\rvec3<f32>(tileMax.x,tileMax.y,tileMin.z),\rvec3<f32>(tileMin.x,tileMin.y,tileMax.z),\rvec3<f32>(tileMax.x,tileMin.y,tileMax.z),\rvec3<f32>(tileMin.x,tileMax.y,tileMax.z),\rtileMax\r);\r\n\rvar isCornerInsideCone=false;\r\r\n\r\rlet tileCenter:vec3<f32>=(tileMin + tileMax) * 0.5;\r\n\rfor (var i:u32=0u;i < 9u;i=i+1) {\rvar toCorner:vec3<f32>;\rif(i<8u){\rtoCorner= corners[i] - position;\r}else{\rtoCorner= tileCenter - position;\r}\rvar cosOuterCutoffAngle=cos(outerCutoffAngle);\rvar dotProduct=dot(normalize(toCorner),spotlightDirection);\rdotProduct=clamp(dotProduct,-1.0,1.0);\r\n\rif(dotProduct >=cosOuterCutoffAngle) {\risCornerInsideCone=true;\rbreak;\r}\r}\r\n\rreturn isCornerInsideCone;\r\n}\r\n@compute @workgroup_size(REDGPU_DEFINE_WORKGROUP_SIZE_X,REDGPU_DEFINE_WORKGROUP_SIZE_Y,REDGPU_DEFINE_WORKGROUP_SIZE_Z)\r\nfn main(@builtin(global_invocation_id) global_id:vec3<u32>) {\r\rlet tileIndex=global_id.x +\rglobal_id.y * pointLight_tileCount.x +\rglobal_id.z * pointLight_tileCount.x * pointLight_tileCount.y;\r\rvar clusterLightCount=0u;\r\rvar clusterPointLightIndices:array<u32,REDGPU_DEFINE_MAX_LIGHTS_PER_CLUSTERu>;\r\n\r\rfor (var i=0u;i < u32(pointLightList.count[0]);i=i + 1u) {\r\rlet lightInCluster=pointLight_testSphereAABB(i,tileIndex);\r\n\r\rif (lightInCluster) {\r\rclusterPointLightIndices[clusterLightCount]=i;\r\rclusterLightCount=clusterLightCount + 1u;\r}\r\n\r\rif (clusterLightCount==REDGPU_DEFINE_MAX_LIGHTS_PER_CLUSTERu) {\rbreak;\r}\r}\r\n\r\rvar offset=atomicAdd(&pointLight_clusterLightGroup.offset,clusterLightCount);\r\n\r\rfor(var i=0u;i < clusterLightCount;i=i + 1u) {\r\rpointLight_clusterLightGroup.indices[offset + i]=clusterPointLightIndices[i];\r}\r\n\r\rpointLight_clusterLightGroup.lights[tileIndex].offset=offset;\rpointLight_clusterLightGroup.lights[tileIndex].count=clusterLightCount;\r\n}\r\n").shaderSource;this.#Lr=e.createBuffer({size:Fe.getPointLight_ClusterLightsBufferSize(),usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST});const n=e.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}}]});this.#Ur=e.createBindGroup({label:"clusterLightBindGroup",layout:n,entries:[{binding:0,resource:{buffer:this.#Ir.passLightClustersBound.clusterBoundBuffer}}]}),this.#Br=e.createComputePipeline({label:"clusterLightPipeline",layout:e.createPipelineLayout({bindGroupLayouts:[t.getGPUBindGroupLayout(ResourceManager.PRESET_GPUBindGroupLayout_System),n]}),compute:{module:e.createShaderModule({code:r,label:"Cluster Light"}),entryPoint:"main"}})}}class PassPointLightClustersBound{#Ir;#Dr;#Or;#Gr;#Nr;#v;constructor(e,t){validateRedGPUContext(e),this.#v=e,this.#Ir=t,this.#Ar()}get clusterBoundBuffer(){return this.#Dr}render(){const e=this.#Ir.systemUniform_Vertex_UniformBindGroup;if(e){const{gpuDevice:t}=this.#v,r=t.createCommandEncoder(),n=r.beginComputePass({label:"Bound cluster"}),i=Fe.getDispatchSize();n.setPipeline(this.#Nr),n.setBindGroup(0,e),n.setBindGroup(1,this.#Gr),n.dispatchWorkgroups(i[0],i[1],i[2]),n.end(),t.queue.submit([r.finish()])}}#Ar(){const{gpuDevice:e,resourceManager:t}=this.#v,r=parseWGSL("#redgpu_include SYSTEM_UNIFORM;\r\n@group(1) @binding(0) var<storage,read_write> pointLight_Clusters:PointLight_Clusters;\r\n\r\nfn lineIntersectionToZPlane(a:vec3<f32>,b:vec3<f32>,zDistance:f32) -> vec3<f32> {\rlet normal=vec3<f32>(0.0,0.0,0.5);\rlet ab=b - a;\rlet t=(zDistance - dot(normal,a))/dot(normal,ab);\rreturn a + t * ab;\r\n}\r\n\r\nfn clipToView(clip:vec4<f32>) -> vec4<f32> {\rlet view=systemUniforms.inverseProjectionMatrix * clip;\rreturn view/vec4<f32>(view.w,view.w,view.w,view.w);\r\n}\r\n\r\nfn screen2View(screen:vec4<f32>) -> vec4<f32> {\rlet texCoord=screen.xy/systemUniforms.resolution.xy;\rlet clip=vec4<f32>(vec2<f32>(texCoord.x,1.0 - texCoord.y) * 2.0 - vec2<f32>(1.0,1.0),screen.z,screen.w );\rreturn clipToView(clip);\r\n}\r\n\r\nconst eyePos=vec3<f32>(0.0);\r\n\r\n@compute @workgroup_size(REDGPU_DEFINE_WORKGROUP_SIZE_X,REDGPU_DEFINE_WORKGROUP_SIZE_Y,REDGPU_DEFINE_WORKGROUP_SIZE_Z)\r\n\r\nfn main(@builtin(global_invocation_id) global_id:vec3<u32>) {\r\rlet tileIndex=global_id.x +\rglobal_id.y * pointLight_tileCount.x +\rglobal_id.z * pointLight_tileCount.x * pointLight_tileCount.y;\r\n\r\rlet tileSize=vec2<f32>(\rsystemUniforms.resolution.x/f32(pointLight_tileCount.x),\rsystemUniforms.resolution.y/f32(pointLight_tileCount.y)\r);\r\n\r\rlet global_id_x_pos_one=vec2<f32>(f32(global_id.x + 1u),f32(global_id.y + 1u)) * tileSize;\rlet global_id_x_y=vec2<f32>(f32(global_id.x),f32(global_id.y)) * tileSize;\r\n\rlet maxPoint_sS=vec4<f32>(global_id_x_pos_one,0.0,1.0);\rlet minPoint_sS=vec4<f32>(global_id_x_y,0.0,1.0);\r\n\rlet maxPoint_vS=screen2View(maxPoint_sS).xyz;\rlet minPoint_vS=screen2View(minPoint_sS).xyz;\r\n\r\rlet nearFarX=systemUniforms.camera.nearClipping;\rlet nearFarY=systemUniforms.camera.farClipping;\r\n\rlet tileZ=f32(global_id.z)/f32(pointLight_tileCount.z);\rlet tileZ_plus_one=f32(global_id.z + 1u)/f32(pointLight_tileCount.z);\r\n\rlet tileNear=-nearFarX * pow(nearFarY/nearFarX,tileZ);\rlet tileFar=-nearFarX * pow(nearFarY/nearFarX,tileZ_plus_one);\r\n\r\rlet minPointNear=lineIntersectionToZPlane(eyePos,minPoint_vS,tileNear);\rlet minPointFar=lineIntersectionToZPlane(eyePos,minPoint_vS,tileFar);\rlet maxPointNear=lineIntersectionToZPlane(eyePos,maxPoint_vS,tileNear);\rlet maxPointFar=lineIntersectionToZPlane(eyePos,maxPoint_vS,tileFar);\r\n\r\rlet minAABB=min(min(minPointNear,minPointFar),min(maxPointNear,maxPointFar));\rlet maxAABB=max(max(minPointNear,minPointFar),max(maxPointNear,maxPointFar));\r\n\rpointLight_Clusters.cubeList[tileIndex].minAABB=vec4<f32>(minAABB,0.0);\rpointLight_Clusters.cubeList[tileIndex].maxAABB=vec4<f32>(maxAABB,0.0);\r\n}\r\n").shaderSource;this.#Dr=e.createBuffer({size:32*Fe.getTotalTileSize(),usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST}),this.#Or=e.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}}]}),this.#Gr=e.createBindGroup({label:"clusterBoundBindGroup",layout:this.#Or,entries:[{binding:0,resource:{buffer:this.#Dr}}]}),this.#Nr=e.createComputePipeline({label:"clusterBoundPipeline",layout:e.createPipelineLayout({bindGroupLayouts:[t.getGPUBindGroupLayout(ResourceManager.PRESET_GPUBindGroupLayout_System),this.#Or]}),compute:{module:e.createShaderModule({code:r,label:"Cluster Bounds"}),entryPoint:"main"}})}}class PickingEvent{pickingId;mouseX;mouseY;target;time;type;movementX=0;movementY=0;localX=0;localY=0;localZ=0;altKey=!1;ctrlKey=!1;shiftKey=!1;constructor(e,t,r,n,i,s,a){this.pickingId=e,this.mouseX=t,this.mouseY=r,this.target=n,this.time=i,this.type=s,this.altKey=a.altKey,this.ctrlKey=a.ctrlKey,this.shiftKey=a.shiftKey}}const er={MOVE:"move",DOWN:"down",UP:"up",OVER:"over",OUT:"out",CLICK:"click"};class PickingManager{lastMouseEvent;lastMouseClickEvent;#Vr;#Fr;#zr;#$r;#v;#Ir;#Hr=[];#Kr=0;#Xr=0;#jr;#Yr;get mouseX(){return this.#Kr}set mouseX(e){this.#Kr=e}get mouseY(){return this.#Xr}set mouseY(e){this.#Xr=e}get castingList(){return this.#Hr}get pickingGPUTexture(){return this.#zr}get pickingGPUTextureView(){return this.#$r}get pickingDepthGPUTextureView(){return this.#Fr}resetCastingList(){this.#Hr.length=0}destroy(){this.#zr&&(this.#zr.destroy(),this.#Vr.destroy(),this.#zr=null,this.#$r=null,this.#Vr=null,this.#Fr=null)}checkTexture(e){const{redGPUContext:t}=e;this.#Ir=e,this.#v=t,this.#zr?.width===this.#Ir.pixelRectObject.width&&this.#zr?.height===this.#Ir.pixelRectObject.height||(this.destroy(),this.#zr=this.#Zr(navigator.gpu.getPreferredCanvasFormat()),this.#$r=this.#zr.createView(),this.#Vr=this.#Zr("depth24plus"),this.#Fr=this.#Vr.createView())}checkEvents(e,t){this.#qr(e,t),this.resetCastingList()}#Zr(e){const{gpuDevice:t}=this.#v;return t.createTexture({size:[this.#Ir.pixelRectObject.width,this.#Ir.pixelRectObject.height,1],usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_SRC,format:e,sampleCount:1})}#qr=async(e,t,r=1,n=1)=>{const{gpuDevice:i}=e.redGPUContext,{pixelRectArray:s}=e,a=this.#Kr,o=this.#Xr;if(a<=0||a>=s[2]||o<=0||o>=s[3])return;const u=this.#Wr(),l=this.#Jr(i,r,n,a,o),c=await this.#Qr(l);l.destroy(),c?(this.#en(c,a,o,t,u),this.#tn(c,a,o,t,u)):this.#rn(),this.lastMouseEvent=null,this.lastMouseClickEvent=null};#Wr=()=>this.#Hr.reduce(((e,t)=>(e[t.pickingId]=t,e)),{});#Jr=(e,t,r,n,i)=>{const s=e.createCommandEncoder(),a=e.createBuffer({size:16*t*r,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),o={texture:this.#zr,origin:{x:n,y:i,z:0}},u={buffer:a,bytesPerRow:Math.max(256,4*t*r),rowsPerImage:1},l={width:t,height:r,depthOrArrayLayers:1};return s.copyTextureToBuffer(o,u,l),e.queue.submit([s.finish()]),a};#en=(e,t,r,n,i)=>{const s=i[e],a=this.lastMouseClickEvent?.type;if(a===er.CLICK){const i=new PickingEvent(e,t,r,s,n,a,this.lastMouseClickEvent);this.#nn(a,i)}};#tn=(e,t,r,n,i)=>{const s=i[e],a=this.lastMouseEvent?.type;if(a){const i=new PickingEvent(e,t,r,s,n,a,this.lastMouseEvent);switch(this.#jr&&(i.movementX=t-this.#jr.mouseX,i.movementY=r-this.#jr.mouseY),a){case er.DOWN:case er.UP:this.#nn(a,i);break;case er.MOVE:this.#in(e,s,i)}this.#jr=i}};#in=(e,t,r)=>{const n=this.#jr?.pickingId;n!==e?(this.#jr&&n&&n!==e&&this.#rn(),this.#Yr!==t&&(this.#nn(er.OVER,r),document.body.style.cursor="pointer"),this.#Yr=t):this.#nn(er.MOVE,r)};#rn=()=>{this.#jr&&this.#nn(er.OUT,this.#jr),this.#jr=null,this.#Yr=null,document.body.style.cursor="default"};async#Qr(e){await e.mapAsync(GPUMapMode.READ);const t=new DataView(e.getMappedRange()),r="rgba8unorm"==this.#zr.format?[0,1,2,3]:[2,1,0,3],n=t.getUint8(r[0]),i=t.getUint8(r[1]),s=t.getUint8(r[2]);return(t.getUint8(r[3])<<24|s<<16|i<<8|n)>>>0}#nn(e,t){t.target.events[e]&&t.target.events[e](t)}}Object.freeze(PickingManager);class PostEffectManager{#Ir;#sn=[];#an;#on;#un=16;#ln=4;#cn=1;constructor(e){this.#Ir=e}get view(){return this.#Ir}get effectList(){return this.#sn}addEffect(e){this.#sn.push(e)}addEffectAt(e){}getEffectAt(e){return this.#sn[e]}removeEffect(e){}removeEffectAt(e){}removeAllEffect(e){this.#sn.forEach((e=>{e.clear()})),this.#sn.length=0}render(){const{colorResolveTextureView:e,colorTexture:t}=this.#Ir.viewRenderTextureManager;this.#on=this.#hn(this.#Ir,e);let r=this.#on;const{width:n,height:i}=t;return this.#sn.forEach((e=>{r=e.render(this.#Ir,n,i,r)})),r}clear(){this.#sn.forEach((e=>{e.clear()}))}#hn(e,t){this.#an&&(this.#an.destroy(),this.#an=null);const{redGPUContext:r,viewRenderTextureManager:n}=e,{colorTexture:i}=n,{gpuDevice:s}=r,{width:a,height:o}=i,u=this.#mn(),l=s.createShaderModule({code:u}),c=this.#dn(r);this.#an=this.#Zr(s,a,o);const h=this.#an.createView();return this.#pn(s,this.#fn(s,l,c),this.#gn(r,c,t,h),a,o),h}#mn(){return`@group(0) @binding(0) var sourceTextureSampler:sampler;@group(0) @binding(1) var sourceTexture:texture_2d<f32>;@group(0) @binding(2) var outputTexture:texture_storage_2d<rgba8unorm,write>;@compute @workgroup_size(${this.#un},${this.#ln},${this.#cn})fn main (@builtin(global_invocation_id) global_id:vec3<u32>,){let index=vec2<u32>(global_id.xy );let dimensions:vec2<u32>=textureDimensions(sourceTexture);let dimW=f32(dimensions.x);let dimH=f32(dimensions.y);let uv=\tvec2<f32>((f32(index.x)+0.5)/dimW,(f32(index.y)+0.5)/dimH);var color:vec4<f32>=textureSampleLevel(sourceTexture,sourceTextureSampler,uv,0);textureStore(outputTexture,index,color );};`}#dn(e){return e.resourceManager.createBindGroupLayout("POST_EFFECT_COPY_TO_STORAGE",{entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,sampler:{type:"filtering"}},{binding:1,visibility:GPUShaderStage.COMPUTE,texture:{}},{binding:2,visibility:GPUShaderStage.COMPUTE,storageTexture:{format:"rgba8unorm"}}]})}#Zr(e,t,r){return e.createTexture({size:{width:t,height:r},format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.STORAGE_BINDING})}#gn(e,t,r,n){return e.gpuDevice.createBindGroup({layout:t,entries:[{binding:0,resource:new Sampler(e).gpuSampler},{binding:1,resource:r},{binding:2,resource:n}]})}#fn(e,t,r){return e.createComputePipeline({layout:e.createPipelineLayout({bindGroupLayouts:[r]}),compute:{module:t,entryPoint:"main"}})}#pn(e,t,r,n,i){const s=e.createCommandEncoder(),a=s.beginComputePass();a.setPipeline(t),a.setBindGroup(0,r),a.dispatchWorkgroups(Math.ceil(n/this.#un),Math.ceil(i/this.#ln)),a.end(),e.queue.submit([s.finish()])}}Object.freeze(PostEffectManager);class RenderViewStateData{useDistanceCulling;cullingDistanceSquared;distanceCulling;num3DGroups;num3DObjects;numDrawCalls;numDirtyPipelines;numInstances;numTriangles;numPoints;viewRenderTime;viewportSize;usedVideoMemory;currentRenderPassEncoder;timestamp;frustumPlanes;prevVertexGpuBuffer;prevFragmentUniformBindGroup;dirtyVertexUniformFromMaterial={};alphaLayer=[];transparentLayer=[];particleLayer=[];instanceMeshLayer=[];startTime;isScene2DMode=!1;#Ir;constructor(e){this.#Ir=e}get view(){return this.#Ir}reset(e,t){if(!t||!this.#Ir)throw new Error("Invalid parameters provided");const r=this.#Ir,{useFrustumCulling:n,frustumPlanes:i}=r,{colorTexture:s,depthTexture:a}=r.viewRenderTextureManager;if(!s||!a)throw new Error("Invalid view properties");this.useDistanceCulling=r.useDistanceCulling,this.distanceCulling=r.distanceCulling,this.cullingDistanceSquared=this.distanceCulling*this.distanceCulling,this.num3DGroups=0,this.num3DObjects=0,this.numDrawCalls=0,this.numInstances=0,this.numDirtyPipelines=0,this.numTriangles=0,this.numPoints=0,this.viewRenderTime=0,this.currentRenderPassEncoder=e,this.timestamp=t,this.prevVertexGpuBuffer=null,this.prevFragmentUniformBindGroup=null,this.dirtyVertexUniformFromMaterial={},this.alphaLayer=[],this.transparentLayer=[],this.particleLayer=[],this.instanceMeshLayer=[],this.startTime=performance.now(),this.isScene2DMode=r.camera instanceof Camera2D,this.viewportSize={x:r.x,y:r.y,width:r.width,height:r.height,pixelRectArray:r.pixelRectArray};try{this.usedVideoMemory=calculateTextureByteSize({size:[s.width,s.height,s.depthOrArrayLayers],format:s.format,sampleCount:s.sampleCount,usage:s.usage})+calculateTextureByteSize({size:[a.width,a.height,a.depthOrArrayLayers],format:a.format,sampleCount:a.sampleCount,usage:a.usage})}catch(e){throw new Error("Could not calculate texture size:"+e.message)}this.frustumPlanes=n?i:null}}const tr=parseWGSL("#redgpu_include drawPicking;\r\n#redgpu_include calcTintBlendMode;\r\nstruct Uniforms {\rcolor:vec3<f32>,\r\ropacity:f32,\ruseTint:u32,\rtint:vec4<f32>,\rtintBlendMode:u32,\r\n};\r\n\r\nstruct InputData {\r\r@builtin(position) position:vec4<f32>,\r@location(12) combinedOpacity:f32,\r@location(15) pickingId:vec4<f32>,\r\n}\r\n\r\n@group(2) @binding(0) var<uniform> uniforms:Uniforms;\r\n@fragment\r\nfn main(inputData:InputData) -> @location(0) vec4<f32> {\rvar finalColor=vec4<f32>( uniforms.color.r,uniforms.color.g,uniforms.color.b,uniforms.opacity * inputData.combinedOpacity);\rif(uniforms.useTint==1u){\rfinalColor=calcTintBlendMode(finalColor,uniforms.tintBlendMode,uniforms.tint);\r}\rreturn finalColor;\r\n}\r\n\r\n\r\n");class ColorMaterial extends ABaseMaterial{constructor(e,t="#fff"){super(e,"COLOR_MATERIAL",tr,2),this.initGPURenderInfos(),this.color.setColorByHEX(t)}}rt.defineByPreset(ColorMaterial,[rt.PRESET_COLOR_RGB.COLOR]),Object.freeze(ColorMaterial);class GeometryGPURenderInfo{buffers;constructor(e){this.buffers=e}}Object.freeze(GeometryGPURenderInfo);const calculateVolume=e=>{const t=e.stride,r=e.data;let n=e.vertexCount,i=1/0,s=1/0,a=1/0,o=-1/0,u=-1/0,l=-1/0,c=0;for(;c<=n-4;c+=4){let e=c*t;const n=r[e],h=r[e+1],m=r[e+2];e=(c+1)*t;const d=r[e],p=r[e+1],f=r[e+2];e=(c+2)*t;const g=r[e],x=r[e+1],_=r[e+2];e=(c+3)*t;const v=r[e],y=r[e+1],T=r[e+2];i=Math.min(n,d,g,v,i),s=Math.min(h,p,x,y,s),a=Math.min(m,f,_,T,a),o=Math.max(n,d,g,v,o),u=Math.max(h,p,x,y,u),l=Math.max(m,f,_,T,l)}for(;c<n;c++){let e=c*t;const n=r[e],h=r[e+1],m=r[e+2];i=Math.min(n,i),s=Math.min(h,s),a=Math.min(m,a),o=Math.max(n,o),u=Math.max(h,u),l=Math.max(m,l)}const h=Math.max(Math.abs(i),Math.abs(o)),m=Math.max(Math.abs(s),Math.abs(u)),d=Math.max(Math.abs(a),Math.abs(l));return{volume:[o-i,u-s,l-a],minX:i,maxX:o,minY:s,maxY:u,minZ:a,maxZ:l,xSize:h,ySize:m,zSize:d,geometryRadius:Math.max(h,m,d)}};class Geometry extends ResourceBase{gpuRenderInfo;#xn;#_n;#vn;constructor(e,t,r){super(e),this.#yn(t),this.#Tn(r);const{interleavedStruct:n}=this.#xn;this.gpuRenderInfo=new GeometryGPURenderInfo([{arrayStride:n.arrayStride,attributes:n.attributes}])}get vertexBuffer(){return this.#xn}get indexBuffer(){return this.#_n}get volume(){return this.#vn||(this.#vn=calculateVolume(this.#xn)),this.#vn}#yn(e){const t=this.#xn;this.#xn=e,t&&t.__removeDirtyPipelineListener(this.#bn),e&&e.__addDirtyPipelineListener(this.#bn),this.#vn=null}#Tn(e){const t=this.#_n;this.#_n=e,t&&t.__removeDirtyPipelineListener(this.#Sn),e&&e.__addDirtyPipelineListener(this.#Sn)}#bn(){this.__fireListenerList()}#Sn(){this.__fireListenerList()}}Object.freeze(Geometry);class ResourceStateIndexBuffer{static dirtyList=[];buffer;label;uuid;#x=0;constructor(e){this.buffer=e,this.label=e.name,this.uuid=e.uuid}get useNum(){return this.#x}set useNum(e){this.#x=e,ResourceStateIndexBuffer.dirtyList.push(this)}}class IndexBuffer extends ABaseBuffer{#E;#Mn=0;#Rn=0;#P;constructor(e,t,r=GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST,n=""){super(e,"managedIndexBufferState",r);const i=getCacheBufferFromResourceState(this,n);if(i)return i;n&&(this.name=n),this.changeData(t),basicRegisterResource(this,new ResourceStateIndexBuffer(this))}get gpuBuffer(){return this.#P}get size(){return this.#E.byteLength||0}get triangleCount(){return this.#Rn}get indexNum(){return this.#Mn}destroy(){const e=this.#P;e&&(this.#P=null,this.__fireListenerList(!0),basicUnregisterResource(this),e&&e.destroy())}changeData(e){const{gpuDevice:t}=this;if(Array.isArray(e)&&(e=new Uint32Array(e)),this.#P){this.targetResourceManagedState.videoMemory-=this.#E.byteLength||0;let e=this.#P;requestAnimationFrame((()=>{e.destroy()})),this.#P=null}this.#E=e,this.#Mn=e.length,this.targetResourceManagedState.videoMemory+=this.#E.byteLength;const r={size:this.#E.byteLength,usage:this.usage,label:this.name};this.#P=t.createBuffer(r),this.#Rn=this.#Mn/3,t.queue.writeBuffer(this.#P,0,this.#E)}updatePartialData(e,t){const{gpuDevice:r}=this;(e<0||e>=this.#E.length)&&consoleAndThrowError(`Offset value is out of data bounds. Tried to access index ${e} on data of length ${this.#E.length}`),Array.isArray(t)&&(t=new Uint32Array(t)),this.#Mn=t.length,r.queue.writeBuffer(this.#P,e,t)}}Object.freeze(IndexBuffer);class ResourceStateVertexBuffer{static dirtyList=[];buffer;label;uuid;#x=0;constructor(e){this.buffer=e,this.label=e.name,this.uuid=e.uuid}get useNum(){return this.#x}set useNum(e){this.#x=e,ResourceStateVertexBuffer.dirtyList.push(this)}}class VertexBuffer extends ABaseBuffer{#wn=0;#En=0;#Pn;#E;#Rn=0;#P;constructor(e,t,r,n=GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST,i=""){super(e,"managedVertexBufferState",n);const s=getCacheBufferFromResourceState(this,i);if(s)return s;this.#Pn=r,i&&(this.name=i),this.changeData(t,this.#Pn),basicRegisterResource(this,new ResourceStateVertexBuffer(this))}get gpuBuffer(){return this.#P}get stride(){return this.#En}get data(){return this.#E}get size(){return this.#E.byteLength||0}get interleavedStruct(){return this.#Pn}get vertexCount(){return this.#wn}get triangleCount(){return this.#Rn}destroy(){const e=this.#P;e&&(this.#P=null,this.__fireListenerList(!0),basicUnregisterResource(this),e&&e.destroy())}updateAllData(e){const{gpuDevice:t}=this;t.queue.writeBuffer(this.#P,0,this.#E)}changeData(e,t){const{gpuDevice:r}=this;if(Array.isArray(e)&&(e=new Float32Array(e)),this.#E=e,t&&this.#Cn(t),this.#P){this.targetResourceManagedState.videoMemory-=this.#E.byteLength||0;let e=this.#P;requestAnimationFrame((()=>{e.destroy()})),this.#P=null}this.targetResourceManagedState.videoMemory+=this.#E.byteLength;const n={size:this.#E.byteLength,usage:this.usage,label:this.name};this.#P=r.createBuffer(n),this.#Rn=this.#E.length/this.#En,r.queue.writeBuffer(this.#P,0,this.#E)}#Cn(e){this.#Pn=e,this.#wn=0,this.#En=0;for(const e in this.#Pn.define){const t=this.#Pn.define[e].attributeStride/Float32Array.BYTES_PER_ELEMENT;this.#wn+=t,this.#En+=t}this.#wn=this.#E.length/this.#wn}}Object.freeze(VertexBuffer);class InterleaveType{static get float32(){return{numElements:1,stride:Float32Array.BYTES_PER_ELEMENT,gpuVertexFormat:"float32",offset:0}}static get float32x2(){return{numElements:2,stride:2*Float32Array.BYTES_PER_ELEMENT,gpuVertexFormat:"float32x2",offset:0}}static get float32x3(){return{numElements:3,stride:3*Float32Array.BYTES_PER_ELEMENT,gpuVertexFormat:"float32x3",offset:0}}static get float32x4(){return{numElements:4,stride:4*Float32Array.BYTES_PER_ELEMENT,gpuVertexFormat:"float32x4",offset:0}}}Object.freeze(InterleaveType);class InterleavedStructElement{attributeName;attributeStride;interleaveType;constructor(e,t,r){this.attributeName=e,this.attributeStride=t,this.interleaveType=r}}class InterleavedStruct{#kn;#s="";#In=[];#Un=0;constructor(e,t=""){this.#s=t,this.#Bn(e),this.#Ln()}get label(){return this.#s}get attributes(){return this.#In}get arrayStride(){return this.#Un}get define(){return{...this.#kn}}#Bn(e){let t={};for(const r in e){const n=e[r],i=n.stride;t[r]=new InterleavedStructElement(r,i,n),i%4!=0&&consoleAndThrowError(`Invalid attribute stride:${i}`)}this.#kn=t}#Ln(){this.#Un=0,this.#In=[];for(const[e,{attributeStride:t,interleaveType:r}]of Object.entries(this.#kn))this.#In.push({attributeName:e,shaderLocation:this.#In.length,offset:this.#Un,format:r.gpuVertexFormat}),this.#Un+=t}}class Primitive{#An;#xn;#_n;#vn;constructor(e){validateRedGPUContext(e)}static get primitiveInterleaveStruct(){return new InterleavedStruct({vertexPosition:InterleaveType.float32x3,vertexNormal:InterleaveType.float32x3,texcoord:InterleaveType.float32x2},"primitiveInterleaveStruct")}get gpuRenderInfo(){return this.#An}get vertexBuffer(){return this.#xn}get indexBuffer(){return this.#_n}get volume(){return this.#vn||(this.#vn=calculateVolume(this.#xn)),this.#vn}_setData(e){if(this.#xn=e.vertexBuffer,this.#_n=e.indexBuffer,this.#xn){const{interleavedStruct:e}=this.#xn;this.#An=new GeometryGPURenderInfo([{arrayStride:e.arrayStride,attributes:e.attributes}])}}}Object.freeze(Primitive);const createPrimitiveGeometry=(e,t,r,n)=>new Geometry(e,new VertexBuffer(e,new Float32Array(t),Primitive.primitiveInterleaveStruct,void 0,`VertexBuffer_${n}`),new IndexBuffer(e,new Uint32Array(r),void 0,`IndexBuffer_${n}`));class Box extends Primitive{#Dn=function(){let e,t;return t=function(t,r,n,i,s,a,o,u,l,c,h,m,d){let p,f,g=u/h,x=l/m,_=u/2,v=l/2,y=c/2,T=h+1,b=m+1,S=0,M=[];for(f=0;f<b;f++){let e=f*x-v;for(p=0;p<T;p++){let r=p*g-_;M[n]=r*a,M[i]=e*o,M[s]=y,t.push(M.x,M.y,M.z),M[n]=0,M[i]=0,M[s]=c>0?1:-1,t.push(M.x,M.y,M.z),t.push(p/h*d,f/m*d),S+=1}}for(f=0;f<m;f++)for(p=0;p<h;p++){let t=e+p+T*f,n=e+p+T*(f+1),i=e+(p+1)+T*(f+1),s=e+(p+1)+T*f;r.push(t,n,s,n,i,s)}e+=S},function(r,n,i,s,a,o,u,l,c){let h=[],m=[];return e=0,t(h,m,"z","y","x",-1,-1,a,s,i,l,u,c),t(h,m,"z","y","x",1,-1,a,s,-i,l,u,c),t(h,m,"x","z","y",1,1,i,a,s,o,l,c),t(h,m,"x","z","y",1,-1,i,a,-s,o,l,c),t(h,m,"x","y","z",1,-1,i,s,a,o,u,c),t(h,m,"x","y","z",-1,-1,i,s,-a,o,u,c),createPrimitiveGeometry(n,h,m,r)}}();constructor(e,t=1,r=1,n=1,i=1,s=1,a=1,o=1){super(e);const u=`PRIMITIVE_BOX_W${t}_H${r}_D${n}_WS${i}_HS${s}_DS${a}_UV${o}`,l=e.resourceManager.cachedBufferState;let c=l[u];c||(c=l[u]=this.#Dn(u,e,t,r,n,i,s,a,o)),this._setData(c)}}class Cylinder extends Primitive{#Dn=function(){let e,t;return function(r,n,i,s,a,o,u,l,c,h){const m=[],d=[];let p=0;const f=[],g=a/2;return e=function(){let e,t;const r=[],n=[],l=(s-i)/a;for(t=0;t<=u;t++){const d=[],x=t/u,_=x*(s-i)+i;for(e=0;e<=o;e++){const t=e/o,i=t*h+c,s=Math.sin(i),u=Math.cos(i);n[0]=_*s,n[1]=-x*a+g,n[2]=_*u,m.push(n[0],n[1],n[2]),r[0]=s,r[1]=l,r[2]=u,normalize$4(r,r),m.push(r[0],r[1],r[2]),m.push(t,x),d.push(p++)}f.push(d)}for(e=0;e<o;e++)for(t=0;t<u;t++){const r=f[t][e],n=f[t+1][e],i=f[t+1][e+1],s=f[t][e+1];d.push(r,n,s),d.push(n,i,s)}},t=function(e){let t,r,n;const a=[],u=[],l=!0===e?i:s,f=!0===e?1:-1;for(r=p,t=1;t<=o;t++)m.push(0,g*f,0),m.push(0,f,0),m.push(.5,.5),p++;for(n=p,t=0;t<=o;t++){const e=t/o*h+c,r=Math.cos(e),n=Math.sin(e);u[0]=l*n,u[1]=g*f,u[2]=l*r,m.push(u[0],u[1],u[2]),m.push(0,f,0),a[0]=.5*r+.5,a[1]=.5*n*f+.5,m.push(a[0],1-a[1]),p++}for(t=0;t<o;t++){const i=r+t,s=n+t;!0===e?d.push(s,s+1,i):d.push(s+1,s,i)}},e(),!1===l&&(i>0&&t(!0),s>0&&t(!1)),createPrimitiveGeometry(n,m,d,r)}}();constructor(e,t=1,r=1,n=1,i=8,s=8,a=!1,o=0,u=2*Math.PI){super(e);const l=`PRIMITIVE_CYLINDER_RT${t}_RB${r}_H${n}_RS${i}_HS${s}_TS${a}_TS${o}_TL${u}`,c=e.resourceManager.cachedBufferState;let h=c[l];h||(h=c[l]=this.#Dn(l,e,t,r,n,i,s,a,o,u)),this._setData(h)}}class Sphere extends Primitive{#Dn=function(){let e,t,r,n,i,s,a,o,u=[],l=new Float32Array([0,0,0]),c=new Float32Array([0,0,0]);return function(h,m,d,p,f,g,x,_,v,y){e=_+v,n=0,u.length=0,l[0]=0,l[1]=0,l[2]=0,c[0]=0,c[1]=0,c[2]=0;let T=[],b=[];for(r=0;r<=f;r++){let e=[],i=r/f;for(t=0;t<=p;t++){let r=t/p;l.x=-d*Math.cos(g+r*x)*Math.sin(_+i*v),l.y=d*Math.cos(_+i*v),l.z=d*Math.sin(g+r*x)*Math.sin(_+i*v),T.push(l.x,l.y,l.z),c[0]=l.x,c[1]=l.y,c[2]=l.z,normalize$4(c,c),T.push(c[0],c[1],c[2]),T.push(r*y,i*y),e.push(n++)}u.push(e)}for(r=0;r<f;r++)for(t=0;t<p;t++)i=u[r][t+1],s=u[r][t],a=u[r+1][t],o=u[r+1][t+1],(0!==r||_>0)&&b.push(i,s,o),(r!==f-1||e<Math.PI)&&b.push(s,a,o);return createPrimitiveGeometry(m,T,b,h)}}();constructor(e,t=1,r=16,n=16,i=0,s=2*Math.PI,a=0,o=Math.PI,u=1){super(e);const l=`PRIMITIVE_SPHERE_R${t}_WS${r}_HS${n}_PS${i}_PL${s}_TS${a}_TL${o}_UV${u}`,c=e.resourceManager.cachedBufferState;let h=c[l];h||(h=c[l]=this.#Dn(l,e,t,r,n,i,s,a,o,u)),this._setData(h)}}class Axis extends Mesh{constructor(e){super(e,null,null);const t=new Mesh(e,new Sphere(e,.5),new ColorMaterial(e));this.addChild(t);const r=new Box(e);this.addChild(this.#On(r,"#ff0000",[5,.1,.1],[2.5,0,0])),this.addChild(this.#Gn(e,"#ff0000",[.5,1.25],[5.5,0,0],[0,0,-90])),this.addChild(this.#On(r,"#00ff00",[.1,5,.1],[0,2.5,0])),this.addChild(this.#Gn(e,"#00ff00",[.5,1.25],[0,5.5,0],[180,0,0])),this.addChild(this.#On(r,"#0000ff",[.1,.1,5],[0,0,2.5])),this.addChild(this.#Gn(e,"#0000ff",[.5,1.25],[0,0,5.5],[90,0,0]))}#On(e,t,r,n){const{redGPUContext:i}=this,s=new Mesh(i,e,new ColorMaterial(i,t));return s.setScale(...r),s.setPosition(...n),s}#Gn(e,t,r,n,i){const s=new Mesh(e,new Cylinder(e,r[0],.001,r[1],32,1),new ColorMaterial(e,t));return s.setScale(r[0],r[1],r[0]),s.setPosition(...n),s.setRotation(...i),s}}const rr=parseWGSL("#redgpu_include SYSTEM_UNIFORM;\r\n#redgpu_include calcTintBlendMode;\r\n#redgpu_include drawPicking;\r\n\r\nstruct Uniforms {\ruseDiffuseTexture:u32,\r\ropacity:f32,\ruseTint:u32,\rtint:vec4<f32>,\rtintBlendMode:u32,\r\n};\r\n\r\n@group(2) @binding(0) var<uniform> uniforms:Uniforms;\r\n@group(2) @binding(1) var diffuseTextureSampler:sampler;\r\n@group(2) @binding(2) var diffuseTexture:texture_2d<f32>;\r\n\r\nstruct InputData {\r@builtin(position) position:vec4<f32>,\r@location(0) vertexPosition:vec3<f32>,\r@location(1) vertexNormal:vec3<f32>,\r@location(2) uv:vec2<f32>,\r@location(12) combinedOpacity:f32,\r@location(13) shadowPos:vec3<f32>,\r@location(15) pickingId:vec4<f32>,\r\n};\r\n\r\n@fragment\r\nfn main(inputData:InputData) -> @location(0) vec4<f32> {\r\rvar finalColor:vec4<f32>=textureSample(diffuseTexture,diffuseTextureSampler,inputData.uv);\rfinalColor=vec4<f32>(finalColor.rgb,finalColor.a * uniforms.opacity * inputData.combinedOpacity);\r\n\rif(uniforms.useTint==1u){\rfinalColor=calcTintBlendMode(finalColor,uniforms.tintBlendMode,uniforms.tint);\r}\r\n\r\rif (systemUniforms.isView3D==1 && finalColor.a==0.0) {\rdiscard;\r}\r\n\rreturn finalColor;\r\n};\r\n");class BitmapMaterial extends ABitmapBaseMaterial{dirtyPipeline=!1;constructor(e,t,r){super(e,"BITMAP_MATERIAL",rr,2),r&&(this.name=r),this.diffuseTexture=t,this.diffuseTextureSampler=new Sampler(this.redGPUContext),this.initGPURenderInfos()}}rt.defineByPreset(BitmapMaterial,[rt.PRESET_TEXTURE.DIFFUSE_TEXTURE,rt.PRESET_SAMPLER.DIFFUSE_TEXTURE_SAMPLER]),Object.freeze(BitmapMaterial);const nr={NORMAL:0,MULTIPLY:1,LIGHTEN:2,SCREEN:3,LINEAR_DODGE:4,SUBTRACT:5,DIFFERENCE:6,EXCLUSION:7};const ir=parseWGSL("#redgpu_include SYSTEM_UNIFORM;\r\n#redgpu_include calcTintBlendMode;\r\n#redgpu_include calcDirectionalShadowVisibility;\r\n#redgpu_include normalFunctions;\r\n#redgpu_include drawPicking;\r\nstruct Uniforms {\ruseDiffuseTexture:u32,\rcolor:vec3<f32>,\r\remissiveColor:vec3<f32>,\remissiveStrength:f32,\ruseEmissiveTexture:u32,\r\rspecularColor:vec3<f32>,\rspecularStrength:f32,\ruseSpecularTexture:u32,\rshininess:f32,\r\ruseAoTexture:u32,\raoStrength:f32,\r\ruseAlphaTexture:u32,\r\ruseNormalTexture:u32,\rnormalScale:f32,\r\ropacity:f32,\ruseTint:u32,\rtint:vec4<f32>,\rtintBlendMode:u32,\r\r\n};\r\n\r\nstruct InputData {\r\r@builtin(position) position:vec4<f32>,\r\n\r\r@location(0) vertexPosition:vec3<f32>,\r@location(1) vertexNormal:vec3<f32>,\r@location(2) uv:vec2<f32>,\r@location(12) combinedOpacity:f32,\r@location(13) shadowPos:vec3<f32>,\r@location(14) receiveShadow:f32,\r@location(15) pickingId:vec4<f32>,\r\n}\r\n\r\n@group(2) @binding(0) var<uniform> uniforms:Uniforms;\r\n@group(2) @binding(1) var diffuseTextureSampler:sampler;\r\n@group(2) @binding(2) var diffuseTexture:texture_2d<f32>;\r\n@group(2) @binding(3) var alphaTextureSampler:sampler;\r\n@group(2) @binding(4) var alphaTexture:texture_2d<f32>;\r\n@group(2) @binding(5) var specularTextureSampler:sampler;\r\n@group(2) @binding(6) var specularTexture:texture_2d<f32>;\r\n@group(2) @binding(7) var emissiveTextureSampler:sampler;\r\n@group(2) @binding(8) var emissiveTexture:texture_2d<f32>;\r\n@group(2) @binding(9) var aoTextureSampler:sampler;\r\n@group(2) @binding(10) var aoTexture:texture_2d<f32>;\r\n@group(2) @binding(11) var normalTextureSampler:sampler;\r\n@group(2) @binding(12) var normalTexture:texture_2d<f32>;\r\n\r\n\r\n@fragment\r\nfn main(inputData:InputData) -> @location(0) vec4<f32> {\r\n\r\rlet u_ambientLight=systemUniforms.ambientLight;\rlet u_ambientLightColor=u_ambientLight.color;\rlet u_ambientLightIntensity=u_ambientLight.intensity;\r\n\r\rlet u_directionalLightCount=systemUniforms.directionalLightCount;\rlet u_directionalLights=systemUniforms.directionalLights;\rlet u_directionalLightShadowDepthTextureSize=systemUniforms.directionalLightShadowDepthTextureSize;\rlet u_directionalLightShadowBias=systemUniforms.directionalLightShadowBias;\r\n\r\n\r\rlet u_camera=systemUniforms.camera;\rlet u_cameraMatrix=u_camera.cameraMatrix;\rlet u_cameraPosition=u_camera.cameraPosition;\r\n\r\n\r\rlet u_color=uniforms.color;\rlet u_aoStrength=uniforms.aoStrength;\rlet u_emissiveColor=uniforms.emissiveColor;\rlet u_emissiveStrength=uniforms.emissiveStrength;\rlet u_normalScale=uniforms.normalScale;\rlet u_specularColor=uniforms.specularColor;\rlet u_specularStrength=uniforms.specularStrength;\rlet u_shininess=uniforms.shininess;\rlet u_opacity=uniforms.opacity;\rlet E=normalize(u_cameraPosition);\r\rlet u_useDiffuseTexture=uniforms.useDiffuseTexture==1;\rlet u_useAlphaTexture=uniforms.useAlphaTexture==1;\rlet u_useSpecularTexture=uniforms.useSpecularTexture==1;\rlet u_useEmissiveTexture=uniforms.useEmissiveTexture==1;\rlet u_useAoTexture=uniforms.useAoTexture==1;\rlet u_useNormalTexture=uniforms.useNormalTexture==1;\r\rlet receiveShadowYn=inputData.receiveShadow !=.0;\r\n\r\n\r\r\n\r\rvar N=normalize(inputData.vertexNormal);\rif(u_useNormalTexture){\rlet normalSamplerColor=textureSample(normalTexture,normalTextureSampler,inputData.uv).rgb;\rN=perturb_normal( N,inputData.vertexPosition,inputData.uv,normalSamplerColor,u_normalScale );\r}else{\rN=N * u_normalScale;\r}\r\rvar finalColor:vec4<f32>;\rvar resultAlpha:f32=u_opacity * inputData.combinedOpacity;\rvar diffuseColor:vec3<f32>=u_color;\rif(u_useDiffuseTexture){\rlet diffuseSampleColor=textureSample(diffuseTexture,diffuseTextureSampler,inputData.uv);\rdiffuseColor=diffuseSampleColor.rgb;\rresultAlpha=resultAlpha * diffuseSampleColor.a;\r}\r\n\rvar specularSamplerValue:f32=1;\rif(u_useSpecularTexture){\rspecularSamplerValue=textureSample(specularTexture,specularTextureSampler,inputData.uv).r;\r}\rvar mixColor:vec3<f32>;\r\n\rvar visibility:f32=1.0;\rvisibility=calcDirectionalShadowVisibility(\rdirectionalShadowMap,\rdirectionalShadowMapSampler,\ru_directionalLightShadowDepthTextureSize,\ru_directionalLightShadowBias,\rinputData.shadowPos\r);\r\n\rif(!receiveShadowYn){\rvisibility=1.0;\r}\r\n\rfor (var i=0u;i < u_directionalLightCount;i=i + 1) {\rlet u_directionalLightDirection=u_directionalLights[i].direction;\rlet u_directionalLightColor=u_directionalLights[i].color;\rlet u_directionalLightIntensity=u_directionalLights[i].intensity * visibility;\r\n\rlet L=normalize(u_directionalLightDirection);\rlet R=reflect(L,N);\rlet lambertTerm=max(dot(N,-L),0.0);\rlet specular=pow(max(dot(R,E),0.0),u_shininess) * specularSamplerValue;\rlet la=u_ambientLightColor * u_ambientLightIntensity * visibility;\rlet ld=diffuseColor * (u_directionalLightColor * u_directionalLightIntensity) * lambertTerm;\rlet ls=u_specularColor * u_specularStrength * (u_directionalLightColor * u_directionalLightIntensity) * specular;\rmixColor +=la + ld + ls;\r}\r\n\r\rlet clusterIndex=getPointLightClusterIndex(inputData.position);\rlet lightOffset =pointLight_clusterLightGroup.lights[clusterIndex].offset;\rlet lightCount:u32 =pointLight_clusterLightGroup.lights[clusterIndex].count;\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\rfor (var lightIndex=0u;lightIndex < lightCount;lightIndex=lightIndex + 1u) {\rlet i=pointLight_clusterLightGroup.indices[lightOffset + lightIndex];\rlet u_pointLightPosition=pointLightList.lights[i].position;\rlet u_pointLightColor=pointLightList.lights[i].color;\rlet u_pointLightIntensity=pointLightList.lights[i].intensity;\rlet u_pointLightRadius=pointLightList.lights[i].radius;\r\n\rlet lightDir=normalize(u_pointLightPosition - inputData.vertexPosition);\rlet lightDistance=length(u_pointLightPosition - inputData.vertexPosition);\rlet attenuation=clamp(0.0,1.0,1.0 - (lightDistance * lightDistance)/(u_pointLightRadius * u_pointLightRadius));\rif(lightDistance<=u_pointLightRadius){\r\n\rlet L=normalize(lightDir);\rlet R=reflect(-L,N);\r\n\rlet diffuse=max(dot(N,L),0.0);\rlet specular=pow(max(dot(R,E),0.0),u_shininess);\r\n\rlet ld=(u_pointLightColor * u_pointLightIntensity) * diffuse * attenuation * u_pointLightIntensity;\rlet ls=u_specularColor * u_specularStrength * specular * attenuation * u_pointLightIntensity;\r\n\rmixColor +=ld + ls;\r}\r}\r\n\r\n\rif(u_useAlphaTexture){\rlet alphaMapValue:f32=textureSample(alphaTexture,alphaTextureSampler,inputData.uv).r;\rresultAlpha=alphaMapValue * resultAlpha;\rif(resultAlpha==0){\rdiscard;\r}\r}\rvar emissiveColor=u_emissiveColor * u_emissiveStrength;\rif(u_useEmissiveTexture){\remissiveColor=textureSample(emissiveTexture,emissiveTextureSampler,inputData.uv).rgb * u_emissiveStrength;\r}\rif(u_useAoTexture){\rmixColor=mixColor * textureSample(aoTexture,aoTextureSampler,inputData.uv).rgb * u_aoStrength;\r}\rfinalColor=vec4<f32>(mixColor + emissiveColor,resultAlpha);\rif(uniforms.useTint==1u){\rfinalColor=calcTintBlendMode(finalColor,uniforms.tintBlendMode,uniforms.tint);\r}\r\rif (systemUniforms.isView3D==1 && finalColor.a==0.0) {\rdiscard;\r}\rreturn finalColor;\r\n}\r\n");class PhongMaterial extends ABitmapBaseMaterial{#Nn;#Vn=1;constructor(e,t="#fff",r){super(e,"PHONG_MATERIAL",ir,2),r&&(this.name=r),this.initGPURenderInfos(),this.color.setColorByHEX(t),this.emissiveColor.setColorByHEX(this.emissiveColor.hex),this.specularColor.setColorByHEX(this.specularColor.hex)}get displacementScale(){return this.#Vn}set displacementScale(e){this.#Vn=e}get displacementTexture(){return this.#Nn}set displacementTexture(e){const t=this.#Nn;this.#Nn=e,this.updateTexture(t,e),this.dirtyPipeline=!0}}rt.defineByPreset(PhongMaterial,[rt.PRESET_COLOR_RGB.COLOR,rt.PRESET_TEXTURE.ALPHA_TEXTURE,rt.PRESET_SAMPLER.ALPHA_TEXTURE_SAMPLER,rt.PRESET_TEXTURE.AO_TEXTURE,rt.PRESET_SAMPLER.AO_TEXTURE_SAMPLER,rt.PRESET_POSITIVE_NUMBER.AO_STRENGTH,rt.PRESET_TEXTURE.DIFFUSE_TEXTURE,rt.PRESET_SAMPLER.DIFFUSE_TEXTURE_SAMPLER,rt.PRESET_TEXTURE.EMISSIVE_TEXTURE,rt.PRESET_SAMPLER.EMISSIVE_TEXTURE_SAMPLER,rt.PRESET_POSITIVE_NUMBER.EMISSIVE_STRENGTH,[rt.PRESET_COLOR_RGB.EMISSIVE_COLOR,"#000000"],rt.PRESET_TEXTURE.NORMAL_TEXTURE,rt.PRESET_SAMPLER.NORMAL_TEXTURE_SAMPLER,rt.PRESET_POSITIVE_NUMBER.NORMAL_SCALE,rt.PRESET_TEXTURE.SPECULAR_TEXTURE,rt.PRESET_SAMPLER.SPECULAR_TEXTURE_SAMPLER,rt.PRESET_POSITIVE_NUMBER.SPECULAR_STRENGTH,[rt.PRESET_COLOR_RGB.SPECULAR_COLOR,"#ffffff"],[rt.PRESET_POSITIVE_NUMBER.SHININESS,32]]),Object.freeze(PhongMaterial);var sr=Object.freeze({__proto__:null,ABaseMaterial:ABaseMaterial,ABitmapBaseMaterial:ABitmapBaseMaterial,BLEND_MODE:nr,BitmapMaterial:BitmapMaterial,COMPOSITE_MODE:{ADDITIVE:"additive",SOURCE_OVER:"source-over",SOURCE_IN:"source-in",SOURCE_OUT:"source-out",SOURCE_ATOP:"source-atop",DESTINATION_OVER:"destination-over",DESTINATION_IN:"destination-in",DESTINATION_OUT:"destination-out",DESTINATION_ATOP:"destination-atop"},ColorMaterial:ColorMaterial,PhongMaterial:PhongMaterial,TINT_BLEND_MODE:dt,getComputeBindGroupLayoutDescriptorFromShaderInfo:getComputeBindGroupLayoutDescriptorFromShaderInfo,getFragmentBindGroupLayoutDescriptorFromShaderInfo:getFragmentBindGroupLayoutDescriptorFromShaderInfo,getVertexBindGroupLayoutDescriptorFromShaderInfo:getVertexBindGroupLayoutDescriptorFromShaderInfo}),ar="#redgpu_include SYSTEM_UNIFORM;\r\nstruct VertexIn {\r@location(0) pos:vec4<f32>,\r@location(1) uv:vec2<f32>,\r\n}\r\n\r\nstruct VertexOut {\r@builtin(position) pos:vec4<f32>,\r@location(0) uv:vec2<f32>,\r\n}\r\n\r\n\r\n@vertex\r\nfn vertexMain(in:VertexIn) -> VertexOut {\rvar out:VertexOut;\r\rlet u_projectionMatrix=systemUniforms.projectionMatrix;\rlet u_camera=systemUniforms.camera;\rlet u_cameraMatrix=u_camera.cameraMatrix;\r\rout.pos=u_projectionMatrix * u_cameraMatrix * in.pos;\rout.uv=in.uv;\rreturn out;\r\n}\r\n\r\nfn PristineGrid(uv:vec2<f32>,lineWidth:vec2<f32>) -> f32 {\rlet uvDDXY=vec4<f32>(dpdx(uv),dpdy(uv));\rlet uvDeriv=vec2<f32>(length(uvDDXY.xz),length(uvDDXY.yw));\rlet invertLine:vec2<bool>=lineWidth > vec2f(0.5);\rlet targetWidth:vec2<f32>=select(lineWidth,1 - lineWidth,invertLine);\rlet drawWidth:vec2<f32>=clamp(targetWidth,uvDeriv,vec2f(0.5));\rlet lineAA:vec2<f32>=uvDeriv * 1.5;\rvar gridUV:vec2<f32>=abs(fract(uv) * 2.0 - 1.0);\rgridUV=select(1 - gridUV,gridUV,invertLine);\rvar grid2:vec2<f32>=smoothstep(drawWidth + lineAA,drawWidth - lineAA,gridUV);\rgrid2 *=saturate(targetWidth/drawWidth);\rgrid2=mix(grid2,targetWidth,saturate(uvDeriv * 2.0 - 1.0));\rgrid2=select(grid2,1.0 - grid2,invertLine);\rreturn mix(grid2.x,1.0,grid2.y);\r\n}\r\n\r\n\r\nstruct GridArgs {\rlineColor:vec4<f32>,\rbaseColor:vec4<f32>,\rlineWidth:vec2<f32>,\rsize:f32,\rdistance:f32,\r\n}\r\n@group(1) @binding(0) var<uniform> gridArgs:GridArgs;\r\n\r\n@fragment\r\nfn fragmentMain(in:VertexOut) -> @location(0) vec4<f32> {\rvar lineWidthWeight:f32=1;\rvar color:vec4<f32>=gridArgs.lineColor;\rlet DIVISION_SIZE:f32=gridArgs.size;\rlet ASIX_SIZE:f32=max(DIVISION_SIZE * gridArgs.lineWidth.x,DIVISION_SIZE/20);\r\n\rlet HALF_DIVISION_SIZE:f32=DIVISION_SIZE * 0.5;\rlet PER_SIZE:f32=1/DIVISION_SIZE * ASIX_SIZE;\rlet MIN_RANGE=HALF_DIVISION_SIZE - PER_SIZE;\rlet MAX_RANGE=HALF_DIVISION_SIZE + PER_SIZE;\rif( MIN_RANGE <=in.uv.x && in.uv.x <=MAX_RANGE) {\rcolor=vec4<f32>(0,0,1,1);\rlineWidthWeight=ASIX_SIZE;\r}else if( MIN_RANGE <=in.uv.y && in.uv.y <=MAX_RANGE) {\rcolor=vec4<f32>(1,0,0,1);\rlineWidthWeight=ASIX_SIZE;\r}\rvar grid=PristineGrid(in.uv,gridArgs.lineWidth * lineWidthWeight);\r\n\r\n\rreturn mix(gridArgs.baseColor,color,grid * gridArgs.lineColor.a);\r\n;\r\n}\r\n";const or=parseWGSL(ar),ur=or.uniforms.gridArgs;class Grid{#xn;#_n;#Fn;#zn;#$n;#Hn;#Ze;#qe;#Kn;#w=100;#e;#s;#Xn=1;constructor(e){validateRedGPUContext(e),this.#e=InstanceIdGenerator.getNextId(this.constructor);const{resourceManager:t,gpuDevice:r}=e,n={code:ar},i=t.createGPUShaderModule("VERTEX_MODULE_GRID",n);this.#Ze=new BlendState(this,lt.ONE,lt.ONE_MINUS_SRC_ALPHA,ct.ADD),this.#qe=new BlendState(this,lt.SRC_ALPHA,lt.ONE_MINUS_SRC_ALPHA,ct.ADD),this.#Kn=new ColorRGBA(128,128,128,1);const s=t.getGPUBindGroupLayout(ResourceManager.PRESET_GPUBindGroupLayout_System),a=e.resourceManager.getGPUBindGroupLayout("GRID_MATERIAL_BIND_GROUP_LAYOUT")||e.resourceManager.createBindGroupLayout("GRID_MATERIAL_BIND_GROUP_LAYOUT",getFragmentBindGroupLayoutDescriptorFromShaderInfo(or,1));this.#jn(e),this.#zn=r.createBindGroup({label:"FRAGMENT_BIND_GROUP_DESCRIPTOR_GRID",layout:a,entries:[{binding:0,resource:{buffer:this.#Fn.gpuBuffer,offset:0,size:this.#Fn.size}}]});const o={label:"PIPELINE_DESCRIPTOR_GRID",layout:r.createPipelineLayout({bindGroupLayouts:[s,a]}),vertex:{module:i,entryPoint:"vertexMain",buffers:[{arrayStride:this.#xn.interleavedStruct.arrayStride,attributes:this.#xn.interleavedStruct.attributes}]},fragment:{module:i,entryPoint:"fragmentMain",targets:[{format:navigator.gpu.getPreferredCanvasFormat(),blend:{color:this.#Ze.state,alpha:this.#qe.state}}]},depthStencil:{format:"depth24plus",depthWriteEnabled:!1,depthCompare:bt.LESS_EQUAL}};this.#$n=r.createRenderPipeline(o),this.#Hn=r.createRenderPipeline({...o,multisample:{count:4}})}get name(){return this.#e||(this.#e=InstanceIdGenerator.getNextId(this.constructor)),this.#s||`${this.constructor.name} Instance ${this.#e}`}set name(e){this.#s=e}get size(){return this.#w}set size(e){this.#w=e}get lineColor(){return this.#Kn}get lineWidth(){return this.#Xn}set lineWidth(e){validatePositiveNumberRange(e),this.#Xn=e}render(e){const{view:t,currentRenderPassEncoder:r}=e,n=create$4();set$4(n,t.rawCamera.x,t.rawCamera.y,t.rawCamera.z);const i=distance$2(n,[0,0,0]),s=this.#w;e.num3DObjects++,e.numDrawCalls++;const a=1/t.pixelRectObject.width*i*this.#Xn;this.#Fn.writeBuffers([[ur.members.lineColor,this.#Kn.rgbaNormal],[ur.members.lineWidth,[a,a]],[ur.members.size,s],[ur.members.distance,i]]);const o=[-s/2,-0,-s/2,0,0,s/2,-0,-s/2,s,0,-s/2,-0,s/2,0,s,s/2,-0,s/2,s,s];if(this.#xn.changeData(o),this.#$n){const{triangleCount:n,indexNum:i}=this.#_n;r.setPipeline(t.redGPUContext.useMSAA?this.#Hn:this.#$n),r.setBindGroup(1,this.#zn),r.setVertexBuffer(0,this.#xn.gpuBuffer),r.setIndexBuffer(this.#_n.gpuBuffer,"uint32"),r.drawIndexed(6),e.numTriangles+=n,e.numPoints+=i}}#jn(e){const t=this.#w,{resourceManager:r}=e,{cachedBufferState:n}=r;{const r="VertexBuffer_Grid",i=n[r],s=[-t,-0,-t,0,0,t,-0,-t,t,0,-t,-0,t,0,t,t,-0,t,t,t];n[r]=this.#xn=i||new VertexBuffer(e,s,new InterleavedStruct({position:InterleaveType.float32x3,uv:InterleaveType.float32x2}),void 0,r)}{const t="IndexBuffer_Grid",r=n[t],i=[0,1,2,1,2,3];n[t]=this.#_n=r||new IndexBuffer(e,i,void 0,t)}{const t="UniformBuffer_Grid",r=n[t],i=new ArrayBuffer(ur.arrayBufferByteLength);n[t]=this.#Fn=r||new UniformBuffer(e,i)}}}class BaseLight{#Yn;#Zn;constructor(e,t=1){this.#Yn=e,this.#Zn=t}get color(){return this.#Yn}set color(e){this.#Yn=e}get intensity(){return this.#Zn}set intensity(e){this.#Zn=e}}Object.freeze(BaseLight);class AmbientLight extends BaseLight{constructor(e=new ColorRGB(7,7,7),t=.2){super(e,t)}}Object.freeze(AmbientLight);class DirectionalLight extends BaseLight{#qn;constructor(e=[-1,-1,-1],t="#fff",r=1){super(new ColorRGB(...convertHexToRgb(t,!0)),r),this.#qn=e}get direction(){return this.#qn}set direction(e){this.#qn=e}}Object.freeze(DirectionalLight);class PointLight extends BaseLight{#Wn=1;#r=0;#n=0;#i=0;constructor(e="#fff",t=1){super(new ColorRGB(...convertHexToRgb(e,!0)),t)}get x(){return this.#r}set x(e){this.#r=e}get y(){return this.#n}set y(e){this.#n=e}get z(){return this.#i}set z(e){this.#i=e}get position(){return[this.#r,this.#n,this.#i]}get radius(){return this.#Wn}set radius(e){this.#Wn=e}setPosition(e,t,r){Array.isArray(e)?[this.#r,this.#n,this.#i]=e:(this.#r=e,this.#n=t,this.#i=r)}}Object.freeze(PointLight);class LightManager{#Jn=3;#Qn=Fe.MAX_POINT_LIGHTS;#ei=[];#ti=[];#ri=new AmbientLight;#ni=create$5();get limitPointLightCount(){return this.#Qn}get pointLights(){return this.#ti}get limitDirectionalLightCount(){return this.#Jn}get directionalLightCount(){return this.#ei.length}get pointLightCount(){return this.#ti.length}get directionalLights(){return this.#ei}get ambientLight(){return this.#ri}set ambientLight(e){e instanceof AmbientLight||consoleAndThrowError("allow only AmbientLight instance"),this.#ri=e}addPointLight(e){e instanceof PointLight||consoleAndThrowError("allow only PointLight instance");this.#ti.length>this.#Qn&&consoleAndThrowError("Cannot add more directional lights. The limit has been reached."),this.#ti.push(e)}addDirectionalLight(e){e instanceof DirectionalLight||consoleAndThrowError("allow only DirectionalLight instance");this.#ei.length>this.#Jn&&consoleAndThrowError("Cannot add more directional lights. The limit has been reached."),this.#ei.push(e)}removeDirectionalLight(e){const t=this.#ei.indexOf(e);-1!==t&&this.#ei.splice(t,1)}removeAllDirectionalLight(){this.#ei=[],this.#ri=null}updateViewSystemUniforms(e){const{redGPUContext:t,scene:r}=e,n=e.systemUniform_Vertex_StructInfo,{systemUniform_Vertex_UniformBuffer:i}=e,{members:s}=n,{lightManager:a,shadowManager:o}=r;if(i.writeBuffers([[s.directionalLightCount,a.directionalLightCount],[s.directionalLightProjectionViewMatrix,this.#ii(e)],[s.directionalLightProjectionMatrix,this.#si(e)],[s.directionalLightViewMatrix,this.#ai(e)],[s.directionalLightShadowDepthTextureSize,o.directionalLightShadowDepthTextureSize],[s.directionalLightShadowBias,o.directionalLightShadowBias]]),a.directionalLights.forEach(((e,t)=>{const{directionalLights:r}=s,{direction:n,color:a,intensity:o}=r.memberList[t];i.writeBuffers([[n,e.direction],[a,e.color.rgbNormal],[o,e.intensity]])})),a.ambientLight){const t=e.scene.lightManager.ambientLight,{ambientLight:r}=s,{color:n,intensity:a}=r.members;i.writeBuffers([[n,t.color.rgbNormal],[a,t.intensity]])}}#ii(e){return multiply$5(create$5(),this.#si(e),this.#ai(e))}#si(e){const t=create$5(),r=fromValues$4(e.rawCamera.x,e.rawCamera.y,e.rawCamera.z),n=Math.max(distance$2(r,create$4()),1);return f(t,-n,n,-n,n,3*-n,3*n),t}#ai(e){identity$2(this.#ni);const t=Math.max(distance$2(fromValues$4(e.rawCamera.x,e.rawCamera.y,e.rawCamera.z),create$4()),1),r=fromValues$4(0,1,0),n=fromValues$4(0,0,0),i=e.scene.lightManager.directionalLights.length?fromValues$4(-e.scene.lightManager.directionalLights[0].direction[0]*t,-e.scene.lightManager.directionalLights[0].direction[1]*t,-e.scene.lightManager.directionalLights[0].direction[2]*t):create$4(),s=create$5();return lookAt(s,i,n,r),s}}Object.freeze(LightManager);class ShadowManager{#oi=2048;#ui=.005;#li;#ci;#hi;#v;#Hr=[];get castingList(){return this.#Hr}get shadowDepthGPUTextureView(){return this.#ci}get shadowDepthGPUTextureViewEmpty(){return this.#hi}get directionalLightShadowBias(){return this.#ui}set directionalLightShadowBias(e){validatePositiveNumberRange(e,0,1),this.#ui=e}get directionalLightShadowDepthTextureSize(){return this.#oi}set directionalLightShadowDepthTextureSize(e){validateUintRange(e,1),this.#oi=e,this.#mi()}resetCastingList(){this.#Hr.length=0}updateViewSystemUniforms(e){this.#v=e,this.#mi()}destroy(){this.#li&&(this.#li.destroy(),this.#li=null,this.#ci=null)}#mi(){this.#li?.width!==this.#oi&&(this.destroy(),this.#di())}#pi(e){const t=e.createTexture({size:[1,1,1],usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING,format:"depth32float"});this.#hi=t.createView()}#di(){const{gpuDevice:e}=this.#v;this.#li=e.createTexture({size:[this.#oi,this.#oi,1],usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING,format:"depth32float"}),this.#ci=this.#li.createView(),this.#hi||this.#pi(e)}}Object.freeze(ShadowManager);class Scene extends Object3DContainer{#e;#s;#fi=new ColorRGBA;#gi=!1;#xi=new LightManager;#_i=new ShadowManager;constructor(e){super(),this.#e=InstanceIdGenerator.getNextId(this.constructor),this.#s=e}get lightManager(){return this.#xi}get shadowManager(){return this.#_i}get name(){return this.#e||(this.#e=InstanceIdGenerator.getNextId(this.constructor)),this.#s||`${this.constructor.name} Instance ${this.#e}`}set name(e){this.#s=e}get backgroundColor(){return this.#fi}set backgroundColor(e){e instanceof ColorRGBA||consoleAndThrowError("allow only ColorRGBA instance"),this.#fi=e}get useBackgroundColor(){return this.#gi}set useBackgroundColor(e){this.#gi=e}}const lr=parseWGSL("\r\nstruct Uniforms {\ropacity:f32,\ruseSkyboxTexture:u32\r\n};\r\n@group(2) @binding(0) var<uniform> uniforms:Uniforms;\r\n@group(2) @binding(1) var skyboxTextureSampler:sampler;\r\n@group(2) @binding(2) var skyboxTexture:texture_cube<f32>;\r\n\r\nstruct InputData {\r@location(0) vertexPosition:vec4<f32>,\r\n};\r\n@fragment\r\nfn main(inputData:InputData) -> @location(0) vec4<f32> {\rvar cubemapVec=inputData.vertexPosition.xyz - vec3<f32>(0.5);\rvar sampleColor:vec4<f32>=textureSample(skyboxTexture,skyboxTextureSampler,cubemapVec);\rvar outColor=vec4<f32>(sampleColor.rgb,sampleColor.a * uniforms.opacity);\rif(outColor.a==0.0) {\rdiscard;\r}\rreturn outColor;\r\n}\r\n");class SkyBoxMaterial extends ABitmapBaseMaterial{dirtyPipeline=!1;constructor(e,t){super(e,"SKYBOX_MATERIAL",lr,2),this.skyboxTexture=t,this.skyboxTextureSampler=new Sampler(this.redGPUContext),this.initGPURenderInfos()}}rt.defineCubeTexture(SkyBoxMaterial,["skyboxTexture"]),rt.defineSampler(SkyBoxMaterial,["skyboxTextureSampler"]),Object.freeze(SkyBoxMaterial);class ViewRenderTextureManager{#vi;#yi;#Ti;#bi;#Si;#Mi;#Ri=!0;#wi=!0;#v;#Ir;constructor(e){validateRedGPUContext(e.redGPUContext),this.#v=e.redGPUContext,this.#Ir=e}get colorTexture(){return this.#vi}get colorResolveTexture(){return this.#yi}get depthTexture(){return this.#Ti}get depthTextureView(){return this.#Ei("depth"),this.#Mi}get colorTextureView(){return this.#Ei("color"),this.#bi}get colorResolveTextureView(){return this.#Si}#Ei(e){const t="depth"===e,{useMSAA:r,gpuDevice:n}=this.#v,i=t?this.#Ti:this.#vi,{pixelRectObject:s}=this.#Ir,{width:a,height:o}=s,u=i?.width!==a||i?.height!==o,l=t?this.#wi!==r:this.#Ri!==r,c=!i||u||l;if(t?this.#wi=r:this.#Ri=r,c){i&&(i?.destroy(),t||this.#yi?.destroy());const s=n.createTexture({size:[Math.max(a,1),Math.max(o,1),1],sampleCount:r?4:1,format:t?"depth24plus":navigator.gpu.getPreferredCanvasFormat(),usage:GPUTextureUsage.RENDER_ATTACHMENT|("color"===e?GPUTextureUsage.TEXTURE_BINDING:0)});if(t)this.#Ti=s,this.#Mi=s.createView();else if(this.#vi=s,this.#bi=s.createView(),r){const e=n.createTexture({size:{width:Math.max(a,1),height:Math.max(o,1),depthOrArrayLayers:1},sampleCount:1,format:navigator.gpu.getPreferredCanvasFormat(),usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.TEXTURE_BINDING});this.#yi=e,this.#Si=e.createView()}}}}Object.freeze(ViewRenderTextureManager);const cr=create$5(),computeViewFrustumPlanes=(e,t)=>{multiply$5(cr,e,t);const r=[[cr[3]-cr[0],cr[7]-cr[4],cr[11]-cr[8],cr[15]-cr[12]],[cr[3]+cr[0],cr[7]+cr[4],cr[11]+cr[8],cr[15]+cr[12]],[cr[3]+cr[1],cr[7]+cr[5],cr[11]+cr[9],cr[15]+cr[13]],[cr[3]-cr[1],cr[7]-cr[5],cr[11]-cr[9],cr[15]-cr[13]],[cr[3]-cr[2],cr[7]-cr[6],cr[11]-cr[10],cr[15]-cr[14]],[cr[3]+cr[2],cr[7]+cr[6],cr[11]+cr[10],cr[15]+cr[14]]];for(let e=0;e<6;e++){const t=r[e],n=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);t[0]/=n,t[1]/=n,t[2]/=n,t[3]/=n}return r};class ViewTransform{onResize=null;#v;#Pi=create$5();#Zt;#r=0;#n=0;#Sr;#Mr;#Rr=[0,0,0,0];constructor(e){validateRedGPUContext(e),this.#v=e}get redGPUContext(){return this.#v}get camera(){return this.#Zt}set camera(e){e instanceof PerspectiveCamera||e instanceof Camera2D||e instanceof Camera2D||e instanceof OrthographicCamera||e instanceof AController||consoleAndThrowError("allow PerspectiveCamera or OrthographicCamera or AController instance"),this.#Zt=e}get x(){return this.#r}set x(e){this.setPosition(e,this.y)}get y(){return this.#n}set y(e){this.setPosition(this.x,e)}get width(){return this.#Sr}set width(e){this.setSize(e,this.#Mr)}get height(){return this.#Mr}set height(e){this.setSize(this.#Sr,e)}get pixelRectArray(){return this.#Rr}get pixelRectObject(){return{x:this.#Rr[0],y:this.#Rr[1],width:this.#Rr[2],height:this.#Rr[3]}}get screenRectObject(){return{x:this.#Rr[0]/devicePixelRatio,y:this.#Rr[1]/devicePixelRatio,width:this.#Rr[2]/devicePixelRatio,height:this.#Rr[3]/devicePixelRatio}}get aspect(){return this.#Rr[2]/this.#Rr[3]}get frustumPlanes(){return this.#Zt instanceof AController?computeViewFrustumPlanes(this.projectionMatrix,this.#Zt.camera.modelMatrix):computeViewFrustumPlanes(this.projectionMatrix,this.#Zt.modelMatrix)}get rawCamera(){return this.#Zt instanceof AController?this.#Zt.camera:this.#Zt}get projectionMatrix(){const{pixelRectObject:e,redGPUContext:t}=this;if(this.rawCamera instanceof OrthographicCamera){const{nearClipping:e,farClipping:t}=this.rawCamera;orthoZO(this.#Pi,this.rawCamera.left,this.rawCamera.right,this.rawCamera.bottom,this.rawCamera.top,e,t)}else if(this.rawCamera instanceof Camera2D)f(this.#Pi,-.5,.5,-.5,.5,-1e5,1e5),scale$5(this.#Pi,this.#Pi,[t.renderScale,t.renderScale,1]),translate$1(this.#Pi,this.#Pi,[-.5,.5,0]),scale$5(this.#Pi,this.#Pi,[1/e.width*window.devicePixelRatio,-1/e.height*window.devicePixelRatio,1]),identity$2(this.rawCamera.modelMatrix);else{const{fieldOfView:e,nearClipping:t,farClipping:r}=this.rawCamera;p(this.#Pi,Math.PI/180*e,this.aspect,t,r)}return this.#Pi}get inverseProjectionMatrix(){return invert$2(create$5(),this.#Pi)}setPosition(e=this.#r,t=this.#n){const{sizeManager:r}=this.#v;RedGPUContextSizeManager.validatePositionValue(e),RedGPUContextSizeManager.validatePositionValue(t),this.#r=e,this.#n=t;const n=r.pixelRectObject,i=RedGPUContextSizeManager.getPixelDimension(n,"width",e),s=RedGPUContextSizeManager.getPixelDimension(n,"height",t);this.#Rr[0]=Math.floor(i*(this.#r.toString().includes("%")?1:r.renderScale*window.devicePixelRatio)),this.#Rr[1]=Math.floor(s*(this.#n.toString().includes("%")?1:r.renderScale*window.devicePixelRatio))}setSize(e=this.#Sr,t=this.#Mr){const{sizeManager:r}=this.#v;RedGPUContextSizeManager.validateSizeValue(e),RedGPUContextSizeManager.validateSizeValue(t),this.#Sr=e,this.#Mr=t;const n=r.pixelRectObject,i=RedGPUContextSizeManager.getPixelDimension(n,"width",e),s=RedGPUContextSizeManager.getPixelDimension(n,"height",t);this.#Rr[2]=Math.floor(i*(this.#Sr.toString().includes("%")?1:r.renderScale*window.devicePixelRatio)),this.#Rr[3]=Math.floor(s*(this.#Mr.toString().includes("%")?1:r.renderScale*window.devicePixelRatio)),this.onResize&&this.onResize(this.screenRectObject.width,this.screenRectObject.height)}}const hr=parseWGSL(ze.SYSTEM_UNIFORM).uniforms.systemUniforms;class View3D extends ViewTransform{#Ci=hr;#ki;#Ii;#e;#Ui;#Bi;#Li;#s;#Ai;#Di=!0;#Oi=!1;#Gi=50;#Ni;#Vi;#Fi;#zi;#$i=new PickingManager;#Hi=[];#Ki;#Ee;#Xi;#ji;#Yi;#Zi;#qi=void 0;#Wi=void 0;constructor(e,t,r,n){super(e),this.scene=t,this.camera=r,n&&(this.name=n),this.#Ji(),this.#zi=new ViewRenderTextureManager(this),this.#Vi=new RenderViewStateData(this),this.#Fi=new PostEffectManager(this),this.setSize("100%","100%")}get viewRenderTextureManager(){return this.#zi}get systemUniform_Vertex_StructInfo(){return this.#Ci}get systemUniform_Vertex_UniformBindGroup(){return this.#ki}get systemUniform_Vertex_UniformBuffer(){return this.#Ii}get passLightClustersBound(){return this.#Zi}get iblTexture(){return this.#Ni}set iblTexture(e){this.#Ni=e}get pickingManager(){return this.#$i}get postEffectManager(){return this.#Fi}get name(){return this.#e||(this.#e=InstanceIdGenerator.getNextId(this.constructor)),this.#s||`${this.constructor.name} Instance ${this.#e}`}set name(e){this.#s=e}get debugViewRenderState(){return this.#Vi}get grid(){return this.#Ui}set grid(e){if("boolean"==typeof e)e=!0===e?new Grid(this.redGPUContext):null;else if(!(e instanceof Grid)&&null!==e)throw new TypeError("grid must be of type 'Grid','boolean',or 'null'.");this.#Ui=e}get axis(){return this.#Bi}set axis(e){if("boolean"==typeof e)e=!0===e?new Axis(this.redGPUContext):null;else if(!(e instanceof Axis)&&null!==e)throw new TypeError("axis must be of type 'Axis','boolean',or 'null'.");this.#Bi=e}get skybox(){return this.#Li}set skybox(e){this.#Li=e}get useFrustumCulling(){return this.#Di}set useFrustumCulling(e){this.#Di=e}get useDistanceCulling(){return this.#Oi}set useDistanceCulling(e){this.#Oi=e}get distanceCulling(){return this.#Gi}set distanceCulling(e){this.#Gi=e}get scene(){return this.#Ai}set scene(e){e instanceof Scene||consoleAndThrowError("allow only Scene instance"),this.#Ai=e}update(e,t=!1,r=!1){const{scene:n}=e;let i=e.iblTexture?.gpuTexture||(e.skybox?._material instanceof SkyBoxMaterial?e.skybox._material.skyboxTexture?.gpuTexture:void 0),s=t?n.shadowManager.shadowDepthGPUTextureViewEmpty:n.shadowManager.shadowDepthGPUTextureView;const a=e.redGPUContext.viewList.indexOf(e),o=`${a}_${t?"shadowRender":"basic"}`;if(a>-1){let t=!0,r=this.#Hi[o];r&&(t=r.iblTexture!==i||r.shadowDepthGPUTextureView!==s||!this.#Yi),t?this.#Qi(o,s,i):this.#ki=this.#Hi[o].vertexUniformBindGroup,[{key:"useIblTexture",value:[i?1:0]},{key:"time",value:[e.debugViewRenderState.timestamp||0]},{key:"isView3D",value:[this.constructor===View3D?1:0]}].forEach((({key:e,value:t})=>{this.redGPUContext.gpuDevice.queue.writeBuffer(this.#Ii.gpuBuffer,this.#Ci.members[e].uniformOffset,new this.#Ci.members[e].View(t))})),this.#Hi[o]={iblTexture:i,shadowDepthGPUTextureView:s,vertexUniformBindGroup:this.#ki}}this.#es(r)}checkMouseInViewBounds(){const{pixelRectObject:e,pickingManager:t}=this,{mouseX:r,mouseY:n}=t;return 0<r&&r<e.width&&0<n&&n<e.height}#Qi(e,t,r){this.#es(!0);const n={layout:this.redGPUContext.resourceManager.getGPUBindGroupLayout(ResourceManager.PRESET_GPUBindGroupLayout_System),label:`SYSTEM_UNIFORM_bindGroup_${e}`,entries:[{binding:0,resource:{buffer:this.#Ii.gpuBuffer,offset:0,size:this.#Ii.size}},{binding:1,resource:this.#Ki},{binding:2,resource:t},{binding:3,resource:this.#Ee},{binding:4,resource:r?.createView(CubeTexture.defaultViewDescriptor)||this.redGPUContext.resourceManager.emptyCubeTextureView},{binding:5,resource:{buffer:this.#Xi,offset:0,size:this.#Xi.size}},{binding:6,resource:{buffer:this.#Yi.clusterLightsBuffer,offset:0,size:this.#Yi.clusterLightsBuffer.size}}]};this.#ki=this.redGPUContext.gpuDevice.createBindGroup(n)}#Ji(){const e=new ArrayBuffer(hr.arrayBufferByteLength);this.#Ii=new UniformBuffer(this.redGPUContext,e,"#systemUniform_Vertex_UniformBuffer"),this.#ji=new Float32Array(8*Fe.MAX_POINT_LIGHTS+4),this.#Xi=this.redGPUContext.gpuDevice.createBuffer({label:"clusterPointLightsBuffer",size:this.#ji.byteLength,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC}),this.redGPUContext.gpuDevice.queue.writeBuffer(this.#Xi,0,this.#ji),this.#Ki=new Sampler(this.redGPUContext,{addressModeU:Ue.CLAMP_TO_EDGE,addressModeV:Ue.CLAMP_TO_EDGE,addressModeW:Ue.CLAMP_TO_EDGE,compare:bt.LESS_EQUAL}).gpuSampler,this.#Ee=new Sampler(this.redGPUContext).gpuSampler}#es(e=!1){if(!e)return;const{redGPUContext:t,scene:r}=this;if(this.#Zi||(this.#Zi=new PassPointLightClustersBound(t,this)),this.#Yi&&(this.#Zi.render(),this.#qi=this.pixelRectArray[2],this.#Wi=this.pixelRectArray[3]),this.#Yi||(this.#Yi=new PassPointLightClusters(t,this)),r){const{pointLights:e}=r.lightManager,t=e.length;if(t){let r=t;for(;r--;){const t=e[r],n=4+8*r;this.#ji.set([...t.position,t.radius,...t.color.rgbNormal,t.intensity],n)}this.#ji.set([t,0,0,0],0),this.redGPUContext.gpuDevice.queue.writeBuffer(this.#Xi,0,this.#ji)}this.#Yi.render()}}}Object.freeze(View3D);class RedGPUContextViewContainer{#ts=[];constructor(){}get viewList(){return this.#ts}get numViews(){return this.#ts.length}contains(e){return this.#ts.includes(e)}addView(e){this.#rs(e),this.#ts.push(e)}addViewAt(e,t){this.#rs(e),validateUintRange(t);const r=this.#ts.length;r<t&&(t=r),this.#ts[t]=e}getViewAt(e){return validateUintRange(e),this.#ts[e]}getViewIndex(e){return this.#rs(e),this.#ts.indexOf(e)}setViewIndex(e,t){this.#rs(e),validateUintRange(t);const r=this.#ts.length,n=t>=r,i=this.#ts.indexOf(e);-1===i&&consoleAndThrowError(" View  RedGPUContext instance    View ."),n&&consoleAndThrowError(`index must be smaller than the viewList length./index:${t}/this.#viewList.length:${r}`),this.#ts.splice(i,1),this.#ts.splice(t,0,e)}swapViews(e,t){this.#rs(e),this.#rs(t);const r=this.#ts.indexOf(e),n=this.#ts.indexOf(t);-1!==r&&-1!==n||consoleAndThrowError((-1===r?"view1":"view2")+" is not child of this RedGPUContext instance."),this.swapViewsAt(r,n)}swapViewsAt(e,t){e===t&&consoleAndThrowError("The indices to swap cannot be the same."),validateUintRange(e),validateUintRange(t);const r=this.#ts.length;(e>=r||t>=r)&&consoleAndThrowError(`index1,index2 must be smaller than the viewList length./index1:${e}/index2:${t}/this.#viewList.length:${r}`);const n=this.#ts[e];this.#ts[e]=this.#ts[t],this.#ts[t]=n}removeView(e){this.#rs(e);const t=this.#ts.indexOf(e);t>-1?this.#ts.splice(t,1):consoleAndThrowError("View3D is not found in the view list.")}removeViewAt(e){validateUintRange(e);const t=this.#ts.length;e<t?this.#ts.splice(e,1):consoleAndThrowError(`Index ${e} is out of range. View list length is ${t}.`)}removeAllViews(){this.#ts.length=0}#rs(e){e instanceof View3D||consoleAndThrowError("allow only View3D instance")}}class RedGPUContextDetector{#ns;#is;#ss;#as;#os;constructor(e){this.#Ji(e.gpuAdapter)}get adapterInfo(){return this.#ns}get limits(){return this.#is}get isFallbackAdapter(){return this.#ss}get groupedLimits(){return this.#as}get userAgent(){return this.#os}get isMobile(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Windows Phone|Kindle|Silk|PlayBook/i.test(navigator.userAgent)}#Ji(e){this.#os=navigator.userAgent,this.#us(e),this.#ls()}#us(e){if(e){const{isFallbackAdapter:t,limits:r,info:n}=e;this.#ns=n,this.#ss=t,this.#is=r}}#ls(){const e={TextureLimits:["maxTextureDimension1D","maxTextureDimension2D","maxTextureDimension3D","maxTextureArrayLayers","maxSampledTexturesPerShaderStage","maxSamplersPerShaderStage"],BufferLimits:["maxBindGroups","maxBindGroupsPlusVertexBuffers","maxBindingsPerBindGroup","maxDynamicUniformBuffersPerPipelineLayout","maxDynamicStorageBuffersPerPipelineLayout","maxStorageBuffersPerShaderStage","maxStorageTexturesPerShaderStage","maxUniformBuffersPerShaderStage","maxUniformBufferBindingSize","maxStorageBufferBindingSize","minUniformBufferOffsetAlignment","minStorageBufferOffsetAlignment","maxBufferSize"],PipelineAndShaderLimits:["maxVertexBuffers","maxVertexAttributes","maxVertexBufferArrayStride","maxInterStageShaderComponents","maxInterStageShaderVariables"],ComputeLimits:["maxComputeWorkgroupStorageSize","maxComputeInvocationsPerWorkgroup","maxComputeWorkgroupSizeX","maxComputeWorkgroupSizeY","maxComputeWorkgroupSizeZ","maxComputeWorkgroupsPerDimension"],ColorLimits:["maxColorAttachments","maxColorAttachmentBytesPerSample"]};let t={TextureLimits:{},BufferLimits:{},PipelineAndShaderLimits:{},ComputeLimits:{},ColorLimits:{},EtcLimit:{}};for(const r in this.#is){let n=!1;for(const i in e)if(e[i].includes(r)){t[i][r]=this.#is[r],n=!0;break}n||(t.EtcLimit[r]=this.#is[r])}this.#as=t}}class RedGPUContext extends RedGPUContextViewContainer{currentRequestAnimationFrame;useMSAA=!0;onResize=null;#cs;#hs;#ms;#ds;#y;#wr;#ps;#fs;#We;#fi=new ColorRGBA(0,0,0,1);#gs=!1;#xs={};constructor(e,t,r,n,i){super(),this.#hs=t,this.#y=r,this.#ds=n,this.#ms=i,this.#wr=e,this.#ps=new RedGPUContextSizeManager(this),this.#fs=new RedGPUContextDetector(this),this.#We=new ResourceManager(this),this.#_s()}get useDebugPanel(){return this.#gs}set useDebugPanel(e){this.#gs=e}get backgroundColor(){return this.#fi}set backgroundColor(e){e instanceof ColorRGBA||consoleAndThrowError("allow only ColorRGBA instance"),this.#fi=e}get detector(){return this.#fs}get configurationDescription(){return this.#cs}get gpuAdapter(){return this.#hs}get alphaMode(){return this.#ms}set alphaMode(e){this.#ms=e,this.#vs()}get gpuContext(){return this.#ds}get gpuDevice(){return this.#y}get htmlCanvas(){return this.#wr}get keyboardKeyBuffer(){return this.#xs}set keyboardKeyBuffer(e){this.#xs=e}get resourceManager(){return this.#We}get sizeManager(){return this.#ps}get width(){return this.#ps.width}set width(e){this.#ps.width=e}get height(){return this.#ps.height}set height(e){this.#ps.height=e}get screenRectObject(){return this.#ps.screenRectObject}get renderScale(){return this.#ps.renderScale}set renderScale(e){this.#ps.renderScale=e,this.viewList.forEach((e=>{e.setPosition(),e.setSize()}))}destroy(){this.#y.destroy()}setSize(e=this.width,t=this.height){this.sizeManager.setSize(e,t)}#_s(){this.#vs(),this.sizeManager.setSize("100%","100%"),window?.addEventListener("resize",(()=>{this.sizeManager.setSize(),this.viewList.forEach((e=>{e.setSize(),e.setPosition()}))}));(this.detector.isMobile?["click","touchmove","touchstart","touchend"]:["click","mousemove","mousedown","mouseup"]).forEach((e=>{const t=this.detector.isMobile?{click:er.CLICK,touchmove:er.MOVE,touchstart:er.DOWN,touchend:er.UP}:{click:er.CLICK,mousemove:er.MOVE,mousedown:er.DOWN,mouseup:er.UP};this.#wr.addEventListener(e,(e=>{const r=t[e.type];this.viewList.forEach((t=>{this.detector.isMobile&&e instanceof TouchEvent&&e.touches.length>0?(t.pickingManager.mouseX=e.touches[0].clientX*devicePixelRatio-t.pixelRectObject.x,t.pickingManager.mouseY=e.touches[0].clientY*devicePixelRatio-t.pixelRectObject.y):e instanceof MouseEvent&&(t.pickingManager.mouseX=e.offsetX*devicePixelRatio-t.pixelRectObject.x,t.pickingManager.mouseY=e.offsetY*devicePixelRatio-t.pixelRectObject.y),r===er.CLICK?t.pickingManager.lastMouseClickEvent={...e,type:r}:t.pickingManager.lastMouseEvent={...e,type:r}}))}))}));{const HD_keyDown=e=>{this.#xs[e.key]=!0},HD_keyUp=e=>{this.#xs[e.key]=!1};window?.addEventListener("keyup",HD_keyUp),window?.addEventListener("keydown",HD_keyDown)}new ResizeObserver((e=>{})).observe(this.#wr)}#vs(){const e=navigator.gpu.getPreferredCanvasFormat();this.#cs={device:this.#y,format:e,alphaMode:this.#ms},this.#ds.configure(this.#cs)}#ys=()=>{this.sizeManager.setSize()};saveCanvasAsImage(){const e=this.htmlCanvas.toDataURL("image/png"),t=document.createElement("a");t.href=e,t.download="image.png",t.click()}}Object.freeze(RedGPUContext);const getFileExtension=e=>{if(!e||0===e.trim().length)throw new Error("URL must not be empty or undefined");const t=e.split("/"),r=t[t.length-1],n=r.lastIndexOf(".");return-1===n?"":r.substring(n+1).toLowerCase()},getFileName=(e,t=!0)=>{const r=e.substring(e.lastIndexOf("/")+1);return t?r:r.split(".").slice(0,-1).join(".")},getFilePath=e=>{if(!e||0===e.trim().length)throw new Error("URL must not be empty or undefined");return e.substring(0,e.lastIndexOf("/")+1)},calculateNormals=(e,t)=>{let r,n,i=[];for(r=0;r<e.length;r+=3)i[r+0]=0,i[r+1]=0,i[r+2]=0;for(r=0;r<t.length;r+=3){let s,a,o,u,l=[],c=[],h=[];for(s=3*t[r],a=3*t[r+1],o=3*t[r+2],l[0]=e[o+0]-e[a+0],l[1]=e[o+1]-e[a+1],l[2]=e[o+2]-e[a+2],c[0]=e[s+0]-e[a+0],c[1]=e[s+1]-e[a+1],c[2]=e[s+2]-e[a+2],h[0]=l[1]*c[2]-l[2]*c[1],h[1]=l[2]*c[0]-l[0]*c[2],h[2]=l[0]*c[1]-l[1]*c[0],n=0;n<3;n++)u=3*t[r+n],i[u+0]=i[u+0]+h[0],i[u+1]=i[u+1]+h[1],i[u+2]=i[u+2]+h[2]}for(r=0;r<e.length;r+=3){let e=[];e[0]=i[r+0],e[1]=i[r+1],e[2]=i[r+2];let t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);0===t&&(t=1),e[0]=e[0]/t,e[1]=e[1]/t,e[2]=e[2]/t,i[r+0]=e[0],i[r+1]=e[1],i[r+2]=e[2]}return i},formatBytes=(e,t=2)=>{if(("number"!=typeof e||e<0||Number.isNaN(e)||!Number.isInteger(e))&&consoleAndThrowError("Invalid input:'bytes' must be a uint"),0===e)return"0 Bytes";const r=t<0?0:t,n=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,n)).toFixed(r))+" "+["Bytes","KB","MB","GB"][n]},mat4ToEuler=(e,t,r)=>{t=t||[0,0,0],r=r||"XYZ";let n=e[0],i=e[4],s=e[8],a=e[1],o=e[5],u=e[9],l=e[2],c=e[6],h=e[10];return"XYZ"===r?(t[1]=Math.asin(clamp(s,-1,1)),Math.abs(s)<.99999?(t[0]=Math.atan2(-u,h),t[2]=Math.atan2(-i,n)):(t[0]=Math.atan2(c,o),t[2]=0)):"YXZ"===r?(t[0]=Math.asin(-clamp(u,-1,1)),Math.abs(u)<.99999?(t[1]=Math.atan2(s,h),t[2]=Math.atan2(a,o)):(t[1]=Math.atan2(-l,n),t[2]=0)):"ZXY"===r?(t[0]=Math.asin(clamp(c,-1,1)),Math.abs(c)<.99999?(t[1]=Math.atan2(-l,h),t[2]=Math.atan2(-i,o)):(t[1]=0,t[2]=Math.atan2(a,n))):"ZYX"===r?(t[1]=Math.asin(-clamp(l,-1,1)),Math.abs(l)<.99999?(t[0]=Math.atan2(c,h),t[2]=Math.atan2(a,n)):(t[0]=0,t[2]=Math.atan2(-i,o))):"YZX"===r?(t[2]=Math.asin(clamp(a,-1,1)),Math.abs(a)<.99999?(t[0]=Math.atan2(-u,o),t[1]=Math.atan2(-l,n)):(t[0]=0,t[1]=Math.atan2(s,h))):"XZY"===r&&(t[2]=Math.asin(-clamp(i,-1,1)),Math.abs(i)<.99999?(t[0]=Math.atan2(c,o),t[1]=Math.atan2(s,n)):(t[0]=Math.atan2(-u,h),t[1]=0)),t};let clamp=function(e,t,r){return Math.max(t,Math.min(r,e))};const quaternionToRotationMat4=(e,t)=>{let r=e[0],n=e[1],i=e[2],s=e[3],a=r+r,o=n+n,u=i+i,l=r*a,c=r*o,h=r*u,m=n*o,d=n*u,p=i*u,f=s*a,g=s*o,x=s*u;return t[0]=1-(m+p),t[4]=c-x,t[8]=h+g,t[1]=c+x,t[5]=1-(l+p),t[9]=d-f,t[2]=h-g,t[6]=d+f,t[10]=1-(l+m),t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t};let mr,dr,pr,fr,gr,xr,_r=create$4(),vr=create$5(),yr=create$5();function sortTransparentObjects(e,t){const r={},{x:n,y:i,z:s}=e;return t.sort(((e,t)=>{if(!r[e.uuid]){const t=e.x-n,a=e.y-i,o=e.z-s;r[e.uuid]=t*t+a*a+o*o}if(!r[t.uuid]){const e=t.x-n,a=t.y-i,o=t.z-s;r[t.uuid]=e*e+a*a+o*o}return r[t.uuid]-r[e.uuid]}))}var Tr=Object.freeze({__proto__:null,calculateNormals:calculateNormals,calculateTextureByteSize:calculateTextureByteSize,calculateVolume:calculateVolume,computeViewFrustumPlanes:computeViewFrustumPlanes,convertHexToRgb:convertHexToRgb,convertRgbToHex:convertRgbToHex,createUUID:createUUID,formatBytes:formatBytes,getFileExtension:getFileExtension,getFileName:getFileName,getFilePath:getFilePath,getMipLevelCount:getMipLevelCount,getScreenPoint:getScreenPoint,localToWorld:localToWorld,matToEuler:mat4ToEuler,quaternionToRotationMat4:quaternionToRotationMat4,screenToWorld:(e,t)=>{const{rawCamera:r}=t;return mr=2*e[0]/e[2]-1,dr=-2*e[1]/e[3]+1,pr=1,multiply$5(yr,t.projectionMatrix,r.modelMatrix),xr=clone$5(yr),invert$2(xr,xr),_r=fromValues$4(mr,dr,1),identity$2(vr),translate$1(vr,vr,_r),multiply$5(xr,xr,vr),_r[0]=xr[12],_r[1]=xr[13],_r[2]=xr[14],fr=yr[12]*mr+yr[13]*dr+yr[15],0!==fr&&(gr=1/fr,_r[0]/=gr,_r[1]/=gr,_r[2]/=gr,_r[0]=_r[0]+r.x,_r[1]=_r[1]+r.y,_r[2]=_r[2]+r.z),[_r[0],_r[1],_r[2]]},sortTransparentObjects:sortTransparentObjects,uuidToUint:uuidToUint,worldToLocal:worldToLocal});const copyGPUBuffer=(e,t,r)=>{const n=e.createCommandEncoder();n.copyBufferToBuffer(t,0,r,0,Math.min(t.size,r.size));const i=n.finish();e.queue.submit([i])};var br="#redgpu_include SYSTEM_UNIFORM;\r\n\r\nstruct InstanceUniforms {\rinstanceGroupModelMatrix:mat4x4<f32>,\r\n\t instanceModelMatrixs:array<mat4x4<f32>,100000>,\r\n\t instanceNormalModelMatrix:array<mat4x4<f32>,100000>,\r\n\t instanceOpacity:array<f32,100000>,\ruseDisplacementTexture:u32,\rdisplacementScale:f32,\r\n};\r\n@group(1) @binding(0) var<storage,read> instanceUniforms:InstanceUniforms;\r\n@group(1) @binding(1) var displacementTextureSampler:sampler;\r\n@group(1) @binding(2) var displacementTexture:texture_2d<f32>;\r\n\r\nstruct InputData {\r@builtin(instance_index) instanceIdx:u32,\r@location(0) position:vec3<f32>,\r@location(1) vertexNormal:vec3<f32>,\r@location(2) uv:vec2<f32>,\r\n\r\n};\r\nstruct OutputData {\r@builtin(position) position:vec4<f32>,\r@location(0) vertexPosition:vec3<f32>,\r@location(1) vertexNormal:vec3<f32>,\r@location(2) uv:vec2<f32>,\r@location(12) instanceOpacity:f32,\r@location(13) shadowPos:vec3<f32>,\r@location(14) receiveShadow:f32,\r@location(15) pickingId:vec4<f32>,\r\n};\r\nstruct OutputShadowData {\r@builtin(position) position:vec4<f32>,\r\n};\r\nconst maxDistance:f32=1000.0;\r\nconst maxMipLevel:f32=10.0;\r\n@vertex\r\nfn main( inputData:InputData ) -> OutputData {\rvar output:OutputData;\r\n\rlet input_instanceIdx:u32=inputData.instanceIdx;\rlet u_modelMatrix=instanceUniforms.instanceModelMatrixs[input_instanceIdx];\rlet u_normalModelMatrix=instanceUniforms.instanceNormalModelMatrix[input_instanceIdx];\rlet u_instanceGroupModelMatrix=instanceUniforms.instanceGroupModelMatrix;\rlet u_useDisplacementTexture=instanceUniforms.useDisplacementTexture==1u;\rlet u_displacementScale=instanceUniforms.displacementScale;\r\rlet u_projectionMatrix=systemUniforms.projectionMatrix;\rlet u_camera=systemUniforms.camera;\rlet u_cameraMatrix=u_camera.cameraMatrix;\rlet u_cameraPosition=u_camera.cameraPosition;\r\n\r\n\rlet input_position=inputData.position;\rlet input_vertexNormal=inputData.vertexNormal;\rlet input_uv=inputData.uv;\r\n\rvar position:vec4<f32>=u_modelMatrix * vec4<f32>(input_position,1.0);\r\n\r\r\rlet worldPosition=position.xyz;\r\n\r\rlet margin:f32=0.5;\r\n\r\rvar clipPosition:vec4<f32>=u_projectionMatrix * u_cameraMatrix * vec4<f32>(worldPosition,1.0);\r\n\r\rlet ndcPosition:vec3<f32>=clipPosition.xyz/clipPosition.w;\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\noutput.position=clipPosition;\r\n\r\r\n\r\n\rvar normalPosition:vec3<f32>=(u_instanceGroupModelMatrix * u_normalModelMatrix * vec4<f32>(input_vertexNormal,1.0)).xyz;;\r\n\r\n\rif (u_useDisplacementTexture) {\rlet distance=distance(position.xyz,u_cameraPosition);\rlet mipLevel=(distance/maxDistance) * maxMipLevel;\rlet displacementSample=textureSampleLevel(displacementTexture,displacementTextureSampler,input_uv,mipLevel).r;\rlet scaledDisplacement=displacementSample * u_displacementScale;\rlet displacedPosition=input_position + input_vertexNormal * scaledDisplacement;\r\n\rposition=u_modelMatrix * vec4<f32>(displacedPosition,1.0);\r\n\r}\r\n\routput.position=u_projectionMatrix * u_cameraMatrix * u_instanceGroupModelMatrix * position;\routput.vertexPosition=position.xyz;\routput.vertexNormal=normalPosition;\routput.uv=input_uv;\routput.instanceOpacity=instanceUniforms.instanceOpacity[input_instanceIdx];\rreturn output;\r\n}\r\n@vertex\r\nfn drawDirectionalShadowDepth( inputData:InputData ) -> OutputShadowData {\rvar output:OutputShadowData;\rlet input_instanceIdx:u32=inputData.instanceIdx;\rlet u_directionalLightProjectionViewMatrix=systemUniforms.directionalLightProjectionViewMatrix;\rlet u_modelMatrix=instanceUniforms.instanceModelMatrixs[input_instanceIdx];\rlet u_useDisplacementTexture=instanceUniforms.useDisplacementTexture==1u;\rlet u_displacementScale=instanceUniforms.displacementScale;\r\n\rlet input_position=inputData.position;\rlet input_vertexNormal=inputData.vertexNormal;\rlet input_uv=inputData.uv;\r\n\rvar position:vec4<f32>;\rposition= u_modelMatrix * vec4<f32>(input_position,1.0);\r\n\r\n\rif (u_useDisplacementTexture) {\rlet distance=distance(position.xyz,u_directionalLightProjectionViewMatrix[3].xyz);\rlet mipLevel=(distance/maxDistance) * maxMipLevel;\rlet displacementSample=textureSampleLevel(displacementTexture,displacementTextureSampler,input_uv,mipLevel).r;\rlet scaledDisplacement=displacementSample * u_displacementScale;\rlet displacedPosition=input_position + input_vertexNormal * scaledDisplacement;\r\n\rposition=u_modelMatrix * vec4<f32>(displacedPosition,1.0);\r}\r\n\r\n\routput.position=u_directionalLightProjectionViewMatrix * position;\rreturn output;\r\n}\r\n";const Sr=3.141592653589793,Mr=6.283185307179586,Rr=.225,wr=1.27323954,Er=.405284735,Pr=1.5707963267948966,Cr=Math.PI/180;class InstancingMeshObject3D{modelMatrix=create$5();localMatrix=create$5();normalModelMatrix=create$5();inited=!1;#r=0;#i=0;#n=0;#At=[0,0,0];#Vt=1;#Ft=1;#zt=1;#$t=[1,1,1];#o=0;#u=0;#l=0;#Ht=[0,0,0];#Ts=0;#bs;#v;#Yt=1;get opacity(){return this.#Yt}set opacity(e){validatePositiveNumberRange(e,0,1),this.#Yt=e,this.#Ss()}constructor(e,t,r){validateRedGPUContext(e),this.#v=e,this.#bs=r,this.#Ts=t}get x(){return this.#r}set x(e){this.#r=this.#At[0]=e,this.#Ss()}get y(){return this.#n}set y(e){this.#n=this.#At[1]=e,this.#Ss()}get z(){return this.#i}set z(e){this.#i=this.#At[2]=e,this.#Ss()}get position(){return this.#At}set position(e){this.#r=this.#At[0]=e,this.#n=this.#At[1]=e,this.#i=this.#At[2]=e,this.#Ss()}get scaleX(){return this.#Vt}set scaleX(e){this.#Vt=this.#$t[0]=e,this.#Ss()}get scaleY(){return this.#Ft}set scaleY(e){this.#Ft=this.#$t[1]=e,this.#Ss()}get scaleZ(){return this.#zt}set scaleZ(e){this.#zt=this.#$t[2]=e,this.#Ss()}get scale(){return this.#At}set scale(e){this.#Vt=this.#$t[0]=e,this.#Ft=this.#$t[1]=e,this.#zt=this.#$t[2]=e,this.#Ss()}get rotationX(){return this.#o}set rotationX(e){this.#o=this.#Ht[0]=e,this.#Ss()}get rotationY(){return this.#u}set rotationY(e){this.#u=this.#Ht[1]=e,this.#Ss()}get rotationZ(){return this.#l}set rotationZ(e){this.#l=this.#Ht[2]=e,this.#Ss()}get rotation(){return this.#Ht}set rotation(e){this.#o=this.#Ht[0]=e,this.#u=this.#Ht[1]=e,this.#l=this.#Ht[2]=e,this.#Ss()}setScale(e,t,r){t=t??e,r=r??e;const n=this.#$t;this.#Vt=n[0]=e,this.#Ft=n[1]=t,this.#zt=n[2]=r,this.#Ss()}setPosition(e,t,r){t=t??e,r=r??e;const n=this.#At;this.#r=n[0]=e,this.#n=n[1]=t,this.#i=n[2]=r,this.#Ss()}setRotation(e,t,r){t=t??e,r=r??e;const n=this.#Ht;this.#o=n[0]=e,this.#u=n[1]=t,this.#l=n[2]=r,this.#Ss()}#Ss(){let e,t,r,n,i,s,a,o,u,l,c,h,m,d,p,f,g,x,_,v,y,T,b,S,M,R,w,E,P,C,k,I,U,B,L,A,D,O;this.inited=!0;{const m=this.localMatrix;let g;l=1,c=0,h=0,d=0,p=1,f=0,x=0,_=0,v=1,m[12]=this.#r,m[13]=this.#n,m[14]=this.#i,m[15]=1,a=this.#o*Cr,o=this.#u*Cr,u=this.#l*Cr,g=a%Mr,g<-3.141592653589793?g+=Mr:g>Sr&&(g-=Mr),g=g<0?wr*g+Er*g*g:wr*g-Er*g*g,e=g<0?Rr*(g*-g-g)+g:Rr*(g*g-g)+g,g=(a+Pr)%Mr,g<-3.141592653589793?g+=Mr:g>Sr&&(g-=Mr),g=g<0?wr*g+Er*g*g:wr*g-Er*g*g,n=g<0?Rr*(g*-g-g)+g:Rr*(g*g-g)+g,g=o%Mr,g<-3.141592653589793?g+=Mr:g>Sr&&(g-=Mr),g=g<0?wr*g+Er*g*g:wr*g-Er*g*g,t=g<0?Rr*(g*-g-g)+g:Rr*(g*g-g)+g,g=(o+Pr)%Mr,g<-3.141592653589793?g+=Mr:g>Sr&&(g-=Mr),g=g<0?wr*g+Er*g*g:wr*g-Er*g*g,i=g<0?Rr*(g*-g-g)+g:Rr*(g*g-g)+g,g=u%Mr,g<-3.141592653589793?g+=Mr:g>Sr&&(g-=Mr),g=g<0?wr*g+Er*g*g:wr*g-Er*g*g,r=g<0?Rr*(g*-g-g)+g:Rr*(g*g-g)+g,g=(u+Pr)%Mr,g<-3.141592653589793?g+=Mr:g>Sr&&(g-=Mr),g=g<0?wr*g+Er*g*g:wr*g-Er*g*g,s=g<0?Rr*(g*-g-g)+g:Rr*(g*g-g)+g,C=i*s,k=e*t*s-n*r,I=n*t*s+e*r,U=i*r,B=e*t*r+n*s,L=n*t*r-e*s,A=-t,D=e*i,O=n*i,a=this.#Vt,o=this.#Ft,u=this.#zt,m[0]=(l*C+d*k+x*I)*a,m[1]=(c*C+p*k+_*I)*a,m[2]=(h*C+f*k+v*I)*a,m[3]=m[3]*a,m[4]=(l*U+d*B+x*L)*o,m[5]=(c*U+p*B+_*L)*o,m[6]=(h*U+f*B+v*L)*o,m[7]=m[7]*o,m[8]=(l*A+d*D+x*O)*u,m[9]=(c*A+p*D+_*O)*u,m[10]=(h*A+f*D+v*O)*u,m[11]=m[11]*u}this.modelMatrix=this.localMatrix;{let e=this.normalModelMatrix,t=this.modelMatrix;l=t[0],c=t[1],h=t[2],m=t[3],d=t[4],p=t[5],f=t[6],g=t[7],x=t[8],_=t[9],v=t[10],y=t[11],b=t[12],S=t[13],M=t[14],R=t[15],T=l*p-c*d,w=l*f-h*d,E=l*g-m*d,P=c*f-h*p,C=c*g-m*p,k=h*g-m*f,I=x*S-_*b,U=x*M-v*b,B=x*R-y*b,A=_*R-y*S,L=v*R-y*M,O=T*L-w*A+E*L+P*B-C*U+k*I,O=1/O,e[0]=(p*L-f*A+g*L)*O,e[4]=(-c*L+h*A-m*L)*O,e[8]=(S*k-M*C+R*P)*O,e[12]=(-_*k+v*C-y*P)*O,e[1]=(-d*L+f*B-g*U)*O,e[5]=(l*L-h*B+m*U)*O,e[9]=(-b*k+M*E-R*w)*O,e[13]=(x*k-v*E+y*w)*O,e[2]=(d*A-p*B+g*I)*O,e[6]=(-l*A+c*B-m*I)*O,e[10]=(b*C-S*E+R*T)*O,e[14]=(-x*C+_*E-y*T)*O,e[3]=(-d*L+p*U-f*I)*O,e[7]=(l*L-c*U+h*I)*O,e[11]=(-b*P+S*w-M*T)*O,e[15]=(x*P-_*w+v*T)*O}if(this.#bs.gpuRenderInfo){const{vertexUniformBuffer:e,vertexUniformInfo:t}=this.#bs.gpuRenderInfo,r=t.members.instanceModelMatrixs,n=t.members.instanceNormalModelMatrix,i=t.members.instanceOpacity;this.#v.gpuDevice.queue.writeBuffer(e.gpuBuffer,r.uniformOffset+r.stride*this.#Ts,new r.View(this.modelMatrix)),this.#v.gpuDevice.queue.writeBuffer(e.gpuBuffer,n.uniformOffset+n.stride*this.#Ts,new n.View(this.normalModelMatrix)),this.#v.gpuDevice.queue.writeBuffer(e.gpuBuffer,i.uniformOffset+i.stride*this.#Ts,new i.View([this.opacity]))}}}const kr="VERTEX_BIND_GROUP_DESCRIPTOR_INSTANCING";class InstancingMesh extends Mesh{#Bt=!0;#v;#Ms=1;#Rs=[];constructor(e,t,r,n){super(e,r,n),this.#v=e,this.gpuRenderInfo=new VertexGPURenderInfo(null,null,null,null,null,null),this.instanceCount=t,this.#ws(e)}get instanceCount(){return this.#Ms}set instanceCount(e){validateUintRange(e),this.gpuRenderInfo.vertexUniformInfo=parseWGSL(br).storage.instanceUniforms;const t=new ArrayBuffer(this.gpuRenderInfo.vertexUniformInfo.arrayBufferByteLength),r=new StorageBuffer(this.#v,t,this.name),n=this.gpuRenderInfo.vertexUniformBuffer;n?.gpuBuffer&&copyGPUBuffer(this.#v.gpuDevice,n.gpuBuffer,r.gpuBuffer),n?.destroy(),this.gpuRenderInfo.vertexUniformBuffer=r;let i=e;for(;i--;)this.#Rs[i]||(this.#Rs[i]=new InstancingMeshObject3D(this.#v,i,this));this.#Ms=e,this.#ws(this.#v)}get instanceChildren(){return this.#Rs}render(e,t=!1){const{view:r,currentRenderPassEncoder:n}=e,{scene:i}=r,{shadowManager:s}=i,{castingList:a}=s,o=this.parent;let u=this.dirtyTransform;u&&(identity$2(this.localMatrix),translate$1(this.localMatrix,this.localMatrix,[this.x,this.y,this.z]),rotateX$3(this.localMatrix,this.localMatrix,this.rotationX),rotateY$3(this.localMatrix,this.localMatrix,this.rotationY),rotateZ$3(this.localMatrix,this.localMatrix,this.rotationZ),scale$5(this.localMatrix,this.localMatrix,[this.scaleX,this.scaleY,this.scaleZ]),o?.modelMatrix?multiply$5(this.modelMatrix,this.localMatrix,o.modelMatrix):this.modelMatrix=clone$5(this.localMatrix)),this.geometry?e.num3DObjects++:e.num3DGroups++;const l=this.#v;if(this.geometry){const{useMSAA:r,gpuDevice:i}=l;r!==this.#Bt&&(this.#Bt=r,this.dirtyPipeline=!0),this.gpuRenderInfo||this.#ws(l);const s=this.dirtyPipeline||this.material.dirtyPipeline,{displacementTexture:a,displacementScale:o}=this.material||{};s&&(this.dirtyTransform=!0,this.material.dirtyPipeline&&this.material._updateFragmentState(),this.#Es(),this.material.dirtyPipeline=!1,this.dirtyPipeline=!1,e.numDirtyPipelines++);const{gpuRenderInfo:u}=this,{vertexUniformBuffer:c,vertexUniformBindGroup:h,vertexUniformInfo:m,pipeline:d,shadowPipeline:p}=u;void 0!==m.members.displacementScale&&i.queue.writeBuffer(c.gpuBuffer,m.members.displacementScale.uniformOffset,new m.members.displacementScale.View([o])),void 0!==m.members.useDisplacementTexture&&i.queue.writeBuffer(c.gpuBuffer,m.members.useDisplacementTexture.uniformOffset,new m.members.useDisplacementTexture.View([a?1:0])),this.dirtyTransform&&i.queue.writeBuffer(c.gpuBuffer,m.members.instanceGroupModelMatrix.uniformOffset,new m.members.instanceGroupModelMatrix.View(this.modelMatrix)),this.dirtyTransform=!1,n.setPipeline(t?p:d);const{gpuBuffer:f}=this.geometry.vertexBuffer,{fragmentUniformBindGroup:g}=this.material.gpuRenderInfo;if(e.prevVertexGpuBuffer!==f&&(n.setVertexBuffer(0,f),e.prevVertexGpuBuffer=f),n.setBindGroup(1,h),n.setBindGroup(2,g),e.numDrawCalls++,e.numInstances++,this.geometry.indexBuffer){const{indexBuffer:t}=this.geometry,{indexNum:r,triangleCount:i,gpuBuffer:s}=t;n.setIndexBuffer(s,"uint32"),n.drawIndexed(r,this.#Ms,0,0,0),e.numTriangles+=i*this.#Ms,e.numPoints+=r*this.#Ms}else{const{vertexBuffer:t}=this.geometry,{vertexCount:r,triangleCount:i}=t;n.draw(r,this.#Ms,0,0),e.numTriangles+=i,e.numPoints+=r}}this.castShadow&&(a[a.length]=this);const{children:c}=this;let h=c.length;for(;h--;)c[h].dirtyTransform=u,c[h].render(e);this.dirtyTransform=!1}#ws(e){this.dirtyPipeline=!0;const{resourceManager:t}=this.#v,r=t.getGPUBindGroupLayout(ResourceManager.PRESET_VERTEX_GPUBindGroupLayout_Instancing),{basicSampler:n,emptyBitmapTextureView:i,emptyCubeTextureView:s}=t,{gpuSampler:a}=n,{vertexUniformBuffer:o}=this.gpuRenderInfo,{material:u}=this,l={layout:r,label:kr,entries:[{binding:0,resource:{buffer:o.gpuBuffer,offset:0,size:o.size}},{binding:1,resource:u?.displacementTextureSampler?.gpuSampler||a},{binding:2,resource:u?.displacementTexture?.gpuTexture?.createView()||i}]},c=e.gpuDevice.createBindGroup(l);this.#Es(),this.gpuRenderInfo.vertexBindGroupLayout=r,this.gpuRenderInfo.vertexUniformBindGroup=c}#Es(){const{resourceManager:e}=this.#v,t={code:br},r=e.createGPUShaderModule("VERTEX_MODULE_INSTANCING",t),{vertexUniformBuffer:n}=this.gpuRenderInfo,{material:i}=this,{basicSampler:s,emptyBitmapTextureView:a,emptyCubeTextureView:o}=e,{gpuSampler:u}=s,l=e.getGPUBindGroupLayout(ResourceManager.PRESET_VERTEX_GPUBindGroupLayout_Instancing),c={layout:l,label:kr,entries:[{binding:0,resource:{buffer:n.gpuBuffer,offset:0,size:n.size}},{binding:1,resource:i?.displacementTextureSampler?.gpuSampler||u},{binding:2,resource:i?.displacementTexture?.gpuTexture?.createView()||a}]};this.gpuRenderInfo.vertexUniformBindGroup=this.redGPUContext.gpuDevice.createBindGroup(c),this.gpuRenderInfo.pipeline=createBasePipeline(this,r,l),this.gpuRenderInfo.shadowPipeline=createBasePipeline(this,r,l,St)}}Object.defineProperty(InstancingMesh.prototype,"meshType",{value:"instanceMesh",writable:!1});var Ir="#redgpu_include SYSTEM_UNIFORM;\r\n\r\nstruct InputData {\r@location(0) position:vec3<f32>,\r@location(1) vertexNormal:vec3<f32>,\r@location(2) uv:vec2<f32>,\r\n};\r\n\r\nstruct OutData {\r@builtin(position) position:vec4<f32>,\r@location(0) vertexPosition:vec4<f32>,\r\n};\r\nstruct VertexUniforms {\r\n\t modelMatrix:mat4x4<f32>,\r\n};\r\n@group(1) @binding(0) var<uniform> vertexUniforms:VertexUniforms;\r\n@vertex\r\nfn main(inputData:InputData) -> OutData {\rvar outData:OutData;\rlet u_projectionMatrix=systemUniforms.projectionMatrix;\rlet u_camera=systemUniforms.camera;\rlet u_cameraMatrix=u_camera.cameraMatrix;\routData.position=u_projectionMatrix * u_cameraMatrix * vertexUniforms.modelMatrix * vec4<f32>(inputData.position,1.0);\routData.vertexPosition=0.5 * (vec4<f32>(inputData.position,1.0) + vec4<f32>(1.0,1.0,1.0,1.0));\rreturn outData;\r\n}\r\n";const Ur=parseWGSL(Ir),Br=Ur.uniforms.vertexUniforms;var Lr="#redgpu_include SYSTEM_UNIFORM;\r\n\r\nstruct InputData {\r@location(0) position:vec3<f32>,\r@location(1) vertexNormal:vec3<f32>,\r@location(2) uv:vec2<f32>,\r\n};\r\n\r\nstruct OutData {\r@builtin(position) position:vec4<f32>,\r@location(0) uv:vec2<f32>,\r\n};\r\nstruct VertexUniforms {\r\n\t modelMatrix:mat4x4<f32>,\r\n};\r\n@group(1) @binding(0) var<uniform> vertexUniforms:VertexUniforms;\r\n@vertex\r\nfn main(inputData:InputData) -> OutData {\rvar outData:OutData;\rlet u_projectionMatrix=systemUniforms.projectionMatrix;\rlet u_camera=systemUniforms.camera;\rlet u_cameraMatrix=u_camera.cameraMatrix;\rlet input_uv=inputData.uv;\routData.position=u_projectionMatrix * u_cameraMatrix * vertexUniforms.modelMatrix * vec4<f32>(inputData.position,1.0);\r\n\routData.uv=input_uv;\rreturn outData;\r\n}\r\n";const Ar=parseWGSL("\r\nstruct Uniforms {\ropacity:f32,\ruseSkyboxTexture:u32\r\n};\r\n@group(2) @binding(0) var<uniform> uniforms:Uniforms;\r\n@group(2) @binding(1) var skyboxTextureSampler:sampler;\r\n@group(2) @binding(2) var skyboxTexture:texture_2d<f32>;\r\n\r\nstruct InputData {\r@location(0) uv:vec2<f32>,\r\n};\r\n@fragment\r\nfn main(inputData:InputData) -> @location(0) vec4<f32> {\rvar sampleColor:vec4<f32>=textureSample(skyboxTexture,skyboxTextureSampler,inputData.uv);\rvar outColor=vec4<f32>(sampleColor.rgb,sampleColor.a * uniforms.opacity);\rif(outColor.a==0.0) {\rdiscard;\r}\rreturn outColor;\r\n}\r\n");class SphericalSkyBoxMaterial extends ABitmapBaseMaterial{dirtyPipeline=!1;constructor(e,t){super(e,"SPHERICAL_SKYBOX_MATERIAL",Ar,2),this.skyboxTexture=t,this.skyboxTextureSampler=new Sampler(this.redGPUContext),this.initGPURenderInfos()}}rt.defineCubeTexture(SphericalSkyBoxMaterial,["skyboxTexture"]),rt.defineSampler(SphericalSkyBoxMaterial,["skyboxTextureSampler"]),Object.freeze(SphericalSkyBoxMaterial);const Dr=parseWGSL(Lr),Or=Dr.uniforms.vertexUniforms;class View2D extends View3D{constructor(e,t,r){super(e,t,new Camera2D,r)}}Object.freeze(View2D);const Gr=Math.PI/180;class GroupBase extends Object3DContainer{modelMatrix=create$5();localMatrix=create$5();#e;#s;#Lt;#r=0;#i=0;#n=0;#At=[0,0,0];#Dt=0;#Ot=0;#Gt=0;#Vt=1;#Ft=1;#zt=1;#$t=[1,1,1];#o=0;#u=0;#l=0;#Ht=[0,0,0];#Ps=!0;constructor(e){super(),e&&(this.name=e)}get dirtyTransform(){return this.#Ps}set dirtyTransform(e){this.#Ps=e}get name(){return this.#e||(this.#e=InstanceIdGenerator.getNextId(this.constructor)),this.#s||`${this.constructor.name} Instance ${this.#e}`}set name(e){this.#s=e}get parent(){return this.#Lt}set parent(e){this.#Lt=e}get pivotX(){return this.#Dt}set pivotX(e){this.#Dt=e,this.dirtyTransform=!0}get pivotY(){return this.#Ot}set pivotY(e){this.#Ot=e,this.dirtyTransform=!0}get pivotZ(){return this.#Gt}set pivotZ(e){this.#Gt=e,this.dirtyTransform=!0}get x(){return this.#r}set x(e){this.#r=this.#At[0]=e,this.dirtyTransform=!0}get y(){return this.#n}set y(e){this.#n=this.#At[1]=e,this.dirtyTransform=!0}get z(){return this.#i}set z(e){this.#i=this.#At[2]=e,this.dirtyTransform=!0}get position(){return this.#At}get scaleX(){return this.#Vt}set scaleX(e){this.#Vt=this.#$t[0]=e,this.dirtyTransform=!0}get scaleY(){return this.#Ft}set scaleY(e){this.#Ft=this.#$t[1]=e,this.dirtyTransform=!0}get scaleZ(){return this.#zt}set scaleZ(e){this.#zt=this.#$t[2]=e,this.dirtyTransform=!0}get scale(){return this.#At}get rotationX(){return this.#o}set rotationX(e){this.#o=this.#Ht[0]=e,this.dirtyTransform=!0}get rotationY(){return this.#u}set rotationY(e){this.#u=this.#Ht[1]=e,this.dirtyTransform=!0}get rotationZ(){return this.#l}set rotationZ(e){this.#l=this.#Ht[2]=e,this.dirtyTransform=!0}get rotation(){return this.#Ht}setScale(e,t,r){t=t??e,r=r??e;const n=this.#$t;this.#Vt=n[0]=e,this.#Ft=n[1]=t,this.#zt=n[2]=r,this.dirtyTransform=!0}setPosition(e,t,r){t=t??e,r=r??e;const n=this.#At;this.#r=n[0]=e,this.#n=n[1]=t,this.#i=n[2]=r,this.dirtyTransform=!0}setRotation(e,t,r){t=t??e,r=r??e;const n=this.#Ht;this.#o=n[0]=e,this.#u=n[1]=t,this.#l=n[2]=r,this.dirtyTransform=!0}render(e){const{view:t,isScene2DMode:r}=e;let n;if(r&&(this.#i=0,this.#Gt=0),this.dirtyTransform){n=!0;{const{pixelRectObject:e}=t,r=this.parent,n=this.localMatrix;identity$2(n),translate$1(n,n,[this.#r,this.#n,this.#i]),rotateX$3(n,n,this.#o*Gr),rotateY$3(n,n,this.#u*Gr),rotateZ$3(n,n,this.#l*Gr);let i=[this.#Vt,this.#Ft,this.#zt];if(this.renderTextureWidth&&(i[0]*=this.renderTextureWidth/e.height,i[1]*=this.renderTextureHeight/e.height),scale$5(n,n,i),this.#Dt||this.#Ot||this.#Gt){translate$1(n,n,[-this.#Dt,-this.#Ot,-this.#Gt])}r?.modelMatrix?multiply$5(this.modelMatrix,r.modelMatrix,this.localMatrix):copy$5(this.modelMatrix,this.localMatrix)}}this.dirtyTransform&&(n=!0,this.dirtyTransform=!1),e.num3DGroups++;const{children:i}=this;let s=0;const a=i.length;for(;s<a;s++)n&&(i[s].dirtyTransform=n),i[s].render(e)}}Object.defineProperty(GroupBase.prototype,"meshType",{value:"mesh",writable:!1}),Object.freeze(GroupBase);class Group3D extends GroupBase{#e;#s;constructor(e){super(),e&&(this.name=e)}get name(){return this.#e||(this.#e=InstanceIdGenerator.getNextId(this.constructor)),this.#s||`${this.constructor.name} Instance ${this.#e}`}set name(e){this.#s=e}}Object.defineProperty(Group3D.prototype,"meshType",{value:"mesh",writable:!1}),Object.freeze(Group3D);class Group2D extends GroupBase{#e;#s;#Cs=0;constructor(e){super(),e&&(this.name=e)}get name(){return this.#e||(this.#e=InstanceIdGenerator.getNextId(this.constructor)),this.#s||`${this.constructor.name} Instance ${this.#e}`}set name(e){this.#s=e}get rotation(){return this.#Cs}set rotation(e){this.#Cs=e,super.rotationZ=e}setScale(e,t){t=t??e,super.setScale(e,t,1)}setPosition(e,t){t=t??e,super.setPosition(e,t,0)}setRotation(e){this.rotation=e}}Object.defineProperty(Group2D.prototype,"is2DMeshType",{value:!0,writable:!1}),Object.freeze(Group2D);const Nr={Linear:0,QuintIn:1,QuintOut:2,QuintInOut:3,BackIn:4,BackOut:5,BackInOut:6,CircIn:7,CircOut:8,CircInOut:9,CubicIn:10,CubicOut:11,CubicInOut:12,ExpoIn:13,ExpoOut:14,ExpoInOut:15,QuadIn:16,QuadOut:17,QuadInOut:18,QuartIn:19,QuartOut:20,QuartInOut:21,SineIn:22,SineOut:23,SineInOut:24,ElasticIn:25,ElasticOut:26,ElasticInOut:27};class Plane extends Primitive{#Dn=function(){const e=[],t=[];return function(r,n,i,s,a,o,u,l){const c=i/2,h=s/2,m=Math.floor(a)||1,d=Math.floor(o)||1,p=m+1,f=d+1,g=i/m,x=s/d;e.length=0,t.length=0;for(let r=0;r<f;r++){const n=r*x-h,i=l?(1-r/d)*u:r/d*u;for(let s=0;s<p;s++){const a=s*g-c,o=s/m*u;if(e.push(a,-n,0,0,0,1,o,i),r<d&&s<m){const e=s+p*r,n=s+p*(r+1),i=s+1+p*(r+1),a=s+1+p*r;t.push(e,n,a),t.push(n,i,a)}}}return createPrimitiveGeometry(n,e,t,r)}}();constructor(e,t=1,r=1,n=1,i=1,s=1,a=!1){super(e);const o=`PRIMITIVE_PLANE_W${t}_H${r}_WS${n}_HS${i}_UV${s}_FY${a}`,u=e.resourceManager.cachedBufferState;let l=u[o];l||(l=u[o]=this.#Dn(o,e,t,r,n,i,s,a)),this._setData(l)}}var Vr="#redgpu_include SYSTEM_UNIFORM;\r\n#redgpu_include getBillboardMatrix;\r\nstruct VertexUniforms {\rpickingId:u32,\r\n\t modelMatrix:mat4x4<f32>,\r\n\t normalModelMatrix:mat4x4<f32>,\r\n\t useBillboardPerspective:u32,\r\n\t useBillboard:u32,\r\n\t combinedOpacity:f32,\r\n};\r\n\r\n@group(1) @binding(0) var<uniform> vertexUniforms:VertexUniforms;\r\n\r\nstruct InputData {\r@location(0) a_position:vec3<f32>,\r@location(1) a_normal:vec3<f32>,\r@location(2) a_uv:vec2<f32>,\r@location(3) position:vec3<f32>,\r@location(4) alpha:f32,\r@location(5) rotation:vec3<f32>,\r@location(6) scale:f32,\r\n};\r\nstruct OutputData {\r@builtin(position) position:vec4<f32>,\r@location(0) vertexPosition:vec3<f32>,\r@location(1) vertexNormal:vec3<f32>,\r@location(2) uv:vec2<f32>,\r@location(12) combinedOpacity:f32,\r@location(13) shadowPos:vec3<f32>,\r@location(14) receiveShadow:f32,\r@location(15) pickingId:vec4<f32>,\r\n};\r\nfn mat4_inverse(a:mat4x4<f32>) -> mat4x4<f32> {\rvar a00:f32=a[0][0];\rvar a01:f32=a[0][1];\rvar a02:f32=a[0][2];\rvar a03:f32=a[0][3];\rvar a10:f32=a[1][0];\rvar a11:f32=a[1][1];\rvar a12:f32=a[1][2];\rvar a13:f32=a[1][3];\rvar a20:f32=a[2][0];\rvar a21:f32=a[2][1];\rvar a22:f32=a[2][2];\rvar a23:f32=a[2][3];\rvar a30:f32=a[3][0];\rvar a31:f32=a[3][1];\rvar a32:f32=a[3][2];\rvar a33:f32=a[3][3];\r\n\rvar b00:f32=a00*a11 - a01*a10;\rvar b01:f32=a00*a12 - a02*a10;\rvar b02:f32=a00*a13 - a03*a10;\rvar b03:f32=a01*a12 - a02*a11;\rvar b04:f32=a01*a13 - a03*a11;\rvar b05:f32=a02*a13 - a03*a12;\rvar b06:f32=a20*a31 - a21*a30;\rvar b07:f32=a20*a32 - a22*a30;\rvar b08:f32=a20*a33 - a23*a30;\rvar b09:f32=a21*a32 - a22*a31;\rvar b10:f32=a21*a33 - a23*a31;\rvar b11:f32=a22*a33 - a23*a32;\r\n\r\rvar det:f32=b00*b11 - b01*b10 + b02*b09 + b03*b08 - b04*b07 + b05*b06;\r\n\r\rif (det !=0.0) {\rdet=1.0/det;\rreturn mat4x4<f32>(\r(a11*b11 - a12*b10 + a13*b09) * det,\r(a02*b10 - a01*b11 - a03*b09) * det,\r(a31*b05 - a32*b04 + a33*b03) * det,\r(a22*b04 - a21*b05 - a23*b03) * det,\r(a12*b08 - a10*b11 - a13*b07) * det,\r(a00*b11 - a02*b08 + a03*b07) * det,\r(a32*b02 - a30*b05 - a33*b01) * det,\r(a20*b05 - a22*b02 + a23*b01) * det,\r(a10*b10 - a11*b08 + a13*b06) * det,\r(a01*b08 - a00*b10 - a03*b06) * det,\r(a30*b04 - a31*b02 + a33*b00) * det,\r(a21*b02 - a20*b04 - a23*b00) * det,\r(a11*b07 - a10*b09 - a12*b06) * det,\r(a00*b09 - a01*b07 + a02*b06) * det,\r(a31*b01 - a30*b03 - a32*b00) * det,\r(a20*b03 - a21*b01 + a22*b00) * det\r);\r}\r\n\r\rreturn mat4x4<f32>(\r0.0,0.0,0.0,0.0,\r0.0,0.0,0.0,0.0,\r0.0,0.0,0.0,0.0,\r0.0,0.0,0.0,0.0\r);\r\n}\r\nfn rotationMTX(t:vec3<f32>)->mat4x4<f32>\r\n{\rvar s:f32=sin(t.x);\rvar c:f32=cos(t.x);\rvar m1=mat4x4<f32>(1,0, 0,0,\r0,c,-s,0,\r0,s, c,0,\r0,0, 0,1);\r\n\rs=sin(t[1]);c=cos(t[1]);\rvar m2=mat4x4<f32>(c,0,s,0,\r0,1,0,0,\r-s,0,c,0,\r0,0,0,1);\r\n\rs=sin(t[2]);c=cos(t[2]);\rvar m3=mat4x4<f32>(c,-s,0,0,\rs,c,0,0,\r0,0,1,0,\r0,0,0,1);\r\n\rreturn m1 * m2 * m3;\r\n}\r\n\r\n@vertex\r\nfn main( inputData:InputData) -> OutputData {\rvar output:OutputData;\r\n\r\rlet u_projectionMatrix=systemUniforms.projectionMatrix;\rlet u_resolution=systemUniforms.resolution;\rlet u_camera=systemUniforms.camera;\rlet u_cameraMatrix=u_camera.cameraMatrix;\rlet u_cameraPosition=u_camera.cameraPosition;\r\rlet u_modelMatrix=vertexUniforms.modelMatrix;\rlet u_normalModelMatrix=vertexUniforms.normalModelMatrix;\r\n\rlet u_useBillboardPerspective=vertexUniforms.useBillboardPerspective==1u;\rlet u_useBillboard=vertexUniforms.useBillboard==1u;\r\n\r\rlet input_position=inputData.position;\rvar position:vec4<f32>;\rvar normalPosition:vec4<f32>;\rvar scaleMTX=mat4x4<f32>(\rinputData.scale,0,0,0,\r0,inputData.scale,0,0,\r0,0,inputData.scale,0,\r0,0,0,1\r);\r\n\r\n\rvar translateTX=mat4x4<f32>(\r1,0,0,0,\r0,1,0,0,\r0,0,1,0,\rinputData.position.x,inputData.position.y,inputData.position.z,1\r);\r\n\r\n\rvar temp:mat4x4<f32>;\rif(u_useBillboard){\rvar rotateMTX2=rotationMTX( vec3(0,0,inputData.rotation.z) );\rtemp=translateTX * rotateMTX2;\rposition=rotateMTX2 * vec4<f32>(inputData.a_position ,1);\routput.position= u_projectionMatrix * getBillboardMatrixNoScaleRatio( u_cameraMatrix, temp ) * scaleMTX * position;\r}else{\rvar rotateMTX=rotationMTX( inputData.rotation );\rtemp=translateTX * rotateMTX * scaleMTX;\rposition=temp * vec4<f32>(inputData.a_position,1);\routput.position=u_projectionMatrix * u_cameraMatrix * position;\r}\r\n\routput.vertexPosition=position.xyz;\routput.vertexNormal= (transpose(mat4_inverse(temp) ) * vec4<f32>(inputData.a_normal,1.0)).xyz;\routput.uv=inputData.a_uv;\routput.combinedOpacity=vertexUniforms.combinedOpacity;\rreturn output;\r\n}\r\nstruct OutputShadowData {\r@builtin(position) position:vec4<f32>,\r\n};\r\n";const Fr=parseWGSL(Vr),zr=Fr.uniforms.vertexUniforms;class ParticleEmitter extends Mesh{#ks=1e3;#Is=5e3;#Us=0;#Bs=0;#Ls=0;#As=0;#Ds=0;#Os=0;#Gs=-5;#Ns=-5;#Vs=-5;#Fs=5;#zs=5;#$s=5;#Hs=0;#Ks=0;#Xs=1;#js=1;#Ys=0;#Zs=1;#qs=0;#Ws=0;#Js=-360;#Qs=-360;#ea=-360;#ta=360;#ra=360;#na=360;#ia=-360;#sa=-360;#aa=-360;#oa=360;#ua=360;#la=360;#ca=Nr.CubicOut;#ha=Nr.CubicOut;#ma=Nr.CubicOut;#da=Nr.Linear;#pa=Nr.Linear;#fa=Nr.CubicOut;#ga=Nr.CubicOut;#xa=Nr.CubicOut;#_a;#va;#ya;#Ta;#ba;#Sa=2e3;constructor(e){super(e),this.geometry=new Plane(e),this.material=new BitmapMaterial(e),this.ignoreFrustumCulling=!0,this.useBillboard=!0}get vertexStateBuffers(){return[{arrayStride:32,stepMode:"vertex",attributes:[{shaderLocation:0,offset:0,format:"float32x3"},{shaderLocation:1,offset:12,format:"float32x3"},{shaderLocation:2,offset:24,format:"float32x2"}]},{arrayStride:48,stepMode:"instance",attributes:[{shaderLocation:3,offset:16,format:"float32x3"},{shaderLocation:4,offset:28,format:"float32"},{shaderLocation:5,offset:32,format:"float32x3"},{shaderLocation:6,offset:44,format:"float32"}]}]}get particleBuffers(){return this.#va}get particleNum(){return this.#Sa}set particleNum(e){this.#Sa=Math.max(Math.min(e,5e5),1),this.#Ma()}get minLife(){return this.#ks}set minLife(e){this.#ks=e}get maxLife(){return this.#Is}set maxLife(e){this.#Is=e}get minStartX(){return this.#Us}set minStartX(e){this.#Us=e}get minStartY(){return this.#Bs}set minStartY(e){this.#Bs=e}get minStartZ(){return this.#Ls}set minStartZ(e){this.#Ls=e}get maxStartX(){return this.#As}set maxStartX(e){this.#As=e}get maxStartY(){return this.#Ds}set maxStartY(e){this.#Ds=e}get maxStartZ(){return this.#Os}set maxStartZ(e){this.#Os=e}get minEndX(){return this.#Gs}set minEndX(e){this.#Gs=e}get minEndY(){return this.#Ns}set minEndY(e){this.#Ns=e}get minEndZ(){return this.#Vs}set minEndZ(e){this.#Vs=e}get maxEndX(){return this.#Fs}set maxEndX(e){this.#Fs=e}get maxEndY(){return this.#zs}set maxEndY(e){this.#zs=e}get maxEndZ(){return this.#$s}set maxEndZ(e){this.#$s=e}get minStartAlpha(){return this.#Hs}set minStartAlpha(e){this.#Hs=e}get maxStartAlpha(){return this.#Ks}set maxStartAlpha(e){this.#Ks=e}get minEndAlpha(){return this.#Xs}set minEndAlpha(e){this.#Xs=e}get maxEndAlpha(){return this.#js}set maxEndAlpha(e){this.#js=e}get minStartScale(){return this.#Ys}set minStartScale(e){this.#Ys=e}get maxStartScale(){return this.#Zs}set maxStartScale(e){this.#Zs=e}get minEndScale(){return this.#qs}set minEndScale(e){this.#qs=e}get maxEndScale(){return this.#Ws}set maxEndScale(e){this.#Ws=e}get minStartRotationX(){return this.#Js}set minStartRotationX(e){this.#Js=e}get minStartRotationY(){return this.#Qs}set minStartRotationY(e){this.#Qs=e}get minStartRotationZ(){return this.#ea}set minStartRotationZ(e){this.#ea=e}get maxStartRotationX(){return this.#ta}set maxStartRotationX(e){this.#ta=e}get maxStartRotationY(){return this.#ra}set maxStartRotationY(e){this.#ra=e}get maxStartRotationZ(){return this.#na}set maxStartRotationZ(e){this.#na=e}get minEndRotationX(){return this.#ia}set minEndRotationX(e){this.#ia=e}get minEndRotationY(){return this.#sa}set minEndRotationY(e){this.#sa=e}get minEndRotationZ(){return this.#aa}set minEndRotationZ(e){this.#aa=e}get maxEndRotationX(){return this.#oa}set maxEndRotationX(e){this.#oa=e}get maxEndRotationY(){return this.#ua}set maxEndRotationY(e){this.#ua=e}get maxEndRotationZ(){return this.#la}set maxEndRotationZ(e){this.#la=e}get easeX(){return this.#ca}set easeX(e){this.#ca=e}get easeY(){return this.#ha}set easeY(e){this.#ha=e}get easeZ(){return this.#ma}set easeZ(e){this.#ma=e}get easeAlpha(){return this.#da}set easeAlpha(e){this.#da=e}get easeScale(){return this.#pa}set easeScale(e){this.#pa=e}get easeRotationX(){return this.#fa}set easeRotationX(e){this.#fa=e}get easeRotationY(){return this.#ga}set easeRotationY(e){this.#ga=e}get easeRotationZ(){return this.#xa}set easeRotationZ(e){this.#xa=e}createCustomMeshVertexShaderModule(){return this.createMeshVertexShaderModuleBASIC("VERTEX_MODULE_PARTICLE_EMITTER",Fr,zr,Vr)}render(e){this.#va||this.#Ji(),this.#Ra(e.timestamp),super.render(e)}#Ma(){let e=this.redGPUContext;const t=new Float32Array(12*this.#Sa),r=new Float32Array(12*this.#Sa),n=new Float32Array(12*this.#Sa),i=new Float32Array(4*this.#Sa),s=new Float32Array(4*this.#Sa),a=performance.now(),o=this.localToWorld(this.x,this.y,this.z);for(let e=0;e<this.#Sa;++e){let u=Math.random()*this.#Is,l=Math.random()*u;const c=o[0]+Math.random()*(this.#As-this.#Us)+this.#Us,h=o[1]+Math.random()*(this.#Ds-this.#Bs)+this.#Bs,m=o[2]+Math.random()*(this.#Os-this.#Ls)+this.#Ls,d=Math.random()*(this.#ta-this.#Js)+this.#Js,p=Math.random()*(this.#ra-this.#Qs)+this.#Qs,f=Math.random()*(this.#na-this.#ea)+this.#ea;Math.random(),this.#Zs,this.#Ys,this.#Ys,Math.random(),this.#Ks,this.#Hs,this.#Hs,t[12*e]=a-l,t[12*e+1]=u,t[12*e+4]=c,t[12*e+5]=h,t[12*e+6]=m,t[12*e+7]=0,t[12*e+8]=d,t[12*e+9]=p,t[12*e+10]=f,t[12*e+11]=0,r[4*e]=c,r[4*e+1]=Math.random()*(this.#Fs-this.#Gs)+this.#Gs,r[4*e+2]=this.#ca,r[4*e+3]=o[0],r[4*e+4]=h,r[4*e+5]=Math.random()*(this.#zs-this.#Ns)+this.#Ns,r[4*e+6]=this.#ha,r[4*e+7]=o[1],r[4*e+8]=m,r[4*e+9]=Math.random()*(this.#$s-this.#Vs)+this.#Vs,r[4*e+10]=this.#ma,r[4*e+11]=o[2],n[4*e]=d,n[4*e+1]=Math.random()*(this.#oa-this.#ia)+this.#ia,n[4*e+2]=this.#fa,n[4*e+3]=0,n[4*e+4]=p,n[4*e+5]=Math.random()*(this.#ua-this.#sa)+this.#sa,n[4*e+6]=this.#ga,n[4*e+7]=0,n[4*e+8]=f,n[4*e+9]=Math.random()*(this.#la-this.#aa)+this.#aa,n[4*e+10]=this.#xa,n[4*e+11]=0,i[4*e]=0,i[4*e+1]=Math.random()*(this.#Ws-this.#qs)+this.#qs,i[4*e+2]=this.#pa,i[4*e+3]=0,s[4*e]=0,s[4*e+1]=Math.random()*(this.#js-this.#Xs)+this.#Xs,s[4*e+2]=this.#da,s[4*e+3]=0}const u=this.#va;this.#va=[];const l=[t,r,n,i,s];l.forEach(((t,r)=>{const n=e.gpuDevice.createBuffer({size:t.byteLength,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.COPY_SRC|GPUBufferUsage.VERTEX|GPUBufferUsage.STORAGE});e.gpuDevice.queue.writeBuffer(n,0,t),this.#va.push(n),u?.length&&copyGPUBuffer(e.gpuDevice,u[r],n)})),u&&u.forEach((e=>e.destroy()));let c={code:"\r\nstruct Info {\rstartValue:f32,\rendValue:f32,\reaseType:f32,\rbirthCenterValue:f32\r\n};\r\n\r\nstruct InfoGroup {\rinfoX:Info,\rinfoY:Info,\rinfoZ:Info,\r\n};\r\n\r\nstruct Particle {\rstartTime:f32,\rlife:f32,\rvaluePosition:vec3<f32>,\rvalueAlpha:f32,\rvalueRotation:vec3<f32>,\rvalueScale:f32,\r\n};\r\nstruct SimParams {\rtime:f32,\rcurrentPositionX:f32,currentPositionY:f32,currentPositionZ:f32,\rminLife:f32,maxLife:f32,\rminStartX:f32,maxStartX:f32,minEndX:f32,maxEndX:f32,easeX:f32,\rminStartY:f32,maxStartY:f32,minEndY:f32,maxEndY:f32,easeY:f32,\rminStartZ:f32,maxStartZ:f32,minEndZ:f32,maxEndZ:f32,easeZ:f32,\rminStartAlpha:f32,maxStartAlpha:f32,minEndAlpha:f32,maxEndAlpha:f32,easeAlpha:f32,\rminStartScale:f32,maxStartScale:f32,minEndScale:f32,maxEndScale:f32,easeScale:f32,\rminStartRotationX:f32,maxStartRotationX:f32,minEndRotationX:f32,maxEndRotationX:f32,easeRotationX:f32,\rminStartRotationY:f32,maxStartRotationY:f32,minEndRotationY:f32,maxEndRotationY:f32,easeRotationY:f32,\rminStartRotationZ:f32,maxStartRotationZ:f32,minEndRotationZ:f32,maxEndRotationZ:f32,easeRotationZ:f32,\r\n};\r\n\r\n\r\n@group(0) @binding(0) var<uniform> params:SimParams;\r\n@group(0) @binding(1) var<storage,read_write> particles:array<Particle>;\r\n@group(0) @binding(2) var<storage,read_write> infoPosition:array<InfoGroup>;\r\n@group(0) @binding(3) var<storage,read_write> infoRotation:array<InfoGroup>;\r\n@group(0) @binding(4) var<storage,read_write> infoScale:array<Info>;\r\n@group(0) @binding(5) var<storage,read_write> infoAlpha:array<Info>;\r\n\r\nconst PI:f32=3.141592653589793;\r\nconst HPI:f32=PI * 0.5;\r\nconst PI2:f32=PI * 2.0;\r\n\r\nfn calEasing(n:f32,easingType:f32) -> f32 {\rvar m:f32=n;\rlet easingInt:i32=i32(easingType);\r\n\rswitch (easingInt) {\rcase 0:{ m=m;}\rcase 1:{ m=m * m * m * m * m;}\rcase 2:{\rm -=1.0;\rm=(m * m * m * m * m) + 1.0;\r}\rcase 3:{\rif(m * 2.0 < 1.0) {\rm *=2.0;\rm=m * m * m * m * m * 0.5;\r}\relse {\rm=m * 2.0 - 2.0;\rm=0.5 * (m * m * m * m * m + 2.0);\r}\r}\rcase 4:{ m=m * m * (m * 1.70158 + m - 1.70158);}\rcase 5:{\rm -=1.0;\rm=m * m * (m * 1.70158 + m + 1.70158) + 1.0;\r}\rcase 6:{\rif(m * 2.0 < 1.0) {\rm *=2.0;\rm=0.5 * m * m * (m * 1.70158 + m - 1.70158);\r}\relse {\rm=m * 2.0 - 2.0;\rm=0.5 * m * m * (m * 1.70158 + m + 1.70158) + 1.0;\r}\r}\rcase 7:{ m=-1.0 * (sqrt(1.0 - m * m) - 1.0);}\rcase 8:{\rm -=1.0;\rm=sqrt(1.0 - m * m);\r}\rcase 9:{\rif(m * 2.0 < 1.0) {\rm *=2.0;\rm=-0.5 * (sqrt(1.0 - m * m) - 1.0);\r}\relse {\rm=m * 2.0 - 2.0;\rm=0.5 * sqrt(1.0 - m * m) + 0.5;\r}\r}\rcase 10:{ m=m * m * m;}\rcase 11:{\rm -=1.0;\rm=m * m * m + 1.0;\r}\rcase 12:{\rif(m * 2.0 < 1.0) {\rm *=2.0;\rm=m * m * m * 0.5;\r}\relse {\rm=m * 2.0 - 2.0;\rm=0.5 * (m * m * m + 2.0);\r}\r}\rcase 13:{\rif (m==0.0) { m=0.0;}\relse { m=pow(2.0,10.0 * (m - 1.0));}\r}\rcase 14:{\rif (m==1.0) { m=1.0;}\relse { m=-pow(2.0,-10.0 * m) + 1.0;}\r}\rcase 15:{\rif(m * 2.0 < 1.0) {\rif (m==0.0) { m=0.0;}\relse { m *=2.0;m=0.5 * pow(2.0,10.0 * (m - 1.0));}\r}\relse {\rif (m==2.0) { m=1.0;}\relse { m=m * 2.0 - 1.0;m=-0.5 * pow(2.0,-10.0 * m) + 1.0;}\r}\r}\rcase 16:{ m=m * m;}\rcase 17:{ m=(2.0 - m) * m;}\rcase 18:{\rif(m * 2.0 < 1.0) {\rm *=2.0;\rm=m * m * 0.5;\r}\relse {\rm=2.0 - m;\rm=0.5 * (m * m + 1.0);\r}\r}\rcase 19:{ m=m * m * m * m;}\rcase 20:{\rm -=1.0;\rm=1.0 - (m * m * m * m);\r}\rcase 21:{\rif(m * 2.0 < 1.0) {\rm *=2.0;\rm=m * m * m * m * 0.5;\r}\relse {\rm=m * 2.0 - 2.0;\rm=1.0 - (m * m * m * m * 0.5);\r}\r}\rcase 22:{ m=-cos(m * HPI) + 1.0;}\rcase 23:{ m=sin(m * HPI);}\rcase 24:{ m=(-cos(m * PI) + 1.0) * 0.5;}\rcase 25:{\rif (m==0.0) { m=0.0;}\relse if (m==1.0) { m=1.0;}\relse { m -=1.0;m=-1.0 * pow(2.0,10.0 * m) * sin((m - 0.075) * (PI2)/0.3);}\r}\r\rcase 26:{\rif (m==0.0) {\rm=0.0;\r} else if (m==1.0) {\rm=1.0;\r} else {\rm -=1.0;\rm=-pow(2.0,10.0 * m) * sin((m - 0.075) * PI2/0.3);\r}\r}\r\rcase 27:{\rif (m==0.0) {\rm=0.0;\r} else if (m==1.0) {\rm=1.0;\r} else {\rm=pow(2.0,-10.0 * m) * sin((m - 0.075) * PI2/0.3) + 1.0;\r}\r}\rdefault:{ m=m;}\r}\rreturn m;\r\n}\r\nfn rand(n:f32) -> f32 {\rreturn fract(sin(n) * 43758.5453123);\r\n}\r\nfn randomRange(min:f32,max:f32,v:f32)->f32\r\n{\rvar newValue:f32=rand(v);\rreturn (newValue * (max-min)) + min;\r\n}\r\nfn compute_value(tInfo:Info,lifeRatio:f32) -> f32 {\rreturn tInfo.startValue + ((tInfo.endValue - tInfo.startValue) * calEasing(lifeRatio,tInfo.easeType));\r\n}\r\n@compute @workgroup_size(256,1,1)\r\nfn main(\r@builtin(global_invocation_id) global_id:vec3<u32>\r) {\rlet index:u32=(global_id.x);\rlet age:f32=(params.time - particles[index].startTime);\rvar lifeRatio:f32=(age/particles[index].life);\rif (lifeRatio >=1.0 ) {\rlet uuid:f32=(params.time + f32(index));\rparticles[index].startTime=params.time;\rparticles[index].life=randomRange( params.minLife,params.maxLife,uuid );\r\n\r\rinfoPosition[index].infoX.startValue=randomRange( params.minStartX + params.currentPositionX,params.maxStartX + params.currentPositionX,(uuid + 1.0) );\rinfoPosition[index].infoX.endValue =randomRange( params.minEndX + params.currentPositionX,params.maxEndX + params.currentPositionX,(uuid + 2.0) );\rinfoPosition[index].infoX.easeType =params.easeX;\rinfoPosition[index].infoX.birthCenterValue=params.currentPositionX;\r\rinfoPosition[index].infoY.startValue=randomRange( params.minStartY +params.currentPositionY,params.maxStartY+params.currentPositionY,(uuid + 3.0) );\rinfoPosition[index].infoY.endValue =randomRange( params.minEndY+params.currentPositionY,params.maxEndY+params.currentPositionY,(uuid + 4.0) );\rinfoPosition[index].infoY.easeType =params.easeY;\rinfoPosition[index].infoY.birthCenterValue=params.currentPositionY;\r\rinfoPosition[index].infoZ.startValue=randomRange( params.minStartZ+params.currentPositionZ,params.maxStartZ+params.currentPositionZ,(uuid + 5.0) );\rinfoPosition[index].infoZ.endValue =randomRange( params.minEndZ+params.currentPositionZ,params.maxEndZ+params.currentPositionZ,(uuid + 6.0) );\rinfoPosition[index].infoZ.easeType =params.easeZ;\rinfoPosition[index].infoZ.birthCenterValue=params.currentPositionZ;\r\rinfoAlpha[index].startValue=randomRange( params.minStartAlpha,params.maxStartAlpha,(uuid + 7.0) );\rinfoAlpha[index].endValue =randomRange( params.minEndAlpha,params.maxEndAlpha,(uuid + 8.0) );\rinfoAlpha[index].easeType =params.easeAlpha;\r\rinfoScale[index].startValue=randomRange( params.minStartScale,params.maxStartScale,(uuid + 9.0) );\rinfoScale[index].endValue =randomRange( params.minEndScale,params.maxEndScale,(uuid + 10.0));\rinfoScale[index].easeType =params.easeScale;\r\rinfoRotation[index].infoX.startValue=randomRange( params.minStartRotationX,params.maxStartRotationX,(uuid + 11.0));\rinfoRotation[index].infoX.endValue =randomRange( params.minEndRotationX,params.maxEndRotationX,(uuid + 12.0));\rinfoRotation[index].infoX.easeType =params.easeRotationX;\r\rinfoRotation[index].infoY.startValue=randomRange( params.minStartRotationY,params.maxStartRotationY,(uuid + 13.0));\rinfoRotation[index].infoY.endValue =randomRange( params.minEndRotationY,params.maxEndRotationY,(uuid + 14.0));\rinfoRotation[index].infoY.easeType =params.easeRotationY;\r\rinfoRotation[index].infoZ.startValue=randomRange( params.minStartRotationZ,params.maxStartRotationZ,(uuid + 15.0));\rinfoRotation[index].infoZ.endValue =randomRange( params.minEndRotationZ,params.maxEndRotationZ,(uuid + 16.0));\rinfoRotation[index].infoZ.easeType =params.easeRotationZ;\r\n\rlifeRatio=0.0;\r}\rvar targetInfo:Info;\rlet targetParticle=particles[index];\r\rtargetInfo=infoPosition[index].infoX;\rparticles[index].valuePosition.x=compute_value(targetInfo,lifeRatio);\rtargetInfo=infoPosition[index].infoY;\rparticles[index].valuePosition.y= compute_value(targetInfo,lifeRatio);\rtargetInfo=infoPosition[index].infoZ;\rparticles[index].valuePosition.z= compute_value(targetInfo,lifeRatio);\r\rtargetInfo=infoAlpha[index];\rparticles[index].valueAlpha=compute_value(targetInfo,lifeRatio);\r\rtargetInfo=infoScale[index];\rparticles[index].valueScale=compute_value(targetInfo,lifeRatio);\r\rtargetInfo=infoRotation[index].infoX;\rparticles[index].valueRotation.x= compute_value(targetInfo,lifeRatio) * PI/180.0;\rtargetInfo=infoRotation[index].infoY;\rparticles[index].valueRotation.y= compute_value(targetInfo,lifeRatio) * PI/180.0;\rtargetInfo=infoRotation[index].infoZ;\rparticles[index].valueRotation.z= compute_value(targetInfo,lifeRatio) * PI/180.0;\r\n\r\n\r\n}\r\n"},h=e.resourceManager.createGPUShaderModule("PARTICLE_EMITTER_MODULE",c);const m=[{binding:0,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}}],d=[{binding:0,resource:{buffer:this.#_a,offset:0,size:this.#ya.byteLength}}];l.forEach(((e,t)=>{m.push({binding:t+1,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}}),d.push({binding:t+1,resource:{buffer:this.#va[t],offset:0,size:e.byteLength}})}));const p=e.gpuDevice.createBindGroupLayout({entries:m}),f=e.gpuDevice.createPipelineLayout({bindGroupLayouts:[p]});this.#ba=e.gpuDevice.createBindGroup({layout:p,entries:d}),this.#Ta=e.gpuDevice.createComputePipeline({layout:f,compute:{module:h,entryPoint:"main"}})}#Ji(){this.#ya=new Float32Array(46);let e={size:this.#ya.byteLength,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST};const{gpuDevice:t}=this.redGPUContext;this.#_a=t.createBuffer(e),t.queue.writeBuffer(this.#_a,0,this.#ya),this.#Ma(),this.depthStencilState.depthWriteEnabled=!1}#Ra(e){const t=this.localToWorld(this.x,this.y,this.z);this.#ya.set([e,...t,this.#ks,this.#Is,this.#Us,this.#As,this.#Gs,this.#Fs,this.#ca,this.#Bs,this.#Ds,this.#Ns,this.#zs,this.#ha,this.#Ls,this.#Os,this.#Vs,this.#$s,this.#ma,this.#Hs,this.#Ks,this.#Xs,this.#js,this.#da,this.#Ys,this.#Zs,this.#qs,this.#Ws,this.#pa,this.#Js,this.#ta,this.#ia,this.#oa,this.#fa,this.#Qs,this.#ra,this.#sa,this.#ua,this.#ga,this.#ea,this.#na,this.#aa,this.#la,this.#xa],0);const{gpuDevice:r}=this.redGPUContext;r.queue.writeBuffer(this.#_a,0,this.#ya);const n=r.createCommandEncoder({}),i=n.beginComputePass();i.setPipeline(this.#Ta),i.setBindGroup(0,this.#ba),i.dispatchWorkgroups(Math.ceil(this.#Sa/256)),i.end(),r.queue.submit([n.finish()])}}function mixInMesh2D(e){const t=class extends e{#Cs=0;#wa=nr.NORMAL;get blendMode(){const e=Object.entries(nr).find((([,e])=>e===this.#wa));if(!e)throw new Error(`Invalid blendMode value:${this.#wa}`);return e[0]}set blendMode(e){let t;if("string"==typeof e){if(!(e in nr))throw new Error(`Invalid blendMode key:${e}`);t=nr[e]}else{if("number"!=typeof e||!Object.values(nr).includes(e))throw new Error(`Invalid blendMode:${e}`);t=e}this.#wa=t,this.#Ea(t)}get rotation(){return this.#Cs}set rotation(e){this.#Cs=e,super.rotationZ=e}setScale(e,t){t=t??e,super.setScale(e,t,1)}setPosition(e,t){t=t??e,super.setPosition(e,t,0)}setRotation(e){this.rotation=e}#Ea(e){const{blendColorState:t,blendAlphaState:r}=this._material;switch(e){case nr.NORMAL:t.operation=ct.ADD,t.srcFactor=lt.ONE,t.dstFactor=lt.ONE_MINUS_SRC_ALPHA,r.operation=ct.ADD,r.srcFactor=lt.ONE,r.dstFactor=lt.ONE_MINUS_SRC_ALPHA;break;case nr.MULTIPLY:t.operation=ct.ADD,t.srcFactor=lt.ONE_MINUS_DST_ALPHA,t.dstFactor=lt.ONE_MINUS_SRC_ALPHA,r.operation=ct.ADD,r.srcFactor=lt.SRC_ALPHA,r.dstFactor=lt.ONE_MINUS_SRC_ALPHA;break;case nr.LIGHTEN:t.operation=ct.MAX,t.srcFactor=lt.ONE,t.dstFactor=lt.ONE,r.operation=ct.ADD,r.srcFactor=lt.SRC_ALPHA,r.dstFactor=lt.ONE_MINUS_SRC_ALPHA;break;case nr.SCREEN:t.operation=ct.ADD,t.srcFactor=lt.ONE,t.dstFactor=lt.ONE_MINUS_SRC,r.operation=ct.ADD,r.srcFactor=lt.SRC_ALPHA,r.dstFactor=lt.ONE_MINUS_SRC_ALPHA;break;case nr.LINEAR_DODGE:t.operation=ct.ADD,t.srcFactor=lt.ONE,t.dstFactor=lt.ONE,r.operation=ct.ADD,r.srcFactor=lt.SRC_ALPHA,r.dstFactor=lt.ONE;break;case nr.SUBTRACT:t.operation=ct.REVERSE_SUBTRACT,t.srcFactor=lt.SRC_ALPHA,t.dstFactor=lt.ONE_MINUS_SRC_ALPHA,r.operation=ct.REVERSE_SUBTRACT,r.srcFactor=lt.ONE,r.dstFactor=lt.ONE;break;case nr.DIFFERENCE:t.operation=ct.SUBTRACT,t.srcFactor=lt.ONE,t.dstFactor=lt.ONE,r.operation=ct.SUBTRACT,r.srcFactor=lt.ONE,r.dstFactor=lt.ONE;break;case nr.EXCLUSION:t.operation=ct.ADD,t.srcFactor=lt.ONE_MINUS_DST_ALPHA,t.dstFactor=lt.ONE_MINUS_SRC_ALPHA,r.operation=ct.ADD,r.srcFactor=lt.ONE,r.dstFactor=lt.ONE;break;default:console.warn(`Unsupported blend mode:${e}`)}}};return Object.defineProperty(t.prototype,"is2DMeshType",{value:!0,writable:!1}),t}Object.defineProperty(ParticleEmitter.prototype,"meshType",{value:"particle",writable:!1}),Ie.defineByPreset(ParticleEmitter,[Ie.PRESET_BOOLEAN.USE_BILLBOARD]),Ie.definePositiveNumber(ParticleEmitter,[]),Object.freeze(ParticleEmitter);const $r=mixInMesh2D(Mesh);class Sprite2D extends $r{#Sr=1;#Mr=1;constructor(e,t){super(e,new Plane(e,1,1,1,1,1,!0),t),this.primitiveState.cullMode=wt.FRONT}get width(){return this.#Sr}set width(e){validatePositiveNumberRange(e),this.#Sr=e,this.dirtyTransform=!0}get height(){return this.#Mr}set height(e){validatePositiveNumberRange(e),this.#Mr=e,this.dirtyTransform=!0}get material(){return this._material}set material(e){consoleAndThrowError("Sprite2D can not change material")}setSize(e,t){this.width=e,this.height=void 0!==t?t:e}}Object.freeze(Sprite2D);var Hr="#redgpu_include SYSTEM_UNIFORM;\r\n#redgpu_include getBillboardMatrix;\r\nstruct VertexUniforms {\rpickingId:u32,\rmodelMatrix:mat4x4<f32>,\rnormalModelMatrix:mat4x4<f32>,\ruseBillboardPerspective:u32,\ruseBillboard:u32,\rbillboardFixedScale:f32,\rcombinedOpacity:f32,\r\n};\r\n\r\n\r\n@group(1) @binding(0) var<uniform> vertexUniforms:VertexUniforms;\r\n\r\nstruct InputData {\r@location(0) position:vec3<f32>,\r@location(1) vertexNormal:vec3<f32>,\r@location(2) uv:vec2<f32>,\r\n};\r\nstruct OutputData {\r@builtin(position) position:vec4<f32>,\r@location(0) vertexPosition:vec3<f32>,\r@location(1) vertexNormal:vec3<f32>,\r@location(2) uv:vec2<f32>,\r@location(12) combinedOpacity:f32,\r@location(13) shadowPos:vec3<f32>,\r@location(15) pickingId:vec4<f32>,\r\n};\r\n\r\n@vertex\r\nfn main(inputData:InputData) -> OutputData {\rvar output:OutputData;\r\n\r\rlet u_resolution=systemUniforms.resolution;\rlet u_projectionMatrix=systemUniforms.projectionMatrix;\rlet u_camera=systemUniforms.camera;\rlet u_cameraMatrix=u_camera.cameraMatrix;\rlet u_cameraPosition=u_camera.cameraPosition;\r\n\r\rlet u_modelMatrix=vertexUniforms.modelMatrix;\rlet u_normalModelMatrix=vertexUniforms.normalModelMatrix;\rlet u_useBillboardPerspective=vertexUniforms.useBillboardPerspective;\rlet u_useBillboard=vertexUniforms.useBillboard;\rlet u_billboardFixedScale=vertexUniforms.billboardFixedScale;\r\n\r\rlet input_position=inputData.position;\rlet input_vertexNormal=inputData.vertexNormal;\rlet input_positionVec4=vec4<f32>(input_position,1.0);\rlet input_vertexNormalVec4=vec4<f32>(input_vertexNormal,1.0);\rlet input_uv=inputData.uv;\r\n\r\rvar position:vec4<f32>;\rvar normalPosition:vec4<f32>;\r\n\r\n\r\n\r\rif (u_useBillboard==1) {\r\rlet projectionModelMatrix=u_projectionMatrix * u_modelMatrix;\rlet billboardMatrix=getBillboardMatrix(u_cameraMatrix,u_modelMatrix);\rlet billboardNormalMatrix=getBillboardMatrix(u_cameraMatrix,u_normalModelMatrix);\rif(u_useBillboardPerspective==1){\rposition=billboardMatrix * input_positionVec4;\rnormalPosition=billboardNormalMatrix * input_vertexNormalVec4;\r}else{\rposition=billboardMatrix * input_positionVec4;\rnormalPosition=billboardNormalMatrix * input_vertexNormalVec4;\r}\r\n\r\routput.position=u_projectionMatrix * position;\r\n\rif (u_useBillboardPerspective !=1) {\r\rvar temp=output.position/output.position.w;\r\n\r\rlet aspectRatio=u_resolution.x/u_resolution.y;\rlet scaleX=clamp((projectionModelMatrix)[1][1],-1.0,1.0)/aspectRatio;\rlet scaleY=clamp((projectionModelMatrix)[1][1],-1.0,1.0);\r\n\r\routput.position=vec4<f32>(\rtemp.xy + input_position.xy * vec2<f32>(scaleX * u_billboardFixedScale,scaleY * u_billboardFixedScale),\rtemp.zw\r);\r}\r} else {\r\rposition=u_cameraMatrix * u_modelMatrix * input_positionVec4;\rnormalPosition=u_cameraMatrix * u_normalModelMatrix * input_vertexNormalVec4;\r\n\r\routput.position=u_projectionMatrix * position;\r}\r\n\r\routput.vertexPosition=position.xyz;\routput.vertexNormal=normalPosition.xyz;\routput.uv=input_uv;\routput.combinedOpacity=vertexUniforms.combinedOpacity;\rreturn output;\r\n}\r\nstruct OutputShadowData {\r@builtin(position) position:vec4<f32>,\r\n};\r\n\r\n@vertex\r\nfn drawDirectionalShadowDepth( inputData:InputData ) -> OutputShadowData {\rvar output:OutputShadowData;\r\rlet u_directionalLightProjectionViewMatrix=systemUniforms.directionalLightProjectionViewMatrix;\rlet u_directionalLightProjectionMatrix=systemUniforms.directionalLightProjectionMatrix;\rlet u_directionalLightViewMatrix=systemUniforms.directionalLightViewMatrix;\r\rlet u_modelMatrix=vertexUniforms.modelMatrix;\rlet u_camera=systemUniforms.camera;\rlet u_cameraMatrix=u_camera.cameraMatrix;\rlet u_cameraPosition=u_camera.cameraPosition;\rlet u_useBillboardPerspective=vertexUniforms.useBillboardPerspective;\rlet u_useBillboard=vertexUniforms.useBillboard;\rlet u_billboardFixedScale=vertexUniforms.billboardFixedScale;\rlet input_position=inputData.position;\rlet input_positionVec4=vec4<f32>(input_position,1.0);\rvar position:vec4<f32>;\r\n\rreturn output;\r\n}\r\n@vertex\r\nfn picking(inputData:InputData) -> OutputData {\rvar output:OutputData;\r\n\r\rlet u_projectionMatrix=systemUniforms.projectionMatrix;\rlet u_cameraMatrix=systemUniforms.camera.cameraMatrix;\rlet u_modelMatrix=vertexUniforms.modelMatrix;\r\n\r\rlet u_useBillboardPerspective=vertexUniforms.useBillboardPerspective;\rlet u_useBillboard=vertexUniforms.useBillboard;\rlet u_billboardFixedScale=vertexUniforms.billboardFixedScale;\r\n\r\rlet input_position=inputData.position;\rlet input_positionVec4=vec4<f32>(input_position,1.0);\r\rlet u_resolution=systemUniforms.resolution;\r\n\r\rvar position:vec4<f32>;\r\n\rif (u_useBillboard==1) {\r\rlet projectionModelMatrix=u_projectionMatrix * u_modelMatrix;\rlet billboardMatrix=getBillboardMatrix(u_cameraMatrix,u_modelMatrix);\rif(u_useBillboardPerspective==1){\rposition=billboardMatrix * input_positionVec4;\r}else{\rposition=billboardMatrix * input_positionVec4;\r}\r\n\r\routput.position=u_projectionMatrix * position;\r\n\rif (u_useBillboardPerspective !=1) {\r\rvar temp=output.position/output.position.w;\r\n\r\rlet aspectRatio=u_resolution.x/u_resolution.y;\rlet scaleX=clamp((projectionModelMatrix)[1][1],-1.0,1.0)/aspectRatio;\rlet scaleY=clamp((projectionModelMatrix)[1][1],-1.0,1.0);\r\n\r\routput.position=vec4<f32>(\rtemp.xy + input_position.xy * vec2<f32>(scaleX * u_billboardFixedScale,scaleY * u_billboardFixedScale),\rtemp.zw\r);\r}\r} else {\r\rposition=u_cameraMatrix * u_modelMatrix * input_positionVec4;\routput.position=u_projectionMatrix * position;\r}\r\n\r\routput.pickingId=unpack4x8unorm(vertexUniforms.pickingId);\r\n\rreturn output;\r\n}\r\n";const Kr=parseWGSL(Hr),Xr=Kr.uniforms.vertexUniforms;class Sprite3D extends Mesh{constructor(e,t,r){super(e),this._geometry=r||new Plane(e),this._material=t,this._material.transparent=!0,this.dirtyPipeline=!0,this.dirtyTransform=!0,this.primitiveState.cullMode=wt.NONE}createCustomMeshVertexShaderModule(){return this.createMeshVertexShaderModuleBASIC("VERTEX_MODULE_SPRITE_3D",Kr,Xr,Hr)}}Ie.defineByPreset(Sprite3D,[[Ie.PRESET_BOOLEAN.USE_BILLBOARD_PERSPECTIVE,!0],[Ie.PRESET_BOOLEAN.USE_BILLBOARD,!0],[Ie.PRESET_POSITIVE_NUMBER.BILLBOARD_FIXED_SCALE,.1,.1]]),Object.freeze(Sprite3D);class ASpriteSheet extends Mesh{#Pa=0;#Ca=0;#ka=0;#Ia=!0;#Ua=!0;#Ba;#La;#Aa="play";constructor(e,t,r){super(e),this.#La=r,this._material=new BitmapMaterial(e),this._material.transparent=!0,this.dirtyPipeline=!0,this.dirtyTransform=!0,this.spriteSheetInfo=t}get state(){return this.#Aa}get loop(){return this.#Ua}set loop(e){this.#Ua=e}get frameRate(){return this.#Pa}set frameRate(e){e<0&&(e=0),0===this.#Pa&&e&&(this.#Ca=0),this.#Pa=e,this.#ka=1e3/this.#Pa}get geometry(){return this._geometry}set geometry(e){consoleAndThrowError("ASpriteSheet can not change geometry")}get material(){return this._material}set material(e){consoleAndThrowError("ASpriteSheet can not change material")}get spriteSheetInfo(){return this.#Ba}set spriteSheetInfo(e){this.#Ba=e,this.frameRate=e.frameRate,this.segmentW=e.segmentW,this.segmentH=e.segmentH,this.totalFrame=e.totalFrame,this.currentIndex=e.startIndex,this.#Ua=!0,this.#Ca=0,this._material.diffuseTexture=e.texture}play(){this.#Ia=!0,this.#Aa="play",this.#Ca=0}pause(){this.#Ia=!1,this.#Aa="pause"}stop(){this.#Ia=!1,this.currentIndex=0,this.#Aa="stop"}render(e){const{diffuseTexture:t}=this._material;this.#La(t,this.segmentW,this.segmentH);const{timestamp:r}=e;if(this.#Ca||(this.#Ca=this.#ka+r),this.#Ia&&this.#Ca<r&&this.#Pa){const e=Math.floor((r-this.#Ca)/this.#ka),t=(Number.isFinite(e)?e:0)||1;this.#Ca=this.#ka+r,this.currentIndex+=t,this.currentIndex>=this.totalFrame&&(this.loop?(this.#Ia=!0,this.currentIndex=0):(this.#Ia=!1,this.currentIndex=this.totalFrame-1))}super.render(e)}}Ie.definePositiveNumber(ASpriteSheet,[["segmentW",5],["segmentH",3],["totalFrame",15],["currentIndex",0]]),Object.freeze(ASpriteSheet);var jr="#redgpu_include SYSTEM_UNIFORM;\r\n#redgpu_include getBillboardMatrix;\r\nstruct VertexUniforms {\rpickingId:u32,\rmodelMatrix:mat4x4<f32>,\rnormalModelMatrix:mat4x4<f32>,\rsegmentW:f32,\rsegmentH:f32,\rtotalFrame:f32,\rcurrentIndex:f32,\rcombinedOpacity:f32,\r\n};\r\n\r\n\r\n@group(1) @binding(0) var<uniform> vertexUniforms:VertexUniforms;\r\n\r\nstruct InputData {\r@location(0) position:vec3<f32>,\r@location(1) vertexNormal:vec3<f32>,\r@location(2) uv:vec2<f32>,\r\n};\r\nstruct OutputData {\r@builtin(position) position:vec4<f32>,\r@location(0) vertexPosition:vec3<f32>,\r@location(1) vertexNormal:vec3<f32>,\r@location(2) uv:vec2<f32>,\r@location(12) combinedOpacity:f32,\r@location(13) shadowPos:vec3<f32>,\r@location(15) pickingId:vec4<f32>,\r\n};\r\n\r\n\r\n@vertex\r\nfn main( inputData:InputData ) -> OutputData {\rvar output:OutputData;\r\n\r\rlet u_projectionMatrix=systemUniforms.projectionMatrix;\rlet u_camera=systemUniforms.camera;\rlet u_cameraMatrix=u_camera.cameraMatrix;\rlet u_cameraPosition=u_camera.cameraPosition;\r\rlet u_modelMatrix=vertexUniforms.modelMatrix;\rlet u_normalModelMatrix=vertexUniforms.normalModelMatrix;\r\n\r\n\r\rlet input_position=inputData.position;\rlet input_vertexNormal=inputData.vertexNormal;\rlet input_uv=inputData.uv;\r\n\rvar position:vec4<f32>;\rvar normalPosition:vec4<f32>;\r\n\rposition=u_cameraMatrix * u_modelMatrix * vec4<f32>(input_position,1.0);\rnormalPosition=u_cameraMatrix * u_normalModelMatrix * vec4<f32>(input_vertexNormal,1.0);\r\n\routput.position=u_projectionMatrix * position;\routput.vertexPosition=position.xyz;\routput.vertexNormal=normalPosition.xyz;\routput.combinedOpacity=vertexUniforms.combinedOpacity;\r\n\rlet uv=vec2<f32>(\rinput_uv.x * 1/vertexUniforms.segmentW + ((vertexUniforms.currentIndex % vertexUniforms.segmentW)/vertexUniforms.segmentW),\rinput_uv.y * 1/vertexUniforms.segmentH - (floor(vertexUniforms.currentIndex/vertexUniforms.segmentH)/vertexUniforms.segmentH)\r);\r\n\routput.uv=uv;\rreturn output;\r\n}\r\nstruct OutputShadowData {\r@builtin(position) position:vec4<f32>,\r\n};\r\n\r\n@vertex\r\nfn drawDirectionalShadowDepth( inputData:InputData ) -> OutputShadowData {\rvar output:OutputShadowData;\r\rlet u_directionalLightProjectionViewMatrix=systemUniforms.directionalLightProjectionViewMatrix;\rlet u_directionalLightProjectionMatrix=systemUniforms.directionalLightProjectionMatrix;\rlet u_directionalLightViewMatrix=systemUniforms.directionalLightViewMatrix;\r\rlet u_modelMatrix=vertexUniforms.modelMatrix;\rlet u_camera=systemUniforms.camera;\rlet u_cameraMatrix=u_camera.cameraMatrix;\rlet u_cameraPosition=u_camera.cameraPosition;\rlet input_position=inputData.position;\rvar position:vec4<f32>;\r\n\rreturn output;\r\n}\r\n\r\n@vertex\r\nfn picking(inputData:InputData) -> OutputData {\rvar output:OutputData;\rlet u_projectionMatrix=systemUniforms.projectionMatrix;\rlet u_camera=systemUniforms.camera;\rlet u_cameraMatrix=u_camera.cameraMatrix;\rlet u_cameraPosition=u_camera.cameraPosition;\r\rlet u_modelMatrix=vertexUniforms.modelMatrix;\rlet u_normalModelMatrix=vertexUniforms.normalModelMatrix;\r\r\n\r\rlet input_position=inputData.position;\rlet input_vertexNormal=inputData.vertexNormal;\rlet input_uv=inputData.uv;\r\n\rvar position:vec4<f32>;\rvar normalPosition:vec4<f32>;\r\n\rposition=u_cameraMatrix * u_modelMatrix * vec4<f32>(input_position,1.0);\rnormalPosition=u_cameraMatrix * u_normalModelMatrix * vec4<f32>(input_vertexNormal,1.0);\routput.position=u_projectionMatrix * position;\r\n\routput.pickingId=unpack4x8unorm(vertexUniforms.pickingId);\rreturn output;\r\n}\r\n";const Yr=parseWGSL(jr),Zr=Yr.uniforms.vertexUniforms,qr=mixInMesh2D(ASpriteSheet);class SpriteSheet2D extends qr{#Sr=1;#Mr=1;constructor(e,t){super(e,t,((e,t,r)=>{if(e){const{gpuTexture:n}=e,i=n?.width/t,s=n?.height/r;i===this.#Sr&&s===this.#Mr||(this.#Sr=n?.width/t,this.#Mr=n?.height/r,this.dirtyTransform=!0)}else this.#Sr=1,this.#Mr=1})),this._geometry=new Plane(e,1,1,1,1,1,!0),this.primitiveState.cullMode=wt.FRONT}get width(){return this.#Sr}get height(){return this.#Mr}get geometry(){return this._geometry}set geometry(e){consoleAndThrowError("SpriteSheet2D can not change geometry")}get material(){return this._material}set material(e){consoleAndThrowError("SpriteSheet2D can not change material")}createCustomMeshVertexShaderModule(){return this.createMeshVertexShaderModuleBASIC("VERTEX_MODULE_SPRITE_SHEET_2D",Yr,Zr,jr)}}Object.freeze(SpriteSheet2D);var Wr="#redgpu_include SYSTEM_UNIFORM;\r\n#redgpu_include getBillboardMatrix;\r\nstruct VertexUniforms {\rpickingId:u32,\rmodelMatrix:mat4x4<f32>,\rnormalModelMatrix:mat4x4<f32>,\ruseBillboardPerspective:u32,\ruseBillboard:u32,\rsegmentW:f32,\rsegmentH:f32,\rtotalFrame:f32,\rcurrentIndex:f32,\rbillboardFixedScale:f32,\r_renderRatioX:f32,\r_renderRatioY:f32,\rcombinedOpacity:f32,\r\n};\r\n\r\n\r\n@group(1) @binding(0) var<uniform> vertexUniforms:VertexUniforms;\r\n\r\nstruct InputData {\r@location(0) position:vec3<f32>,\r@location(1) vertexNormal:vec3<f32>,\r@location(2) uv:vec2<f32>,\r\n};\r\nstruct OutputData {\r@builtin(position) position:vec4<f32>,\r@location(0) vertexPosition:vec3<f32>,\r@location(1) vertexNormal:vec3<f32>,\r@location(2) uv:vec2<f32>,\r@location(12) combinedOpacity:f32,\r@location(13) shadowPos:vec3<f32>,\r@location(15) pickingId:vec4<f32>,\r\n};\r\n\r\n\r\n@vertex\r\nfn main( inputData:InputData ) -> OutputData {\rvar output:OutputData;\r\n\r\rlet u_resolution=systemUniforms.resolution;\rlet u_projectionMatrix=systemUniforms.projectionMatrix;\rlet u_camera=systemUniforms.camera;\rlet u_cameraMatrix=u_camera.cameraMatrix;\rlet u_cameraPosition=u_camera.cameraPosition;\r\rlet u_modelMatrix=vertexUniforms.modelMatrix;\rlet u_normalModelMatrix=vertexUniforms.normalModelMatrix;\r\n\rlet u_useBillboardPerspective=vertexUniforms.useBillboardPerspective;\rlet u_useBillboard=vertexUniforms.useBillboard;\rlet u_billboardFixedScale=vertexUniforms.billboardFixedScale;\rlet u_renderRatioX=vertexUniforms._renderRatioX;\rlet u_renderRatioY=vertexUniforms._renderRatioY;\rvar ratioScaleMatrix:mat4x4<f32>=mat4x4<f32>(\ru_renderRatioX,0,0,0,\r0,u_renderRatioY,0,0,\r0,0,1,0,\r0,0,0,1\r);\r\n\r\n\r\rlet input_position=inputData.position;\rlet input_vertexNormal=inputData.vertexNormal;\rlet input_uv=inputData.uv;\r\n\rvar position:vec4<f32>;\rvar normalPosition:vec4<f32>;\r\n\r\rif (u_useBillboard==1) {\r\rif(u_useBillboardPerspective==1){\rposition=getBillboardMatrix(u_cameraMatrix,u_modelMatrix) * ratioScaleMatrix * vec4<f32>(input_position,1.0);\rnormalPosition=getBillboardMatrix(u_cameraMatrix,u_normalModelMatrix) * ratioScaleMatrix *vec4<f32>(input_vertexNormal,1.0);\r}else{\rposition=getBillboardMatrix(u_cameraMatrix,u_modelMatrix) * ratioScaleMatrix *vec4<f32>(input_position,1.0);\rnormalPosition=getBillboardMatrix(u_cameraMatrix,u_normalModelMatrix) * ratioScaleMatrix * vec4<f32>(input_vertexNormal,1.0);\r}\r\n\r\routput.position=u_projectionMatrix * position;\r\n\rif (u_useBillboardPerspective !=1) {\r\rvar temp=output.position/output.position.w;\r\n\r\rlet aspectRatio=u_resolution.x/u_resolution.y;\rlet scaleX=clamp((u_projectionMatrix)[1][1],-1.0,1.0)/aspectRatio * u_renderRatioX;\rlet scaleY=clamp((u_projectionMatrix)[1][1],-1.0,1.0) * u_renderRatioY;\r\n\r\routput.position=vec4<f32>(\rtemp.xy + input_position.xy * vec2<f32>(scaleX * u_billboardFixedScale,scaleY * u_billboardFixedScale),\rtemp.zw\r);\r}\r} else {\r\rposition=u_cameraMatrix * u_modelMatrix * ratioScaleMatrix * vec4<f32>(input_position,1.0);\rnormalPosition=u_cameraMatrix * u_normalModelMatrix * ratioScaleMatrix * vec4<f32>(input_vertexNormal,1.0);\r\n\r\routput.position=u_projectionMatrix * position;\r}\r\n\r\n\routput.vertexPosition=position.xyz;\routput.vertexNormal=normalPosition.xyz;\routput.combinedOpacity=vertexUniforms.combinedOpacity;\r\n\r\n\rlet uv=vec2<f32>(\rinput_uv.x * 1/vertexUniforms.segmentW + ((vertexUniforms.currentIndex % vertexUniforms.segmentW)/vertexUniforms.segmentW),\rinput_uv.y * 1/vertexUniforms.segmentH - (floor(vertexUniforms.currentIndex/vertexUniforms.segmentH)/vertexUniforms.segmentH)\r);\r\n\routput.uv=uv;\rreturn output;\r\n}\r\nstruct OutputShadowData {\r@builtin(position) position:vec4<f32>,\r\n};\r\n\r\n@vertex\r\nfn drawDirectionalShadowDepth( inputData:InputData ) -> OutputShadowData {\rvar output:OutputShadowData;\r\rlet u_directionalLightProjectionViewMatrix=systemUniforms.directionalLightProjectionViewMatrix;\rlet u_directionalLightProjectionMatrix=systemUniforms.directionalLightProjectionMatrix;\rlet u_directionalLightViewMatrix=systemUniforms.directionalLightViewMatrix;\r\rlet u_modelMatrix=vertexUniforms.modelMatrix;\rlet u_camera=systemUniforms.camera;\rlet u_cameraMatrix=u_camera.cameraMatrix;\rlet u_cameraPosition=u_camera.cameraPosition;\rlet u_useBillboardPerspective=vertexUniforms.useBillboardPerspective;\rlet u_useBillboard=vertexUniforms.useBillboard;\rlet input_position=inputData.position;\rvar position:vec4<f32>;\r\n\rreturn output;\r\n}\r\n\r\n@vertex\r\nfn picking(inputData:InputData) -> OutputData {\rvar output:OutputData;\r\n\r\rlet u_projectionMatrix=systemUniforms.projectionMatrix;\rlet u_cameraMatrix=systemUniforms.camera.cameraMatrix;\rlet u_modelMatrix=vertexUniforms.modelMatrix;\r\n\r\rlet u_useBillboardPerspective=vertexUniforms.useBillboardPerspective;\rlet u_useBillboard=vertexUniforms.useBillboard;\rlet u_billboardFixedScale=vertexUniforms.billboardFixedScale;\rlet u_renderRatioX=vertexUniforms._renderRatioX;\rlet u_renderRatioY=vertexUniforms._renderRatioY;\rvar ratioScaleMatrix:mat4x4<f32>=mat4x4<f32>(\ru_renderRatioX,0,0,0,\r0,u_renderRatioY,0,0,\r0,0,1,0,\r0,0,0,1\r);\r\n\r\rlet input_position=inputData.position;\r\n\r\rlet u_resolution=systemUniforms.resolution;\r\n\r\rvar position:vec4<f32>;\r\n\rif (u_useBillboard==1) {\r\rif(u_useBillboardPerspective==1){\rposition=getBillboardMatrix(u_cameraMatrix,u_modelMatrix) * ratioScaleMatrix * vec4<f32>(input_position,1.0);\r}else{\rposition=getBillboardMatrix(u_cameraMatrix,u_modelMatrix) * ratioScaleMatrix *vec4<f32>(input_position,1.0);\r}\r\n\r\routput.position=u_projectionMatrix * position;\r\n\rif (u_useBillboardPerspective !=1) {\r\rvar temp=output.position/output.position.w;\r\n\r\rlet aspectRatio=u_resolution.x/u_resolution.y;\rlet scaleX=clamp((u_projectionMatrix)[1][1],-1.0,1.0)/aspectRatio * u_renderRatioX;\rlet scaleY=clamp((u_projectionMatrix)[1][1],-1.0,1.0) * u_renderRatioY;\r\n\r\routput.position=vec4<f32>(\rtemp.xy + input_position.xy * vec2<f32>(scaleX * u_billboardFixedScale,scaleY * u_billboardFixedScale),\rtemp.zw\r);\r}\r} else {\r\rposition=u_cameraMatrix * u_modelMatrix * ratioScaleMatrix * vec4<f32>(input_position,1.0);\r\routput.position=u_projectionMatrix * position;\r}\r\n\r\routput.pickingId=unpack4x8unorm(vertexUniforms.pickingId);\r\n\rreturn output;\r\n}\r\n";const Jr=parseWGSL(Wr),Qr=Jr.uniforms.vertexUniforms;class SpriteSheet3D extends ASpriteSheet{#Da=1;#Oa=1;constructor(e,t){super(e,t,((e,t,r)=>{if(e){const{gpuTexture:n}=e,i=n?.width/t,s=n?.height/r;i===this.#Da&&s===this.#Oa||(this.#Da=n?.width/t,this.#Oa=n?.height/r,this.#Oa>this.#Da?(this._renderRatioX=1,this._renderRatioY=this.#Oa/this.#Da):(this._renderRatioX=this.#Da/this.#Oa,this._renderRatioY=1),this.dirtyTransform=!0)}else this.#Da=1,this.#Oa=1})),this._geometry=new Plane(e)}get geometry(){return this._geometry}set geometry(e){consoleAndThrowError("SpriteSheet3D can not change geometry")}get material(){return this._material}set material(e){consoleAndThrowError("SpriteSheet3D can not change material")}createCustomMeshVertexShaderModule(){return this.createMeshVertexShaderModuleBASIC("VERTEX_MODULE_SPRITE_SHEET_3D",Jr,Qr,Wr)}}Ie.definePositiveNumber(SpriteSheet3D,[["_renderRatioX",1],["_renderRatioY",1]]),Ie.defineByPreset(SpriteSheet3D,[[Ie.PRESET_BOOLEAN.USE_BILLBOARD_PERSPECTIVE,!0],[Ie.PRESET_BOOLEAN.USE_BILLBOARD,!0],[Ie.PRESET_POSITIVE_NUMBER.BILLBOARD_FIXED_SCALE,.1,.1]]),Object.freeze(SpriteSheet3D);class SpriteSheetInfo{#Ga=0;#Na=0;#Va=0;#Fa=0;#Pa=0;#Ua=!0;#za;constructor(e,t,r,n,i,s,a=!0,o=60){validateRedGPUContext(e),validateUintRange(r),validateUintRange(n),validateUintRange(i),validateUintRange(s),validateUintRange(o),this.#Ga=r,this.#Na=n,this.#Va=i,this.#Fa=s,this.#za=new BitmapTexture(e,t),this.#Ua=a,this.#Pa=o}get segmentW(){return this.#Ga}get segmentH(){return this.#Na}get totalFrame(){return this.#Va}get startIndex(){return this.#Fa}get texture(){return this.#za}get frameRate(){return this.#Pa}get loop(){return this.#Ua}}Object.freeze(SpriteSheetInfo);const en=parseWGSL("#redgpu_include drawPicking;\r\nstruct Uniforms {\r\topacity:f32\r\n};\r\n\r\nstruct InputData {\r\r@builtin(position) position:vec4<f32>,\r@location(0) vertexPosition:vec3<f32>,\r@location(1) vertexColor:vec4<f32>,\r@location(15) pickingId:vec4<f32>,\r\n}\r\n\r\n@group(2) @binding(0) var<uniform> uniforms:Uniforms;\r\n@fragment\r\nfn main(inputData:InputData) -> @location(0) vec4<f32> {\rreturn inputData.vertexColor;\r\n}\r\n\r\n\r\n");class LineMaterial extends ABaseMaterial{constructor(e,t){super(e,"LINE_MATERIAL",en,2),t&&(this.name=t),this.initGPURenderInfos()}}Object.freeze(LineMaterial);class LinePoint{position;colorRGBA;constructor(e=0,t=0,r=0,n){this.position=[e,t,r],this.colorRGBA=n}}const getPointsOnBezierCurveWithSplitting=(e,t,r,n)=>{let i=n||[];if(((e,t)=>{let r=e[t].position,n=e[t+1].position,i=e[t+2].position,s=e[t+3].position,a=3*n[0]-2*r[0]-s[0],o=3*n[1]-2*r[1]-s[1],u=3*i[0]-2*s[0]-r[0],l=3*i[1]-2*s[1]-r[1];return a*=a,o*=o,u*=u,l*=l,a<u&&(a=u),o<l&&(o=l),a+o})(e,t)<r)i.push(e[t],e[t+3]);else{let n=.5,s=e[t],a=e[t+1],o=e[t+2],u=e[t+3],l=lerp$4(create$4(),s.position,a.position,n),c=lerp$4(create$4(),a.position,o.position,n),h=lerp$4(create$4(),o.position,u.position,n),m=lerp$4(create$4(),l,c,n),d=lerp$4(create$4(),c,h,n),p=lerp$4(create$4(),m,d,n);p=new LinePoint(p[0],p[1],p[2],s.colorRGBA),l=new LinePoint(l[0],l[1],l[2],l.colorRGBA),h=new LinePoint(h[0],h[1],h[2],h.colorRGBA),m=new LinePoint(m[0],m[1],m[2],m.colorRGBA),d=new LinePoint(d[0],d[1],d[2],d.colorRGBA),getPointsOnBezierCurveWithSplitting([s,l,m,p],0,r,i),getPointsOnBezierCurveWithSplitting([p,d,h,u],0,r,i)}return i};class LinePointWithInOut{inLinePoint;linePoint;outLinePoint;constructor(e=0,t=0,r=0,n=0,i=0,s=0,a=0,o=0,u=0,l,c){let h=[...convertHexToRgb(l,!0)];h=[h[0]/255,h[1]/255,h[2]/255,c],this.inLinePoint=new LinePoint(n,i,s,h),this.linePoint=new LinePoint(e,t,r,h),this.outLinePoint=new LinePoint(a,o,u,h)}}const lineVec2DistanceToSegmentSq=function(e,t,r){e=[e[0],e[1]],t=[t[0],t[1]],r=[r[0],r[1]];let n=be(t,r);if(0===n)return be(e,t);let i=((e[0]-t[0])*(r[0]-t[0])+(e[1]-t[1])*(r[1]-t[1]))/n;return i=Math.max(0,Math.min(1,i)),be(e,lerp([0,0],t,r,i))},lineSimplifyPoints=(e,t,r,n,i)=>{let s=i||[],a=e[t],o=e[r-1],u=0,l=1,c=t+1;for(;c<r-1;++c){let t=lineVec2DistanceToSegmentSq(e[c].position,a.position,o.position);t>u&&(u=t,l=c)}return Math.sqrt(u)>n?(lineSimplifyPoints(e,t,l+1,n,s),lineSimplifyPoints(e,l,r,n,s)):s.push(a,o),s},tn={LINEAR:"linear",CATMULL_ROM:"catmullRom",BEZIER:"bezier"};Object.freeze(tn);var rn="#redgpu_include SYSTEM_UNIFORM;\r\nstruct VertexUniforms {\rpickingId:u32,\rmodelMatrix:mat4x4<f32>,\rnormalModelMatrix:mat4x4<f32>,\r\n};\r\n@group(1) @binding(0) var<uniform> vertexUniforms:VertexUniforms;\r\n\r\nstruct InputData {\r@location(0) position:vec3<f32>,\r@location(1) vertexColor:vec4<f32>,\r\n};\r\nstruct OutputData {\r@builtin(position) position:vec4<f32>,\r@location(0) vertexPosition:vec3<f32>,\r@location(1) vertexColor:vec4<f32>,\r\n\r\n\r\n\r@location(15) pickingId:vec4<f32>,\r\n};\r\n\r\n@vertex\r\nfn main( inputData:InputData ) -> OutputData {\rvar output:OutputData;\r\n\r\rlet u_projectionMatrix=systemUniforms.projectionMatrix;\rlet u_resolution=systemUniforms.resolution;\rlet u_camera=systemUniforms.camera;\rlet u_cameraMatrix=u_camera.cameraMatrix;\rlet u_cameraPosition=u_camera.cameraPosition;\r\rlet u_modelMatrix=vertexUniforms.modelMatrix;\r\rlet input_position=inputData.position;\rlet input_vertexColor=inputData.vertexColor;\r\n\rvar position:vec4<f32>;\rposition=u_modelMatrix * vec4<f32>(input_position,1.0);\routput.position=u_projectionMatrix * u_cameraMatrix * position;\routput.vertexPosition=position.xyz;\routput.vertexColor=input_vertexColor;\rreturn output;\r\n}\r\nstruct OutputShadowData {\r@builtin(position) position:vec4<f32>,\r\n};\r\n@vertex\r\nfn picking(inputData:InputData) -> OutputData {\r\n\rvar output:OutputData;\rreturn output;\r\n}\r\n";const nn=parseWGSL(rn),sn=nn.uniforms.vertexUniforms;class Line3D extends Mesh{baseColor;#$a;#Ha=1;#Ka=.01;#dr=.01;#Xa=[];#ja=[];#Ya;constructor(e,t=tn.LINEAR,r="#fff"){super(e),this.primitiveState.topology=Ct.LINE_STRIP,this.baseColor=r,this.#$a=t,this._geometry=new Geometry(e,new VertexBuffer(e,this.#Xa,new InterleavedStruct({vertexPosition:InterleaveType.float32x3,vertexColor:InterleaveType.float32x4}))),this._material=new LineMaterial(e)}get originalPoints(){return this.#ja}get type(){return this.#$a}set type(e){this.#$a=e,this.#Za()}get interleaveData(){return this.#Xa}get tension(){return this.#Ha}set tension(e){validatePositiveNumberRange(e),this.#Ha=e,this.#Za()}get tolerance(){return this.#Ka}set tolerance(e){validatePositiveNumberRange(e),this.#Ka=e,this.#Za()}get distance(){return this.#dr}set distance(e){validatePositiveNumberRange(e),this.#dr=e,this.#Za()}get numPoints(){return this.#ja.length}get geometry(){return this._geometry}set geometry(e){consoleAndThrowError("Line3D can not change geometry")}get material(){return this._material}set material(e){consoleAndThrowError("Line3D can not change material")}createCustomMeshVertexShaderModule(){return this.createMeshVertexShaderModuleBASIC("VERTEX_MODULE_LINE_3D",nn,sn,rn)}addPoint(e=0,t=0,r=0,n=this.baseColor,i=1,s=0,a=0,o=0,u=0,l=0,c=0){this.#ja.push(new LinePointWithInOut(e,t,r,s,a,o,u,l,c,n,i)),this.#Za()}addPointAt(e,t=0,r=0,n=0,i=this.baseColor,s=1,a=0,o=0,u=0,l=0,c=0,h=0){this.#ja.length<e&&(e=this.#ja.length),null!=e?this.#ja.splice(e,0,new LinePointWithInOut(t,r,n,a,o,u,l,c,h,i,s)):this.#ja.push(new LinePointWithInOut(t,r,n,a,o,u,l,c,h,i,s)),this.#Za()}removePointAt(e){validateUintRange(e),this.#ja[e]?this.#ja.splice(e,1):consoleAndThrowError("removeChildAt","index    .",":"+e),this.#Za()}removeAllPoint(){this.#ja.length=0,this.#Za()}#je(){if(this._geometry,this.#ja.length){const{redGPUContext:e}=this;this._geometry=new Geometry(e,new VertexBuffer(e,this.#Xa,new InterleavedStruct({vertexPosition:InterleaveType.float32x3,vertexColor:InterleaveType.float32x4})))}this.dirtyPipeline=!0}#Za(){const e=this.#ja,t=this.#Ha,r=this.#Ka,n=this.#dr;let i,s,a,o;switch(this.#Xa.length=0,this.#$a){case tn.CATMULL_ROM:case tn.BEZIER:if(e.length>1)for(this.#Ya=(e=>{let t,r=[],n=0,i=0;const s=e.length;for(;n<s;n++){t=e[n];const{inLinePoint:s,linePoint:a,outLinePoint:o}=t;0===i?(r[i++]=a,r[i++]=o):(r[i++]=s,r[i++]=a,e[n+1]&&(r[i++]=o))}return r})(tn.CATMULL_ROM===this.#$a?((e,t=1)=>{const r=e.length,n=r-2;for(let i=0;i<r-1;i++){const r=i?e[i-1].linePoint.position:e[i].linePoint.position,s=e[i].linePoint.position,a=e[i+1].linePoint.position,o=i===n?a:e[i+2].linePoint.position;e[i].outLinePoint.position=[s[0]+(a[0]-r[0])/6*t,s[1]+(a[1]-r[1])/6*t,s[2]+(a[2]-r[2])/6*t],e[i+1].inLinePoint.position=[a[0]-(o[0]-s[0])/6*t,a[1]-(o[1]-s[1])/6*t,a[2]-(o[2]-s[2])/6*t]}return e})(e,t):e),i=((e,t)=>{let r=[],n=(e.length-1)/3;n=Math.floor(n);let i,s=0;for(;s<n;++s)i=3*s,getPointsOnBezierCurveWithSplitting(e,i,t,r);return r})(this.#Ya,r),i=lineSimplifyPoints(i,0,i.length,n),s=0,a=i.length;s<a;s++)o=i[s],this.#Xa.push(...o.position,...o.colorRGBA);else this.#Xa.push(0,0,0,1,1,1,1);break;default:for(s=0,a=e.length;s<a;s++){const{linePoint:t}=e[s],r=t.colorRGBA;this.interleaveData.push(...t.position,...r)}}this.#je()}}Object.freeze(Line3D);const an=parseWGSL(rn),on=an.uniforms.vertexUniforms;const un=";box-sizing:content-box;white-space:nowrap;",cn={padding:0,background:"transparent",color:"#fff",fontFamily:"Arial",fontSize:16,fontWeight:"normal",fontStyle:"normal",letterSpacing:0,wordBreak:"keep-all",verticalAlign:"middle",textAlign:"center",lineHeight:1.4,border:"",boxShadow:"none",boxSizing:"border-box",filter:""};class ATextField extends Mesh{#qa;#Wa;#Ja;#Qa;#eo;#to;#ro;#no=!0;#v;#io;#so=!1;#ao=!1;#oo=!1;constructor(e,t,r=!0){super(e),this.#v=e,this.#no=r,this.#ro=t,this._material=new BitmapMaterial(e,new BitmapTexture(e)),this._material.transparent=!0,this._material.diffuseTextureSampler=new Sampler(e,r?{minFilter:Be.LINEAR,magFilter:Be.LINEAR,mipmapFilter:Le.LINEAR}:{minFilter:Be.NEAREST,magFilter:Be.NEAREST,mipmapFilter:null}),this.depthStencilState.depthWriteEnabled=!1,this.#uo(),this.#lo(),this.#co(),this.#ho(),this.#mo()}get text(){return this.#to}set text(e){this.#to=e;const t=this.#Ja.querySelector("foreignObject div"),r=this.#do(e);this.#Qa.innerHTML=r,t.innerHTML=r,this.#po()}render(e){this.#ro(this.#eo.width,this.#eo.height),super.render(e)}#do(e){return e.toString().replace(/\<br\/>/gi,"<div/>")}#uo(){"undefined"!=typeof OffscreenCanvas?this.#qa=new OffscreenCanvas(100,100):this.#qa=document.createElement("canvas"),this.#Wa=this.#qa.getContext("2d")}#fo(){const e=this.#Qa.getBoundingClientRect();const t=e.width+2+2,r=e.height+2+2;return{width:-2&Math.ceil(t),height:-2&Math.ceil(r),extraTop:2,extraRight:2,extraBottom:2,extraLeft:2}}#po(){if(this.#so=!0,this.#ao)return void(this.#oo=!0);this.#ao=!0;const updateFrame=()=>{if(this.#so){this.#so=!1;const e=this.#Ja,t=e.querySelector("foreignObject"),{width:r,height:n,extraTop:i,extraRight:s,extraBottom:a,extraLeft:o}=this.#fo();t.setAttribute("width",r.toString()),t.setAttribute("height",n.toString()),t.style.padding=`${i}px ${s}px ${a}px ${o}px`,e.setAttribute("width",r.toString()),e.setAttribute("height",n.toString()),this.#eo.src="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(e.outerHTML)}this.#oo?(this.#so=!0,this.#oo=!1,requestAnimationFrame(updateFrame)):this.#ao=!1};requestAnimationFrame(updateFrame)}#ho(){this.#eo=new Image,this.#eo.style.cssText="position:absolute;bottom:0px;left:0;",this.#eo.onload=e=>{let t,r;const{width:n,height:i}=this.#fo(),s=(this.#no,2),a=this.#no?1:2;t=n*s,r=i*s,this.#eo.width=t/a,this.#eo.height=r/a,this.#qa.width=t,this.#qa.height=r,this.#qa instanceof OffscreenCanvas||(this.#qa.style.width=t/s+"px",this.#qa.style.height=r/s+"px"),this.#Wa.imageSmoothingEnabled=!0,this.#Wa.imageSmoothingQuality="high",this.#Wa.clearRect(0,0,t,r),this.#Wa.fillStyle="rgba(0,0,0,0)",this.#Wa.fillRect(0,0,t,r),this.#Wa.drawImage(this.#eo,0,0,t,r),this.dirtyTransform=!0;const callback=e=>{this.material.diffuseTexture.src=URL.createObjectURL(e)};this.#qa instanceof OffscreenCanvas?this.#qa.convertToBlob({type:"image/png"}).then(callback):this.#qa.toBlob(callback,"image/png")}}#go=(e,t)=>{const r=this.#Ja.querySelector("foreignObject > div").style,n=this.#Qa.style,i=`_${e}`;this[i]=t,Object.defineProperty(this,e,{get:()=>this[i],set:t=>{this[i]=t,(e=>"number"==typeof e)(t)&&(e=>!["lineHeight","fontWeight"].includes(e))(e)&&(t=`${t}px`),r[e]=t,n[e]=t,this.#io&&cancelAnimationFrame(this.#io),this.#io=requestAnimationFrame((()=>{this.#po()}))}}),this[e]=t};#lo(){this.#Qa=document.createElement("div"),this.#Qa.style.cssText=un+";position:absolute;top:200px;left:0;visibility:hidden;text-rendering:optimizeLegibility",document.body.appendChild(this.#Qa)}#co(){const e=this.#Ja=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttribute("xmlns","http://www.w3.org/2000/svg"),e.setAttribute("text-rendering","optimizeLegibility"),e.style.cssText="position:absolute;top:0px;left:0px;z-index:1;margin:0;padding:0;overflow:visible;background:transparent",e.innerHTML=`<rect x="0" y="0" width="100%" height="100%" fill="rgba(0,0,0,0)"/><foreignObject width="100%" height="100%" style="margin:0;padding:0;" overflow="visible"><div xmlns="http://www.w3.org/1999/xhtml" style="${un}"></div></foreignObject>`}#mo(){for(const[e,t]of Object.entries(cn))this.#go(e,t)}}Object.freeze(ATextField);var hn="#redgpu_include SYSTEM_UNIFORM;\r\n#redgpu_include getBillboardMatrix;\r\nstruct VertexUniforms {\rpickingId:u32,\r\n\t modelMatrix:mat4x4<f32>,\r\n\t normalModelMatrix:mat4x4<f32>,\r\n\t useBillboardPerspective:u32,\r\n\t useBillboard:u32,\r\n\t combinedOpacity:f32,\r\n};\r\n\r\n\r\n@group(1) @binding(0) var<uniform> vertexUniforms:VertexUniforms;\r\n\r\nstruct InputData {\r@location(0) position:vec3<f32>,\r@location(1) vertexNormal:vec3<f32>,\r@location(2) uv:vec2<f32>,\r\n};\r\nstruct OutputData {\r@builtin(position) position:vec4<f32>,\r@location(0) vertexPosition:vec3<f32>,\r@location(1) vertexNormal:vec3<f32>,\r@location(2) uv:vec2<f32>,\r@location(12) combinedOpacity:f32,\r@location(13) shadowPos:vec3<f32>,\r@location(15) pickingId:vec4<f32>,\r\n};\r\n\r\n@vertex\r\nfn main( inputData:InputData ) -> OutputData {\rvar output:OutputData;\r\n\r\rlet u_resolution=systemUniforms.resolution;\rlet u_projectionMatrix=systemUniforms.projectionMatrix;\rlet u_camera=systemUniforms.camera;\rlet u_cameraMatrix=u_camera.cameraMatrix;\rlet u_cameraPosition=u_camera.cameraPosition;\r\rlet u_modelMatrix=vertexUniforms.modelMatrix;\rlet u_normalModelMatrix=vertexUniforms.normalModelMatrix;\r\n\rlet u_useBillboardPerspective=vertexUniforms.useBillboardPerspective;\rlet u_useBillboard=vertexUniforms.useBillboard;\r\n\r\rlet input_position=inputData.position;\rlet input_vertexNormal=inputData.vertexNormal;\rlet input_positionVec4=vec4<f32>(input_position,1.0);\rlet input_vertexNormalVec4=vec4<f32>(input_vertexNormal,1.0);\rlet input_uv=inputData.uv;\r\n\rvar position:vec4<f32>;\rvar normalPosition:vec4<f32>;\r\n\r\n\r\nvar scaleMatrix:mat4x4<f32>;\r\rlet cameraPosition=vec3<f32>((u_cameraMatrix * u_modelMatrix)[3].xyz);\rlet objectPosition=input_position.xyz;\rlet distance=length(cameraPosition - objectPosition);\r\n\r\rlet scaleFactor=distance;\rscaleMatrix=mat4x4<f32>(\r10,0.0,0.0,0.0,\r0.0,10,0.0,0.0,\r0.0,0.0,1.0,0.0,\r0.0,0.0,0.0,1.0\r);\r\n\r\n\r\n\r\rif (u_useBillboard==1) {\r\r\rif (u_useBillboardPerspective==1) {\r\r\n\r} else {\r\rscaleMatrix=mat4x4<f32>(\rscaleFactor,0.0,0.0,0.0,\r0.0,scaleFactor,0.0,0.0,\r0.0,0.0,1.0,0.0,\r0.0,0.0,0.0,1.0\r);\r}\r\n\r\rposition=getBillboardMatrix(u_cameraMatrix,u_modelMatrix) * scaleMatrix * vec4<f32>(objectPosition,1.0);\rnormalPosition=getBillboardMatrix(u_cameraMatrix,u_modelMatrix) * scaleMatrix * vec4<f32>(input_vertexNormal.xyz,1.0);\r\n\r\rvar temp=output.position/output.position.w;\routput.position=vec4<f32>(\rtemp.xy + objectPosition.xy * vec2<f32>(\r(u_projectionMatrix * u_modelMatrix)[0][0],\r(u_projectionMatrix * u_modelMatrix)[1][1]\r),\rtemp.zw\r);\r\n\r} else {\r\rposition=u_cameraMatrix * u_modelMatrix * scaleMatrix * vec4<f32>(objectPosition,1.0);\rnormalPosition=u_cameraMatrix * u_normalModelMatrix * scaleMatrix * vec4<f32>(input_vertexNormal.xyz,1.0);\r}\r\n\r\routput.position=u_projectionMatrix * position;\routput.vertexPosition=position.xyz;\routput.vertexNormal=normalPosition.xyz;\routput.uv=input_uv;\routput.combinedOpacity=vertexUniforms.combinedOpacity;\rreturn output;\r\n}\r\nstruct OutputShadowData {\r@builtin(position) position:vec4<f32>,\r\n};\r\n\r\n@vertex\r\nfn picking(inputData:InputData) -> OutputData {\rvar output:OutputData;\rlet u_projectionMatrix=systemUniforms.projectionMatrix;\rlet u_camera=systemUniforms.camera;\rlet u_cameraMatrix=u_camera.cameraMatrix;\rlet u_cameraPosition=u_camera.cameraPosition;\r\rlet u_modelMatrix=vertexUniforms.modelMatrix;\rlet u_normalModelMatrix=vertexUniforms.normalModelMatrix;\r\rlet u_useBillboardPerspective=vertexUniforms.useBillboardPerspective;\rlet u_useBillboard=vertexUniforms.useBillboard;\r\n\r\rlet input_position=inputData.position;\rlet input_positionVec4=vec4<f32>(input_position,1.0);\rlet input_uv=inputData.uv;\r\n\rvar position:vec4<f32>;\r\n\r\n\rvar scaleMatrix:mat4x4<f32>;\r\rlet cameraPosition=vec3<f32>((u_cameraMatrix * u_modelMatrix)[3].xyz);\rlet objectPosition=input_position.xyz;\rlet distance=length(cameraPosition - objectPosition);\r\n\r\rlet scaleFactor=distance;\rscaleMatrix=mat4x4<f32>(\r10,0.0,0.0,0.0,\r0.0,10,0.0,0.0,\r0.0,0.0,1.0,0.0,\r0.0,0.0,0.0,1.0\r);\r\rif (u_useBillboard==1) {\r\rif (u_useBillboardPerspective==1) {\r\r\n\r} else {\r\rscaleMatrix=mat4x4<f32>(\rscaleFactor,0.0,0.0,0.0,\r0.0,scaleFactor,0.0,0.0,\r0.0,0.0,1.0,0.0,\r0.0,0.0,0.0,1.0\r);\r}\r\n\r\rposition=getBillboardMatrix(u_cameraMatrix,u_modelMatrix) * scaleMatrix * vec4<f32>(objectPosition,1.0);\r\n\r\rvar temp=output.position/output.position.w;\routput.position=vec4<f32>(\rtemp.xy + objectPosition.xy * vec2<f32>(\r(u_projectionMatrix * u_modelMatrix)[0][0],\r(u_projectionMatrix * u_modelMatrix)[1][1]\r),\rtemp.zw\r);\r\n\r} else {\r\rposition=u_cameraMatrix * u_modelMatrix * scaleMatrix * vec4<f32>(objectPosition,1.0);\r}\routput.position=u_projectionMatrix * position;\routput.pickingId=unpack4x8unorm(vertexUniforms.pickingId);\rreturn output;\r\n}\r\n";const mn=parseWGSL("#redgpu_include SYSTEM_UNIFORM;\r\n#redgpu_include calcTintBlendMode;\r\n#redgpu_include drawPicking;\r\n\r\nstruct Uniforms {\ruseDiffuseTexture:u32,\r\ropacity:f32,\ruseTint:u32,\rtint:vec4<f32>,\rtintBlendMode:u32,\r\n};\r\n\r\n@group(2) @binding(0) var<uniform> uniforms:Uniforms;\r\n@group(2) @binding(1) var diffuseTextureSampler:sampler;\r\n@group(2) @binding(2) var diffuseTexture:texture_2d<f32>;\r\n\r\nstruct InputData {\r@builtin(position) position:vec4<f32>,\r@location(0) vertexPosition:vec3<f32>,\r@location(1) vertexNormal:vec3<f32>,\r@location(2) uv:vec2<f32>,\r@location(12) combinedOpacity:f32,\r@location(13) shadowPos:vec3<f32>,\r@location(15) pickingId:vec4<f32>,\r\n};\r\n\r\n@fragment\r\nfn main(inputData:InputData) -> @location(0) vec4<f32> {\r\rvar finalColor:vec4<f32>=textureSample(diffuseTexture,diffuseTextureSampler,inputData.uv);\rfinalColor=vec4<f32>(finalColor.rgb,finalColor.a * uniforms.opacity * inputData.combinedOpacity);\r\n\rif(uniforms.useTint==1u){\rfinalColor=calcTintBlendMode(finalColor,uniforms.tintBlendMode,uniforms.tint);\r}\r\n\r\rif (finalColor.a==0.0) {\rdiscard;\r}\r\n\rreturn finalColor;\r\n};\r\n");class TextFieldMaterial extends ABitmapBaseMaterial{dirtyPipeline=!1;constructor(e,t,r){super(e,"TEXT_FILED_MATERIAL",mn,2),r&&(this.name=r),this.diffuseTexture=t,this.diffuseTextureSampler=new Sampler(this.redGPUContext),this.initGPURenderInfos()}}rt.defineByPreset(TextFieldMaterial,[rt.PRESET_TEXTURE.DIFFUSE_TEXTURE,rt.PRESET_SAMPLER.DIFFUSE_TEXTURE_SAMPLER]),Object.freeze(TextFieldMaterial);const dn=parseWGSL(hn),pn=dn.uniforms.vertexUniforms;class TextField3D extends ATextField{#Da=1;#Oa=1;constructor(e){super(e,((e,t)=>{this.#Da=e/1024,this.#Oa=t/1024})),this._geometry=new Plane(e),this._material=new TextFieldMaterial(e,new BitmapTexture(e)),this._material.transparent=!0,this.dirtyPipeline=!0,this.dirtyTransform=!0}get geometry(){return this._geometry}set geometry(e){console.error("TextField3D can not change geometry")}get material(){return this._material}set material(e){console.error("TextField3D can not change material")}get renderTextureWidth(){return this.#Da}get renderTextureHeight(){return this.#Oa}createCustomMeshVertexShaderModule(){return this.createMeshVertexShaderModuleBASIC("VERTEX_MODULE_TEXT_FIELD_3D",dn,pn,hn)}}Ie.defineByPreset(TextField3D,[[Ie.PRESET_BOOLEAN.USE_BILLBOARD_PERSPECTIVE,!0],Ie.PRESET_BOOLEAN.USE_BILLBOARD]),Object.freeze(TextField3D);var fn="#redgpu_include SYSTEM_UNIFORM;\r\n#redgpu_include getBillboardMatrix;\r\nstruct VertexUniforms {\rpickingId:u32,\r\n\t modelMatrix:mat4x4<f32>,\r\n\t normalModelMatrix:mat4x4<f32>,\r\n\t combinedOpacity:f32,\r\n};\r\n\r\n\r\n@group(1) @binding(0) var<uniform> vertexUniforms:VertexUniforms;\r\n\r\nstruct InputData {\r@location(0) position:vec3<f32>,\r@location(1) vertexNormal:vec3<f32>,\r@location(2) uv:vec2<f32>,\r\n};\r\nstruct OutputData {\r@builtin(position) position:vec4<f32>,\r@location(0) vertexPosition:vec3<f32>,\r@location(1) vertexNormal:vec3<f32>,\r@location(2) uv:vec2<f32>,\r@location(12) combinedOpacity:f32,\r@location(13) shadowPos:vec3<f32>,\r@location(15) pickingId:vec4<f32>,\r\n};\r\n\r\n\r\n@vertex\r\nfn main( inputData:InputData ) -> OutputData {\rvar output:OutputData;\r\n\r\rlet u_projectionMatrix=systemUniforms.projectionMatrix;\rlet u_camera=systemUniforms.camera;\rlet u_cameraMatrix=u_camera.cameraMatrix;\rlet u_cameraPosition=u_camera.cameraPosition;\r\rlet u_modelMatrix=vertexUniforms.modelMatrix;\rlet u_normalModelMatrix=vertexUniforms.normalModelMatrix;\r\n\r\n\r\rlet input_position=inputData.position;\rlet input_vertexNormal=inputData.vertexNormal;\rlet input_uv=inputData.uv;\r\n\rvar position:vec4<f32>;\rvar normalPosition:vec4<f32>;\r\n\rposition=u_cameraMatrix * u_modelMatrix * vec4<f32>(input_position,1.0);\rnormalPosition=u_cameraMatrix * u_normalModelMatrix * vec4<f32>(input_vertexNormal,1.0);\routput.position=u_projectionMatrix * position;\r\n\r\n\routput.vertexPosition=position.xyz;\routput.vertexNormal=normalPosition.xyz;\routput.uv=input_uv;\routput.combinedOpacity=vertexUniforms.combinedOpacity;\rreturn output;\r\n}\r\nstruct OutputShadowData {\r@builtin(position) position:vec4<f32>,\r\n};\r\n\r\n@vertex\r\nfn picking(inputData:InputData) -> OutputData {\rvar output:OutputData;\rlet u_projectionMatrix=systemUniforms.projectionMatrix;\rlet u_camera=systemUniforms.camera;\rlet u_cameraMatrix=u_camera.cameraMatrix;\rlet u_cameraPosition=u_camera.cameraPosition;\r\rlet u_modelMatrix=vertexUniforms.modelMatrix;\rlet u_normalModelMatrix=vertexUniforms.normalModelMatrix;\r\r\n\r\n\r\rlet input_position=inputData.position;\rlet input_vertexNormal=inputData.vertexNormal;\rlet input_uv=inputData.uv;\r\n\rvar position:vec4<f32>;\rvar normalPosition:vec4<f32>;\r\n\rposition=u_cameraMatrix * u_modelMatrix * vec4<f32>(input_position,1.0);\rnormalPosition=u_cameraMatrix * u_normalModelMatrix * vec4<f32>(input_vertexNormal,1.0);\routput.position=u_projectionMatrix * position;\r\n\routput.pickingId=unpack4x8unorm(vertexUniforms.pickingId);\rreturn output;\r\n}\r\n";const gn=parseWGSL(fn),xn=gn.uniforms.vertexUniforms,_n=mixInMesh2D(ATextField);class TextField2D extends _n{get useSmoothing(){return this.#xo}set useSmoothing(e){this.#xo=e,this.useSmoothing?(this._material.diffuseTextureSampler.minFilter=Be.LINEAR,this._material.diffuseTextureSampler.magFilter=Be.LINEAR,this._material.diffuseTextureSampler.mipmapFilter=Le.LINEAR):(this._material.diffuseTextureSampler.minFilter=Be.NEAREST,this._material.diffuseTextureSampler.magFilter=Be.NEAREST,this._material.diffuseTextureSampler.mipmapFilter=null)}#Sr=1;#Mr=1;#xo=!1;constructor(e,t=!1){super(e,((e,t)=>{this.#Sr=e,this.#Mr=t}),!1),this._geometry=new Plane(e,1,1,1,1,1,!0),this._material=new TextFieldMaterial(e,new BitmapTexture(e)),this._material.transparent=!0,this.useSmoothing=t,this.dirtyPipeline=!0,this.dirtyTransform=!0,this.primitiveState.cullMode=wt.FRONT}get width(){return this.#Sr}get height(){return this.#Mr}get geometry(){return this._geometry}set geometry(e){console.error("TextField2D can not change geometry")}get material(){return this._material}set material(e){console.error("TextField2D can not change material")}createCustomMeshVertexShaderModule(){return this.createMeshVertexShaderModuleBASIC("VERTEX_MODULE_TEXT_FIELD_2D",gn,xn,fn)}}Object.freeze(TextField2D);var vn=Object.freeze({__proto__:null,Group2D:Group2D,Group3D:Group3D,InstancingMesh:InstancingMesh,LINE_TYPE:tn,Line2D:class extends Line3D{constructor(e,t=tn.LINEAR,r="#fff"){super(e,t,r),this._material=new LineMaterial(e)}get geometry(){return this._geometry}set geometry(e){consoleAndThrowError("Line2D can not change geometry")}get material(){return this._material}set material(e){consoleAndThrowError("Line2D can not change material")}createCustomMeshVertexShaderModule(){return this.createMeshVertexShaderModuleBASIC("VERTEX_MODULE_LINE_2D",an,on,rn)}addPoint(e=0,t=0,r=this.baseColor,n=1,i=0,s=0,a=0,o=0){super.addPoint(e,t,0,r,n,i,s,0,a,o,0)}addPointAt(e,t=0,r=0,n=this.baseColor,i=1,s=0,a=0,o=0,u=0){super.addPointAt(e,t,r,0,n,i,s,a,0,o,u,0)}},Line3D:Line3D,Mesh:Mesh,Object3DContainer:Object3DContainer,PARTICLE_EASE:Nr,ParticleEmitter:ParticleEmitter,Scene:Scene,SkyBox:class{dirtyPipeline=!0;modelMatrix=create$5();gpuRenderInfo;_geometry;_material;#Bt=!0;#v;#kt;#It;constructor(e,t){validateRedGPUContext(e),this.#v=e,this._geometry=new Box(e),this._material=new SkyBoxMaterial(e,t),this.#kt=new PrimitiveState(this),this.#kt.cullMode=wt.NONE,this.#It=new DepthStencilState(this),this.#It.depthWriteEnabled=!1}render(e){const{currentRenderPassEncoder:t}=e;this.#_o(),this.gpuRenderInfo||this.#ws(this.#v),this.dirtyPipeline&&(this.gpuRenderInfo.pipeline=this.#vo(),this.dirtyPipeline=!1,e.numDirtyPipelines++);const{gpuRenderInfo:r}=this,{vertexUniformBindGroup:n,pipeline:i}=r,{indexBuffer:s}=this._geometry,{triangleCount:a,indexNum:o}=s;t.setPipeline(i),t.setVertexBuffer(0,this._geometry.vertexBuffer.gpuBuffer),t.setBindGroup(1,n),t.setBindGroup(2,this._material.gpuRenderInfo.fragmentUniformBindGroup),t.setIndexBuffer(s.gpuBuffer,"uint32"),t.drawIndexed(s.indexNum,1,0,0,0),e.num3DObjects++,e.numDrawCalls++,e.numTriangles+=a,e.numPoints+=o}#_o(){const{useMSAA:e}=this.#v;e!==this.#Bt&&(this.#Bt=e,this.dirtyPipeline=!0)}#ws(e){const{resourceManager:t}=this.#v,r=t.getGPUBindGroupLayout("SKYBOX_VERTEX_BIND_GROUP_LAYOUT")||t.createBindGroupLayout("SKYBOX_VERTEX_BIND_GROUP_LAYOUT",getVertexBindGroupLayoutDescriptorFromShaderInfo(Ur,1)),n=new ArrayBuffer(Br.arrayBufferByteLength),i=new UniformBuffer(e,n);identity$2(this.modelMatrix),scale$5(this.modelMatrix,this.modelMatrix,[1e4,1e4,1e4]),i.writeBuffer(Br.members.modelMatrix,this.modelMatrix);const s={layout:r,label:"VERTEX_BIND_GROUP_DESCRIPTOR_SKYBOX",entries:[{binding:0,resource:{buffer:i.gpuBuffer,offset:0,size:i.size}}]},a=e.gpuDevice.createBindGroup(s);this.gpuRenderInfo=new VertexGPURenderInfo(null,Br,r,i,a,this.#vo())}#vo(){const{resourceManager:e,gpuDevice:t}=this.#v,r={code:Ir},n={module:e.createGPUShaderModule("VERTEX_MODULE_SKYBOX",r),entryPoint:"main",buffers:this._geometry.gpuRenderInfo.buffers},i=e.getGPUBindGroupLayout("SKYBOX_VERTEX_BIND_GROUP_LAYOUT")||e.createBindGroupLayout("SKYBOX_VERTEX_BIND_GROUP_LAYOUT",getVertexBindGroupLayoutDescriptorFromShaderInfo(Ur,1)),s={bindGroupLayouts:[e.getGPUBindGroupLayout(ResourceManager.PRESET_GPUBindGroupLayout_System),i,this._material.gpuRenderInfo.fragmentBindGroupLayout]},a={label:"PIPELINE_DESCRIPTOR_SKYBOX",layout:t.createPipelineLayout(s),vertex:n,fragment:this._material.gpuRenderInfo.fragmentState,primitive:this.#kt.state,depthStencil:this.#It.state,multisample:{count:this.#v.useMSAA?4:1}};return t.createRenderPipeline(a)}},SphericalSkyBox:class{dirtyPipeline=!0;modelMatrix=create$5();gpuRenderInfo;_geometry;_material;#Bt=!0;#v;#kt;#It;constructor(e,t){validateRedGPUContext(e),this.#v=e,this._geometry=new Sphere(e,1,64,64,64),this._material=new SphericalSkyBoxMaterial(e,t),this.#kt=new PrimitiveState(this),this.#kt.cullMode=wt.FRONT,this.#It=new DepthStencilState(this),this.#It.depthWriteEnabled=!1}render(e){const{currentRenderPassEncoder:t}=e;this.#_o(),this.gpuRenderInfo||this.#ws(this.#v),this.dirtyPipeline&&(this.gpuRenderInfo.pipeline=this.#vo(),this.dirtyPipeline=!1,e.numDirtyPipelines++);const{gpuRenderInfo:r}=this,{vertexUniformBindGroup:n,pipeline:i}=r,{indexBuffer:s}=this._geometry,{triangleCount:a,indexNum:o}=s;t.setPipeline(i),t.setVertexBuffer(0,this._geometry.vertexBuffer.gpuBuffer),t.setBindGroup(1,n),t.setBindGroup(2,this._material.gpuRenderInfo.fragmentUniformBindGroup),t.setIndexBuffer(s.gpuBuffer,"uint32"),t.drawIndexed(s.indexNum,1,0,0,0),e.num3DObjects++,e.numDrawCalls++,e.numTriangles+=a,e.numPoints+=o}#_o(){const{useMSAA:e}=this.#v;e!==this.#Bt&&(this.#Bt=e,this.dirtyPipeline=!0)}#ws(e){const{resourceManager:t}=this.#v,r=t.getGPUBindGroupLayout("SPHERICAL_SKYBOX_VERTEX_BIND_GROUP_LAYOUT")||t.createBindGroupLayout("SPHERICAL_SKYBOX_VERTEX_BIND_GROUP_LAYOUT",getVertexBindGroupLayoutDescriptorFromShaderInfo(Dr,1)),n=new ArrayBuffer(Or.arrayBufferByteLength),i=new UniformBuffer(e,n);identity$2(this.modelMatrix),scale$5(this.modelMatrix,this.modelMatrix,[5e3,5e3,5e3]),i.writeBuffer(Or.members.modelMatrix,this.modelMatrix);const s={layout:r,label:"VERTEX_BIND_GROUP_DESCRIPTOR_SPHERICAL_SKYBOX",entries:[{binding:0,resource:{buffer:i.gpuBuffer,offset:0,size:i.size}}]},a=e.gpuDevice.createBindGroup(s);this.gpuRenderInfo=new VertexGPURenderInfo(null,Or,r,i,a,this.#vo())}#vo(){const{resourceManager:e,gpuDevice:t}=this.#v,r={code:Lr},n={module:e.createGPUShaderModule("VERTEX_MODULE_SPHERICAL_SKYBOX",r),entryPoint:"main",buffers:this._geometry.gpuRenderInfo.buffers},i=e.getGPUBindGroupLayout("SPHERICAL_SKYBOX_VERTEX_BIND_GROUP_LAYOUT")||e.createBindGroupLayout("SPHERICAL_SKYBOX_VERTEX_BIND_GROUP_LAYOUT",getVertexBindGroupLayoutDescriptorFromShaderInfo(Dr,1)),s={bindGroupLayouts:[e.getGPUBindGroupLayout(ResourceManager.PRESET_GPUBindGroupLayout_System),i,this._material.gpuRenderInfo.fragmentBindGroupLayout]},a={label:"PIPELINE_DESCRIPTOR_SPHERICAL_SKYBOX",layout:t.createPipelineLayout(s),vertex:n,fragment:this._material.gpuRenderInfo.fragmentState,primitive:this.#kt.state,depthStencil:this.#It.state,multisample:{count:this.#v.useMSAA?4:1}};return t.createRenderPipeline(a)}},Sprite2D:Sprite2D,Sprite3D:Sprite3D,SpriteSheet2D:SpriteSheet2D,SpriteSheet3D:SpriteSheet3D,SpriteSheetInfo:SpriteSheetInfo,TextField2D:TextField2D,TextField3D:TextField3D,View2D:View2D,View3D:View3D}),yn=Object.freeze({__proto__:null,AmbientLight:AmbientLight,DirectionalLight:DirectionalLight,PointLight:PointLight});function calculatePositionOnCurve(e,t,r,n,i){const s=Math.cos(e),a=Math.sin(e),o=r/t*e,u=Math.cos(o);i[0]=n*(2+u)*.5*s,i[1]=n*(2+u)*a*.5,i[2]=n*Math.sin(o)*.5}var Tn=Object.freeze({__proto__:null,Box:Box,Circle:class extends Primitive{#Dn=function(){return function(e,t,r,n,i,s){const a=[],o=[];let u,l,c;a.push(0,0,0,0,0,1,.5,.5);let h=0,m=3;for(;h<=n;)u=i+h/n*s,l=Math.cos(u),c=Math.sin(u),a.push(r*l,r*c,0,0,0,1,(l/r+1)/2,(c/r+1)/2),h++,m+=3;for(m=1;m<=n;)o.push(m,m+1,0),m++;return createPrimitiveGeometry(t,a,o,e)}}();constructor(e,t=1,r=32,n=0,i=2*Math.PI){super(e);const s=`PRIMITIVE_CIRCLE_R${t}_S${r}_TS${n}_TL${i}`,a=e.resourceManager.cachedBufferState;let o=a[s];o||(o=a[s]=this.#Dn(s,e,t,r,n,i)),this._setData(o)}},Cylinder:Cylinder,Plane:Plane,Primitive:Primitive,Sphere:Sphere,Torus:class extends Primitive{#Dn=function(){return function(e,t,r,n,i,s,a,o){a=a||0;const u=(o=o||2*Math.PI)-a,l=i+1,c=s+1,h=[],m=[];for(let e=0;e<c;++e){const t=e/s,o=t*Math.PI*2,c=Math.sin(o),m=r+c*n,d=Math.cos(o),p=d*n;for(let e=0;e<l;++e){const r=e/i,n=a+r*u,s=Math.sin(n),o=Math.cos(n),l=s*m,f=o*m,g=s*c,x=o*c;h.push(l,p,f,g,d,x,r,1-t)}}for(let e=0;e<s;++e)for(let t=0;t<i;++t){const r=1+t,n=1+e;m.push(l*e+t,l*n+t,l*e+r),m.push(l*n+t,l*n+r,l*e+r)}return createPrimitiveGeometry(t,h,m,e)}}();constructor(e,t=1,r=.5,n=16,i=16,s=0,a=2*Math.PI){if(super(e),n<3)throw new Error("radialSubdivisions must be 3 or greater");if(i<3)throw new Error("verticalSubdivisions must be 3 or greater");const o=`PRIMITIVE_TORUS_R${t}_T${r}_RSD${n}_BSD${i}_SA${s}_EA${a}`,u=e.resourceManager.cachedBufferState;let l=u[o];l||(l=u[o]=this.#Dn(o,e,t,r,n,i,s,a)),this._setData(l)}},TorusKnot:class extends Primitive{#Dn=function(){return function(e,t,r,n,i,s,a,o){i=Math.floor(i),s=Math.floor(s);const u=[],l=[],c=[],h=[],m=[0,0,0],d=[0,0,0],p=[0,0,0],f=[0,0,0],g=[0,0,0];for(let e=0;e<=i;++e){const t=e/i*a*Math.PI*2;calculatePositionOnCurve(t,a,o,r,m),calculatePositionOnCurve(t+.01,a,o,r,d),f[0]=d[0]-m[0],f[1]=d[1]-m[1],f[2]=d[2]-m[2],g[0]=d[0]+m[0],g[1]=d[1]+m[1],g[2]=d[2]+m[2];{const e=f[0],t=f[1],r=f[2],n=g[0],i=g[1],s=g[2];p[0]=t*s-r*i,p[1]=r*n-e*s,p[2]=e*i-t*n}{const e=p[0],t=p[1],r=p[2],n=f[0],i=f[1],s=f[2];g[0]=t*s-r*i,g[1]=r*n-e*s,g[2]=e*i-t*n}{let e=p[0],t=p[1],r=p[2],n=e*e+t*t+r*r;n>0&&(n=1/Math.sqrt(n||1)),p[0]=p[0]*n,p[1]=p[1]*n,p[2]=p[2]*n}{let e=g[0],t=g[1],r=g[2],n=e*e+t*t+r*r;n>0&&(n=1/Math.sqrt(n)),g[0]=g[0]*n,g[1]=g[1]*n,g[2]=g[2]*n}for(let t=0;t<=s;++t){const r=t/s*Math.PI*2,a=-n*Math.cos(r),o=n*Math.sin(r);c[0]=m[0]+(a*g[0]+o*p[0]),c[1]=m[1]+(a*g[1]+o*p[1]),c[2]=m[2]+(a*g[2]+o*p[2]),u.push(c[0],c[1],c[2]);{h[0]=c[0]-m[0],h[1]=c[1]-m[1],h[2]=c[2]-m[2];let e=h[0],t=h[1],r=h[2],n=e*e+t*t+r*r;n>0&&(n=1/Math.sqrt(n)),h[0]=h[0]*n,h[1]=h[1]*n,h[2]=h[2]*n}u.push(h[0],h[1],h[2],e/i,t/s)}}for(let e=1;e<=i;e++)for(let t=1;t<=s;t++){const r=(s+1)*(e-1)+(t-1),n=(s+1)*e+(t-1),i=(s+1)*e+t,a=(s+1)*(e-1)+t;l.push(r,n,a),l.push(n,i,a)}return createPrimitiveGeometry(t,u,l,e)}}();constructor(e,t=1,r=.4,n=64,i=8,s=2,a=3){super(e);const o=`PRIMITIVE_TORUS_NUT_R${t}_T${r}_TS${n}_RS${i}_P${s}_Q${a}`,u=e.resourceManager.cachedBufferState;let l=u[o];l||(l=u[o]=this.#Dn(o,e,t,r,n,i,s,a)),this._setData(l)}}});class ResourceStateCubeTextureFromSphericalSky{texture;src;cacheKey;useNum=0;uuid;constructor(e){this.texture=e,this.src=e.src,this.cacheKey=e.cacheKey,this.useNum=0,this.uuid=e.uuid}}class CubeTextureFromSphericalSky extends ManagedResourceBase{static defaultViewDescriptor={dimension:"cube",aspect:"all",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:0,arrayLayerCount:6};#K;#X;#j;#Y;#Z;#q;#W=0;#Q;#ee;#te;constructor(e,t,r=!0,n,i,s){if(super(e,"managedCubeTextureFromSphericalSkyState"),this.#ee=n,this.#te=i,this.#Z=r,this.#Q=s||navigator.gpu.getPreferredCanvasFormat(),t){this.#X=t?.src||t,this.#j=t?.cacheKey||t||this.uuid;const{table:e}=this.targetResourceManagedState;let r;for(const t in e)if(e[t].cacheKey===this.#j){r=e[t];break}if(r)return this.#ee?.(this),e[r.uuid].texture;this.src=t,this.#re()}}get cacheKey(){return this.#j}get videoMemorySize(){return this.#W}get gpuTexture(){return this.#K}get mipLevelCount(){return this.#Y}get src(){return this.#X}set src(e){this.#X=e?.src||e,this.#j=e?.cacheKey||e||this.uuid,this.#X&&this.#ne(this.#X)}get useMipmap(){return this.#Z}set useMipmap(e){this.#Z=e,this.#ie()}destroy(){const e=this.#K;this.#se(null),this.__fireListenerList(!0),this.#X=null,this.#j=null,this.#ae(),e&&e.destroy()}#se(e){this.#K=e,e||(this.#q=null),this.__fireListenerList()}#re(){basicRegisterResource(this,new ResourceStateCubeTextureFromSphericalSky(this))}#ae(){basicUnregisterResource(this)}#ie(){const{gpuDevice:e,resourceManager:t}=this.redGPUContext,{mipmapGenerator:r}=t;this.#K&&(this.#K.destroy(),this.#K=null),this.#Y=1;{const t=this.#q,r=e.createTexture({size:[t.width,t.height,1],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT});e.queue.copyExternalImageToTexture({source:t},{texture:r},[t.width,t.height]);const i=(n=512,e.createTexture({size:[n,n,6],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.COPY_SRC})),s=e.createSampler({magFilter:"linear",minFilter:"linear"}),a=e.createShaderModule({code:"\nstruct VertexOutput {@builtin(position) position:vec4<f32>,@location(0) uv:vec2<f32>,\n};\n\n\n@group(0) @binding(0) var textureSampler:sampler;\n@group(0) @binding(1) var sphericalTexture:texture_2d<f32>;\n@group(0) @binding(2) var<uniform> cubeFaceIndex:u32;\n\n\nfn atan2(y:f32,x:f32) -> f32 {if (x > 0.0) {return atan(y/x);} else if (x < 0.0 && y >=0.0) {return atan(y/x) + 3.141592653589793;} else if (x < 0.0 && y < 0.0) {return atan(y/x) - 3.141592653589793;} else if (x==0.0 && y > 0.0) {return 1.5707963267948966;} else if (x==0.0 && y < 0.0) {return -1.5707963267948966;} else {return 0.0;}\n}\n\n@vertex\n\nfn vertexMain(@builtin(vertex_index) vertexIndex:u32) -> VertexOutput {var positions=array<vec3<f32>,6>(vec3<f32>(-1.0, 1.0,0.0),vec3<f32>( 1.0, 1.0,0.0),vec3<f32>(-1.0,-1.0,0.0),vec3<f32>( 1.0,-1.0,0.0),vec3<f32>(-1.0,-1.0,0.0),vec3<f32>( 1.0, 1.0,0.0));var position=positions[vertexIndex];var output:VertexOutput;output.position=vec4<f32>(position,1.0);\nvar direction:vec3<f32>;if (cubeFaceIndex==0u) {direction=vec3<f32>(1.0,position.y,-position.x);} else if (cubeFaceIndex==1u) { direction=vec3<f32>(-1.0,position.y,position.x);} else if (cubeFaceIndex==2u) {direction=vec3<f32>(position.x,1.0,-position.y);} else if (cubeFaceIndex==3u) { direction=vec3<f32>(position.x,-1.0,position.y);} else if (cubeFaceIndex==4u) {direction=vec3<f32>(position.x,position.y,1.0);} else {direction=vec3<f32>(-position.x,position.y,-1.0);}\n// \ndirection=normalize(direction);\n//  UV  \nlet theta=atan2(direction.z,direction.x);let phi=acos(direction.y); \n//  UV \nlet PI=3.1415927;let u=theta/(2.0 * PI);let v=phi/PI; \n//UV  \noutput.uv=vec2<f32>(u,v);\n\n\nreturn output;\n}\n\n\n@fragment\n\nfn fragmentMain(@location(0) fragUV:vec2<f32>) -> @location(0) vec4<f32> {var sampledColor:vec4<f32>=textureSample(sphericalTexture,textureSampler,fragUV);;if (fragUV.x < 0.0 || fragUV.x > 1.0 || fragUV.y < 0.0 || fragUV.y > 1.0) {sampledColor=vec4<f32>(0.0,0.0,0.0,1.0);} \nlet gamma=2.2;let outputColor=pow(sampledColor.rgb,vec3<f32>(1.0/gamma));\nreturn vec4<f32>(outputColor,sampledColor.a);\n}"}),{pipeline:o,renderPassViews:u}=function(e,t,r){const n=e.createRenderPipeline({layout:"auto",vertex:{module:r,entryPoint:"vertexMain"},fragment:{module:r,entryPoint:"fragmentMain",targets:[{format:"rgba8unorm"}]},primitive:{topology:"triangle-list"}}),i=[];for(let e=0;e<6;e++)i.push(t.createView({dimension:"2d",arrayLayerCount:1,baseArrayLayer:e}));return{pipeline:n,renderPassViews:i}}(e,i,a),l=e.createBuffer({size:4,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),c=e.createBindGroup({layout:o.getBindGroupLayout(0),entries:[{binding:0,resource:s},{binding:1,resource:r.createView()},{binding:2,resource:{buffer:l,offset:0,size:4}}]}),h=e.createCommandEncoder();for(let t=0;t<6;t++){e.queue.writeBuffer(l,0,new Uint32Array([t]));const r=h.beginRenderPass({colorAttachments:[{view:u[t],loadOp:"clear",clearValue:[0,0,0,1],storeOp:"store"}]});r.setPipeline(o),r.setBindGroup(0,c),r.draw(6,1,0,0),r.end()}e.queue.submit([h.finish()]),this.#se(i)}var n}async#ne(e){this.#q=await loadAndCreateBitmapImage(e);try{this.#ie(),this.#ee?.(this)}catch(e){console.error(e),this.#te?.(e)}}}Object.freeze(CubeTextureFromSphericalSky);var bn=Object.freeze({__proto__:null,AUniformBaseBuffer:AUniformBaseBuffer,BitmapTexture:BitmapTexture,CubeTexture:CubeTexture,CubeTextureFromSphericalSky:CubeTextureFromSphericalSky,IndexBuffer:IndexBuffer,InterleavedStructElement:InterleavedStructElement,ResourceBase:ResourceBase,ResourceManager:ResourceManager,ResourceState:ResourceState,Sampler:Sampler,StorageBuffer:StorageBuffer,UniformBuffer:UniformBuffer,UniformType:UniformType,VertexBuffer:VertexBuffer,getUniformOffsetByRoundUp:(e,t)=>((e+t-1)/t|0)*t,loadAndCreateBitmapImage:loadAndCreateBitmapImage,parseIncludeWGSL:parseIncludeWGSL,parseWGSL:parseWGSL}),Sn=Object.freeze({__proto__:null,BlendState:BlendState,DepthStencilState:DepthStencilState,PrimitiveState:PrimitiveState}),Mn="\r\n\r\n@group(1) @binding(0)\r\nvar _sampler:sampler;\r\n\r\n@group(1) @binding(1)\r\nvar _texture:texture_2d<f32>;\r\n\r\n\r\n\r\n@fragment\r\nfn main(@location(0) fragUV:vec2<f32>) -> @location(0) vec4<f32> {\r\rvar diffuseColor:vec4<f32>=textureSample(_texture,_sampler,fragUV);\r\n\r\rdiffuseColor=vec4<f32>(diffuseColor.rgb,diffuseColor.a);\r\n\r\rreturn diffuseColor;\r\n}\r\n",Rn="\r\n\r\nstruct VertexUniforms {\rmodelMatrix:mat4x4<f32>,\r\n};\r\n\r\n\r\n@group(0) @binding(0)\r\nvar<uniform> vertexUniforms:VertexUniforms;\r\n\r\n\r\n\r\n\r\nstruct VertexOutput {\r@builtin(position) Position:vec4<f32>,\r@location(0) fragUV:vec2<f32>,\r\n};\r\n\r\n\r\n@vertex\r\nfn main(@builtin(vertex_index) VertexIndex:u32) -> VertexOutput {\r\n\r\rvar pos=array<vec2<f32>,6>(\rvec2( 1.0, 1.0),\rvec2( 1.0,-1.0),\rvec2(-1.0,-1.0),\rvec2( 1.0, 1.0),\rvec2(-1.0,-1.0),\rvec2(-1.0, 1.0),\r);\r\n\r\rvar uv=array<vec2<f32>,6>(\rvec2(1.0,0.0),\rvec2(1.0,1.0),\rvec2(0.0,1.0),\rvec2(1.0,0.0),\rvec2(0.0,1.0),\rvec2(0.0,0.0),\r);\r\n\r\rvar output:VertexOutput;\r\n\r\routput.Position=vertexUniforms.modelMatrix * vec4<f32>(pos[VertexIndex],0.0,1.0);\routput.fragUV=uv[VertexIndex];\r\n\r\rreturn output;\r\n}\r\n";const wn=parseWGSL(Rn),En=parseWGSL(Mn),Pn=wn.uniforms.vertexUniforms;class FinalRender{#Bt;#yo=[];#To=[];#bo;#So;#Mo;#Ro;#wo;#Eo=[];#$n;#Po=[];#Co=[];#ue;constructor(){}render(e,t){const{useMSAA:r,sizeManager:n,gpuDevice:i,resourceManager:s}=e,{pixelRectObject:a}=n,{width:o,height:u}=a;if(0===o||0===u)return;const l=this.#ko(e),c=i.createCommandEncoder(),h=c.beginRenderPass(l);h.setViewport(0,0,o,u,0,1),h.setScissorRect(0,0,o,u),this.#bo||this.#Io(e),this.#Uo(e,h,t.map((e=>{const t=e.colorAttachments[0];return t.postEffectView||t.pickingView||t.resolveTarget||t.view})),o,u,r),h.end(),i.queue.submit([c.finish()]),this.#Bt=r}#Uo(e,t,r,n,i,s){const{gpuDevice:a}=e;r.forEach(((r,o)=>{const u=e.viewList[o],{x:l,y:c,width:h,height:m}=u.pixelRectObject,d=create$5();f(d,0,1,0,1,-1e3,1e3),scale$5(d,d,[1/n,1/i,1]),translate$1(d,d,[h/2+l,i-m/2-c,0]),scale$5(d,d,[h/2,m/2,1]),this.#Bo(e,o);const p=this.#yo[o],g=this.#To[o];a.queue.writeBuffer(p.gpuBuffer,Pn.members.modelMatrix.uniformOffset,new Pn.members.modelMatrix.View(d));if(this.#Bt!==s||!this.#Po[o]||this.#Po[o].width!==h||this.#Po[o].height!==m||this.#Co[o]!==r){const e={layout:this.#Ro,label:"FRAGMENT_BIND_GROUP_DESCRIPTOR_FINAL_RENDER",entries:[{binding:0,resource:this.#ue.gpuSampler},{binding:1,resource:r}]};this.#Eo[o]=a.createBindGroup(e),this.#Po[o]={width:h||1,height:m||1},this.#Co[o]=r}t.setPipeline(this.#Lo(e)),t.setBindGroup(0,g),t.setBindGroup(1,this.#Eo[o]),t.draw(6,1,0,0)}))}#Io(e){const{resourceManager:t}=e;this.#bo=t.createBindGroupLayout("FINAL_RENDER_VERTEX_BIND_GROUP_LAYOUT",getVertexBindGroupLayoutDescriptorFromShaderInfo(wn,0)),this.#So=t.createGPUShaderModule("VERTEX_MODULE_FINAL_RENDER",{code:Rn}),this.#Mo={module:this.#So,entryPoint:"main"},this.#wo=t.createGPUShaderModule("FRAGMENT_MODULE_FINAL_RENDER",{code:Mn}),this.#Ro=t.createBindGroupLayout("FINAL_RENDER_BIND_GROUP_LAYOUT",getFragmentBindGroupLayoutDescriptorFromShaderInfo(En,1)),this.#ue=new Sampler(e,{minFilter:"linear"})}#Bo(e,t){const{gpuDevice:r}=e;if(!this.#yo[t]){const n=new ArrayBuffer(Pn.arrayBufferByteLength),i=this.#yo[t]=new UniformBuffer(e,n,`FinalRender_View(${t})_VertexUniform`),s={layout:this.#bo,label:"VERTEX_BIND_GROUP_DESCRIPTOR_FINAL_RENDER",entries:[{binding:0,resource:{buffer:i.gpuBuffer,offset:0,size:i.size}}]};this.#To[t]=r.createBindGroup(s)}}#ko(e){const{backgroundColor:t,gpuContext:r}=e,n=t.rgbaNormal;return{colorAttachments:[{view:r.getCurrentTexture().createView(),clearValue:{r:n[0]*n[3],g:n[1]*n[3],b:n[2]*n[3],a:n[3]},loadOp:Ne.CLEAR,storeOp:Ve.STORE}]}}#Lo(e){if(!this.#$n){const{gpuDevice:t}=e,r={label:"PIPELINE_DESCRIPTOR_FINAL_RENDER",layout:t.createPipelineLayout({bindGroupLayouts:[this.#bo,this.#Ro]}),vertex:this.#Mo,fragment:{module:this.#wo,entryPoint:"main",targets:[{format:navigator.gpu.getPreferredCanvasFormat(),blend:{color:{srcFactor:lt.ONE,dstFactor:lt.ONE_MINUS_SRC_ALPHA,operation:ct.ADD},alpha:{srcFactor:lt.ONE,dstFactor:lt.ONE_MINUS_SRC_ALPHA,operation:ct.ADD}}}]}};this.#$n=t.createRenderPipeline(r)}return this.#$n}}!function(e,t){void 0===t&&(t={});var r=t.insertAt;if("undefined"!=typeof document){var n=document.head||document.getElementsByTagName("head")[0],i=document.createElement("style");i.type="text/css","top"===r&&n.firstChild?n.insertBefore(i,n.firstChild):n.appendChild(i),i.styleSheet?i.styleSheet.cssText=e:i.appendChild(document.createTextNode(e))}}(".RedGPUDebugPanel{background:rgba(0,0,0,.8);bottom:0;color:#fff;font-size:11px;left:0;line-height:1;max-height:100%;min-width:250px;overflow-y:auto;position:fixed;transform:translateZ(0);will-change:transform;z-index:2}.RedGPUDebugPanel::-webkit-scrollbar{width:6px}.RedGPUDebugPanel::-webkit-scrollbar-track{background:#000}.RedGPUDebugPanel::-webkit-scrollbar-thumb{background:#333}.RedGPUDebugPanel::-webkit-scrollbar-thumb:hover{background:#444}.debug-group{line-height:1.4;padding:10px;b{color:#fdb48d;font-weight:700}}.debug-sub-group{background:linear-gradient(90deg,hsla(0,0%,100%,.1),rgba(0,0,0,.01));border:1px solid hsla(0,0%,100%,.16);border-radius:6px;box-shadow:0 0 10px rgba(0,0,0,.16);line-height:1.4;margin:8px 0;padding:6px 10px;b{color:#fdb48d;font-weight:700}}.debug-sub-group-title{color:#e3b096}.debug-item{align-items:center;color:#ccc;display:flex;font-weight:400;gap:10px;justify-content:space-between;transform:translateZ(0);width:100%;will-change:transform;b{color:#fdb48d;font-weight:700}}.boolean-true{background:green}.boolean-false,.boolean-true{border-radius:2px;line-height:1;margin:2px 0;padding:2px 4px}.boolean-false{background:red}.debug-folder{background:rgba(0,0,0,.5);border-bottom:1px solid hsla(0,0%,100%,.05);display:flex;flex-direction:column;width:100%}.debug-folder-title{align-items:center;background:linear-gradient(0deg,rgba(0,0,0,.95),hsla(0,0%,100%,.055));border-bottom:1px solid hsla(0,0%,100%,.025);border-top:1px solid hsla(0,0%,100%,.05);cursor:pointer;display:flex;font-size:12px;justify-content:space-between;line-height:1;padding:10px 8px;width:100%;b{color:#fdb48d;font-size:11px;font-weight:700}}.debug-item-title{color:#888}.debug-item-cache-key,.debug-item-title{font-weight:500;max-width:250px;overflow:hidden;text-overflow:ellipsis;text-shadow:1px 1px 0 rgba(0,0,0,.3)}.debug-item-cache-key{color:#fff;white-space:nowrap}.div-line{background:hsla(0,0%,100%,.06);border-bottom:1px solid transparent;height:1px;margin:10px 0;width:100%}.root-padding{padding:6px;width:100%}.color-box{border:1px solid hsla(0,0%,100%,.2);border-radius:4px;margin:2px;padding:3px}");const createDebugTitle=e=>`<div>${e}</div>`,makeColorDebug=(e,t)=>`\n<div class='debug-item'>\n\x3c!--\t<span class='debug-item-title'>${e}</span> --\x3e\n\t<span class='debug-item-title'></span> \n\t<div style="border:1px solid rgba(255,255,255,0.2);border-radius:4px;background:rgba(${t.rgba});padding:3px;margin:2px">${t.rgba}\n\t</div>\n</div>\n`,makeBooleanDebug=(e,t)=>`<span class="${t?"boolean-true":"boolean-false"}">${t?"true":"false"}</span>`,getDebugFormatValue=e=>"boolean"==typeof e?e.toString():"number"==typeof e?e.toLocaleString():e,updateDebugItemValue=(e,t,r,n,i="")=>{const s=e.querySelector(`.${t}`);if(!s)return;const a=`${getDebugFormatValue(r)}${i}`;s.innerHTML!==a&&(s.innerHTML=a,n&&(s.style.background=r?"green":"rgba(255,255,255,0.1)"))};let Cn=class{dom;#Ao;#Do=!1;constructor(e){this.#Ao=e,this.dom=document.createElement("div"),this.dom.innerHTML=`<div class="debug-folder">\t<div class="debug-folder-title" style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;">${createDebugTitle(`${e} Num:<span class="totalCount"></span> (<b class="targetVideoMemorySize"></b>)`)}<div class="onoff">${this.#Do?"close":"open"}</div></div><div class="item-container" style="display:none"></div></div>\n`;const t=this.dom.querySelector(".debug-folder"),r=this.dom.querySelector(".item-container");t.addEventListener("click",(()=>{this.openYn=!this.openYn,r.style.display=this.#Do?"":"none"}))}get openYn(){return this.#Do}set openYn(e){this.#Do=e,this.dom.querySelector(".onoff").innerHTML=this.openYn?"close":"open"}update(e,t){const{resourceManager:r}=t,n=r[`managed${this.#Ao}State`],{table:i,videoMemory:s,length:a}=n;let o;switch(e.totalUsedVideoMemory+=s,updateDebugItemValue(this.dom,"totalCount",a),updateDebugItemValue(this.dom,"targetVideoMemorySize",formatBytes(s)),this.#Ao){case"VertexBuffer":if(o=ResourceStateVertexBuffer,o){const{dirtyList:e}=o;e.length&&(this.#Oo(e),e.length=0)}break;case"IndexBuffer":if(o=ResourceStateIndexBuffer,o){const{dirtyList:e}=o;e.length&&(this.#Oo(e),e.length=0)}break;case"UniformBuffer":o=ResourceStateUniformBuffer,this.#Oo(Object.values(i));break;case"StorageBuffer":o=ResourceStateStorageBuffer,this.#Oo(Object.values(i))}}#Oo(e){const t=this.dom.querySelector(".item-container"),r=new Set,n=this.#Ao,i=new Map;t.querySelectorAll(".debug-group").forEach((e=>{const t=e.className.split(" ")[1].replace(`${n}_`,"");r.add(t),i.set(t,e)})),e.map(((e,s)=>{const{useNum:a,buffer:o}=e,{uuid:u,size:l,name:c}=o,h=`${n}_${u}`;let m=i.get(u);m?r.delete(u):(m=document.createElement("div"),m.className=`debug-group ${h}`,m.innerHTML=`<div class='debug-item'><div><div class='debug-item-title'><span style="white-space:nowrap">${s} <span class="name"></span></span></div><div style="font-size:10px">${u}</div></div><div style="display:flex;flex-direction:column;align-items:center;gap:4px;width:50px"><span class='useNum' style="padding:2px 4px;border-radius:4px;width:100%;text-align:center"></span><span style="white-space:nowrap"><b class="videoMemorySize"></b></span></div></div>`,t.appendChild(m)),updateDebugItemValue(m,"name",c),updateDebugItemValue(m,"useNum",a,!0),updateDebugItemValue(m,"videoMemorySize",formatBytes(l))}));for(let e of r)i.get(e).remove()}};class DebugBufferList{debugStatisticsDomService;constructor(e){this.debugStatisticsDomService=new Cn(e)}get dom(){return this.debugStatisticsDomService.dom}update(e,t){this.debugStatisticsDomService.update(e,t)}}class ADebugItem{debugStatisticsDomService;constructor(){}get dom(){return this.debugStatisticsDomService.dom}update(e,t,r){this.debugStatisticsDomService.update(e,t)}}class ADebugStatisticsDomService{dom;#Do=!1;constructor(){}get openYn(){return this.#Do}set openYn(e){this.#Do=e,this.dom.querySelector(".onoff").innerHTML=this.openYn?"close":"open"}init(e,t=!1){this.#Do=t,this.dom=document.createElement("div"),this.dom.innerHTML=`<div class="debug-folder">\t<div class="debug-folder-title">${e}<div class="onoff">${this.openYn?"close":"open"}</div></div><div class="item-container" style="display:${t?"":"none"}"></div></div>\n`;const r=this.dom.querySelector(".debug-folder-title"),n=this.dom.querySelector(".item-container");r.addEventListener("click",(e=>{this.openYn=!this.openYn,n.style.display=this.openYn?"":"none"}))}update(e,t){}}const kn=["useMSAA","alphaMode","renderScale"];let In=class extends ADebugStatisticsDomService{constructor(){super(),this.init(`${createDebugTitle("RedGPUContext")}`,!0),this.#Oo()}update(e,t){kn.forEach((e=>this.#Go(t,e))),this.#No(t)}#Oo(){const e=this.dom.querySelector(".item-container"),t=['<div class="debug-group">',...kn.map((e=>this.#Vo(e))),this.#Vo("width_height"),this.#Vo("pixelRectArray"),this.#Vo("backgroundColor"),"</div>"];e.innerHTML=t.join("")}#Vo(e){return`<div class='debug-item'>${e}<span class='debug-item-title redGPUContext_${e}'/></div>`}#Go(e,t){const r=e[t];updateDebugItemValue(this.dom,`redGPUContext_${t}`,"useMSAA"===t?makeBooleanDebug(0,r):getDebugFormatValue(r))}#No(e){const{sizeManager:t,width:r,height:n,backgroundColor:i}=e,{pixelRectArray:s}=t;updateDebugItemValue(this.dom,"redGPUContext_width_height",`${r},${n}`),updateDebugItemValue(this.dom,"redGPUContext_pixelRectArray",s),updateDebugItemValue(this.dom,"redGPUContext_backgroundColor",makeColorDebug("backgroundColor",i))}};class DebugRedGPUContext extends ADebugItem{constructor(){super(),this.debugStatisticsDomService=new In}}let Un=class extends ADebugStatisticsDomService{#Fo;constructor(e){super(),this.#Fo=e,this.init(`${createDebugTitle((e?"CubeTexture":"BitmapTexture")+' Num:<span class="totalCount"></span> (<b class="targetVideoMemorySize"></b>)')}`)}update(e,t){const{resourceManager:r}=t,{managedBitmapTextureState:n,managedCubeTextureState:i}=r,{table:s,videoMemory:a,length:o}=this.#Fo?i:n;e.totalUsedVideoMemory+=a;const u=Object.values(s);updateDebugItemValue(this.dom,"totalCount",o),updateDebugItemValue(this.dom,"targetVideoMemorySize",formatBytes(a)),this.#Oo(u)}getTargetSrc(e){if(e instanceof ResourceStateBitmapTexture){const{src:t}=e;return t?t.startsWith("data:")?"base64 texture":t:"null"}{const{srcList:t}=e;return`${t[0]}...`}}getUpdatedTdom(e,t,r,n,i,s){return e||((e=document.createElement("div")).className=`debug-group ${r}`,e.innerHTML=`<div class='debug-item'><div><div class='debug-item-title'>${n} <span class="targetSrc">${i}</span></div> <div class='debug-item-cache-key'>cacheKey:<span class="cacheKey">Place holder for cacheKey</span></div><div>mipLevelCount:<span class="mipLevelCount"></span>/useMipmap:<span class="useMipmap"></span></div><div>width:<span class="width"></span>/height:<span class="height"></span></div></div><div style="display:flex;flex-direction:column;align-items:center;gap:4px;width:50px"><span class='useNum' style="padding:2px 4px;border-radius:4px;width:100%;text-align:center"></span><span><b class="videoMemorySize"></b></span></div></div><div style="font-size:10px">${s}</div>`,t.appendChild(e)),e}updateDebugItems(e,t,r,n,i,s,a,o,u){updateDebugItemValue(e,"mipLevelCount",t),updateDebugItemValue(e,"useMipmap",r),updateDebugItemValue(e,"width",n),updateDebugItemValue(e,"height",i),updateDebugItemValue(e,"useNum",s,!0),updateDebugItemValue(e,"cacheKey",a),updateDebugItemValue(e,"targetSrc",o),updateDebugItemValue(e,"videoMemorySize",formatBytes(u))}#Oo(e){const t=this.dom.querySelector(".item-container"),r=new Set,n=this.#Fo?"cube_texture":"bitmap_texture";t.querySelectorAll(".debug-group").forEach((e=>{const t=e.className.split(" ")[1].replace(`${n}_`,"");r.add(t)})),e.map(((e,i)=>{const{useNum:s,cacheKey:a,texture:o}=e;let u=this.getTargetSrc(e);const{mipLevelCount:l,useMipmap:c,gpuTexture:h,uuid:m,videoMemorySize:d}=o,{width:p,height:f}=h||{},g=`${n}_${o.uuid}`;let x=t.querySelector(`.${g}`);x=this.getUpdatedTdom(x,t,g,i,u,m),r.delete(o.uuid),this.updateDebugItems(x,l,c,p,f,s,a,u,d)}));for(let e of r)t.querySelector(`.${n}_${e}`).remove()}};class DebugTextureList extends ADebugItem{constructor(e=!1){super(),this.debugStatisticsDomService=new Un(e)}}const Bn=["totalNum3DGroups","totalNum3DObjects","totalNumInstances","totalNumDrawCalls","totalNumTriangles","totalNumPoints","totalUsedVideoMemory"];let Ln=class{dom;constructor(){this.dom=document.createElement("div"),this.#zo()}update(e){Bn.forEach((t=>{const r=e[t],n="totalUsedVideoMemory"===t?`<b>${formatBytes(r)}</b>`:r;updateDebugItemValue(this.dom,t,n)}))}#zo(){const e=this.#Oo();this.dom.innerHTML=`<div class="debug-group">${createDebugTitle("Total State")}<div>${e}</div> </div>`}#Oo(){return Bn.map((e=>"totalUsedVideoMemory"===e?`<div class='debug-item'>${e}<span class='debug-item-title'/><b class="${e}"></b></div>`:`<div class='debug-item'>${e}<span class='debug-item-title ${e}'/></div>`)).join("")}};class DebugTotalState extends ADebugItem{constructor(){super(),this.debugStatisticsDomService=new Ln}}const An=["usedVideoMemory","viewRenderTime","num3DGroups","num3DObjects","numInstances","numDrawCalls","numTriangles","numPoints"],Dn={viewRenderTime:"ms"},On={camera:"camera.name",scene:"scene.name",useBackgroundColor:"scene.useBackgroundColor",backgroundColor:"scene.backgroundColor",x_y:"x,y",width_height:"width,height"};let Gn=class extends ADebugStatisticsDomService{#$o=0;constructor(){super(),this.init(`${createDebugTitle("ViewList")}`,!0)}update(e,t){const{viewList:r,numViews:n}=t;this.#$o!==n&&(this.#Ho(r),this.#$o=n),r.forEach(((t,r)=>{An.forEach((n=>this.#Go(t,r,n,e))),this.#No(t,r)}))}#Vo(e,t){return`<div class='debug-item'>${On[t]||t}<span class='debug-item-title view${e}_${t}'/></div>`}#Ho(e){const t=this.dom.querySelector(".item-container"),r=e.map(((e,t)=>{const{name:r}=e,n=An.map((e=>this.#Vo(t,e)));return n.push('<div class="debug-sub-group">',this.#Vo(t,"x_y"),this.#Vo(t,"width_height"),this.#Vo(t,"pixelRectArray"),this.#Vo(t,"camera"),this.#Vo(t,"scene"),this.#Vo(t,"useBackgroundColor"),this.#Vo(t,"backgroundColor"),"</div>"),`${createDebugTitle(`<div class="debug-sub-group-title">${r}</div>`)}${n.join("")}`}));return t.innerHTML=`<div class="debug-group">${r.join('<div class="div-line"></div>')}</div>`}#Go(e,t,r,n){const{debugViewRenderState:i}=e,s=`total${r.charAt(0).toUpperCase()}${r.substring(1)}`,a=i[r],o="usedVideoMemory"===r?`<b>${formatBytes(a)}</b>`:a,u=Dn[r];n[s]+=a,updateDebugItemValue(this.dom,`view${t}_${r}`,o,!1,u)}#No(e,t){const{debugViewRenderState:r,rawCamera:n,scene:i}=e,{backgroundColor:s,useBackgroundColor:a}=i,{viewportSize:o}=r,{pixelRectArray:u,x:l,y:c,width:h,height:m}=o;updateDebugItemValue(this.dom,`view${t}_x_y`,`${l},${c}`),updateDebugItemValue(this.dom,`view${t}_width_height`,`${h},${m}`),updateDebugItemValue(this.dom,`view${t}_pixelRectArray`,u),updateDebugItemValue(this.dom,`view${t}_useBackgroundColor`,makeBooleanDebug(0,a)),updateDebugItemValue(this.dom,`view${t}_backgroundColor`,makeColorDebug("backgroundColor",s)),updateDebugItemValue(this.dom,`view${t}_camera`,n.name),updateDebugItemValue(this.dom,`view${t}_scene`,i.name)}};class DebugViewList extends ADebugItem{constructor(){super(),this.debugStatisticsDomService=new Gn}}class DebugStatisticsDomService{dom;constructor(){this.dom=document.createElement("div"),this.dom.style.cssText="z-index:1;position:sticky;top:0;background:#000;border-bottom:1px solid rgba(255,255,255,0.06);box-shadow:0 10px 10px rgba(0,0,0,0.5)",this.#zo()}update(e,t,r){const n={elapsedSeconds:e,currentFps:t,averageFps:r};Object.entries(n).forEach((([e,t])=>this.#Ko(e,t)))}#zo(){this.dom.innerHTML='<div class="debug-group" ><div class=\'debug-item\'><span class=\'debug-item-title\'>Frame</span><span style="text-align:right"><div class="elapsedSeconds">elapsedSeconds</div><div class="currentFps">currentFps</div><div style="color:#fff" class="averageFps">averageFps</div></span></div></div>'}#Ko(e,t){const r=this.dom.querySelector(`.${e}`);if(r){const e=t.toLocaleString();r.innerHTML!==e&&(r.innerHTML=e)}}}class Fps extends ADebugItem{#Xo;#jo;#Yo=0;#Zo=0;constructor(){super(),this.debugStatisticsDomService=new DebugStatisticsDomService,this.#jo=performance.now()}update(e,t,r){this.#qo(r);const n=this.#Wo(),{elapsedSeconds:i,currentFps:s,averageFps:a}=n;this.debugStatisticsDomService.update(`${i.toLocaleString()}ms`,`${s.toLocaleString()} fps`,`AVG:${a} fps`)}#qo(e){this.#Xo=e-this.#jo||16,this.#jo=e,this.#Yo++}#Wo(){const e=1/(this.#Xo/1e3),t=Math.round(e);this.#Zo+=e;return{currentFps:t,averageFps:Math.round(this.#Zo/this.#Yo),elapsedSeconds:this.#Xo}}}class DebugRender{fps;debugTotalState;debugViewList;debugRedGPUContext;debugBitmapTextureList;debugCubeTextureList;debugIndexBufferList;debugVertexBufferList;debugUniformBufferList;debugStorageBufferList;totalNum3DGroups;totalNum3DObjects;totalNumDrawCalls;totalNumInstances;totalNumTriangles;totalNumPoints;totalUsedVideoMemory;#Jo;constructor(){this.fps=new Fps,this.debugTotalState=new DebugTotalState,this.debugRedGPUContext=new DebugRedGPUContext,this.debugViewList=new DebugViewList,this.debugBitmapTextureList=new DebugTextureList,this.debugCubeTextureList=new DebugTextureList(!0),this.debugIndexBufferList=new DebugBufferList("IndexBuffer"),this.debugVertexBufferList=new DebugBufferList("VertexBuffer"),this.debugUniformBufferList=new DebugBufferList("UniformBuffer"),this.debugStorageBufferList=new DebugBufferList("StorageBuffer"),this.#Qo()}render(e,t){e.useDebugPanel?(this.#eu(),this.fps.update(this,e,t),this.debugRedGPUContext.update(this,e,t),this.debugViewList.update(this,e,t),this.debugBitmapTextureList.update(this,e,t),this.debugCubeTextureList.update(this,e,t),this.debugIndexBufferList.update(this,e),this.debugVertexBufferList.update(this,e),this.debugUniformBufferList.update(this,e),this.debugStorageBufferList.update(this,e),this.debugTotalState.update(this,e,t)):this.#tu(),this.#Qo()}#Qo(){this.totalNum3DGroups=0,this.totalNum3DObjects=0,this.totalNumInstances=0,this.totalNumDrawCalls=0,this.totalNumTriangles=0,this.totalNumPoints=0,this.totalUsedVideoMemory=0}#eu(){this.#Jo||(this.#Jo=document.createElement("div"),this.#Jo.className="RedGPUDebugPanel",document.body.appendChild(this.#Jo),[this.fps.debugStatisticsDomService,this.debugTotalState.debugStatisticsDomService,this.debugRedGPUContext.debugStatisticsDomService,this.debugViewList.debugStatisticsDomService,this.debugVertexBufferList.debugStatisticsDomService,this.debugIndexBufferList.debugStatisticsDomService,this.debugUniformBufferList.debugStatisticsDomService,this.debugStorageBufferList.debugStatisticsDomService,this.debugBitmapTextureList.debugStatisticsDomService,this.debugCubeTextureList.debugStatisticsDomService].forEach((e=>this.#Jo.appendChild(e.dom))))}#tu(){this.#Jo&&(this.#Jo.remove(),this.#Jo=null)}}Object.freeze(DebugRender);const renderListForLayer=(e,t,r="pipeline")=>{let n=0;const i=e.length,{currentRenderPassEncoder:s}=t;for(;n<i;n++){const i=e[n];if(i.gpuRenderInfo){const e=i._geometry,n=i._material;e?t.num3DObjects++:t.num3DGroups++;const{gpuRenderInfo:a}=i,{vertexUniformBindGroup:o}=a;if(e&&a[r]){s.setPipeline(a[r]);const{gpuBuffer:u}=e.vertexBuffer,{fragmentUniformBindGroup:l}=n.gpuRenderInfo;if(t.prevVertexGpuBuffer!==u&&(s.setVertexBuffer(0,u),t.prevVertexGpuBuffer=u,i.particleBuffers&&(i.particleBuffers.forEach(((e,t)=>{s.setVertexBuffer(t+1,e)})),t.prevVertexGpuBuffer=null)),s.setBindGroup(1,o),t.prevFragmentUniformBindGroup!==l&&(s.setBindGroup(2,l),t.prevFragmentUniformBindGroup=l),t.numDrawCalls++,e.indexBuffer){const{indexBuffer:r}=e,{indexNum:n,triangleCount:a,gpuBuffer:o}=r;s.setIndexBuffer(o,"uint32"),i.particleBuffers?s.drawIndexed(n,i.particleNum,0,0,0):s.drawIndexed(n,1,0,0,0),t.numTriangles+=a,t.numPoints+=n}else{const{vertexBuffer:r}=e,{vertexCount:n,triangleCount:i}=r;s.draw(n,1,0,0),t.numTriangles+=i,t.numPoints+=n}}}}t.prevVertexGpuBuffer=null,t.prevFragmentUniformBindGroup=null,t.prevVertexGpuBuffer=null},renderList=(e,t)=>{let r=0;const n=e.length;for(;r<n;r++)e[r].render(t);t.prevVertexGpuBuffer=null,t.prevFragmentUniformBindGroup=null,t.prevVertexGpuBuffer=null};class Renderer{#ru;#nu;#iu=new DebugRender;constructor(){}renderFrame(e,t){this.#nu||(this.#nu=new FinalRender);const r=[];{let n=0;const i=e.viewList.length;for(;n<i;n++){const i=e.viewList[n];r.push(this.renderView(i,t))}}this.#nu.render(e,r);{let t=0;const r=e.viewList.length;for(;t<r;t++)e.viewList[t].postEffectManager.clear()}}start(e,t){cancelAnimationFrame(e.currentRequestAnimationFrame);const HD_render=r=>{t?.(r),this.renderFrame(e,r),this.#iu.render(e,r),e.currentRequestAnimationFrame=requestAnimationFrame(HD_render)};e.currentRequestAnimationFrame=requestAnimationFrame(HD_render)}stop(e){cancelAnimationFrame(e.currentRequestAnimationFrame)}renderView(e,t){const{redGPUContext:r,camera:n,scene:i,pickingManager:s,pixelRectObject:a,axis:o,grid:u,debugViewRenderState:l}=e,{shadowManager:c}=i,{colorAttachment:h,depthStencilAttachment:m}=this.#su(e),d={colorAttachments:[h],depthStencilAttachment:m};n.update?.(e);const p=r.gpuDevice.createCommandEncoder();if(e.debugViewRenderState.reset(null,t),a.width&&a.height){if(c.shadowDepthGPUTextureView){const t={colorAttachments:[],depthStencilAttachment:{view:c.shadowDepthGPUTextureView,depthClearValue:1,depthLoadOp:Ne.CLEAR,depthStoreOp:Ve.STORE}},r=p.beginRenderPass(t);this.#au(e,r,!0,!1),((e,t)=>{const{debugViewRenderState:r,scene:n}=e;r.currentRenderPassEncoder=t;const{castingList:i}=n.shadowManager;renderListForLayer(i,r,"shadowPipeline")})(e,r),r.end(),c.resetCastingList()}{const t=p.beginRenderPass(d);this.#au(e,t,!1,!0),((e,t)=>{const{debugViewRenderState:r,skybox:n,scene:i}=e;r.currentRenderPassEncoder=t;const{instanceMeshLayer:s}=r,{children:a}=i;n&&n.render(r),renderList(a,r),renderList(s,r)})(e,t),o&&o.render(l),u&&u.render(l),((e,t)=>{const{debugViewRenderState:r,rawCamera:n}=e;r.currentRenderPassEncoder=t;const{alphaLayer:i,transparentLayer:s,particleLayer:a}=r;renderListForLayer(i,r);const{x:o,y:u,z:l}=n;sortTransparentObjects({x:o,y:u,z:l},s),renderListForLayer(s,r),renderListForLayer(a,r)})(e,t),t.end()}if(e.postEffectManager.effectList.length&&(d.colorAttachments[0].postEffectView=e.postEffectManager.render()),s){s.checkTexture(e);const t={colorAttachments:[{view:s.pickingGPUTextureView,clearValue:{r:0,g:0,b:0,a:0},loadOp:Ne.CLEAR,storeOp:Ve.STORE}],depthStencilAttachment:{view:s.pickingDepthGPUTextureView,depthClearValue:1,depthLoadOp:Ne.CLEAR,depthStoreOp:Ve.STORE}},r=p.beginRenderPass(t);this.#au(e,r,!1,!1),((e,t)=>{const{debugViewRenderState:r,pickingManager:n}=e;r.currentRenderPassEncoder=t;const{castingList:i}=n;renderListForLayer(i,r,"pickingPipeline")})(e,r),r.end()}}return r.gpuDevice.queue.submit([p.finish()]),e.debugViewRenderState.viewRenderTime=performance.now()-e.debugViewRenderState.startTime,s.checkEvents(e,t),d}#su(e){const{scene:t,redGPUContext:r,viewRenderTextureManager:n}=e,{depthTextureView:i,colorTextureView:s,colorResolveTextureView:a}=n,{useBackgroundColor:o,backgroundColor:u}=t,l=u.rgbaNormal,c={view:s,clearValue:o?{r:l[0]*l[3],g:l[1]*l[3],b:l[2]*l[3],a:l[3]}:{r:0,g:0,b:0,a:0},loadOp:Ne.CLEAR,storeOp:Ve.STORE};r.useMSAA&&(c.resolveTarget=a);return{colorAttachment:c,depthStencilAttachment:{view:i,depthClearValue:1,depthLoadOp:Ne.CLEAR,depthStoreOp:Ve.STORE}}}#au(e,t,r=!1,n=!0){const{inverseProjectionMatrix:i,pixelRectObject:s,projectionMatrix:a,rawCamera:o,redGPUContext:u,scene:l}=e,{gpuDevice:c}=u,{modelMatrix:h,position:m}=o,d=e.systemUniform_Vertex_StructInfo,p=e.systemUniform_Vertex_UniformBuffer.gpuBuffer,{shadowManager:f,lightManager:g}=l,x=o instanceof Camera2D;if(r){const e=f.directionalLightShadowDepthTextureSize,r=f.directionalLightShadowDepthTextureSize;t.setViewport(0,0,e,r,0,1),t.setScissorRect(0,0,e,r)}else{const{width:e,height:r}=s;this.#ru&&this.#ru.width===e&&this.#ru.height===r||(t.setViewport(0,0,e,r,0,1),t.setScissorRect(0,0,e,r),this.#ru={width:e,height:r})}g.updateViewSystemUniforms(e),f.updateViewSystemUniforms(u),e.update(e,r,n),t.setBindGroup(0,e.systemUniform_Vertex_UniformBindGroup),[{key:"projectionMatrix",value:a},{key:"projectionCameraMatrix",value:multiply$5(Nn,a,h)},{key:"inverseProjectionMatrix",value:i},{key:"resolution",value:[e.pixelRectObject.width,e.pixelRectObject.height]}].forEach((({key:e,value:t})=>{c.queue.writeBuffer(p,d.members[e].uniformOffset,new d.members[e].View(t))})),[{key:"cameraMatrix",value:h},{key:"cameraPosition",value:m},{key:"nearClipping",value:[x?0:o.nearClipping]},{key:"farClipping",value:[x?0:o.farClipping]}].forEach((({key:e,value:t})=>{c.queue.writeBuffer(p,d.members.camera.members[e].uniformOffset,new d.members.camera.members[e].View(t))}))}}let Nn=create$5();var Vn=Object.freeze({__proto__:null,isHexColor:isHexColor,isUint:isUint,validateNumber:validateNumber,validateNumberRange:validateNumberRange,validatePositiveNumberRange:validatePositiveNumberRange,validateRedGPUContext:validateRedGPUContext,validateUintRange:validateUintRange});class MeshInfo_OBJ{name;groupName;materialKey;index;position;resultPosition;resultNormal;resultUV;resultInterleave;use;childrenInfo;ableUV;ableNormal;ableLight;mesh;constructor(e,t){this.name=e,this.groupName=t,this.index=[],this.position=[],this.resultPosition=[],this.resultNormal=[],this.resultUV=[],this.resultInterleave=[],this.use=!0,this.childrenInfo={}}createVertexBuffer(e,t){let r={};return this.resultPosition.length&&(r.aVertexPosition=InterleaveType.float32x3),this.resultNormal.length&&(r.aVertexNormal=InterleaveType.float32x3),this.resultUV.length&&(r.aTexcoord=InterleaveType.float32x2),new VertexBuffer(e,new Float32Array(this.resultInterleave.length?this.resultInterleave:this.resultPosition),new InterleavedStruct(r,`InterleavedStruct_${t}}`),void 0,`VertexBuffer_${t}`)}createBufferIndex(e,t){if(this.index.length)return new IndexBuffer(e,this.index,void 0,`IndexBuffer_${t}`)}createColorMaterial(e){return this.resultUV.length&&this.resultNormal.length||this.resultNormal.length?new ColorMaterial(e,"#00ff00"):new ColorMaterial(e,"#0000ff")}}Object.freeze(MeshInfo_OBJ);class TotalPointInfo_OBJ{position=[];normal=[];uv=[];points=[];normalPoints=[];uvPoints=[];constructor(){}}Object.freeze(TotalPointInfo_OBJ);class OBJMTLLoader{complete;parseData;#ou;#uu;#lu;constructor(e,t,r){this.#ou=getFilePath(t),this.#uu=getFileName(t),this.#lu=t,this.#cu(t,r)}get path(){return this.#ou}get fileName(){return this.#uu}get url(){return this.#lu}#cu(e,t){fetch(e,{method:"GET",headers:{"Content-Type":"application/x-www-form-urlencoded;charset=UTF-8"}}).then((e=>{if(!e.ok)throw new Error(`HTTP ! :${e.status}`);return e.text()})).then((e=>{this.complete=!0,this.parseData=function(e,t){let r;const n={},i={single:["newmtl","Ns","Ni","d","illum"],multi:["Ka","Kd","Ks"],maps:["map_Kd","map_Ns","map_bump"]};return(t=t.replace(/^\#[\s\S]+?\n/g,"")).split("\n").forEach((t=>{for(const s in i)for(const a of i[s])if(new RegExp(`^(${a} )`).test(t))switch(s){case"single":if("newmtl"===a){const e=t.replace("newmtl ","").trim();r={name:e},n[e]=r}else r[a]=+t.replace(`${a} `,"").trim();break;case"multi":r[a]=t.replace(`${a} `,"").split(" ");break;case"maps":r[a]=e.path+t.replace(`${a} `,"").trim()}})),n}(this,e),t?.(this.parseData)})).catch((e=>{this.complete=!0,this.parseData={},t?.(this.parseData)}))}}Object.freeze(OBJMTLLoader);const Fn=/^o/,zn=/v( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)( +[\d|\.|\+|\-|e|E]+)/,$n=/f\s+(([\d]{1,}[\s]?){3,})+/,Hn=/f\s+((([\d]{1,}\/[\d]{1,}[\s]?){3,})+)/,Kn=/f\s+((([\d]{1,}\/[\d]{1,}\/[\d]{1,}[\s]?){3,})+)/,Xn=/f\s+((([\d]{1,}\/\/[\d]{1,}[\s]?){3,})+)/;let jn,Yn;function processMaterialLibrary(e,t,r,n,i){i=new OBJMTLLoader(r,`${t.path}${e.split(" ")[1]}`,(e=>{t.mtlLoader=e,t.modelParsingComplete&&(((e,t,r)=>{let n,i,s,a;for(n in a={},t){let o,u;s=t[n];const{use:l,materialKey:c,mesh:h}=s,{ableLight:m,ableNormal:d}=s,{resultInterleave:p}=s;if(l&&p.length){let t,n,s;i=r.parseData[c],i&&(i.map_Kd?(a[i.map_Kd]?u=a[i.map_Kd]:(u=new BitmapTexture(e,i.map_Kd),a[i.map_Kd]=u),o=new BitmapMaterial(e,u)):i.Kd&&(t=255*i.Kd[0],n=255*i.Kd[1],s=255*i.Kd[2],o=new ColorMaterial(e,convertRgbToHex(t,n,s))),o&&(i.map_Ns&&(a[i.map_Ns]?u=a[i.map_Ns]:(u=new BitmapTexture(e,i.map_Ns),a[i.map_Ns]=u),o.specularTexture=u),i.map_bump&&(a[i.map_bump]?u=a[i.map_bump]:(u=new BitmapTexture(e,i.map_bump),a[i.map_bump]=u),o.normalTexture=u),void 0!==i.Ns&&(o.shininess=i.Ns),h.material=o))}}})(r,n,i),t.callback&&t.callback(t.result))})),t.mtlLoader=i}function processMaterialUsage(e,t,r){t[r].materialKey=e.split(" ").slice(1).join("").trim()}function processGroup(e,t,r,n){const i=e.split(" ").slice(1).join("").trim();t[r].use=!1;const s=new MeshInfo_OBJ(i,r);s.groupName=r,s.materialKey=i.replace(`${r}_`,""),s.position=jn.position,n[i]=jn=s,t[r].childrenInfo[i]=jn}function processNewObject(e,t,r){const n=e.split(" ").slice(1).join("").trim(),i=new MeshInfo_OBJ(n,n);i.groupName=n,i.materialKey=n,t[n]=jn=i,r[n]=jn,Yn=n}function processVertexNormals(e,t,r){const n=e.split(" ");t.push(+n[1],+n[2],+n[3]),r[r.length]=[+n[1],+n[2],+n[3]]}function processTextureCoordinates(e,t,r){const n=e.split(" ");t.push(+n[1],1-n[2]),r[r.length]=[+n[1],1-n[2]]}function processVertex(e,t,r){const n=e.split(" ");t.push(+n[1],+n[2],+n[3]),jn.position.push(+n[1],+n[2],+n[3]),r[r.length]=[+n[1],+n[2],+n[3]]}function processFaceVertexNormal(e,t,r,n,i){const s=3*(t.length+r.length);e.split(" ").slice(1,4).forEach((e=>{const[t,,r]=e.split("/").map((e=>Number(e)-1)),a=n[t],o=i[r],{index:u,resultInterleave:l}=jn,{resultPosition:c,resultNormal:h,resultUV:m}=jn;u.push(l.length/s),c.push(...a),h.push(...o),l.push(...a,...o)}))}function processFaceVertexTextureNormal(e,t,r,n,i,s,a){let o=e.split(" ").slice(1,5);if(4===o.length){let e=o[3];o[3]=o[0],o[4]=o[2],o[5]=e}o.forEach((e=>{const[o,u,l]=e.split("/").map(Number).map((e=>e-1)),c=i[o],h=a[u],m=s[l],d=(t.length?3:0)+(r.length?3:0)+(n.length?2:0),{index:p,resultInterleave:f}=jn,{resultPosition:g,resultNormal:x,resultUV:_}=jn;p.push(f.length/d),t.length&&(g.push(...c),f.push(...c)),r.length&&(x.push(...m),f.push(...m)),n.length&&(_.push(...h),f.push(...h))}))}function processFaceVertexTexture(e,t,r,n,i){e.split(" ").slice(1,4).forEach((e=>{const[s,a]=e.split("/").map(Number).map((e=>e-1)),o=n[s];let u;0!==i.length&&(u=i[a]);const l=(t.length?3:0)+(r.length?2:0);jn.index.push(jn.resultInterleave.length/l),t.length&&(jn.resultPosition.push(...o),jn.resultInterleave.push(...o)),r.length&&(jn.resultUV.push(...u),jn.resultInterleave.push(...u))}))}function processFaceVertex(e,t){let r=e.split(" ");jn.resultInterleave=jn.resultPosition=jn.position,jn.index.push(+r[1]-1,+r[2]-1,+r[3]-1),jn.index.push(+r[1]-1,+r[3]-1,+r[4]-1)}const parserMesh_OBJ=(e,t,r)=>{for(let n in r){const i=r[n];let s;if(i.use){const t=i.createVertexBuffer(e,n),r=i.createBufferIndex(e,n),a=i.createColorMaterial(e);s=new Mesh(e,new Geometry(e,t,r),a),i.ableUV=Boolean(i.resultUV.length),i.ableNormal=Boolean(i.resultNormal.length),i.ableLight=i.ableUV&&i.ableNormal}else s=new Mesh(e);s.name=n,i.mesh=s,t.addChild(s),parserMesh_OBJ(e,s,i.childrenInfo)}},parserOBJ=(e,t,r)=>{const n=((e,t,r)=>{let n,i;const s=new TotalPointInfo_OBJ,{points:a,normalPoints:o,uvPoints:u}=s,{position:l,normal:c,uv:h}=s;let m,d;i={},n={};const p=r.length;for(m=0;m<p;m++)if(Fn.test(r[m])){d=!0;break}if(!d){const e="objModel"+createUUID();i[e]=jn=new MeshInfo_OBJ(e,e),n[e]=jn,Yn=e}const f=r.length;for(let s=0;s<f;s++){const m=r[s];m.startsWith("mtllib ")?processMaterialLibrary(m,t,e,n,void 0):m.startsWith("usemtl ")?processMaterialUsage(m,n,Yn):m.startsWith("g ")?processGroup(m,i,Yn,n):m.startsWith("o ")?processNewObject(m,i,n):m.startsWith("vn ")?processVertexNormals(m,c,o):m.startsWith("vt ")?processTextureCoordinates(m,h,u):zn.test(m)?processVertex(m,l,a):Xn.test(m)?processFaceVertexNormal(m,l,c,a,o):Kn.test(m)?processFaceVertexTextureNormal(m,l,c,h,a,o,u):Hn.test(m)?processFaceVertexTexture(m,l,h,a,u):$n.test(m)&&processFaceVertex(m)}return{info:n,infoHierarchy:i}})(e,t,(r=r.replace(/^\#[\s\S]+?\n/g,"")).split("\n")),i=n.infoHierarchy;return parserMesh_OBJ(e,t.resultMesh,i),{...t,...n,parseInfoMaterial:t.mtlLoader}};class OBJLoader{modelParsingComplete=!1;resultMesh;result;callback;mtlLoader;#ou;#uu;#lu;constructor(e,t,r){validateRedGPUContext(e),t&&(fetch(t).then((e=>e.text())).then((t=>{this.result=parserOBJ(e,this,t),this.modelParsingComplete=!0,this.resultMesh=t,r&&(this.mtlLoader?this.mtlLoader.complete&&r(this.result):r(this.result))})).catch((e=>console.error("Error:",e))),this.#ou=getFilePath(t),this.#uu=getFileName(t),this.#lu=t,this.mtlLoader=null,this.callback=r,this.resultMesh=new Mesh(e),this.resultMesh.name="instanceOfOBJLoader_"+createUUID(),this.result=null)}get path(){return this.#ou}get fileName(){return this.#uu}get url(){return this.#lu}}Object.freeze(OBJLoader);class ASinglePassPostEffect{#hu;#mu;#ba;#Ta;#Fn;#du;#pu;#fu=[];#gu=[];#un=16;#ln=16;#cn=1;constructor(){}get storageInfo(){return this.#pu}get uniformBuffer(){return this.#Fn}get uniformInfo(){return this.#du}get WORK_SIZE_X(){return this.#un}set WORK_SIZE_X(e){this.#un=e}get WORK_SIZE_Y(){return this.#ln}set WORK_SIZE_Y(e){this.#ln=e}get WORK_SIZE_Z(){return this.#cn}set WORK_SIZE_Z(e){this.#cn=e}get outputTextureView(){return this.#gu}getOutputTextureView(){return this.#gu[this.#gu.length-1]}clear(){this.#fu&&(this.#fu.forEach((e=>e.destroy())),this.#fu.length=0,this.#gu.length=0)}init(e,t,r,n){const{resourceManager:i}=e;this.#hu=i.createGPUShaderModule(t,{code:r});const s=parseWGSL(r),a=s.storage,o=s.uniforms.uniforms;if(this.#pu=a,o){this.#du=o;const t=new ArrayBuffer(o.arrayBufferByteLength);this.#Fn=new UniformBuffer(e,t,`${this.constructor.name}_UniformBuffer`)}this.#mu=n||e.resourceManager.getGPUBindGroupLayout(`${t}_BIND_GROUP_LAYOUT`)||e.resourceManager.createBindGroupLayout(`${t}_BIND_GROUP_LAYOUT`,getComputeBindGroupLayoutDescriptorFromShaderInfo(s,0))}execute(e,t,r){this.#Ta=e.createComputePipeline({layout:e.createPipelineLayout({bindGroupLayouts:[this.#mu]}),compute:{module:this.#hu,entryPoint:"main"}});const n=e.createCommandEncoder(),i=n.beginComputePass();i.setPipeline(this.#Ta),i.setBindGroup(0,this.#ba),i.dispatchWorkgroups(Math.ceil(t/this.WORK_SIZE_X),Math.ceil(r/this.WORK_SIZE_Y)),i.end(),e.queue.submit([n.finish()])}render(e,t,r,...n){this.#xu(e);const i=this.getOutputTextureView(),{redGPUContext:s}=e,{gpuDevice:a}=s,o=[];for(const e in this.#pu){const t=this.#pu[e],{binding:r,name:s}=t;o.push({binding:r,resource:"outputTexture"===s?i:n[r]})}return this.#Fn&&o.push({binding:this.#du.binding,resource:{buffer:this.#Fn.gpuBuffer,offset:0,size:this.#Fn.size}}),this.#ba=a.createBindGroup({layout:this.#mu,entries:o}),this.execute(a,t,r),i}#xu(e){const{redGPUContext:t,viewRenderTextureManager:r}=e,{colorTexture:n}=r,{gpuDevice:i}=t,{width:s,height:a}=n,o=i.createTexture({size:{width:s,height:a},format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.STORAGE_BINDING});this.#fu.push(o),this.#gu.push(o.createView())}}Object.freeze(ASinglePassPostEffect);class AMultiPassPostEffect extends ASinglePassPostEffect{#_u=[];constructor(e){super(),this.#_u.push(...e)}get passList(){return this.#_u}clear(){this.#_u.forEach((e=>e.clear()))}render(e,t,r,n){let i;return this.#_u.forEach(((s,a)=>{a&&(n=i),i=s.render(e,t,r,n)})),i}}Object.freeze(AMultiPassPostEffect);const createPostEffectCode=(e,t,r="")=>{const{WORK_SIZE_X:n,WORK_SIZE_Y:i,WORK_SIZE_Z:s}=e;return`${r}@group(0) @binding(0) var sourceTexture:texture_storage_2d<rgba8unorm,read>;@group(0) @binding(1) var outputTexture:texture_storage_2d<rgba8unorm,write>;${r?"@group(0) @binding(2) var<uniform> uniforms:Uniforms;":""}@compute @workgroup_size(${n},${i},${s})fn main (@builtin(global_invocation_id) global_id:vec3<u32>,){${t}};`};Object.freeze(createPostEffectCode);class BrightnessContrast extends ASinglePassPostEffect{#vu=0;#yu=0;constructor(e){super();const t=createPostEffectCode(this,"let index=vec2<u32>(global_id.xy );let dimensions:vec2<u32>=textureDimensions(sourceTexture);let dimW=f32(dimensions.x);let dimH=f32(dimensions.y);let uv=\tvec2<f32>(f32(index.x)/dimW,f32(index.y)/dimH);var color:vec4<f32>=textureLoad(sourceTexture,index,);let brightness_value:f32=uniforms.brightness/255.0;let contrast_value:f32=uniforms.contrast/255.0;var tempColor:vec3<f32>;if ( contrast_value > 0.0 ) {tempColor=( color.rgb - 0.5 )/( 1.0 - contrast_value ) + 0.5;}else {tempColor=( color.rgb - 0.5 ) * ( 1.0 + contrast_value ) + 0.5;}color=vec4<f32>(tempColor + brightness_value,color.a);textureStore(outputTexture,index,color );","struct Uniforms {brightness:f32,contrast:f32};");this.init(e,"POST_EFFECT_BRIGHTNESS_CONTRAST",t)}get brightness(){return this.#vu}set brightness(e){validateNumberRange(e,-150,150),this.#vu=e,this.uniformBuffer.writeBuffer(this.uniformInfo.members.brightness,e)}get contrast(){return this.#yu}set contrast(e){validateNumberRange(e,-50,100),this.#yu=e,this.uniformBuffer.writeBuffer(this.uniformInfo.members.contrast,e)}}Object.freeze(BrightnessContrast);class Grayscale extends ASinglePassPostEffect{constructor(e){super();const t=createPostEffectCode(this,"let index=vec2<u32>(global_id.xy );let dimensions:vec2<u32>=textureDimensions(sourceTexture);let dimW=f32(dimensions.x);let dimH=f32(dimensions.y);let uv=\tvec2<f32>(f32(index.x)/dimW,f32(index.y)/dimH);var color:vec4<f32>=textureLoad(sourceTexture,index,);let gray=(color.r + color.g + color.b)/3.0;textureStore(outputTexture,index,vec4<f32>( gray,gray,gray,1.0) );");this.init(e,"POST_EFFECT_GRAYSCALE",t)}}Object.freeze(Grayscale);class HueSaturation extends ASinglePassPostEffect{#Tu=0;#bu=0;constructor(e){super();const t=createPostEffectCode(this,"let index=vec2<u32>(global_id.xy );let dimensions:vec2<u32>=textureDimensions(sourceTexture);let dimW=f32(dimensions.x);let dimH=f32(dimensions.y);let uv=\tvec2<f32>(f32(index.x)/dimW,f32(index.y)/dimH);var color:vec4<f32>=textureLoad(sourceTexture,index,);let hue_value:f32=uniforms.hue/180.0;let saturation_value:f32=uniforms.saturation/100.0;let angle:f32=hue_value * 3.1415926535897932384626433832795;let s:f32=sin(angle);let c:f32=cos(angle);var weights:vec3<f32>=(vec3<f32>(2.0 * c,-sqrt(3.0) * s - c,sqrt(3.0) * s - c) + 1.0)/3.0;let len:f32=length(color.rgb);color=vec4<f32>(vec3<f32>(dot(color.rgb,weights.xyz),dot(color.rgb,weights.zxy),dot(color.rgb,weights.yzx)),color.a);let average:f32=(color.r + color.g + color.b)/3.0;if (saturation_value > 0.0) {color=vec4<f32>(color.rgb + (average - color.rgb) * (1.0 - 1.0/(1.001 - saturation_value)),color.a);} else {color=vec4<f32>(color.rgb + (average - color.rgb) * (-saturation_value),color.a);}textureStore(outputTexture,index,color );","struct Uniforms {hue:f32,saturation:f32};");this.init(e,"POST_EFFECT_HUE_SATURATION",t)}get hue(){return this.#Tu}set hue(e){validateNumberRange(e,-180,180),this.#Tu=e,this.uniformBuffer.writeBuffer(this.uniformInfo.members.hue,e)}get saturation(){return this.#bu}set saturation(e){validateNumberRange(e,-100,100),this.#bu=e,this.uniformBuffer.writeBuffer(this.uniformInfo.members.saturation,e)}}Object.freeze(HueSaturation);class Invert extends ASinglePassPostEffect{constructor(e){super();const t=createPostEffectCode(this,"let index=vec2<u32>(global_id.xy );let dimensions:vec2<u32>=textureDimensions(sourceTexture);let dimW=f32(dimensions.x);let dimH=f32(dimensions.y);let uv=\tvec2<f32>(f32(index.x)/dimW,f32(index.y)/dimH);var color:vec4<f32>=textureLoad(sourceTexture,index,);color.r=1.0 - color.r;color.g=1.0 - color.g;color.b=1.0 - color.b;textureStore(outputTexture,index,color );");this.init(e,"POST_EFFECT_INVERT",t)}}Object.freeze(Invert);class Threshold extends ASinglePassPostEffect{#Su=128;constructor(e){super();const t=createPostEffectCode(this,"let index=vec2<u32>(global_id.xy );let dimensions:vec2<u32>=textureDimensions(sourceTexture);let dimW=f32(dimensions.x);let dimH=f32(dimensions.y);var color:vec4<f32>=textureLoad(sourceTexture,index,);let threshold_value:f32=uniforms.threshold/255.0;var v=0.0;if( 0.2126 * color.r + 0.7152 * color.g + 0.0722 * color.b >=threshold_value) {v=1.0;}color=vec4<f32>(v,v,v,color.a);textureStore(outputTexture,index,color );","struct Uniforms {threshold:f32};");this.init(e,"POST_EFFECT_THRESHOLD",t),this.threshold=this.#Su}get threshold(){return this.#Su}set threshold(e){validateNumberRange(e,1,255),this.#Su=e,this.uniformBuffer.writeBuffer(this.uniformInfo.members.threshold,e)}}Object.freeze(Threshold);class BlurX extends ASinglePassPostEffect{#w=32;constructor(e){super();const t=createPostEffectCode(this,"let index=vec2<u32>(global_id.xy);let dimensions=textureDimensions(sourceTexture);let dimW=f32(dimensions.x);let size_value:f32=uniforms.size;var sum:vec4<f32>=vec4<f32>(0.0,0.0,0.0,0.0);var offset=random(global_id,0.0);var total=0.0;let loopSize=10.0;for (var t=-loopSize;t <=loopSize;t=t + 1.0) {var percent=(t + offset - 0.5)/loopSize;var weight=1.0 - abs(percent);var ix=clamp((f32(global_id.x) + f32(size_value * percent)),0.0,dimW - 1.0);let delta=vec2<i32>(i32(ix),i32(global_id.y));sum +=textureLoad(sourceTexture,delta).xyzw * weight;total +=weight;}sum/=total;textureStore(outputTexture,vec2<i32>(global_id.xy),sum);","struct Uniforms {size:f32,};fn random(id:vec3<u32>,delta:f32) -> f32 {let seed:u32=((id.x << 16) | (id.y & 0xFFFF)) ^ (id.z * 0x63641362);let t:vec3<f32>=vec3<f32>(f32(seed & 0xFF),f32((seed >> 8) & 0xFF),f32(seed >> 16));return delta + fract(sin(dot(t,vec3<f32>(12.9898,78.233,12.9898))) * 43758.5453);}");this.init(e,"POST_EFFECT_BLUR_X",t),this.size=this.#w}get size(){return this.#w}set size(e){validateNumberRange(e),this.#w=e,this.uniformBuffer.writeBuffer(this.uniformInfo.members.size,e)}}Object.freeze(BlurX);class BlurY extends ASinglePassPostEffect{#w=32;constructor(e){super();const t=createPostEffectCode(this,"let index=vec2<u32>(global_id.xy);let dimensions=textureDimensions(sourceTexture);let dimH=f32(dimensions.y);let size_value:f32=uniforms.size;var sum:vec4<f32>=vec4<f32>(0.0,0.0,0.0,0.0);var offset=random(global_id,0.0);var total=0.0;let loopSize=10.0;for (var t=-loopSize;t <=loopSize;t=t + 1.0) {var percent=(t + offset - 0.5)/loopSize;var weight=1.0 - abs(percent);var iy=clamp((f32(global_id.y) + f32(size_value * percent)),0.0,dimH - 1.0);let delta=vec2<i32>(i32(global_id.x),i32(iy));sum +=textureLoad(sourceTexture,delta).xyzw * weight;total +=weight;}sum/=total;textureStore(outputTexture,vec2<i32>(global_id.xy),sum);","struct Uniforms {size:f32,};fn random(id:vec3<u32>,delta:f32) -> f32 {let seed:u32=((id.x << 16) | (id.y & 0xFFFF)) ^ (id.z * 0x63641362);let t:vec3<f32>=vec3<f32>(f32(seed & 0xFF),f32((seed >> 8) & 0xFF),f32(seed >> 16));return delta + fract(sin(dot(t,vec3<f32>(12.9898,78.233,12.9898))) * 43758.5453);}");this.init(e,"POST_EFFECT_BLUR_Y",t),this.size=this.#w}get size(){return this.#w}set size(e){validateNumberRange(e),this.#w=e,this.uniformBuffer.writeBuffer(this.uniformInfo.members.size,e)}}Object.freeze(BlurY);class GaussianBlur extends AMultiPassPostEffect{#w=32;constructor(e){super([new BlurX(e),new BlurY(e)])}get size(){return this.#w}set size(e){this.#w=e,this.passList.forEach((t=>t.size=e))}}Object.freeze(GaussianBlur);class ZoomBlur extends ASinglePassPostEffect{#Mu=128;#cr=0;#hr=0;constructor(e){super();const t=createPostEffectCode(this,"let dimensions=textureDimensions(sourceTexture);let dimW=f32(dimensions.x);let dimH=f32(dimensions.y);let dimensionsVec=vec2<f32>(dimW,dimH);let amount=uniforms.amount/min(dimW,dimH);const loopSize=30.0;let offset=random(global_id,0.0);let center=vec2<f32>(dimW * 0.5 + uniforms.centerX,dimH * 0.5 + uniforms.centerY);let global_id_vec=vec2<f32>(f32(global_id.x),f32(global_id.y));let dir=(center - global_id_vec) * amount;var sum=vec4<f32>(0.0,0.0,0.0,0.0);var total=0.0;for (var t=-loopSize;t <=loopSize;t=t + 1.0) {var percent=1.0 - (t + offset - 0.5)/loopSize;var weight=3.0 * (percent - percent * percent);let deltaPercent=dir * percent;let delta=vec2<i32>(i32(clamp(global_id_vec.x + deltaPercent.x,0.0,dimW - 1.0)),i32(clamp(global_id_vec.y + deltaPercent.y,0.0,dimH - 1.0)));sum +=textureLoad(sourceTexture,delta).xyzw * weight;total +=weight;}textureStore(outputTexture,vec2<i32>(global_id.xy),sum/total);","struct Uniforms {amount:f32,centerX:f32,centerY:f32};fn random(id:vec3<u32>,delta:f32) -> f32 {let seed:u32=((id.x << 16) | (id.y & 0xFFFF)) ^ (id.z * 0x63641362);let t:vec3<f32>=vec3<f32>(f32(seed & 0xFF),f32((seed >> 8) & 0xFF),f32(seed >> 16));return delta + fract(sin(dot(t,vec3<f32>(12.9898,78.233,12.9898))) * 43758.5453);}");this.init(e,"POST_EFFECT_ZOOM_BLUR",t),this.amount=this.#Mu}get centerX(){return this.#cr}set centerX(e){validateNumber(e),this.#cr=e,this.uniformBuffer.writeBuffer(this.uniformInfo.members.centerX,e)}get centerY(){return this.#hr}set centerY(e){validateNumber(e),this.#hr=e,this.uniformBuffer.writeBuffer(this.uniformInfo.members.centerY,e)}get amount(){return this.#Mu}set amount(e){validateNumberRange(e,0),this.#Mu=e,this.uniformBuffer.writeBuffer(this.uniformInfo.members.amount,e)}}Object.freeze(ZoomBlur);const Zn=[0,0,0,0,0,1,0,0,0,0,0,0],qn=[0,-1,0,0,-1,5,-1,0,0,-1,0,0],Wn=[1,1,1,0,1,1,1,0,1,1,1,0],Jn=[0,1,0,0,1,-4,1,0,0,1,0,0],Qn=[-2,-1,0,0,-1,1,1,0,0,1,2,0];class Convolution extends ASinglePassPostEffect{static NORMAL=Zn;static SHARPEN=qn;static BLUR=Wn;static EDGE=Jn;static EMBOSE=Qn;#Ru=Wn;constructor(e){super();const t=createPostEffectCode(this,"let index=vec2<i32>(global_id.xy );let dimensions:vec2<u32>=textureDimensions(sourceTexture);let dimW=f32(dimensions.x);let dimH=f32(dimensions.y);let perPX=\tvec2<f32>(1.0/dimW,1.0/dimH);let uv=\tvec2<f32>(f32(index.x)/dimW,f32(index.y)/dimH);var color:vec4<f32>=vec4<f32>(0.0);let kernelWeight_value:f32=uniforms.kernelWeight;let kernel_value:mat3x3<f32>=uniforms.kernel;\ncolor +=textureLoad(sourceTexture,index + vec2<i32>(-1,-1)) * kernel_value[0][0] ;color +=textureLoad(sourceTexture,index + vec2<i32>(0,-1)) * kernel_value[0][1];color +=textureLoad(sourceTexture,index + vec2<i32>(1,-1)) * kernel_value[0][2];color +=textureLoad(sourceTexture,index + vec2<i32>(-1,0)) * kernel_value[1][0];color +=textureLoad(sourceTexture,index + vec2<i32>(0,0)) * kernel_value[1][1];color +=textureLoad(sourceTexture,index + vec2<i32>(1,0)) * kernel_value[1][2];color +=textureLoad(sourceTexture,index + vec2<i32>(-1,1)) * kernel_value[2][0];color +=textureLoad(sourceTexture,index + vec2<i32>(0,1)) * kernel_value[2][1];color +=textureLoad(sourceTexture,index + vec2<i32>(1,1)) * kernel_value[2][2];textureStore(outputTexture,index,vec4<f32>((color/kernelWeight_value).rgb,1.0) );\n","struct Uniforms {kernelWeight:f32,kernel:mat3x3<f32>};");this.init(e,"POST_EFFECT_CONVOLUTION",t),this.kernel=this.#Ru}get kernel(){return this.#Ru}set kernel(e){this.#Ru=e;let t=0;for(const e in this.#Ru)t+=this.#Ru[e];this.uniformBuffer.writeBuffer(this.uniformInfo.members.kernelWeight,t),this.uniformBuffer.writeBuffer(this.uniformInfo.members.kernel,e)}}Object.freeze(Convolution);class OldBloomBlend extends ASinglePassPostEffect{#wu=1;#Eu=1;constructor(e){super();const{WORK_SIZE_X:t,WORK_SIZE_Y:r,WORK_SIZE_Z:n}=this,i=`struct Uniforms {bloomStrength:f32,exposure:f32};@group(0) @binding(0) var sourceTexture0:texture_storage_2d<rgba8unorm,read>;@group(0) @binding(1) var sourceTexture1:texture_storage_2d<rgba8unorm,read>;@group(0) @binding(2) var outputTexture:texture_storage_2d<rgba8unorm,write>;@group(0) @binding(3) var<uniform> uniforms:Uniforms;@compute @workgroup_size(${t},${r},${n})fn main (@builtin(global_invocation_id) global_id:vec3<u32>,){let index=vec2<u32>(global_id.xy );let dimensions:vec2<u32>=textureDimensions(sourceTexture0);let dimW=f32(dimensions.x);let dimH=f32(dimensions.y);let uv=\tvec2<f32>(f32(index.x)/dimW,f32(index.y)/dimH);var diffuse:vec4<f32>=textureLoad(sourceTexture0,index,);var blur:vec4<f32>=textureLoad(sourceTexture1,index,);let finalColor=vec4<f32>((diffuse.rgb + blur.rgb * uniforms.bloomStrength ) * uniforms.exposure,diffuse.a);textureStore(outputTexture,index,finalColor );};`;this.init(e,"POST_EFFECT_OLD_BLOOM",i),this.exposure=this.#Eu,this.bloomStrength=this.#wu}get bloomStrength(){return this.#wu}set bloomStrength(e){this.#wu=e,this.uniformBuffer.writeBuffer(this.uniformInfo.members.bloomStrength,e)}get exposure(){return this.#Eu}set exposure(e){this.#Eu=e,this.uniformBuffer.writeBuffer(this.uniformInfo.members.exposure,e)}render(e,t,r,n,i){return super.render(e,t,r,n,i)}}Object.freeze(OldBloomBlend);class OldBloom extends AMultiPassPostEffect{#Pu;#Cu;#ku;#Su=156;#Iu=32;#Eu=1;#wu=1.2;constructor(e){super([new Threshold(e),new GaussianBlur(e),new OldBloomBlend(e)]),this.#Pu=this.passList[0],this.#Cu=this.passList[1],this.#ku=this.passList[2],this.#Pu.threshold=this.#Su,this.#Cu.size=this.#Iu,this.#ku.exposure=this.#Eu,this.#ku.bloomStrength=this.#wu}get threshold(){return this.#Su}set threshold(e){this.#Su=e,this.#Pu.threshold=e}get gaussianBlurSize(){return this.#Iu}set gaussianBlurSize(e){this.#Iu=e,this.#Cu.size=e}get exposure(){return this.#Eu}set exposure(e){this.#Eu=e,this.#ku.exposure=e}get bloomStrength(){return this.#wu}set bloomStrength(e){this.#wu=e,this.#ku.bloomStrength=e}render(e,t,r,n){const i=this.#Pu.render(e,t,r,n),s=this.#Cu.render(e,t,r,i);return this.#ku.render(e,t,r,n,s)}}Object.freeze(OldBloom);class Vignetting extends ASinglePassPostEffect{#Uu=.2;#w=.5;constructor(e){super();const t=createPostEffectCode(this,"let dimensions=textureDimensions(sourceTexture);let dimW=f32(dimensions.x);let dimH=f32(dimensions.y);let index=vec2<u32>(global_id.xy);let uv=vec2<f32>(f32(index.x)/dimW,f32(index.y)/dimH);let smoothness=uniforms.smoothness;let size=uniforms.size;var color:vec4<f32>=textureLoad(sourceTexture,index);var diff=size - distance(uv,vec2<f32>(0.5));let vignette=smoothstep(-smoothness,smoothness,diff);color.r *=vignette;color.g *=vignette;color.b *=vignette;textureStore(outputTexture,index,color);","struct Uniforms {smoothness:f32,size:f32,};");this.init(e,"POST_EFFECT_VIGNETTING",t),this.smoothness=this.#Uu,this.size=this.#w}get size(){return this.#w}set size(e){validateNumberRange(e,0),this.#w=e,this.uniformBuffer.writeBuffer(this.uniformInfo.members.size,e)}get smoothness(){return this.#Uu}set smoothness(e){validateNumberRange(e,0,1),this.#Uu=e,this.uniformBuffer.writeBuffer(this.uniformInfo.members.smoothness,e)}}Object.freeze(Vignetting);var ei=Object.freeze({__proto__:null,AMultiPassPostEffect:AMultiPassPostEffect,ASinglePassPostEffect:ASinglePassPostEffect,BlurX:BlurX,BlurY:BlurY,BrightnessContrast:BrightnessContrast,Convolution:Convolution,GaussianBlur:GaussianBlur,Grayscale:Grayscale,HueSaturation:HueSaturation,Invert:Invert,OldBloom:OldBloom,PostEffectManager:PostEffectManager,Threshold:Threshold,Vignetting:Vignetting,ZoomBlur:ZoomBlur}),ti=Object.freeze({__proto__:null,PICKING_EVENT_TYPE:er,PickingEvent:PickingEvent,PickingManager:PickingManager});const init=async(e,t,r,n,i="premultiplied",s={powerPreference:"high-performance",forceFallbackAdapter:!1})=>{const{gpu:a}=navigator,errorHandler=(e,t)=>{const n=generateErrorMessage(e,t);console.error("\n============\n",n,"\n============\n"),r?.(n)},validateAndRequestDevice=async t=>{const r=[];t.features.has("texture-compression-astc")&&r.push("texture-compression-astc");const n={requiredFeatures:r};try{const r=await t.requestDevice(n);validateAndInitializeContext(e,t,r)}catch(e){errorHandler(null,`Failed to request device. Adapter was ${t},error message is ${e.message}`)}},validateAndInitializeContext=(e,s,a)=>{const o=e.getContext("webgpu");if(o)try{const r=new RedGPUContext(e,s,a,o,i);t(r),a.addEventListener("uncapturederror",(e=>{console.warn("TODO A WebGPU error was not captured:",e),console.warn(e.error?.message),window.cancelAnimationFrame(r.currentRequestAnimationFrame)})),a.lost.then((e=>{console.warn(e),console.warn(`Device lost occurred:${e.message}`),"destroyed"===e.reason&&n?.(e)}))}catch(e){r(errorHandler(e,""))}else errorHandler(new Error(`Failed to get context from canvas:${e.id||e}`),"Failed to get webgpu initialize from canvas")},initializeWebGPU=async()=>{t instanceof Function?e instanceof HTMLCanvasElement?await(async e=>{e||errorHandler(null,"Cannot find navigator.gpu");try{const t=await e.requestAdapter(s);await validateAndRequestDevice(t)}catch(t){errorHandler(t,`Failed to request adapter or validate device with target GPU:${e},error message is ${t.message}`)}})(a):errorHandler(null,`Expected HTMLCanvasElement,but received:${e}`):errorHandler(null,`Expected onWebGPUInitialized,but received:${t}`)};try{await initializeWebGPU()}catch(e){errorHandler(e,`Unexpected error occurred during WebGPU initialization:${e.message}`)}},generateErrorMessage=(e,t)=>{let r=t;return e instanceof Error?(r=e.message??t,"string"==typeof e.stack&&(r+=`\nStack Trace:${e.stack}`)):console.warn("generateErrorMessage function expected an Error instance,but got:",e),r};class TextureLoaderData{src;texture;loadEnd;loadSuccess;srcInfo;idx;constructor(e,t,r){this.src=e,this.texture=null,this.loadEnd=!1,this.loadSuccess=!1,this.srcInfo=t,this.idx=r}}class TextureLoader{textures=[];#Bu=0;#v;#Lu;#Au;#Du;constructor(e,t=[],r,n){this.#v=e,this.#Lu=t,this.#Au=r,this.#Du=n,this.#Lu.length?this.#Lu.forEach(((e,t)=>this.#Ou(e,t))):this.#Gu()}getTextureByIndex(e){if(this.textures[e])return this.textures[e].texture}#Ou(e,t){let r,n,i=BitmapTexture;n=e.hasOwnProperty("src")?e.src:e,n instanceof Array&&(i=CubeTexture),r=new TextureLoaderData(n,e,t);const onLoadHandler=()=>{r.loadSuccess=!0,r.loadEnd=!0,this.#Nu()},onErrorHandler=()=>{r.loadSuccess=!1,r.loadEnd=!0,this.#Nu()};r.texture=i===BitmapTexture?new i(this.#v,e,!0,onLoadHandler,onErrorHandler,e.format,!1):new i(this.#v,e,!0,onLoadHandler,onErrorHandler,e.format),this.textures.push(r)}#Nu(){this.#Bu++,this.#Du&&this.#Du.call(this,{totalNum:this.#Lu.length,loaded:this.#Bu}),this.#Bu===this.#Lu.length&&this.#Gu()}#Gu(){requestAnimationFrame((()=>{this.#Au&&this.#Au.call(this,this)}))}}const arrayBufferLoader=(e,t,r)=>{fetch(e).then((e=>{if(!e.ok)throw new Error(`Network response was not ok ${e.statusText}`);return e.arrayBuffer()})).then((e=>{t&&t(e)})).catch((e=>{}))},ri={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};Object.freeze(ri);class AccessorInfo_GLTF{accessor;bufferView;bufferGlTfId;buffer;bufferURIDataView;componentType;componentType_BYTES_PER_ELEMENT;getMethod;accessorBufferOffset;bufferViewOffset;bufferViewByteStride;startIndex;constructor(e,t,r){switch(this.accessor=t.accessors[r],this.bufferView=t.bufferViews[this.accessor.bufferView],this.bufferGlTfId=this.bufferView.buffer,this.buffer=t.buffers[this.bufferGlTfId],this.bufferURIDataView=null,this.buffer.uri&&(this.bufferURIDataView=e.parsingResult.uris.buffers[this.bufferGlTfId]),this.componentType=ri[this.accessor.componentType],this.componentType_BYTES_PER_ELEMENT=this.componentType.BYTES_PER_ELEMENT,this.componentType){case Float32Array:this.getMethod="getFloat32";break;case Uint32Array:this.getMethod="getUint32";break;case Uint16Array:this.getMethod="getUint16";break;case Int16Array:this.getMethod="getInt16";break;case Uint8Array:this.getMethod="getUint8";break;case Int8Array:this.getMethod="getInt8";break;default:consoleAndThrowError(" ",this.componentType)}this.accessorBufferOffset=this.accessor.byteOffset||0,this.bufferViewOffset=this.bufferView.byteOffset||0,this.bufferViewByteStride=this.bufferView.byteStride||0,this.startIndex=(this.bufferViewOffset+this.accessorBufferOffset)/this.componentType_BYTES_PER_ELEMENT}}class AnimationData_GLTF{gltfLoader;scenesData;accessorGlTfId;dataList;constructor(e,t,r){this.gltfLoader=e,this.scenesData=t,this.accessorGlTfId=r;const n=new AccessorInfo_GLTF(this.gltfLoader,this.scenesData,this.accessorGlTfId),{accessor:i,startIndex:s,componentType_BYTES_PER_ELEMENT:a,bufferURIDataView:o,getMethod:u}=n,{type:l,count:c}=i;let h=s,m=1;switch(l){case"SCALAR":m=1;break;case"VEC4":m=4;break;case"VEC3":m=3}this.dataList=[];let d=0;for(;d<c*m;h++,d++)this.dataList[d]=o[u](h*a,!0)}}class AniTrack_GLTF{key;timeAnimationInfo;aniDataAnimationInfo;interpolation;animationTargetMesh;weightMeshes;constructor(e,t,r,n,i,s){this.key=e,this.timeAnimationInfo=t,this.aniDataAnimationInfo=r,this.interpolation=n,this.animationTargetMesh=i,this.weightMeshes=s}}const parseAnimations=(e,t)=>new Promise((async r=>{t.animations||(t.animations=[]);const{parsingResult:n}=e,{animations:i}=n,{animations:s}=t;if(s.length){const r=s.map((async r=>{const{samplers:n,channels:s}=r,a=[];a.minTime=1e7,a.maxTime=-1,a.name=r.name,i.push(a),await Promise.all(s.map((async r=>((e,t,r,n,i)=>{let s,a;const{nodes:o,meshes:u}=i,l=[],{sampler:c,target:h}=r,m=n[c],{node:d,path:p}=h,f=o[d];if("mesh"in f){s=f.Mesh;const{primitives:e}=u[f.mesh];let t=e.length;for(;t--;)l.push(e[t].Mesh)}else{let t;if(!e.parsingResult.groups[d])return;t=e.parsingResult.groups[d],s=t}if("scale"!=p&&"rotation"!=p&&"translation"!=p&&"weights"!=p||(a=new AniTrack_GLTF(p,new AnimationData_GLTF(e,i,m.input),new AnimationData_GLTF(e,i,m.output),m.interpolation,s,l),t.push(a)),a){const{timeAnimationInfo:e}=a,{dataList:r}=e;t.minTime>r[0]&&(t.minTime=r[0]),t.maxTime<r[r.length-1]&&(t.maxTime=r[r.length-1])}})(e,a,r,n,t))))}));await Promise.all(r),i.length&&i.forEach((t=>e.playAnimation(t)))}r()}));let ni=new Float32Array(16),ii=new Float32Array(16);class ParsedSkinInfo_GLTF{joints;inverseBindMatrices;skeletonMesh;isInverseBindMatrixUpdated=!1;vertexStorageInfo;vertexStorageBuffer;#Vu;#Fu;constructor(){this.joints=[],this.inverseBindMatrices=null,this.skeletonMesh=null}update(e,t){const r=this.#zu(t.modelMatrix),n=this.#$u(this.joints,r);this.#Hu(e,t.animationInfo.skinInfo,n)}#zu(e){return this.#Vu=this.#Vu||new Float32Array(e.length),this.#Vu.set(e),invert$2(this.#Vu,this.#Vu),this.#Vu}#$u(e,t){const r=16*e.length;this.#Fu&&this.#Fu.length==r||(this.#Fu=new Float32Array(r));for(let r=0;r<e.length;r++){const n=multiply$5(ni,t,e[r].modelMatrix),i=multiply$5(ii,n,this.inverseBindMatrices[r]);this.#Fu.set(i,16*r)}return this.#Fu}#Hu(e,t,r){const{vertexStorageBuffer:n,vertexStorageInfo:i}=t,{gpuBuffer:s}=n,{jointMatrix:a}=i.members;e.gpuDevice.queue.writeBuffer(s,a.uniformOffset,r)}}const parseJoint_GLTF=(e,t,r,n)=>{const i=r[n].Mesh;i?(t.joints.push(i),i.depthCompare=bt.NEVER):requestAnimationFrame((function(){parseJoint_GLTF(e,t,r,n)}))},parseAttributeInfo_GLTF=function(e,t,r,n,i,s,a,o,u,l){const{accessor:c,startIndex:h,getMethod:m,bufferViewByteStride:d,bufferURIDataView:p,componentType_BYTES_PER_ELEMENT:f}=t,{type:g,count:x}=c;let _=0;const v=d/f;let y,T=h;switch(g){case"VEC4":if(d)for(y=T+x*(d/f);T<y;T++)_%v<4&&("WEIGHTS_0"==e?a.push(p[m](T*f,!0)):"JOINTS_0"==e?o.push(p[m](T*f,!0)):"COLOR_0"==e?u.push(p[m](T*f,!0)):"TANGENT"==e?l.push(p[m](T*f,!0)):consoleAndThrowError("VEC4     ",e)),_++;else for(y=T+4*x;T<y;T++)"WEIGHTS_0"==e?a.push(p[m](T*f,!0)):"JOINTS_0"==e?o.push(p[m](T*f,!0)):"COLOR_0"==e?u.push(p[m](T*f,!0)):"TANGENT"==e?l.push(p[m](T*f,!0)):consoleAndThrowError("VEC4     ",e),_++;break;case"VEC3":if(d)for(y=T+x*(d/f);T<y;T++)_%v<3&&("NORMAL"==e?s.push(p[m](T*f,!0)):"POSITION"==e?r.push(p[m](T*f,!0)):"COLOR_0"==e?(u.push(p[m](T*f,!0)),_%v==2&&u.push(1)):"TANGENT"==e?l.push(p[m](T*f,!0)):consoleAndThrowError("VEC3     ",e)),_++;else for(y=T+3*x;T<y;T++)"NORMAL"==e?s.push(p[m](T*f,!0)):"POSITION"==e?r.push(p[m](T*f,!0)):"COLOR_0"==e?(u.push(p[m](T*f,!0)),_%3==2&&u.push(1)):"TANGENT"==e?l.push(p[m](T*f,!0)):consoleAndThrowError("VEC3     ",e),_++;break;case"VEC2":if(d)for(y=T+x*(d/f);T<y;T++)_%v<2&&("TEXCOORD_0"==e?n.push(p[m](T*f,!0)):"TEXCOORD_1"==e?i.push(p[m](T*f,!0)):consoleAndThrowError("VEC2     ",e)),_++;else for(y=T+2*x;T<y;T++)"TEXCOORD_0"==e?n.push(p[m](T*f,!0)):"TEXCOORD_1"==e?i.push(p[m](T*f,!0)):consoleAndThrowError("VEC2     ",e),_++}},parseSparse_GLTF=(e,t,r,n,i)=>{const s=r.sparse;if(!s)return;const{values:a,indices:o,count:u}=s,l=n.bufferViews,c=l[a.bufferView],h=c.buffer,m=n.buffers,d=m[h],p=[],f=[],g=l[o.bufferView],x=g.buffer,_=m[x];let v;d.uri&&(v=e.parsingResult.uris.buffers[h]);const y=ri[r.componentType],{BYTES_PER_ELEMENT:T}=y;let b;switch(y){case Float32Array:b="getFloat32";break;case Uint32Array:b="getUint32";break;case Uint16Array:b="getUint16";break;case Int16Array:b="getInt16";break;case Uint8Array:b="getUint8";break;case Int8Array:b="getInt8"}const S=r.byteOffset||0;let M,R,w=((c.byteOffset||0)+S)/T;switch(r.type){case"VEC3":for(M=w+T*u/T*3;w<M;w++){const e=v[b](w*T,!0);"NORMAL"==t||"POSITION"==t&&p.push(e)}break;case"VEC2":for(M=w+T*u/T*2;w<M;w++)"TEXCOORD_0"==t&&f.push(v[b](w*T,!0))}_.uri&&(R=e.parsingResult.uris.buffers[x]);const E=ri[o.componentType],P=E.BYTES_PER_ELEMENT,C=E===Uint16Array?"getUint16":"getUint8",k=o.byteOffset||0;let I=((g.byteOffset||0)+k)/P;const U=I+P*u/P;let B=0;for(;I<U;I++){const e=R[C](I*P,!0);i[3*e]=p[3*B],i[3*e+1]=p[3*B+1],i[3*e+2]=p[3*B+2],B++}};class MorphInfoData_GLTF{vertices=[];verticesColor_0=[];normals=[];uvs=[];uvs1=[];jointWeights=[];joints=[];tangents=[];interleaveData;constructor(e=[],t=[],r=[],n=[],i=[],s=[],a=[],o=[]){this.vertices=e,this.verticesColor_0=t,this.normals=r,this.uvs=n,this.uvs1=i,this.jointWeights=s,this.joints=a,this.tangents=o}}class MorphInfo_GLTF{morphInfoDataList=[];weights;cacheData={};origin;constructor(e,t,r,n){r.targets&&(this.morphInfoDataList=r.targets.map((r=>{const n=new MorphInfoData_GLTF;for(let i in r){const{vertices:s,verticesColor_0:a,normals:o,uvs:u,uvs1:l,jointWeights:c,joints:h,tangents:m}=n,d=r[i],p=new AccessorInfo_GLTF(e,t,d),{accessor:f}=p;parseAttributeInfo_GLTF(i,p,s,u,l,o,c,h,a,m),f.sparse&&parseSparse_GLTF(e,i,f,t,s)}return n}))),this.weights=n||[],this.origin=null}}const parseMaterialTexture=(e,t,r,n,i)=>{const{redGPUContext:s,gltfData:a}=e,{textureRawList:o}=e.parsingResult,u=r.index,l=a.textures[u],c=l.source,h=getURL(e,a,c),m=l.sampler,d=getSamplerInfo(e,a,m),{parsedURI:p,cacheKey:f}=h,g=`${n}SourceGlTfId_${c}`;if(o[g]?(o[g].materialList.push(t),o[g].samplerList.push(new Sampler(s,d))):o[g]={src:p,cacheKey:f,targetTextureKey:n,targetSamplerKey:`${n}Sampler`,materialList:[t],samplerList:[new Sampler(s,d)],format:i||navigator.gpu.getPreferredCanvasFormat()},t[`${n}_texCoord_index`]=r.texCoord||0,"extensions"in r){const{extensions:e}=r,{KHR_texture_transform:i}=e;i&&((e,t,r)=>{e[`${t}_KHR_texture_transform_offset`]=r.offset||[0,0],e[`${t}_KHR_texture_transform_scale`]=r.scale||[1,1],e[`${t}_KHR_texture_transform_rotation`]=r.rotation||0,e[`use_${t}_KHR_texture_transform`]=!0})(t,n,i)}},getURL=function(e,t,r){const{uri:n}=t.images[r];let i;const s=`${e.url}_${r}`;return i=n.indexOf("blob:http")>-1?n:(n.indexOf(";base64,")>-1?"":e.filePath)+n,{parsedURI:i,cacheKey:s}},getSamplerInfo=function(e,t,r){const n={magFilter:Le.LINEAR,minFilter:Le.LINEAR,mipmapFilter:Le.LINEAR,addressModeU:Ue.REPEAT,addressModeV:Ue.REPEAT,addressModeW:Ue.REPEAT},i={33071:Ue.CLAMP_TO_EDGE,33648:Ue.MIRRORED_REPEAT,10497:Ue.REPEAT},s={9728:Le.NEAREST,9729:Le.LINEAR},a={9728:Le.NEAREST,9729:Le.LINEAR};if(t.samplers){let e=t.samplers[r];e&&("magFilter"in e&&(n.magFilter=s[e.magFilter]||Le.LINEAR),"minFilter"in e&&(n.minFilter=a[e.minFilter]||Le.LINEAR),"wrapS"in e&&(n.addressModeU=i[e.wrapS]),"wrapT"in e&&(n.addressModeV=i[e.wrapT]))}return n.string=JSON.stringify(n),n},parseMaterialInfo_GLTF=(e,t,r)=>{const{redGPUContext:n}=e;let i,s=!1,a="OPAQUE",o=.5;if("material"in r){i=new PBRMaterial(n);const u=r.material,l=t.materials[u];s=!!l.doubleSided,a=l.alphaMode??a,o=l.alphaCutoff??o;const{pbrMetallicRoughness:c,normalTexture:h,emissiveTexture:m,occlusionTexture:d}=l;if(i.emissiveFactor=l.emissiveFactor||[0,0,0],c){const{metallicRoughnessTexture:t,baseColorTexture:r}=c;let n,s;i.baseColorFactor=c.baseColorFactor||[1,1,1,1],"metallicFactor"in c&&(n=c.metallicFactor),"roughnessFactor"in c&&(s=c.roughnessFactor),i.metallicFactor=null!=n?n:1,i.roughnessFactor=null!=s?s:1,r&&parseMaterialTexture(e,i,r,"baseColorTexture",`${navigator.gpu.getPreferredCanvasFormat()}-srgb`),t&&parseMaterialTexture(e,i,t,"metallicRoughnessTexture")}if(h){parseMaterialTexture(e,i,h,"normalTexture");const{scale:t}=h;i.normalScale=null!=t?t:1}if(m&&parseMaterialTexture(e,i,m,"emissiveTexture",`${navigator.gpu.getPreferredCanvasFormat()}-srgb`),d&&(parseMaterialTexture(e,i,d,"occlusionTexture"),i.occlusionStrength=l.occlusionTexture.strength||1),"extensions"in l){const{extensions:t}=l,{KHR_materials_clearcoat:r,KHR_materials_emissive_strength:n,KHR_materials_transmission:s,KHR_materials_unlit:a,KHR_materials_ior:o,KHR_materials_sheen:u,KHR_materials_specular:c}=t;if(r&&((e,t,r)=>{e.KHR_clearcoatFactor=t.clearcoatFactor||0,e.KHR_clearcoatRoughnessFactor=t.clearcoatRoughnessFactor||0,e.useKHR_materials_clearcoat=!0;const{clearcoatTexture:n,clearcoatNormalTexture:i,clearcoatRoughnessTexture:s}=t;n&&parseMaterialTexture(r,e,n,"KHR_clearcoatTexture"),i&&parseMaterialTexture(r,e,i,"KHR_clearcoatNormalTexture"),s&&parseMaterialTexture(r,e,s,"KHR_clearcoatRoughnessTexture")})(i,r,e),n){const{emissiveStrength:e}=n;i.emissiveStrength=null!=e?e:1}if(s&&((e,t,r)=>{e.transmissionFactor=t.transmissionFactor||0,e.transparent=!0;{const n=t.transmissionTexture;n&&parseMaterialTexture(r,e,n,"transmissionTexture")}})(i,s,e),a&&(i.useKHR_materials_unlit=!0),o){const{ior:e}=o;i.KHR_materials_ior=null!=e?e:1.5,i.transparent=!0}u&&((e,t,r)=>{e.KHR_sheenColorFactor=t.sheenColorFactor||[0,0,0],e.KHR_sheenRoughnessFactor=t.sheenRoughnessFactor||0,e.useKHR_materials_sheen=!0;const{sheenColorTexture:n,sheenRoughnessTexture:i}=t;n&&parseMaterialTexture(r,e,n,"KHR_sheenColorTexture",`${navigator.gpu.getPreferredCanvasFormat()}-srgb`),i&&parseMaterialTexture(r,e,i,"KHR_sheenRoughnessTexture")})(i,u,e),c&&((e,t,r)=>{e.KHR_specularFactor=t.specularFactor??1,e.KHR_specularColorFactor=t.specularColorFactor||[1,1,1],e.useKHR_materials_specular=!0;const{specularTexture:n,specularColorTexture:i}=t;n&&parseMaterialTexture(r,e,n,"KHR_specularTexture"),i&&parseMaterialTexture(r,e,i,"KHR_specularColorTexture",`${navigator.gpu.getPreferredCanvasFormat()}-srgb`)})(i,c,e)}}else i=new PBRMaterial(n);Object.hasOwn(r.attributes,"COLOR_0")&&(i.useVertexColor=!0),i.doubleSided=s,i.cutOff=o;const{blendColorState:u,blendAlphaState:l}=i;switch(a){case"BLEND":i.alphaBlend=2,u.srcFactor=lt.SRC_ALPHA,u.dstFactor=lt.ONE_MINUS_SRC_ALPHA,l.srcFactor=lt.SRC_ALPHA,l.dstFactor=lt.ONE_MINUS_SRC_ALPHA,i.transparent=!0;break;case"MASK":i.alphaBlend=1,i.useCutOff=!0,u.srcFactor=lt.ONE,u.dstFactor=lt.ZERO,l.srcFactor=lt.ONE,l.dstFactor=lt.ZERO;break;default:u.srcFactor=lt.ONE,u.dstFactor=lt.ZERO,l.srcFactor=lt.ONE,l.dstFactor=lt.ZERO,i.alphaBlend=0}return i},parseIndicesInfo_GLTF=(e,t)=>{const{accessor:r,startIndex:n,getMethod:i,bufferURIDataView:s,componentType_BYTES_PER_ELEMENT:a}=e,{type:o,count:u}=r;let l,c=n;if("SCALAR"===o)for(l=c+u;c<l;c++)t.push(s[i](c*a,!0))},parseInterleaveData_GLTF=(e,t,r,n,i,s,a,o,u)=>{let l,c,h,m,d,p,f,g,x,_=0,v=t.length/3,y=0;const T=t.length,b=n.length,S=s.length,M=r.length,R=a.length,w=o.length,E=u.length;for(l=h=p=0,c=m=f=1,d=g=2,x=3;_<v;_++)T&&(e[y++]=t[h],e[y++]=t[m],e[y++]=t[d]),b?(e[y++]=n[h],e[y++]=n[m],e[y++]=n[d]):(e[y++]=0,e[y++]=0,e[y++]=0),i.length||i.push(0,0),i.length&&(e[y++]=i[l],e[y++]=i[c]),S?(e[y++]=s[l],e[y++]=s[c]):i.length&&(e[y++]=i[l],e[y++]=i[c]),M?(e[y++]=r[p],e[y++]=r[f],e[y++]=r[g],e[y++]=r[x]):(e[y++]=0,e[y++]=0,e[y++]=0,e[y++]=0),R?(e[y++]=a[p],e[y++]=a[f],e[y++]=a[g],e[y++]=a[x]):(e[y++]=0,e[y++]=0,e[y++]=0,e[y++]=0),w?(e[y++]=o[p],e[y++]=o[f],e[y++]=o[g],e[y++]=o[x]):(e[y++]=0,e[y++]=0,e[y++]=0,e[y++]=0),E?(e[y++]=u[p],e[y++]=u[f],e[y++]=u[g],e[y++]=u[x]):(e[y++]=0,e[y++]=0,e[y++]=0,e[y++]=0),l+=2,c+=2,h+=3,m+=3,d+=3,p+=4,f+=4,g+=4,x+=4},si=180/Math.PI,setMeshRotation=(e,t)=>{t.setRotation(-e[0]*si,-e[1]*si,-e[2]*si)},parseTRSAndMATRIX_GLTF=(e,t)=>{const{matrix:r,rotation:n,translation:i,scale:s}=t;let a,o;if("matrix"in t){a=create$5(),o=create$4(),mat4ToEuler(r,o),setMeshRotation(o,e),e.setPosition(r[12],r[13],r[14]);const t=fromValues$4(1,1,1);getScaling(t,r),e.setScale(t[0],t[1],t[2])}"rotation"in t&&(a=create$5(),o=create$4(),quaternionToRotationMat4(n,a),mat4ToEuler(a,o),setMeshRotation(o,e)),"translation"in t&&e.setPosition(i[0],i[1],i[2]),"scale"in t&&(e.setScale(s[0],s[1],s[2]),(s[0]<0||s[1]<0||s[2]<0)&&(e.primitiveState.frontFace=Et.CW))},parseChildrenAndSkin=(e,t,r,n,i)=>{if("children"in n){const i=n.children,s=i.length;for(let n=0;n<s;n++)parseNode_GLTF(e,t,i[n],r)}"skin"in n&&((e,t,r,n)=>{const i=new ParsedSkinInfo_GLTF,s=[],{nodes:a}=t,{joints:o,skeleton:u}=r;{let t=0;const r=o.length;for(;t<r;t++){const r=o[t];parseJoint_GLTF(e,i,a,r)}}u&&(i.skeletonMesh=a[u].Mesh);const l=r.inverseBindMatrices,c=new AccessorInfo_GLTF(e,t,l),{startIndex:h,accessor:m,componentType_BYTES_PER_ELEMENT:d,bufferViewByteStride:p,bufferURIDataView:f,getMethod:g}=c,{type:x,count:_}=m;let v=0;const y=p/d;let T,b=h;if("MAT4"===x)if(p)for(T=b+_*(p/d);b<T;b++)v%y<16&&s.push(f[g](b*d,!0)),v++;else for(T=b+16*_;b<T;b++)s.push(f[g](b*d,!0)),v++;i.inverseBindMatrices=[];for(let e=0;e<o.length;e++)i.inverseBindMatrices.push(new Float32Array([s[16*e],s[16*e+1],s[16*e+2],s[16*e+3],s[16*e+4],s[16*e+5],s[16*e+6],s[16*e+7],s[16*e+8],s[16*e+9],s[16*e+10],s[16*e+11],s[16*e+12],s[16*e+13],s[16*e+14],s[16*e+15]]));n.animationInfo.skinInfo=i,n.material.useSkin=!!n.animationInfo.skinInfo})(e,t,i[n.skin],r)},parseNode_GLTF=(e,t,r,n)=>{const{redGPUContext:i,parsingResult:s}=e,{nodes:a,meshes:o,skins:u}=t,{groups:l,cameras:c}=s,h=a[r];if("mesh"in h){const r=function(e,t,r){const{redGPUContext:n}=e;let i;r.name&&(i=r.name);const s=[],{primitives:a}=r;let o=0;const u=a.length;for(;o<u;o++){const u=a[o];let l,c,h,m=[],d=[],p=[],f=[],g=[],x=[],_=[],v=[],y=[];const{attributes:T}=u;if(T)for(const r in T){const n=T[r],i=new AccessorInfo_GLTF(e,t,n);parseAttributeInfo_GLTF(r,i,d,f,g,x,_,v,p,y),i.accessor.sparse&&parseSparse_GLTF(e,r,i.accessor,t,d)}if("indices"in u){let r=u.indices,n=new AccessorInfo_GLTF(e,t,r);parseIndicesInfo_GLTF(n,m)}c=parseMaterialInfo_GLTF(e,t,u),c instanceof PBRMaterial&&e.parsingResult.materials.push(c);let b,S=!1;if("mode"in u)switch(u.mode){case 0:h=Ct.POINT_LIST;break;case 1:case 2:h=Ct.LINE_LIST;break;case 3:h=Ct.LINE_STRIP,S=!0;break;case 4:case 6:h=Ct.TRIANGLE_LIST;break;case 5:h=Ct.TRIANGLE_STRIP,S=!0}p.length&&(c.useVertexColor_0=!0),y.length&&(c.useVertexTangent=!0),b=x.length?x:calculateNormals(d,m);let M,R=[];parseInterleaveData_GLTF(R,d,p,b,f,g,_,v,y);let w={};if(d.length&&(w.aVertexPosition=InterleaveType.float32x3),b.length&&(w.aVertexNormal=InterleaveType.float32x3),f.length&&(w.aTexcoord=InterleaveType.float32x2),(g.length||f.length)&&(w.aTexcoord1=InterleaveType.float32x2),w.aVertexColor_0=InterleaveType.float32x4,w.aVertexWeight=InterleaveType.float32x4,w.aVertexJoint=InterleaveType.float32x4,w.aVertexTangent=InterleaveType.float32x4,M=new Geometry(n,new VertexBuffer(n,R,new InterleavedStruct(w)),!S&&m.length?new IndexBuffer(n,new Uint32Array(m)):null),c||consoleAndThrowError("  ",u),l=new Mesh(n,M,c),i&&(l.name=i,e.parsingOption))for(let t in e.parsingOption)i.toLowerCase().indexOf(t)>-1&&e.parsingOption[t](l);l.primitiveState.topology=h||Ct.TRIANGLE_LIST,l.material.doubleSided&&(l.primitiveState.cullMode=wt.NONE),l.material.alphaBlend;{let n=new MorphInfo_GLTF(e,t,u,r.weights),i=0,s=n.morphInfoDataList;const a=s.length;for(;i<a;){const e=s[i],t=e.normals.length?e.normals:calculateNormals(e.vertices,m),r=[];parseInterleaveData_GLTF(r,e.vertices,e.verticesColor_0,t,e.uvs,e.uvs1,e.jointWeights,e.joints,e.tangents),e.interleaveData=r,i++}l.animationInfo.morphInfo=n,l.animationInfo.morphInfo.origin=new Float32Array(R)}let E=l.geometry.vertexBuffer.data;l.gpuRenderInfo||l.initGPURenderInfos();let P=0;for(const e in w)P+=w[e].numElements;{const e=l.animationInfo.morphInfo.morphInfoDataList;let t=0;const r=e.length,n=E.length;for(;t<r;){const r=e[t].vertices;let i=0,s=n/P,a=null==l.animationInfo.morphInfo.weights[t]?.5:l.animationInfo.morphInfo.weights[t];for(;i<s;)E[i*P]+=r[3*i]*a,E[i*P+1]+=r[3*i+1]*a,E[i*P+2]+=r[3*i+2]*a,i++;t++}}l.geometry.vertexBuffer.updateAllData(E),l.animationInfo.morphInfo.origin=new Float32Array(E),u.Mesh=l,s.push(l)}return s}(e,t,o[h.mesh]),i=r.length;for(let s=0;s<i;s++){let i=r[s];n.addChild(h.Mesh=i),parseTRSAndMATRIX_GLTF(i,h),parseChildrenAndSkin(e,t,i,h,u)}}else{let s;l[r]?(s=l[r],h.Mesh=s):(s=new Mesh(i),n.addChild(s),h.Mesh=s,s.name=h.name,l[r]=s),parseTRSAndMATRIX_GLTF(s,h),parseChildrenAndSkin(e,t,s,h,u)}},parseGLTF=(e,t,r)=>{(e=>{const t=e?.asset;t||consoleAndThrowError("GLTFLoader - asset must be defined"),t.version||consoleAndThrowError("GLTFLoader - asset version must be defined");const r=parseFloat(t.version);isNaN(r)&&consoleAndThrowError("GLTFLoader - asset version must be a numerical value"),r<2&&consoleAndThrowError("GLTFLoader - asset version must be 2.0 or higher")})(t),((e,t,r)=>{const{parsingResult:n}=e,{uris:i}=n,s="buffers",a=i[s],o=t.buffers,u=o.length;let l=0;o.forEach(((t,n)=>{var i;function checkLoadingStatus(){l===u&&r&&r()}t._redURIkey=s,t._redURIIndex=n,t.uri instanceof ArrayBuffer?(i=new DataView(t.uri),l++,a[n]=i,checkLoadingStatus()):function(t){const r=t.startsWith("data:")?t:e.filePath+t;arrayBufferLoader(r,(function(e){l++,a[n]=new DataView(e),checkLoadingStatus()}))}(t.uri)}))})(e,t,(()=>{((e,t,r)=>{const{scenes:n}=t;n[0].nodes.forEach((r=>{parseNode_GLTF(e,t,r,e.resultMesh)})),r?.()})(e,t,(()=>{((e,t)=>{const{cameras:r}=t;r&&r.forEach((function(t){let r=new PerspectiveCamera;"orthographic"==t.type||(r.fieldOfView=180*t.perspective.yfieldOfView/Math.PI,r.farClipping=t.perspective.zfar,r.nearClipping=t.perspective.znear),e.parsingResult.cameras.push(r)}))})(e,t),new TextureLoader(e.redGPUContext,Object.values(e.parsingResult.textureRawList),(n=>{n.textures.forEach((e=>{const{targetTextureKey:t,targetSamplerKey:r,samplerList:n}=e.srcInfo;e.srcInfo.materialList.forEach(((i,s)=>{i[t]=e.texture,n[s]&&(i[r]=n[s])}))})),parseAnimations(e,t).then((e=>{r&&r()}))}))}))}))},parseFileGLB=async(e,t)=>{const r=e.filePath+e.fileName;await(async(e,t,r=()=>{})=>{try{const r=await fetch(e);t(await r.arrayBuffer())}catch(e){r(e)}})(r,(async r=>{const{content:n,binaryChunk:i}=parseBuffer(r);if(null===n)throw new Error("JSON content not found");const s=JSON.parse(n);processImagesIfExist(s,i),s.buffers[0].uri=i,e.gltfData=s,parseGLTF(e,s,t)}),(e=>{}))},parseBuffer=e=>{let t=null,r=null;const n=new DataView(e,12),i=n.byteLength;for(let s=0;s<i;){const i=n.getUint32(s,!0);s+=4;const a=n.getUint32(s,!0);switch(s+=4,a){case 1313821514:const n=new Uint8Array(e,12+s,i);t=convertUint8ArrayToString(n);break;case 5130562:const a=12+s;r=e.slice(a,a+i)}s+=i}return{content:t,binaryChunk:r}},processImagesIfExist=(e,t)=>{const{images:r,bufferViews:n}=e,i=["image/png","image/jpeg","image/gif"];if(r)for(let e=0;e<r.length;e++){const s=r[e],{mimeType:a,bufferView:o}=s;if(i.includes(a)){const e=n[o].byteOffset||0,r=t.slice(e,e+n[o].byteLength),i=new Blob([new Uint8Array(r)],{type:a});s.uri=URL.createObjectURL(i)}}},convertUint8ArrayToString=e=>{let t="";for(let r of e)t+=String.fromCharCode(r);return t};class GLTFLoader{parsingResult;resultMesh;parsingOption;activeAnimations=[];#v;#Ku;#uu;#lu;#Xu;#ju;#ee;#te;#Yu;constructor(e,t,r,n){validateRedGPUContext(e),this.#v=e,this.#lu=t,this.#Ku=getFilePath(t),this.#uu=getFileName(t),this.#Xu=getFileExtension(t),this.#ee=r,this.#te=n,this.parsingResult={groups:[],materials:[],uris:{buffers:[]},textures:{},textureRawList:[],cameras:[],animations:[]},this.resultMesh=new Mesh(this.#v),this.resultMesh.gltfLoaderInfo=this,this.resultMesh.animationInfo.animationsList=this.parsingResult.animations,this.#Zu()}get redGPUContext(){return this.#v}get filePath(){return this.#Ku}get gltfData(){return this.#ju}set gltfData(e){this.#ju=e}get fileName(){return this.#uu}get url(){return this.#lu}stopAnimation(){const{activeAnimations:e}=this;let t=e.indexOf(this.#Yu);t>-1&&e.splice(t,1)}playAnimation(e){const{activeAnimations:t}=this;t.push(this.#Yu=new PlayAnimationInfo(performance.now(),e))}async#Zu(){try{"glb"===this.#Xu?await parseFileGLB(this,(()=>this.#ee(this))):"gltf"===this.#Xu?await(async(e,t)=>{const r=await fetch(e.url);e.gltfData=await r.json(),parseGLTF(e,e.gltfData,t)})(this,(()=>this.#ee(this))):consoleAndThrowError("Unknown file extension:"+this.#Xu)}catch(e){this.#te?.(e)}}}Object.freeze(GLTFLoader);class PlayAnimationInfo{startTime;targetAniTrackList;constructor(e,t){this.startTime=e,this.targetAniTrackList=t}}export{Jt as Camera,ColorRGB,ColorRGBA,vn as Display,FinalRender,GLTFLoader,Ue as GPU_ADDRESS_MODE,lt as GPU_BLEND_FACTOR,ct as GPU_BLEND_OPERATION,bt as GPU_COMPARE_FUNCTION,wt as GPU_CULL_MODE,Be as GPU_FILTER_MODE,Et as GPU_FRONT_FACE,Pt as GPU_INDEX_FORMAT,Ne as GPU_LOAD_OP,Le as GPU_MIPMAP_FILTER_MODE,Ct as GPU_PRIMITIVE_TOPOLOGY,Ve as GPU_STORE_OP,Geometry,yn as Light,sr as Material,OBJLoader,OBJMTLLoader,ti as Picking,ei as PostEffect,Tn as Primitive,RedGPUContext,RedGPUContextDetector,RedGPUContextSizeManager,RedGPUContextViewContainer,Sn as RenderState,Renderer,bn as Resource,Vn as RuntimeChecker,ze as SystemCode,Tr as Util,we as glMatrix,init};